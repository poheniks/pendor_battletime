# -*- coding: UTF-8 -*-
####################################################################################################################
# Generated by Warband Module Decompiler
# All rights of the module belong to their respective owners
####################################################################################################################

from header_common import *
from header_operations import *
from header_mission_templates import *
from header_animations import *
from header_sounds import *
from header_music import *
from header_items import *
from module_constants import *
#COOP BEGIN#####################################
from module_coop_mission_templates import *
#COOP END#############################################


####################################################################################################################
#   Each mission-template is a tuple that contains the following fields:
#  1) Mission-template id (string): used for referencing mission-templates in other files.
#     The prefix mt_ is automatically added before each mission-template id
#
#  2) Mission-template flags (int): See header_mission-templates.py for a list of available flags
#  3) Mission-type(int): Which mission types this mission template matches.
#     For mission-types to be used with the default party-meeting system,
#     this should be 'charge' or 'charge_with_ally' otherwise must be -1.
#     
#  4) Mission description text (string).
#  5) List of spawn records (list): Each spawn record is a tuple that contains the following fields:
#    5.1) entry-no: Troops spawned from this spawn record will use this entry
#    5.2) spawn flags.
#    5.3) alter flags. which equipment will be overriden
#    5.4) ai flags.
#    5.5) Number of troops to spawn.
#    5.6) list of equipment to add to troops spawned from here (maximum 8).
#  6) List of triggers (list).
#     See module_triggers.py for infomation about triggers.
#
#  Please note that mission templates is work in progress and can be changed in the future versions.
# 
####################################################################################################################

pilgrim_disguise = [itm_pilgrim_hood,itm_pilgrim_disguise,itm_practice_staff, itm_throwing_daggers]
af_castle_lord = af_override_horse | af_override_weapons| af_require_civilian

mission_templates = [
  ("town_default", 0, -1,
  "Default town visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse|af_override_gloves, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, af_override_horse|af_override_gloves, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse|af_override_gloves, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse|af_override_gloves, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse|af_override_gloves, 0, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_horse|af_override_gloves, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, af_override_horse|af_override_gloves, 0, 1, []),
    (7, mtef_team_0|mtef_scene_source, af_override_horse|af_override_gloves, 0, 1, []),
    (8, mtef_scene_source, af_override_horse|af_override_gloves, 0, 1, []),
    (9, mtef_scene_source, af_override_horse, 0, 1, []),
    (10, mtef_scene_source, af_override_horse|af_override_gloves, 0, 1, []),
    (11, mtef_scene_source, af_override_horse, 0, 1, []),
    (12, mtef_scene_source, af_override_horse, 0, 1, []),
    (13, mtef_scene_source, 0, 0, 1, []),
    (14, mtef_scene_source, 0, 0, 1, []),
    (15, mtef_scene_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (1, mtef_visitor_source, af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (2, mtef_visitor_source, af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (3, mtef_visitor_source, af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (4, mtef_visitor_source, af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (5, mtef_visitor_source, af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (6, mtef_visitor_source, af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (7, mtef_visitor_source, af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (35, mtef_visitor_source, af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (36, mtef_visitor_source, af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (eq, "$fadefromblack", 1),
    ],
    [
      (start_presentation, "prsnt_fade_from_black", 0),
    ]),

    (ti_on_agent_spawn, 1, 0, 
    [
      (eq, "$talk_context", 14),
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (try_begin),
        (is_between, ":var1", "trp_musician_male", "trp_musicians_end"),
        (try_begin),
          (agent_has_item_equipped, ":var0", "itm_dedal_lutnia"),
          (agent_set_stand_animation, ":var0", "anim_lute_sitting"),
          (agent_set_animation, ":var0", "anim_lute_sitting"),
          (agent_play_sound, ":var0", "snd_dedal_tavern_lute"),
        (else_try),
          (agent_has_item_equipped, ":var0", "itm_dedal_lira"),
          (agent_set_stand_animation, ":var0", "anim_lyre_sitting"),
          (agent_set_animation, ":var0", "anim_lyre_sitting"),
          (agent_play_sound, ":var0", "snd_dedal_tavern_lyre"),
        (try_end),
        (store_random_in_range, ":var2", 0, 300),
        (agent_set_animation_progress, ":var0", ":var2"),
      (else_try),
        (is_between, ":var1", "trp_tavern_minstrel_1", "trp_kingdom_heroes_including_player_begin"),
        (2077, ":var0", 0),
        (try_begin),
          (agent_has_item_equipped, ":var0", "itm_dedal_lutnia"),
          (agent_set_stand_animation, ":var0", "anim_lute_standing"),
          (agent_set_animation, ":var0", "anim_lute_standing"),
          (agent_play_sound, ":var0", "snd_dedal_tavern_lute"),
        (else_try),
          (agent_has_item_equipped, ":var0", "itm_dedal_lira"),
          (agent_set_stand_animation, ":var0", "anim_lyre_standing"),
          (agent_set_animation, ":var0", "anim_lyre_standing"),
          (agent_play_sound, ":var0", "snd_dedal_tavern_lyre"),
        (try_end),
        (store_random_in_range, ":var2", 0, 300),
        (agent_set_animation_progress, ":var0", ":var2"),
      (else_try),
        (is_between, ":var1", "trp_town_walker_1", "trp_ramun_the_slave_trader"),
        (2077, ":var0", 0),
        (store_random_in_range, ":var3", 0, 10),
        (try_begin),
          (gt, ":var3", 2),
          (1779, ":var0", "itm_dedal_kufel"),
          (1747, ":var0", "itm_dedal_kufel"),
          (agent_set_stand_animation, ":var0", "anim_sitting_drinking_low"),
          (agent_set_animation, ":var0", "anim_sitting_drinking_low"),
          (store_random_in_range, ":var2", 0, 300),
        (else_try),
          (agent_set_stand_animation, ":var0", "anim_sitting_low"),
          (agent_set_animation, ":var0", "anim_sitting_low"),
          (store_random_in_range, ":var2", 0, 300),
        (try_end),
        (agent_set_animation_progress, ":var0", ":var2"),
      (try_end),
    ],
    []),

    (1, 0, ti_once, 
    [],
    [
      (store_current_scene, ":var0"),
      (scene_set_slot, ":var0", 0, 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_initialize_tavern_variables"),
      (eq, "$g_mt_mode", 4),
      (play_sound, "snd_tavern_ambiance"),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", 16384),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 512),
      (try_end),
    ]),

    (ti_on_leave_area, 0, 0, 
    [],
    [
      (stop_all_sounds, 1),
      (assign, "$g_mt_mode", 0),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (stop_all_sounds, 1),
      (assign, "$g_mt_mode", 0),
    ]),

    (ti_on_player_exit, 0, 0, 
    [],
    [
      (stop_all_sounds, 1),
      (assign, "$g_mt_mode", 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (1, 0, 0, 
    [
      (gt, "$g_belligerent_drunk_leaving", 0),
      (entry_point_get_position, pos0, 0),
      (agent_get_position, pos1, "$g_belligerent_drunk_leaving"),
      (get_distance_between_positions, ":var0", pos0, pos1),
      (le, ":var0", 150),
    ],
    [
      (1749, "$g_belligerent_drunk_leaving"),
      (assign, "$g_belligerent_drunk_leaving", 0),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (eq, "$g_main_attacker_agent", 0),
        (set_trigger_result, 1),
      (try_end),
    ],
    []),

    (2, 0, 0, 
    [
      (neg|conversation_screen_is_active),
      (eq, "$talk_context", 14),
      (neg|troop_slot_eq, "trp_hired_assassin", 12, "$g_encountered_party"),
      (troop_slot_eq, "trp_belligerent_drunk", 12, "$g_encountered_party"),
      (eq, "$drunks_dont_pick_fights", 0),
    ],
    [
      (try_begin),
        (eq, "$g_start_belligerent_drunk_fight", 0),
        (assign, "$g_start_belligerent_drunk_fight", 1),
        (try_for_agents, ":var0"),
          (agent_get_troop_id, ":var1", ":var0"),
          (eq, ":var1", "trp_belligerent_drunk"),
          (assign, "$g_belligerent_drunk", ":var0"),
        (try_end),
      (else_try),
        (eq, "$g_start_belligerent_drunk_fight", 1),
        (1712, "$g_belligerent_drunk"),
        (agent_is_alive, "$g_belligerent_drunk"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos0, ":var2"),
        (agent_get_position, pos1, "$g_belligerent_drunk"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (position_get_z, ":var4", pos0),
        (position_get_z, ":var5", pos1),
        (store_sub, ":var6", ":var5", ":var4"),
        (try_begin),
          (le, ":var6", 0),
          (val_mul, ":var6", -1),
        (try_end),
        (store_mul, ":var7", ":var6", 3),
        (val_add, ":var3", ":var7"),
        (store_random_in_range, ":var8", 0, 200),
        (store_add, ":var9", 400, ":var8"),
        (le, ":var3", ":var9"),
        (call_script, "script_activate_tavern_attackers"),
        (start_mission_conversation, "trp_belligerent_drunk"),
        (assign, "$g_start_belligerent_drunk_fight", 2),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (neg|conversation_screen_is_active),
      (eq, "$talk_context", 14),
      (troop_slot_eq, "trp_hired_assassin", 12, "$g_encountered_party"),
    ],
    [
      (try_begin),
        (eq, "$g_start_hired_assassin_fight", 0),
        (assign, "$g_start_hired_assassin_fight", 1),
        (try_for_agents, ":var0"),
          (agent_get_troop_id, ":var1", ":var0"),
          (eq, ":var1", "trp_hired_assassin"),
          (assign, "$g_hired_assassin", ":var0"),
        (try_end),
      (else_try),
        (eq, "$g_start_hired_assassin_fight", 1),
        (1712, "$g_hired_assassin"),
        (agent_is_alive, "$g_hired_assassin"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos0, ":var2"),
        (agent_get_position, pos1, "$g_hired_assassin"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (position_get_z, ":var4", pos0),
        (position_get_z, ":var5", pos1),
        (store_sub, ":var6", ":var5", ":var4"),
        (try_begin),
          (le, ":var6", 0),
          (val_mul, ":var6", -1),
        (try_end),
        (store_mul, ":var7", ":var6", 3),
        (val_add, ":var3", ":var7"),
        (store_random_in_range, ":var8", 0, 200),
        (store_add, ":var9", 400, ":var8"),
        (le, ":var3", ":var9"),
        (call_script, "script_activate_tavern_attackers"),
        (assign, "$g_start_hired_assassin_fight", 2),
      (try_end),
    ]),

    (3, 0, ti_once, 
    [
      (neg|conversation_screen_is_active),
      (eq, "$talk_context", 14),
      (gt, "$g_main_attacker_agent", 0),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (eq, ":var2", 1),
        (agent_is_alive, ":var1"),
        (neg|agent_is_wounded, ":var1"),
        (val_add, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
      (neg|this_or_next|agent_is_alive, "$g_main_attacker_agent"),
      (agent_is_wounded, "$g_main_attacker_agent"),
    ],
    [
      (mission_enable_talk),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_position, pos4, ":var0"),
        (agent_set_scripted_destination, ":var0", pos4),
      (try_end),
      (party_get_slot, ":var1", "$g_encountered_party", 20),
      (start_mission_conversation, ":var1"),
    ]),

    (3, 0, ti_once, 
    [
      (neg|conversation_screen_is_active),
      (eq, "$talk_context", 14),
      (gt, "$g_main_attacker_agent", 0),
      (main_hero_fallen),
    ],
    [
      (jump_to_menu, "mnu_lost_tavern_duel"),
      (finish_mission, 0),
    ]),

    (1, 0, 0, 
    [
      (gt, "$g_main_attacker_agent", 0),
    ],
    [
      (agent_get_wielded_item, ":var0", "$g_main_attacker_agent", 0),
      (val_max, "$g_attacker_drawn_weapon", ":var0"),
      (call_script, "script_neutral_behavior_in_fight"),
    ]),

  ]),

  ("conversation_encounter", 0, -1,
  "Conversation encounter",
  [
    (0, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (1, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (2, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (3, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (4, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (5, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (6, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (7, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (14, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (15, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (16, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_fullhelm|af_override_horse, 0, 1, []),
  ],
  [
  ]),

  ("town_center", 0, -1,
  "Default town visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_scene_source, 0, 0, 1, []),
    (15, mtef_scene_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, 0, 
    [
      (call_script, "script_cf_move_ship", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (call_script, "script_cf_move_ship_d", 0),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (eq, "$fadefromblack", 1),
    ],
    [
      (start_presentation, "prsnt_fade_from_black", 0),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
      (try_begin),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (agent_get_troop_id, ":var1", ":var0"),
        (troop_slot_eq, ":var1", 155, 1),
        (agent_set_team, ":var0", 0),
        (1753, ":var0", 5),
        (troop_set_slot, ":var1", 155, 0),
        (try_begin),
          (troop_slot_eq, ":var1", 149, 3),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination, ":var0", pos1),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_main_attacker_agent", 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$g_mt_mode", 0),
        (store_current_scene, ":var0"),
        (scene_set_slot, ":var0", 0, 1),
      (try_end),
      (call_script, "script_init_town_walker_agents"),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", 16384),
      (else_try),
        (try_begin),
          (eq, "$current_town", "p_town_14"),
          (music_set_situation, mtf_sit_town),
          (play_track, "track_singal", 1),
        (else_try),
          (call_script, "script_music_set_situation_with_culture", 8192),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (try_begin),
        (store_current_scene, ":var0"),
        (this_or_next|eq, "$g_mt_mode", 0),
        (eq, ":var0", "scn_salt_mine"),
        (set_trigger_result, 1),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (display_message, "str_cant_use_inventory_disguised"),
      (else_try),
        (display_message, "str_cant_use_inventory_now"),
      (try_end),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (store_current_scene, ":var0"),
        (eq, ":var0", "scn_salt_mine"),
        (set_trigger_result, 1),
      (else_try),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (this_or_next|eq, "$g_mt_mode", 0),
        (eq, "$g_mt_mode", 1),
        (mission_enable_talk),
        (set_trigger_result, 1),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (try_begin),
        (eq, "$g_defending_against_siege", 0),
        (assign, "$g_leave_town", 1),
      (try_end),
    ],
    [
      (try_begin),
        (eq, "$talk_context", 19),
        (call_script, "script_deduct_casualties_from_garrison"),
        (jump_to_menu, "mnu_sneak_into_town_caught_dispersed_guards"),
      (try_end),
      (mission_enable_talk),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (party_slot_eq, "$current_town", 0, 3),
      (call_script, "script_town_init_doors", 0),
      (try_begin),
        (eq, "$town_nighttime", 0),
        (play_sound, "snd_town_ambiance"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (call_script, "script_tick_town_walkers"),
    ],
    []),

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds"),
    ],
    []),

    (1, 0, 0, 
    [
      (this_or_next|eq, "$talk_context", 18),
      (eq, "$talk_context", 19),
    ],
    [
      (call_script, "script_neutral_behavior_in_fight"),
      (mission_disable_talk),
    ]),

    (1, 0, ti_once, 
    [
      (eq, "$talk_context", 19),
    ],
    [
      (get_player_agent_no, ":var0"),
      (assign, reg6, ":var0"),
      (call_script, "script_activate_town_guard"),
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos4, ":var0"),
      (try_for_range, ":var1", "trp_npc_adonja", "trp_heroes_end"),
        (troop_slot_ge, ":var1", 149, 2),
        (str_store_troop_name, s4, ":var1"),
        (display_message, "str_s4_joins_prison_break"),
        (store_current_scene, ":var2"),
        (modify_visitors_at_site, ":var2"),
        (store_current_scene, ":var2"),
        (modify_visitors_at_site, ":var2"),
        (add_visitors_to_current_scene, 24, ":var1", 1, 0, 0),
        (troop_set_slot, ":var1", 155, 1),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$talk_context", 18),
        (eq, "$talk_context", 19),
        (call_script, "script_deduct_casualties_from_garrison"),
        (jump_to_menu, "mnu_captivity_start_castle_defeat"),
        (assign, ":var0", "trp_heroes_end"),
        (try_for_range, ":var1", "trp_npc_adonja", ":var0"),
          (troop_set_slot, ":var1", 149, 0),
        (try_end),
        (mission_enable_talk),
        (finish_mission, 0),
      (else_try),
        (set_trigger_result, 1),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$talk_context", 19),
      (neg|main_hero_fallen, 0),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (all_enemies_defeated),
    ],
    [
      (call_script, "script_deduct_casualties_from_garrison"),
      (try_for_agents, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (troop_slot_ge, ":var1", 149, 2),
        (try_begin),
          (agent_is_alive, ":var0"),
          (troop_set_slot, ":var1", 149, 4),
        (else_try),
          (troop_set_slot, ":var1", 149, 5),
        (try_end),
      (try_end),
      (jump_to_menu, "mnu_sneak_into_town_caught_ran_away"),
      (mission_enable_talk),
      (finish_mission, 0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (try_begin),
        (this_or_next|eq, ":var2", "trp_sarleon_prison_guard"),
        (this_or_next|eq, ":var2", "trp_rav_prison_guard"),
        (this_or_next|eq, ":var2", "trp_dshar_prison_guard"),
        (this_or_next|eq, ":var2", "trp_fierd_prison_guard"),
        (eq, ":var2", "trp_empire_prison_guard"),
        (eq, ":var3", "trp_player"),
        (display_message, "@You've got the keys to the dungeon."),
      (try_end),
    ]),

  ]),

  ("village_center", 0, -1,
  "village center",
  [
    (0, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_visitor_source, 0, 0, 1, []),
    (15, mtef_visitor_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_visitor_source, af_override_horse, 0, 1, []),
    (41, mtef_visitor_source, af_override_horse, 0, 1, []),
    (42, mtef_visitor_source, af_override_horse, 0, 1, []),
    (43, mtef_visitor_source, af_override_horse, 0, 1, []),
    (44, mtef_visitor_source, af_override_horse, 0, 1, []),
    (45, mtef_visitor_source, af_override_horse, 0, 1, []),
    (46, mtef_visitor_source, af_override_horse, 0, 1, []),
    (47, mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [
      (eq, "$fadefromblack", 1),
    ],
    [
      (start_presentation, "prsnt_fade_from_black", 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (store_current_scene, ":var0"),
      (scene_set_slot, ":var0", 0, 1),
      (call_script, "script_init_town_walker_agents"),
      (call_script, "script_music_set_situation_with_culture", 67108864),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (neg|check_quest_succeeded, "qst_hunt_down_fugitive"),
        (neg|check_quest_failed, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 11, 1),
        (try_begin),
          (call_script, "script_cf_troop_agent_is_alive", "trp_fugitive"),
          (call_script, "script_fail_quest", "qst_hunt_down_fugitive"),
        (else_try),
          (call_script, "script_succeed_quest", "qst_hunt_down_fugitive"),
        (try_end),
      (try_end),
      (set_trigger_result, 1),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (try_begin),
        (assign, "$g_leave_town", 1),
      (try_end),
    ],
    []),

    (3, 0, 0, 
    [
      (call_script, "script_tick_town_walkers"),
    ],
    []),

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds"),
    ],
    []),

    (1, 0, ti_once, 
    [
      (check_quest_active, "qst_hunt_down_fugitive"),
      (neg|check_quest_succeeded, "qst_hunt_down_fugitive"),
      (neg|check_quest_failed, "qst_hunt_down_fugitive"),
      (quest_slot_eq, "qst_hunt_down_fugitive", 11, 1),
      (assign, ":var0", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "trp_fugitive"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
        (call_script, "script_fail_quest", "qst_hunt_down_fugitive"),
        (finish_mission, 4),
      (else_try),
        (call_script, "script_change_player_relation_with_center", "$current_town", -2),
        (call_script, "script_succeed_quest", "qst_hunt_down_fugitive"),
      (try_end),
    ]),

  ]),

  ("bandits_at_night", 0, -1,
  "Default town visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, aif_start_alarmed, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (8, mtef_scene_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_scene_source, 0, 0, 1, []),
    (14, mtef_scene_source, 0, 0, 1, []),
    (15, mtef_scene_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (agent_set_team, ":var0", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (try_begin),
        (eq, "$g_defending_against_siege", 0),
        (assign, "$g_leave_town", 1),
      (try_end),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 4096),
      (set_party_battle_mode),
      (party_slot_eq, "$current_town", 0, 3),
      (call_script, "script_town_init_doors", 0),
    ]),

    (1, 4, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_town_bandits_failed"),
      (else_try),
        (jump_to_menu, "mnu_town_bandits_succeeded"),
      (try_end),
      (finish_mission),
    ]),

  ]),

  ("village_training", mtf_arena_fight, -1,
  "village training",
  [
    (2, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_practice_boots]),
    (4, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_practice_boots]),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_train_peasants_against_bandits_training_succeeded", 0),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_give_up_fight"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_train_peasants_against_bandits_training_succeeded", 1),
      (try_end),
      (finish_mission),
    ]),

  ]),

  ("visit_town_castle", 0, -1,
  "You enter the halls of the lord.",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_scene_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_visitor_source, 0, 0, 1, []),
    (15, mtef_visitor_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (35, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (36, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (37, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (38, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (39, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (40, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (41, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (42, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (43, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (44, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (45, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (46, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (47, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (48, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (49, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (50, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
      (try_begin),
        (eq, "$pop_teleport_player_to_pos59", 1),
        (neg|1707, ":var0"),
        (agent_set_position, ":var0", pos59),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (eq, "$pop_teleport_player_to_pos59", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (is_between, ":var1", "trp_town_1_seneschal", "trp_town_1_arena_master"),
        (assign, ":var2", ":var1"),
      (try_end),
      (start_mission_conversation, ":var2"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (neq, "$talk_context", 18),
      (set_trigger_result, 1),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (eq, "$talk_context", 18),
    ],
    [
      (display_message, "str_leaving_area_during_prison_break"),
      (set_jump_mission, "mt_sneak_caught_fight"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$talk_context", 1),
        (try_begin),
          (store_faction_of_party, ":var0", "$current_town"),
          (faction_slot_eq, ":var0", 4, 6),
          (faction_slot_eq, ":var0", 5, "$current_town"),
          (call_script, "script_music_set_situation_with_culture", 16777216),
        (else_try),
          (try_begin),
            (eq, "$current_town", "p_castle_noldor"),
            (music_set_situation, 0),
            (play_track, "track_lords_hall_noldor", 1),
          (else_try),
            (call_script, "script_music_set_situation_with_culture", 33554432),
          (try_end),
        (try_end),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 0),
      (try_end),
    ]),

  ]),

  ("visit_castle_castle", 0, -1,
  "You enter the halls of the lord.",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_scene_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_visitor_source, 0, 0, 1, []),
    (15, mtef_visitor_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
      (try_begin),
        (eq, "$pop_teleport_player_to_pos59", 1),
        (neg|1707, ":var0"),
        (agent_set_position, ":var0", pos59),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (eq, "$pop_teleport_player_to_pos59", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (is_between, ":var1", "trp_town_1_seneschal", "trp_town_1_arena_master"),
        (assign, ":var2", ":var1"),
      (try_end),
      (start_mission_conversation, ":var2"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (neq, "$talk_context", 18),
      (set_trigger_result, 1),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (eq, "$talk_context", 18),
    ],
    [
      (display_message, "str_leaving_area_during_prison_break"),
      (set_jump_mission, "mt_sneak_caught_fight"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$talk_context", 1),
        (try_begin),
          (store_faction_of_party, ":var0", "$current_town"),
          (faction_slot_eq, ":var0", 4, 6),
          (faction_slot_eq, ":var0", 5, "$current_town"),
          (call_script, "script_music_set_situation_with_culture", 16777216),
        (else_try),
          (try_begin),
            (eq, "$current_town", "p_castle_noldor"),
            (music_set_situation, 0),
            (play_track, "track_lords_hall_noldor", 1),
          (else_try),
            (call_script, "script_music_set_situation_with_culture", 33554432),
          (try_end),
        (try_end),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 0),
      (try_end),
    ]),

  ]),

  ("visit_town_castle_ghostlady", 0, -1,
  "You enter the halls of the lord.",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse|af_override_head, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_scene_source, af_override_horse, 0, 1, []),
    (11, mtef_scene_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_visitor_source, 0, 0, 1, []),
    (15, mtef_visitor_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_before_mission_start, 0, 0, 
    [
      (eq, "$fadefromblack", 1),
    ],
    [
      (start_presentation, "prsnt_fade_from_black", 0),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (neq, "$talk_context", 18),
      (try_begin),
        (check_quest_active, "qst_ghost_lady"),
        (neg|check_quest_succeeded, "qst_ghost_lady"),
        (neg|check_quest_failed, "qst_ghost_lady"),
        (quest_slot_eq, "qst_ghost_lady", 11, 4),
        (try_begin),
          (call_script, "script_cf_troop_agent_is_alive", "trp_ghost_quest_castle_scribe"),
          (quest_set_slot, "qst_ghost_lady", 11, 5),
          (str_store_string, s60, "@You have escaped from the fight with the scribe, talk to the Ghost Lady again."),
          (add_quest_note_from_sreg, "qst_ghost_lady", 0, s60, 0),
        (else_try),
          (quest_set_slot, "qst_ghost_lady", 11, 6),
        (try_end),
      (try_end),
      (set_trigger_result, 1),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (eq, "$talk_context", 18),
    ],
    [
      (display_message, "str_leaving_area_during_prison_break"),
      (set_jump_mission, "mt_sneak_caught_fight"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$talk_context", 1),
        (try_begin),
          (store_faction_of_party, ":var0", "$current_town"),
          (faction_slot_eq, ":var0", 4, 6),
          (faction_slot_eq, ":var0", 5, "$current_town"),
          (call_script, "script_music_set_situation_with_culture", 16777216),
        (else_try),
          (try_begin),
            (eq, "$current_town", "p_castle_noldor"),
            (music_set_situation, 0),
            (play_track, "track_lords_hall_noldor", 1),
          (else_try),
            (call_script, "script_music_set_situation_with_culture", 33554432),
          (try_end),
        (try_end),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 0),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [
      (check_quest_active, "qst_ghost_lady"),
      (neg|check_quest_succeeded, "qst_ghost_lady"),
      (neg|check_quest_failed, "qst_ghost_lady"),
      (quest_slot_eq, "qst_ghost_lady", 11, 4),
      (assign, ":var0", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "trp_ghost_quest_castle_scribe"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_ghostlady_knocked_out"),
        (quest_set_slot, "qst_ghost_lady", 11, 5),
        (str_store_string, s60, "@You have been knocked out by the scribe, talk to the Ghost Lady again."),
        (add_quest_note_from_sreg, "qst_ghost_lady", 0, s60, 0),
        (str_clear, s60),
        (add_quest_note_from_sreg, "qst_ghost_lady", 1, s60, 0),
        (add_quest_note_from_sreg, "qst_ghost_lady", 2, s60, 0),
        (add_quest_note_from_sreg, "qst_ghost_lady", 3, s60, 0),
        (finish_mission, 4),
      (else_try),
        (quest_set_slot, "qst_ghost_lady", 11, 6),
      (try_end),
    ]),

  ]),

  ("grandmaster_ambush", mtf_battle_mode, -1,
  "Grandmaster quest starts here...",
  [
    (0, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (6, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (7, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (neq, "$g_battle_won", 1),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (finish_mission, 0),
        (jump_to_menu, "mnu_grandmaster_ambush_won"),
      (try_end),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (call_script, "script_music_set_situation_with_culture", 4096),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
    ],
    [
      (jump_to_menu, "mnu_grandmaster_ambush_won"),
      (finish_mission, 1),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have been knocked out!"),
      (set_mission_result, -1),
      (finish_mission, 0),
      (jump_to_menu, "mnu_grandmaster_ambush_lost"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

  ]),

  ("back_alley_kill_local_merchant", mtf_battle_mode, -1,
  "You enter the back alley",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 4096),
    ]),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 1),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (assign, ":var1", 0),
      (assign, ":var3", -1),
      (assign, ":var4", -1),
      (try_for_agents, ":var5"),
        (agent_get_troop_id, ":var6", ":var5"),
        (try_begin),
          (eq, ":var6", "trp_local_merchant"),
          (store_agent_hit_points, ":var1", ":var5"),
          (assign, ":var3", ":var5"),
        (else_try),
          (eq, ":var6", "trp_player"),
          (store_agent_hit_points, ":var2", ":var5"),
          (assign, ":var4", ":var5"),
        (try_end),
      (try_end),
      (ge, ":var4", 0),
      (ge, ":var3", 0),
      (agent_is_alive, ":var4"),
      (agent_is_alive, ":var3"),
      (is_between, ":var1", 1, 30),
      (gt, ":var2", 50),
      (start_mission_conversation, "trp_local_merchant"),
    ],
    []),

    (1, 4, ti_once, 
    [
      (assign, ":var0", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "trp_local_merchant"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (call_script, "script_fail_quest", "qst_kill_local_merchant"),
      (else_try),
        (call_script, "script_change_player_relation_with_center", "$current_town", -4),
        (call_script, "script_succeed_quest", "qst_kill_local_merchant"),
      (try_end),
      (finish_mission),
    ]),

  ]),

  ("back_alley_revolt", mtf_battle_mode, charge,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_use_exact_number, af_override_weapons|af_override_horse|af_override_head, aif_start_alarmed, 4, [itm_quarter_staff]),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_do_you_want_to_retreat"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (jump_to_menu, "mnu_collect_taxes_failed"),
      (finish_mission),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 1024),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_collect_taxes_failed"),
      (else_try),
        (jump_to_menu, "mnu_collect_taxes_rebels_killed"),
      (try_end),
      (finish_mission),
    ]),

  ]),

  ("lead_charge", mtf_battle_mode|mtf_synch_inventory, charge,
  "You lead your men to battle.",
  [
    (1, mtef_team_0|mtef_defenders, 0, aif_start_alarmed, 40, []),
    (0, mtef_team_0|mtef_defenders, 0, aif_start_alarmed, 0, []),
    (4, mtef_team_1|mtef_attackers, 0, aif_start_alarmed, 40, []),
    (4, mtef_team_1|mtef_attackers, 0, aif_start_alarmed, 0, []),
  ],
  [
    (0, 0, 0, 
    [
      (key_clicked, key_o),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_wielded_item, ":var1", ":var0", 0),
      (item_get_type, ":var2", ":var1"),
      (this_or_next|eq, ":var2", 8),
      (eq, ":var2", 9),
      (agent_get_position, pos5, ":var0"),
      (assign, ":var3", -1),
      (try_for_agents, ":var4"),
        (neq, ":var4", ":var0"),
        (agent_is_alive, ":var4"),
        (agent_is_human, ":var4"),
        (agent_get_party_id, ":var5", ":var4"),
        (eq, ":var5", "p_main_party"),
        (agent_get_wielded_item, ":var6", ":var4", 0),
        (gt, ":var6", 0),
        (item_get_type, ":var7", ":var6"),
        (eq, ":var7", ":var2"),
        (try_begin),
          (eq, ":var3", -1),
          (assign, ":var3", ":var4"),
          (agent_get_position, pos1, ":var4"),
          (get_distance_between_positions, ":var8", pos1, pos5),
        (else_try),
          (agent_get_position, pos2, ":var4"),
          (get_distance_between_positions, ":var9", pos2, pos5),
          (lt, ":var9", ":var8"),
          (assign, ":var3", ":var4"),
          (assign, ":var8", ":var9"),
        (try_end),
      (try_end),
      (gt, ":var3", -1),
      (lt, ":var8", 100),
      (try_begin),
        (eq, ":var2", 8),
        (assign, ":var10", 5),
      (else_try),
        (assign, ":var10", 6),
      (try_end),
      (assign, ":var11", 0),
      (try_for_range, ":var12", 0, 4),
        (1804, ":var13", ":var0", ":var12"),
        (ge, ":var13", 1),
        (item_get_type, ":var14", ":var13"),
        (eq, ":var14", ":var10"),
        (2710, ":var15", ":var13"),
        (1977, ":var16", ":var0", ":var12"),
        (store_sub, ":var17", ":var15", ":var16"),
        (val_add, ":var11", ":var17"),
      (try_end),
      (assign, ":var18", 0),
      (try_for_range, ":var12", 0, 4),
        (1804, ":var13", ":var3", ":var12"),
        (ge, ":var13", 1),
        (item_get_type, ":var14", ":var13"),
        (eq, ":var14", ":var10"),
        (1977, ":var16", ":var3", ":var12"),
        (val_add, ":var18", ":var16"),
      (try_end),
      (try_begin),
        (ge, ":var11", ":var18"),
        (try_for_range, ":var12", 0, 4),
          (1804, ":var13", ":var3", ":var12"),
          (ge, ":var13", 1),
          (item_get_type, ":var14", ":var13"),
          (try_begin),
            (eq, ":var14", ":var10"),
            (1776, ":var3", ":var13", 0),
          (else_try),
            (eq, ":var14", ":var2"),
            (1774, ":var3", ":var13", ":var12"),
          (try_end),
        (try_end),
        (try_for_range, ":var12", 0, 4),
          (1804, ":var13", ":var0", ":var12"),
          (ge, ":var13", 1),
          (item_get_type, ":var14", ":var13"),
          (eq, ":var14", ":var10"),
          (2710, ":var15", ":var13"),
          (1977, ":var16", ":var0", ":var12"),
          (store_sub, ":var17", ":var15", ":var16"),
          (try_begin),
            (ge, ":var18", ":var17"),
            (1776, ":var0", ":var13", ":var15"),
            (val_sub, ":var18", ":var17"),
          (else_try),
            (val_add, ":var16", ":var18"),
            (1776, ":var0", ":var13", ":var16"),
          (try_end),
        (try_end),
      (else_try),
        (try_for_range, ":var12", 0, 4),
          (1804, ":var13", ":var0", ":var12"),
          (ge, ":var13", 1),
          (item_get_type, ":var14", ":var13"),
          (eq, ":var14", ":var10"),
          (2710, ":var15", ":var13"),
          (1977, ":var16", ":var0", ":var12"),
          (store_sub, ":var17", ":var15", ":var16"),
          (1776, ":var0", ":var13", ":var15"),
        (try_end),
        (try_for_range, ":var12", 0, 4),
          (1804, ":var13", ":var3", ":var12"),
          (ge, ":var13", 1),
          (item_get_type, ":var14", ":var13"),
          (eq, ":var14", ":var10"),
          (1977, ":var16", ":var3", ":var12"),
          (try_begin),
            (ge, ":var11", ":var16"),
            (1776, ":var3", ":var13", 0),
            (val_sub, ":var11", ":var16"),
          (else_try),
            (val_sub, ":var16", ":var11"),
            (1776, ":var3", ":var13", ":var16"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_put_stay_back_companions_end_of_party"),
    ]),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (gt, "$horse_archer_ai_state", 0),
    ],
    [
      (set_fixed_point_multiplier, 1000),
      (try_for_agents, ":var0"),
        (1707, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (neg|agent_slot_eq, ":var0", 1003, 1),
        (agent_get_troop_id, ":var1", ":var0"),
        (assign, ":var2", 1),
        (try_begin),
          (eq, "$horse_archer_ai_state", 1),
          (neg|is_between, ":var1", "trp_npc_adonja", "trp_knight_1_1_wife"),
          (neg|is_between, ":var1", "trp_hero_burilgi", "trp_omen_seeker"),
          (neg|is_between, ":var1", "trp_merc_leader_mettenheim", "trp_andy"),
          (neq, ":var1", "trp_seeress"),
          (assign, ":var2", 0),
        (try_end),
        (eq, ":var2", 1),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (neg|agent_slot_eq, ":var0", 15, 1),
          (gt, ":var3", -1),
          (agent_get_team, ":var4", ":var0"),
          (gt, ":var4", -1),
          (1773, ":var5", ":var0"),
          (gt, ":var5", -1),
          (agent_get_combat_state, ":var6", ":var0"),
          (team_get_weapon_usage_order, ":var7", ":var4", ":var5"),
          (team_get_hold_fire_order, ":var8", ":var4", ":var5"),
          (agent_get_ammo, ":var9", ":var0", 0),
          (assign, ":var10", 0),
          (assign, ":var11", -1),
          (assign, ":var12", -1),
          (try_begin),
            (try_for_range, ":var13", 0, 4),
              (1804, ":var14", ":var0", ":var13"),
              (gt, ":var14", 0),
              (item_get_type, ":var15", ":var14"),
              (try_begin),
                (eq, ":var15", 10),
                (1825, ":var16", ":var0", ":var13"),
                (val_add, ":var10", ":var16"),
              (try_end),
              (try_begin),
                (eq, ":var11", -1),
                (this_or_next|eq, ":var15", 8),
                (this_or_next|eq, ":var15", 10),
                (this_or_next|eq, ":var15", 16),
                (eq, ":var15", 17),
                (assign, ":var11", ":var14"),
                (assign, ":var12", ":var15"),
              (try_end),
            (try_end),
          (try_end),
          (gt, ":var12", -1),
          (neg|2723, ":var11", 1048576),
          (assign, ":var17", 1),
          (try_begin),
            (store_sub, ":var18", ":var9", ":var10"),
            (eq, ":var18", 0),
            (agent_set_speed_limit, ":var0", 1000),
            (assign, ":var17", 0),
          (try_end),
          (eq, ":var17", 1),
          (gt, ":var9", 0),
          (agent_set_slot, ":var0", 1003, 2),
          (neq, ":var8", 1),
          (neq, ":var7", 2),
          (neq, ":var7", 1),
          (agent_get_wielded_item, ":var19", ":var0", 0),
          (gt, ":var19", 0),
          (item_get_type, ":var20", ":var19"),
          (try_begin),
            (2080, ":var21", ":var0"),
            (gt, ":var21", -1),
            (agent_is_human, ":var21"),
            (agent_is_alive, ":var21"),
            (agent_get_team, ":var22", ":var21"),
            (gt, ":var22", -1),
            (neg|teams_are_enemies, ":var4", ":var22"),
            (1713, ":var0", -1),
            (1732, ":var0"),
          (try_end),
          (assign, ":var23", 1000),
          (agent_get_position, pos20, ":var0"),
          (position_move_z, pos20, 250, 1),
          (assign, ":var24", 100000),
          (assign, ":var25", -1),
          (team_get_movement_order, ":var26", ":var4", ":var5"),
          (eq, ":var26", 2),
          (try_for_agents, ":var27"),
            (agent_is_alive, ":var27"),
            (agent_is_human, ":var27"),
            (agent_get_position, pos15, ":var27"),
            (agent_get_team, ":var28", ":var27"),
            (gt, ":var28", -1),
            (teams_are_enemies, ":var4", ":var28"),
            (get_distance_between_positions, ":var29", pos20, pos15),
            (try_begin),
              (agent_slot_eq, ":var27", 15, 1),
              (val_add, ":var29", 10000),
            (try_end),
            (assign, ":var30", 0),
            (try_begin),
              (agent_get_horse, ":var31", ":var27"),
              (gt, ":var31", -1),
              (store_div, ":var30", ":var29", 3),
              (val_mul, ":var30", 2),
              (val_min, ":var30", 2000),
              (val_sub, ":var29", ":var30"),
              (assign, ":var32", ":var30"),
            (try_end),
            (lt, ":var29", ":var24"),
            (assign, ":var24", ":var29"),
            (assign, ":var25", ":var27"),
          (try_end),
          (neq, ":var25", -1),
          (agent_get_position, pos23, ":var25"),
          (try_begin),
            (agent_get_horse, ":var33", ":var25"),
            (gt, ":var33", -1),
            (store_add, ":var34", ":var32", ":var24"),
            (position_move_z, pos23, 250, 1),
          (else_try),
            (assign, ":var34", ":var24"),
            (position_move_z, pos23, 140, 1),
          (try_end),
          (try_begin),
            (agent_slot_eq, ":var25", 15, 1),
            (val_sub, ":var34", 10000),
          (else_try),
            (gt, ":var34", 300),
            (1747, ":var0", ":var11"),
          (try_end),
          (try_begin),
            (this_or_next|eq, ":var20", 8),
            (this_or_next|eq, ":var20", 16),
            (eq, ":var20", 17),
            (1763, ":var35", ":var0"),
            (707, 20, 23),
            (1713, ":var0", ":var25"),
            (try_begin),
              (eq, ":var35", 1),
              (try_begin),
                (eq, ":var26", 2),
                (1689, 8, ":var0"),
                (position_get_y, ":var36", pos8),
                (try_begin),
                  (gt, ":var24", 700),
                  (lt, ":var24", 6000),
                  (store_div, ":var23", ":var36", 300),
                  (store_sub, ":var37", ":var24", 2500),
                  (val_div, ":var37", 20),
                  (val_max, ":var23", ":var37"),
                  (val_max, ":var23", 1),
                (try_end),
              (try_end),
              (eq, ":var20", 8),
              (lt, ":var34", 4000),
              (1745, ":var0", 3, 0),
            (else_try),
              (eq, ":var20", 8),
              (lt, ":var34", 4000),
              (neq, ":var6", 8),
              (1745, ":var0", 3, 1),
            (try_end),
          (try_end),
          (agent_set_speed_limit, ":var0", ":var23"),
          (try_begin),
            (1707, ":var0"),
            (neq, ":var12", 10),
            (gt, ":var25", -1),
            (try_begin),
              (eq, ":var26", 2),
              (this_or_next|agent_slot_eq, ":var25", 15, 1),
              (lt, ":var24", 10000),
              (try_begin),
                (get_scene_boundaries, pos9, pos10),
                (position_get_x, ":var38", pos9),
                (position_get_y, ":var39", pos9),
                (position_get_x, ":var40", pos10),
                (position_get_y, ":var41", pos10),
                (position_get_x, ":var42", pos20),
                (position_get_y, ":var43", pos20),
                (position_copy_origin, pos19, pos9),
                (store_sub, ":var44", ":var42", ":var38"),
                (store_sub, ":var45", ":var43", ":var39"),
                (store_sub, ":var46", ":var40", ":var42"),
                (store_sub, ":var47", ":var41", ":var43"),
                (val_abs, ":var44"),
                (val_abs, ":var45"),
                (val_abs, ":var46"),
                (val_abs, ":var47"),
                (store_sub, ":var48", ":var40", ":var38"),
                (store_sub, ":var49", ":var41", ":var39"),
                (val_div, ":var48", 20),
                (val_div, ":var49", 20),
                (position_move_x, pos19, ":var48", 1),
                (position_move_y, pos19, ":var49", 1),
                (get_distance_between_positions, ":var50", pos19, pos20),
                (717, 19, 20, 19),
                (717, 11, 20, 23),
                (position_get_x, ":var48", pos19),
                (position_get_y, ":var49", pos19),
                (position_get_x, ":var51", pos11),
                (position_get_y, ":var52", pos11),
                (assign, ":var53", 0),
                (try_begin),
                  (le, ":var24", 1000),
                  (store_sub, ":var53", ":var24", 1500),
                  (val_mul, ":var53", 60),
                  (val_max, ":var53", -80000),
                  (assign, ":var53", -80000),
                (else_try),
                  (gt, ":var24", 2500),
                  (store_sub, ":var53", ":var24", 0),
                  (val_mul, ":var53", 5),
                  (val_clamp, ":var53", 35000, 90000),
                  (try_begin),
                    (gt, ":var33", -1),
                    (val_sub, ":var53", 20000),
                  (try_end),
                (try_end),
                (assign, ":var54", 30000),
                (val_min, ":var54", ":var44"),
                (val_min, ":var54", ":var45"),
                (val_min, ":var54", ":var46"),
                (val_min, ":var54", ":var47"),
                (try_begin),
                  (lt, ":var54", 30000),
                  (lt, ":var24", 1500),
                  (agent_slot_eq, ":var25", 15, 0),
                  (1732, ":var0"),
                  (val_mul, ":var48", 100),
                  (val_mul, ":var49", 100),
                  (val_mul, ":var51", 100),
                  (val_mul, ":var52", 100),
                  (store_div, ":var55", ":var48", ":var50"),
                  (store_div, ":var56", ":var49", ":var50"),
                  (store_div, ":var57", ":var51", ":var34"),
                  (store_div, ":var58", ":var52", ":var34"),
                  (2141, ":var59", ":var55"),
                  (2140, ":var60", ":var56"),
                  (2141, ":var61", ":var57"),
                  (2140, ":var62", ":var58"),
                  (try_begin),
                    (lt, ":var60", 0),
                    (val_mul, ":var59", -1),
                    (val_add, ":var59", 360000),
                  (try_end),
                  (try_begin),
                    (lt, ":var62", 0),
                    (val_mul, ":var61", -1),
                    (val_add, ":var61", 360000),
                  (try_end),
                  (store_sub, ":var63", ":var59", ":var61"),
                  (val_sub, ":var63", 270000),
                  (val_sub, ":var63", ":var53"),
                  (store_add, ":var53", ":var63", ":var53"),
                  (try_begin),
                    (lt, ":var59", ":var61"),
                    (val_add, ":var53", 360000),
                  (try_end),
                  (val_clamp, ":var53", -210000, 15000),
                  (1745, ":var0", 3, 1),
                (try_end),
                (store_cos, ":var64", ":var53"),
                (store_sin, ":var65", ":var53"),
                (store_mul, ":var66", ":var64", ":var52"),
                (store_mul, ":var67", ":var65", ":var51"),
                (store_mul, ":var68", ":var65", ":var52"),
                (store_mul, ":var69", ":var64", ":var51"),
                (store_add, ":var70", ":var66", ":var67"),
                (store_sub, ":var71", ":var68", ":var69"),
                (position_move_x, pos20, ":var70", 0),
                (position_move_y, pos20, ":var71", 0),
              (try_end),
              (agent_set_scripted_destination, ":var0", pos20, 1),
            (else_try),
              (agent_clear_scripted_mode, ":var0"),
              (1732, ":var0"),
            (try_end),
          (try_end),
        (else_try),
          (try_begin),
            (agent_slot_eq, ":var0", 1003, 0),
            (agent_set_slot, ":var0", 1003, 1),
          (else_try),
            (agent_slot_eq, ":var0", 1003, 2),
            (this_or_next|eq, ":var9", 0),
            (this_or_next|le, ":var3", 0),
            (this_or_next|eq, ":var8", 1),
            (this_or_next|eq, ":var7", 1),
            (this_or_next|is_between, ":var26", 0, 2),
            (eq, ":var7", 2),
            (1732, ":var0"),
            (agent_clear_scripted_mode, ":var0"),
            (agent_set_speed_limit, ":var0", 1000),
            (agent_set_slot, ":var0", 1003, 3),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (try_begin),
        (eq, ":var1", "trp_player_knight"),
        (troop_get_inventory_capacity, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (troop_get_inventory_slot, ":var4", "trp_player_knight", ":var3"),
          (gt, ":var4", 0),
          (item_get_type, ":var5", ":var4"),
          (try_begin),
            (this_or_next|is_between, ":var5", 2, 11),
            (is_between, ":var5", 16, 19),
            (agent_has_item_equipped, ":var0", ":var4"),
            (1774, ":var0", ":var4"),
          (try_end),
        (try_end),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var7", "trp_player_knight_save", ":var6"),
          (try_begin),
            (gt, ":var7", 0),
            (store_add, ":var8", ":var6", 1),
            (1779, ":var0", ":var7", ":var8"),
          (try_end),
        (try_end),
      (else_try),
        (eq, ":var1", "trp_player_sergeant"),
        (troop_get_inventory_capacity, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (troop_get_inventory_slot, ":var4", "trp_player_sergeant", ":var3"),
          (gt, ":var4", 0),
          (item_get_type, ":var5", ":var4"),
          (try_begin),
            (this_or_next|is_between, ":var5", 2, 11),
            (is_between, ":var5", 16, 19),
            (agent_has_item_equipped, ":var0", ":var4"),
            (1774, ":var0", ":var4"),
          (try_end),
        (try_end),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var7", "trp_player_sergeant_save", ":var6"),
          (try_begin),
            (gt, ":var7", 0),
            (store_add, ":var8", ":var6", 1),
            (1779, ":var0", ":var7", ":var8"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_reassign_team", ":var0"),
      (assign, ":var1", 5000),
      (agent_get_troop_id, ":var2", ":var0"),
      (store_character_level, ":var3", ":var2"),
      (val_mul, ":var3", 70),
      (val_add, ":var1", ":var3"),
      (store_random_in_range, ":var4", 1000, 3000),
      (val_add, ":var1", ":var4"),
      (agent_get_party_id, ":var5", ":var0"),
      (party_get_morale, ":var6", ":var5"),
      (store_sub, ":var7", ":var6", 70),
      (val_mul, ":var7", 30),
      (val_add, ":var1", ":var7"),
      (agent_set_slot, ":var0", 16, ":var1"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 46, -1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (neg|agent_is_human, ":var0"),
        (agent_get_rider, ":var1", ":var0"),
        (ge, ":var1", 0),
        (1712, ":var1"),
        (agent_is_alive, ":var1"),
        (1707, ":var1"),
      (else_try),
        (assign, ":var1", -1),
      (try_end),
      (agent_set_slot, ":var0", 45, ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (neg|agent_is_human, ":var0"),
      (agent_get_slot, ":var1", ":var0", 45),
      (ge, ":var1", 0),
      (1712, ":var1"),
      (agent_is_alive, ":var1"),
      (1707, ":var1"),
      (1745, ":var1", -2, 1),
      (1746, ":var1", -2, 1),
      (agent_clear_scripted_mode, ":var1"),
      (1732, ":var1"),
      (1783, ":var1", 0),
      (agent_set_slot, ":var1", 46, 0),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (1712, ":var0"),
        (agent_slot_ge, ":var0", 46, 0),
        (agent_is_alive, ":var0"),
        (1773, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 46, ":var1"),
        (agent_get_slot, ":var2", ":var0", 46),
        (1783, ":var0", ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (2073, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
      (call_script, "script_apply_death_effect_on_courage_scores", ":var0", ":var1"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (assign, reg18, "$g_battle_won"),
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 1 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_empty_string"),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 2 - battle is won: {reg18}"),
        (try_end),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 3 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 4 - battle is won: {reg18}"),
        (try_end),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 5 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (display_message, "str_can_not_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 6 - battle is won: {reg18}"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (team_give_order, "$deathcam_player_team", 9, 2),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, 0),
      (this_or_next|game_key_is_down, 1),
      (this_or_next|game_key_is_down, 2),
      (this_or_next|game_key_is_down, 3),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, 0),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, 1),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, 3),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, 2),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, pos47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|903, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|903, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (738, 47, ":var7"),
        (position_rotate_y, pos47, 90),
        (738, 47, ":var3"),
        (position_rotate_y, pos47, -90),
        (738, 47, "$deathcam_total_rotx"),
        (738, 47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (gt, ":var1", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_place_player_banner_near_inventory_bms"),
      (party_clear, "p_routed_enemies"),
      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (call_script, "script_place_player_banner_near_inventory"),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 0, 5, 
    [
      (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
      (assign, ":var0", reg0),
      (assign, ":var1", 0),
      (try_for_agents, ":var2"),
        (agent_is_human, ":var2"),
        (agent_get_party_id, ":var3", ":var2"),
        (try_begin),
          (neq, ":var3", "p_main_party"),
          (neg|agent_is_ally, ":var2"),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var4", ":var0", ":var1"),
      (try_begin),
        (lt, ":var4", 100),
        (ge, "$defender_reinforcement_stage", 2),
        (eq, "$defender_reinforcement_limit_increased", 0),
        (assign, "$defender_reinforcement_limit_increased", 1),
      (try_end),
      (lt, "$defender_reinforcement_stage", "$g_defender_reinforcement_limit"),
      (store_mission_timer_a, ":var5"),
      (ge, ":var5", 5),
      (store_normalized_team_count, ":var6", 0),
      (lt, ":var6", 20),
    ],
    [
      (add_reinforcements_to_entry, 0, 20),
      (assign, "$defender_reinforcement_limit_increased", 0),
      (val_add, "$defender_reinforcement_stage", 1),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", "$g_attacker_reinforcement_limit"),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 20),
    ],
    [
      (add_reinforcements_to_entry, 3, 20),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have fallen in battle!"),
      (set_show_messages, 0),
      (team_give_order, "$fplayer_team_no", 9, 2),
      (try_begin),
        (eq, "$g_option_formations", 1),
        (eq, "$g_disciplined_faction", 1),
        (team_set_order_listener, "$fplayer_team_no", 9, -1),
        (call_script, "script_player_order_formations", 2),
      (try_end),
      (team_give_order, "$fplayer_team_no", 9, 13),
      (team_give_order, "$fplayer_team_no", 9, 10),
      (set_show_messages, 1),
      (display_message, "@Your troops are charging!"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$g_option_formations", 0),
        (eq, "$g_disciplined_faction", 0),
        (call_script, "script_select_battle_tactic"),
        (call_script, "script_battle_tactic_init"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (call_script, "script_apply_effect_of_other_people_on_courage_scores"),
    ],
    []),

    (3, 0, 0, 
    [
      (eq, "$g_option_routing", 0),
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (store_mission_timer_a, ":var1"),
        (ge, ":var1", 3),
        (call_script, "script_decide_run_away_or_not", ":var0", ":var1"),
      (try_end),
    ],
    []),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$g_option_formations", 0),
      (eq, "$g_disciplined_faction", 0),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 3),
      (call_script, "script_battle_tactic_apply"),
    ],
    []),

    (0, 0, 0, 
    [],
    [
      (try_begin),
        (this_or_next|key_is_down, key_left_control),
        (key_is_down, key_right_control),
        (try_begin),
          (key_clicked, key_h),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (else_try),
          (this_or_next|key_is_down, key_left_alt),
          (key_is_down, key_right_alt),
          (key_clicked, key_f4),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (try_end),
      (try_end),
      (game_key_clicked, 22),
      (neg|903, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (903, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (1, 0, ti_once, 
    [
      (neg|903, "prsnt_killcount"),
      (neg|903, "prsnt_troop_ratio_bar"),
      (neg|903, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 0),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_option_show_killcount", 0),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$g_option_ratio_bar_is_global", 1),
      (this_or_next|eq, "$g_option_message_on_player_kill", 1),
      (eq, "$g_option_message_on_soldier_death", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (2073, ":var2"),
      (agent_is_human, ":var0"),
      (try_begin),
        (ge, ":var0", 0),
        (try_begin),
          (neg|agent_is_ally, ":var0"),
          (val_sub, "$enemy_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (agent_get_party_id, ":var3", ":var0"),
          (eq, ":var3", "p_main_party"),
          (val_sub, "$player_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (neq, ":var3", "p_main_party"),
          (val_sub, "$ally_count_alive", 1),
        (try_end),
        (assign, reg1, "$enemy_count_alive"),
        (assign, reg2, "$player_count_alive"),
        (assign, reg3, "$ally_count_alive"),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_soldier_death", 1),
        (agent_is_ally, ":var0"),
        (agent_get_party_id, ":var3", ":var0"),
        (eq, ":var3", "p_main_party"),
        (neq, ":var2", 1),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (display_message, "@{s13} has died", 0xEC251A),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_player_kill", 1),
        (agent_get_troop_id, ":var5", ":var1"),
        (eq, ":var5", "trp_player"),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (try_begin),
          (neq, ":var2", 1),
          (display_message, "@You have killed {s13}", 0x33D0BC),
        (else_try),
          (display_message, "@You have knocked out {s13}", 0x33D0BC),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_set_disciplined_faction"),
      (try_begin),
        (eq, "$g_option_formations", 1),
        (assign, "$gk_order", 0),
        (assign, "$gk_order_hold_over_there", 0),
        (assign, "$autorotate_at_player", 1),
        (assign, "$infantry_formation_type", 1),
        (assign, "$archer_formation_type", 1),
        (assign, "$cavalry_formation_type", 4),
        (assign, "$infantry_space", 2),
        (assign, "$archer_space", 2),
        (assign, "$cavalry_space", 0),
        (assign, "$fclock", 1),
        (assign, "$yield", 0),
      (try_end),
    ]),

    (0.1, 0, ti_once, 
    [],
    [
      (assign, "$yield", 0),
      (call_script, "script_get_yield"),
      (val_add, "$yield", 50),
    ]),

    (0, 0.4, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$g_option_formations", 1),
        (get_player_agent_no, "$fplayer_agent_no"),
        (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
        (assign, ":var0", 0),
        (assign, ":var1", 0),
        (assign, ":var2", 0),
        (assign, ":var3", 0),
        (assign, "$team0_size", 0),
        (assign, "$team1_size", 0),
        (assign, "$team2_size", 0),
        (assign, "$team3_size", 0),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_get_team, ":var5", ":var4"),
          (agent_get_troop_id, ":var6", ":var4"),
          (store_troop_faction, ":var7", ":var6"),
          (try_begin),
            (eq, ":var5", 0),
            (val_add, ":var0", ":var7"),
            (val_add, "$team0_size", 1),
          (else_try),
            (eq, ":var5", 1),
            (val_add, ":var1", ":var7"),
            (val_add, "$team1_size", 1),
          (else_try),
            (eq, ":var5", 2),
            (val_add, ":var2", ":var7"),
            (val_add, "$team2_size", 1),
          (else_try),
            (eq, ":var5", 3),
            (val_add, ":var3", ":var7"),
            (val_add, "$team3_size", 1),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team0_size", 0),
          (team_get_leader, ":var8", 0),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team0_faction", ":var9"),
          (else_try),
            (store_mul, "$team0_faction", ":var0", 10),
            (val_div, "$team0_faction", "$team0_size"),
            (val_add, "$team0_faction", 5),
            (val_div, "$team0_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team1_size", 0),
          (team_get_leader, ":var8", 1),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team1_faction", ":var9"),
          (else_try),
            (store_mul, "$team1_faction", ":var1", 10),
            (val_div, "$team1_faction", "$team1_size"),
            (val_add, "$team1_faction", 5),
            (val_div, "$team1_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team2_size", 0),
          (team_get_leader, ":var8", 2),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team2_faction", ":var9"),
          (else_try),
            (store_mul, "$team2_faction", ":var2", 10),
            (val_div, "$team2_faction", "$team2_size"),
            (val_add, "$team2_faction", 5),
            (val_div, "$team2_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team3_size", 0),
          (team_get_leader, ":var8", 3),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team3_faction", ":var9"),
          (else_try),
            (store_mul, "$team3_faction", ":var3", 10),
            (val_div, "$team3_faction", "$team3_size"),
            (val_add, "$team3_faction", 5),
            (val_div, "$team3_faction", 10),
          (try_end),
        (try_end),
      (try_end),
      (call_script, "script_initial_battle_positions"),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_j),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_ranks_fem", 19),
        (else_try),
          (599, "snd_th3_formation_ranks", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 2),
      (call_script, "script_player_attempt_formation", 1, 2),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_k),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_shield_fem", 19),
        (else_try),
          (599, "snd_th3_formation_shield", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 3),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_l),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_wedge_fem", 19),
        (else_try),
          (599, "snd_th3_formation_wedge", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 4),
      (call_script, "script_player_attempt_formation", 2, 4),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_semicolon),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_square_fem", 19),
        (else_try),
          (599, "snd_th3_formation_square", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 5),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_u),
    ],
    [
      (call_script, "script_player_order_formations", 2),
    ]),

    (0, 0.3, 0, 
    [
      (eq, "$g_option_formations", 1),
      (game_key_clicked, 23),
    ],
    [
      (eq, "$gk_order", 23),
      (game_key_is_down, 23),
      (assign, "$gk_order_hold_over_there", 1),
      (assign, "$gk_order", 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 23),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 0),
        (assign, "$gk_order", 23),
      (else_try),
        (try_begin),
          (eq, "$gk_order", 23),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_hold_fem", 19),
            (else_try),
              (599, "snd_th3_order_hold", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 0),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 24),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_advance_fem", 19),
            (else_try),
              (599, "snd_th3_order_advance", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 5),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 25),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_holdfire_fem", 19),
            (else_try),
              (599, "snd_snouz_order_holdfire", 19),
            (try_end),
          (try_end),
          (assign, "$gk_order", 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (game_key_clicked, 24),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 0),
        (assign, "$gk_order", 24),
      (else_try),
        (try_begin),
          (eq, "$gk_order", 23),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_follow_fem", 19),
            (else_try),
              (599, "snd_th3_order_follow", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 1),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 24),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_fallback_fem", 19),
            (else_try),
              (599, "snd_th3_order_fallback", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 6),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 25),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_fireatwill_fem", 19),
            (else_try),
              (599, "snd_snouz_order_fireatwill", 19),
            (try_end),
          (try_end),
          (assign, "$gk_order", 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 25),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 0),
        (assign, "$gk_order", 25),
      (else_try),
        (try_begin),
          (eq, "$gk_order", 23),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_charge_fem", 19),
            (else_try),
              (599, "snd_th3_order_charge", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 2),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 24),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_spreadout_fem", 19),
            (else_try),
              (599, "snd_snouz_order_spreadout", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 8),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 25),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_bluntweapons_fem", 19),
            (else_try),
              (599, "snd_snouz_order_bluntweapons", 19),
            (try_end),
          (try_end),
          (assign, "$gk_order", 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (game_key_clicked, 26),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 23),
        (call_script, "script_player_order_formations", 11),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 24),
        (call_script, "script_player_order_formations", 7),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_standcloser_fem", 19),
          (else_try),
            (599, "snd_snouz_order_standcloser", 19),
          (try_end),
        (try_end),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 25),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_anyweapons_fem", 19),
          (else_try),
            (599, "snd_snouz_order_anyweapons", 19),
          (try_end),
        (try_end),
        (assign, "$gk_order", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 27),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 23),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_retreat_fem", 19),
          (else_try),
            (599, "snd_th3_order_retreat", 19),
          (try_end),
        (try_end),
        (call_script, "script_player_order_formations", 14),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 24),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_mount_fem", 19),
          (else_try),
            (599, "snd_snouz_order_mount", 19),
          (try_end),
        (try_end),
        (assign, "$gk_order", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 28),
    ],
    [
      (eq, "$gk_order", 24),
      (try_begin),
        (class_is_listening_order, "$fplayer_team_no", 2),
        (call_script, "script_formation_end", "$fplayer_team_no", 2),
      (try_end),
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_order_dismount_fem", 19),
        (else_try),
          (599, "snd_snouz_order_dismount", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_order_formations", 4),
      (assign, "$gk_order", 0),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_1),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_infantry_fem", 19),
        (else_try),
          (599, "snd_th3_address_infantry", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_2),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_archers_fem", 19),
        (else_try),
          (599, "snd_th3_address_archers", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_3),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_cavalry_fem", 19),
        (else_try),
          (599, "snd_th3_address_cavalry", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_0),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_everyone_fem", 19),
        (else_try),
          (599, "snd_th3_address_everyone", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (this_or_next|key_clicked, key_1),
      (this_or_next|key_clicked, key_2),
      (this_or_next|key_clicked, key_3),
      (this_or_next|key_clicked, key_4),
      (this_or_next|key_clicked, key_5),
      (this_or_next|key_clicked, key_6),
      (this_or_next|key_clicked, key_7),
      (this_or_next|key_clicked, key_8),
      (this_or_next|key_clicked, key_9),
      (this_or_next|key_clicked, key_0),
      (key_clicked, key_escape),
    ],
    [
      (assign, "$gk_order", 0),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (eq, "$gk_order_hold_over_there", 1),
      (neg|game_key_is_down, 23),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_order_hold_fem", 19),
        (else_try),
          (599, "snd_th3_order_hold", 19),
        (try_end),
      (try_end),
      (call_script, "script_team_get_average_position_of_enemies_augmented", 60, "$fplayer_team_no", 9),
      (assign, ":var3", 0),
      (try_for_range, reg36, 0, 9),
        (class_is_listening_order, "$fplayer_team_no", reg36),
        (val_add, ":var3", 1),
      (try_end),
      (agent_get_position, pos21, "$fplayer_agent_no"),
      (try_begin),
        (neq, "$infantry_formation_type", 0),
        (class_is_listening_order, "$fplayer_team_no", 0),
        (team_get_order_position, pos2, "$fplayer_team_no", 0),
        (call_script, "script_point_y_toward_position", 2, 60),
        (try_begin),
          (gt, ":var3", 1),
          (agent_set_position, "$fplayer_agent_no", pos2),
          (try_begin),
            (call_script, "script_cf_formation", "$fplayer_team_no", 0, "$infantry_space", "$infantry_formation_type"),
          (try_end),
        (else_try),
          (assign, ":var4", 0),
          (try_for_agents, reg36),
            (call_script, "script_cf_valid_formation_member", "$fplayer_team_no", 0, "$fplayer_agent_no", reg36),
            (val_add, ":var4", 1),
          (try_end),
          (call_script, "script_get_centering_amount", "$infantry_formation_type", ":var4", "$infantry_space"),
          (position_move_x, pos2, reg0),
          (copy_position, pos1, pos2),
          (call_script, "script_set_formation_position", "$fplayer_team_no", 0, 1),
          (call_script, "script_form_infantry", "$fplayer_team_no", "$fplayer_agent_no", "$infantry_space", "$infantry_formation_type"),
        (try_end),
        (assign, "$infantry_formation_move_order", 0),
      (try_end),
      (try_begin),
        (neq, "$cavalry_formation_type", 0),
        (class_is_listening_order, "$fplayer_team_no", 2),
        (team_get_order_position, pos2, "$fplayer_team_no", 2),
        (call_script, "script_point_y_toward_position", 2, 60),
        (try_begin),
          (gt, ":var3", 1),
          (agent_set_position, "$fplayer_agent_no", pos2),
          (try_begin),
            (call_script, "script_cf_formation", "$fplayer_team_no", 2, "$cavalry_space", "$cavalry_formation_type"),
          (try_end),
        (else_try),
          (copy_position, pos1, pos2),
          (call_script, "script_set_formation_position", "$fplayer_team_no", 2, 1),
          (call_script, "script_form_cavalry", "$fplayer_team_no", "$fplayer_agent_no", "$cavalry_space"),
        (try_end),
        (assign, "$cavalry_formation_move_order", 0),
      (try_end),
      (try_begin),
        (neq, "$archer_formation_type", 0),
        (class_is_listening_order, "$fplayer_team_no", 1),
        (team_get_order_position, pos2, "$fplayer_team_no", 1),
        (call_script, "script_point_y_toward_position", 2, 60),
        (try_begin),
          (gt, ":var3", 1),
          (agent_set_position, "$fplayer_agent_no", pos2),
          (try_begin),
            (call_script, "script_cf_formation", "$fplayer_team_no", 1, "$archer_space", "$archer_formation_type"),
          (try_end),
        (else_try),
          (assign, ":var4", 0),
          (try_for_agents, reg36),
            (call_script, "script_cf_valid_formation_member", "$fplayer_team_no", 1, "$fplayer_agent_no", reg36),
            (val_add, ":var4", 1),
          (try_end),
          (call_script, "script_get_centering_amount", 1, ":var4", "$archer_space"),
          (val_mul, reg0, -1),
          (position_move_x, pos2, reg0),
          (copy_position, pos1, pos2),
          (call_script, "script_set_formation_position", "$fplayer_team_no", 1, 1),
          (call_script, "script_form_archers", "$fplayer_team_no", "$fplayer_agent_no", "$archer_space", "$archer_formation_type"),
        (try_end),
        (assign, "$archer_formation_move_order", 0),
      (try_end),
      (agent_set_position, "$fplayer_agent_no", pos21),
      (assign, "$gk_order_hold_over_there", 0),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (neg|key_is_down, key_j),
      (neg|key_is_down, key_k),
      (neg|key_is_down, key_l),
      (neg|key_is_down, key_semicolon),
      (neg|key_is_down, key_u),
      (neg|game_key_is_down, 23),
      (neg|game_key_is_down, 24),
      (neg|game_key_is_down, 25),
      (neg|game_key_is_down, 26),
      (neg|game_key_is_down, 27),
      (neg|game_key_is_down, 28),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (store_mod, ":var0", "$fclock", 5),
      (call_script, "script_team_get_average_position_of_enemies_augmented", 60, "$fplayer_team_no", 9),
      (try_begin),
        (eq, reg0, 0),
        (neq, "$g_encountered_party", -1),
        (call_script, "script_formation_end", "$fplayer_team_no", 9),
      (else_try),
        (assign, "$autorotate_at_player", 0),
        (try_begin),
          (neq, "$infantry_formation_type", 0),
          (try_begin),
            (eq, "$infantry_formation_move_order", 1),
            (call_script, "script_cf_formation", "$fplayer_team_no", 0, "$infantry_space", "$infantry_formation_type"),
          (else_try),
            (eq, ":var0", 0),
            (call_script, "script_get_formation_position", 0, "$fplayer_team_no", 0),
            (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", "$fplayer_team_no", 0),
            (call_script, "script_point_y_toward_position", 1, 60),
            (position_copy_rotation, pos0, pos1),
            (call_script, "script_set_formation_position", "$fplayer_team_no", 0, 0),
            (copy_position, pos1, pos0),
            (call_script, "script_form_infantry", "$fplayer_team_no", "$fplayer_agent_no", "$infantry_space", "$infantry_formation_type"),
          (try_end),
        (try_end),
        (try_begin),
          (neq, "$cavalry_formation_type", 0),
          (try_begin),
            (eq, "$cavalry_formation_move_order", 1),
            (call_script, "script_cf_formation", "$fplayer_team_no", 2, "$cavalry_space", "$cavalry_formation_type"),
          (else_try),
            (eq, ":var0", 0),
            (call_script, "script_get_formation_position", 0, "$fplayer_team_no", 2),
            (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", "$fplayer_team_no", 2),
            (call_script, "script_point_y_toward_position", 1, 60),
            (position_copy_rotation, pos0, pos1),
            (call_script, "script_set_formation_position", "$fplayer_team_no", 2, 0),
            (copy_position, pos1, pos0),
            (call_script, "script_form_cavalry", "$fplayer_team_no", "$fplayer_agent_no", "$cavalry_space"),
          (try_end),
        (try_end),
        (try_begin),
          (neq, "$archer_formation_type", 0),
          (try_begin),
            (eq, "$archer_formation_move_order", 1),
            (call_script, "script_cf_formation", "$fplayer_team_no", 1, "$archer_space", "$archer_formation_type"),
          (else_try),
            (eq, ":var0", 0),
            (call_script, "script_get_formation_position", 0, "$fplayer_team_no", 1),
            (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", "$fplayer_team_no", 1),
            (call_script, "script_point_y_toward_position", 1, 60),
            (position_copy_rotation, pos0, pos1),
            (call_script, "script_set_formation_position", "$fplayer_team_no", 1, 0),
            (copy_position, pos1, pos0),
            (call_script, "script_form_archers", "$fplayer_team_no", "$fplayer_agent_no", "$archer_space", "$archer_formation_type"),
          (try_end),
        (try_end),
        (assign, "$autorotate_at_player", 1),
      (try_end),
      (val_add, "$fclock", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_option_formations", 1),
        (assign, "$cur_casualties", 0),
        (assign, "$prev_casualties", 0),
        (assign, "$prev_casualties2", 0),
        (assign, "$ranged_clock", 1),
        (assign, "$battle_phase", 1),
        (assign, "$clock_reset", 0),
        (assign, "$charge_activated", 0),
        (assign, "$charge_ongoing", 0),
        (assign, "$inf_charge_activated", 0),
        (assign, "$inf_charge_ongoing", 0),
        (assign, "$arc_charge_activated", 0),
        (assign, "$att_reinforcements_arrived", 0),
        (assign, "$def_reinforcements_arrived", 0),
        (assign, "$att_reinforcements_needed", 0),
        (assign, "$def_reinforcements_needed", 0),
        (assign, "$disengage", 0),
        (assign, "$patrol_mode", 0),
        (store_random_in_range, "$rand0", -1000, 1000),
        (store_random_in_range, "$rand2", 800, 1501),
        (store_random_in_range, "$rand1", 0, 501),
        (store_random_in_range, "$rand3", 2000, 3001),
        (store_random_in_range, "$rand4", 1000, 3001),
        (store_random_in_range, "$rand5", -1000, 0),
        (store_random_in_range, "$rand6", 4000, 5001),
        (store_random_in_range, "$rand7", 49, 56),
        (store_random_in_range, "$rand8", -100, 101),
        (assign, "$team0_default_formation", 1),
        (assign, "$team1_default_formation", 1),
        (assign, "$team2_default_formation", 1),
        (assign, "$team3_default_formation", 1),
        (init_position, pos56),
        (init_position, pos57),
        (init_position, pos58),
        (init_position, pos59),
        (assign, "$team0_reinforcement_stage", 0),
        (assign, "$team1_reinforcement_stage", 0),
        (init_position, pos17),
        (init_position, pos18),
      (try_end),
    ]),

    (0, 0.5, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$g_option_formations", 1),
        (eq, "$g_disciplined_faction", 1),
        (try_for_agents, ":var0"),
          (agent_set_slot, ":var0", 15, 0),
        (try_end),
        (set_fixed_point_multiplier, 100),
        (call_script, "script_store_battlegroup_data"),
        (call_script, "script_battlegroup_get_position", 12, 0, 9),
        (call_script, "script_battlegroup_get_position", 13, 1, 9),
        (call_script, "script_battlegroup_get_position", 14, 2, 9),
        (call_script, "script_battlegroup_get_position", 16, 3, 9),
        (call_script, "script_field_tactics", 1),
      (try_end),
    ]),

    (60, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (eq, "$g_disciplined_faction", 1),
    ],
    [
      (store_random_in_range, "$rand0", -1000, 1000),
      (store_random_in_range, "$rand2", 800, 1501),
      (store_random_in_range, "$rand1", -1000, 1000),
      (store_random_in_range, "$rand3", 2000, 3001),
      (store_random_in_range, "$rand4", 1000, 3001),
      (store_random_in_range, "$rand5", -1000, 0),
      (store_random_in_range, "$rand6", 4000, 5001),
      (store_random_in_range, "$rand7", 45, 56),
      (store_random_in_range, "$rand8", -100, 101),
    ]),

    (1, 0.9, 0, 
    [
      (eq, "$g_option_formations", 1),
      (eq, "$g_disciplined_faction", 1),
    ],
    [
      (try_begin),
        (assign, "$prev_casualties2", "$cur_casualties"),
        (call_script, "script_cf_count_casualties"),
        (assign, "$cur_casualties", reg0),
        (assign, "$battle_phase", 3),
      (try_end),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_store_battlegroup_data"),
      (try_begin),
        (eq, "$battle_phase", 3),
        (eq, "$clock_reset", 0),
        (call_script, "script_field_tactics", 1),
        (assign, "$ranged_clock", 0),
        (assign, "$clock_reset", 1),
      (else_try),
        (ge, "$battle_phase", 2),
        (store_mod, reg0, "$ranged_clock", 5),
        (eq, reg0, 0),
        (call_script, "script_field_tactics", 1),
        (assign, "$team0_reinforcement_stage", "$defender_reinforcement_stage"),
        (assign, "$team1_reinforcement_stage", "$attacker_reinforcement_stage"),
      (else_try),
        (call_script, "script_field_tactics", 0),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 1),
        (assign, ":var0", 0),
        (try_for_range, ":var1", 0, 4),
          (neq, ":var1", "$fplayer_team_no"),
          (call_script, "script_battlegroup_get_size", ":var1", 9),
          (gt, reg0, 0),
          (call_script, "script_battlegroup_get_position", 1, ":var1", 1),
          (team_get_order_position, pos0, ":var1", 1),
          (get_distance_between_positions, reg0, pos0, pos1),
          (gt, reg0, 500),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 0),
        (assign, "$battle_phase", 2),
      (try_end),
      (val_add, "$ranged_clock", 1),
    ]),

    (ti_on_order_issued, 0, 0, 
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (eq, ":var0", 9),
        (assign, "$dont_use_fist_enable", 1),
      (else_try),
        (this_or_next|eq, ":var0", 10),
        (this_or_next|eq, ":var0", 13),
        (this_or_next|eq, ":var0", 15),
        (this_or_next|eq, ":var0", 16),
        (this_or_next|eq, ":var0", 17),
        (this_or_next|eq, ":var0", 18),
        (this_or_next|eq, ":var0", 19),
        (this_or_next|eq, ":var0", 20),
        (eq, ":var0", 21),
        (assign, "$dont_use_fist_enable", 0),
      (try_end),
    ],
    []),

    (3, 3, 0, 
    [
      (eq, "$dont_use_fist_enable", 1),
      (set_show_messages, 0),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (le, ":var1", -1),
        (agent_get_team, ":var2", ":var0"),
        (1773, ":var3", ":var0"),
        (team_give_order, ":var2", ":var3", 10),
      (try_end),
      (set_show_messages, 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (assign, ":var1", 4),
        (try_for_range, ":var2", 0, ":var1"),
          (1804, ":var3", ":var0", ":var2"),
          (gt, ":var3", 0),
          (2721, ":var4", ":var3"),
          (eq, ":var4", 2),
          (1747, ":var0", ":var3"),
          (assign, ":var1", -1),
        (try_end),
      (try_end),
    ]),

  ]),

  ("village_attack_bandits", mtf_battle_mode|mtf_synch_inventory, charge,
  "You lead your men to battle.",
  [
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_use_exact_number, 0, aif_start_alarmed, 7, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_put_stay_back_companions_end_of_party"),
    ]),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (assign, reg18, "$g_battle_won"),
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 1 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_empty_string"),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 2 - battle is won: {reg18}"),
        (try_end),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 3 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 4 - battle is won: {reg18}"),
        (try_end),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 5 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (display_message, "str_can_not_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 6 - battle is won: {reg18}"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (team_give_order, "$deathcam_player_team", 9, 2),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, 0),
      (this_or_next|game_key_is_down, 1),
      (this_or_next|game_key_is_down, 2),
      (this_or_next|game_key_is_down, 3),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, 0),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, 1),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, 3),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, 2),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, pos47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|903, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|903, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (738, 47, ":var7"),
        (position_rotate_y, pos47, 90),
        (738, 47, ":var3"),
        (position_rotate_y, pos47, -90),
        (738, 47, "$deathcam_total_rotx"),
        (738, 47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20, 1),
      (assign, "$g_battle_result", -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (add_reinforcements_to_entry, 1, 6),
      (else_try),
        (add_reinforcements_to_entry, 1, 29),
      (try_end),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (display_message, "@You have fallen in battle!"),
      (team_give_order, "$fplayer_team_no", 9, 2),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, 0, 
    [],
    [
      (try_begin),
        (this_or_next|key_is_down, key_left_control),
        (key_is_down, key_right_control),
        (try_begin),
          (key_clicked, key_h),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (else_try),
          (this_or_next|key_is_down, key_left_alt),
          (key_is_down, key_right_alt),
          (key_clicked, key_f4),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (try_end),
      (try_end),
      (game_key_clicked, 22),
      (neg|903, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (903, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (1, 0, ti_once, 
    [
      (neg|903, "prsnt_killcount"),
      (neg|903, "prsnt_troop_ratio_bar"),
      (neg|903, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 0),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_option_show_killcount", 0),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$g_option_ratio_bar_is_global", 1),
      (this_or_next|eq, "$g_option_message_on_player_kill", 1),
      (eq, "$g_option_message_on_soldier_death", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (2073, ":var2"),
      (agent_is_human, ":var0"),
      (try_begin),
        (ge, ":var0", 0),
        (try_begin),
          (neg|agent_is_ally, ":var0"),
          (val_sub, "$enemy_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (agent_get_party_id, ":var3", ":var0"),
          (eq, ":var3", "p_main_party"),
          (val_sub, "$player_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (neq, ":var3", "p_main_party"),
          (val_sub, "$ally_count_alive", 1),
        (try_end),
        (assign, reg1, "$enemy_count_alive"),
        (assign, reg2, "$player_count_alive"),
        (assign, reg3, "$ally_count_alive"),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_soldier_death", 1),
        (agent_is_ally, ":var0"),
        (agent_get_party_id, ":var3", ":var0"),
        (eq, ":var3", "p_main_party"),
        (neq, ":var2", 1),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (display_message, "@{s13} has died", 0xEC251A),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_player_kill", 1),
        (agent_get_troop_id, ":var5", ":var1"),
        (eq, ":var5", "trp_player"),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (try_begin),
          (neq, ":var2", 1),
          (display_message, "@You have killed {s13}", 0x33D0BC),
        (else_try),
          (display_message, "@You have knocked out {s13}", 0x33D0BC),
        (try_end),
      (try_end),
    ]),

    (ti_on_order_issued, 0, 0, 
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (eq, ":var0", 9),
        (assign, "$dont_use_fist_enable", 1),
      (else_try),
        (this_or_next|eq, ":var0", 10),
        (this_or_next|eq, ":var0", 13),
        (this_or_next|eq, ":var0", 15),
        (this_or_next|eq, ":var0", 16),
        (this_or_next|eq, ":var0", 17),
        (this_or_next|eq, ":var0", 18),
        (this_or_next|eq, ":var0", 19),
        (this_or_next|eq, ":var0", 20),
        (eq, ":var0", 21),
        (assign, "$dont_use_fist_enable", 0),
      (try_end),
    ],
    []),

    (3, 3, 0, 
    [
      (eq, "$dont_use_fist_enable", 1),
      (set_show_messages, 0),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (le, ":var1", -1),
        (agent_get_team, ":var2", ":var0"),
        (1773, ":var3", ":var0"),
        (team_give_order, ":var2", ":var3", 10),
      (try_end),
      (set_show_messages, 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (assign, ":var1", 4),
        (try_for_range, ":var2", 0, ":var1"),
          (1804, ":var3", ":var0", ":var2"),
          (gt, ":var3", 0),
          (2721, ":var4", ":var3"),
          (eq, ":var4", 2),
          (1747, ":var0", ":var3"),
          (assign, ":var1", -1),
        (try_end),
      (try_end),
    ]),

  ]),

  ("village_raid", mtf_battle_mode|mtf_synch_inventory, charge,
  "You lead your men to battle.",
  [
    (3, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 30, []),
    (3, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (1, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 30, []),
    (1, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_put_stay_back_companions_end_of_party"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (assign, reg18, "$g_battle_won"),
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 1 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_empty_string"),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 2 - battle is won: {reg18}"),
        (try_end),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 3 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 4 - battle is won: {reg18}"),
        (try_end),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 5 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (display_message, "str_can_not_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 6 - battle is won: {reg18}"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (team_give_order, "$deathcam_player_team", 9, 2),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, 0),
      (this_or_next|game_key_is_down, 1),
      (this_or_next|game_key_is_down, 2),
      (this_or_next|game_key_is_down, 3),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, 0),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, 1),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, 3),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, 2),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, pos47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|903, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|903, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (738, 47, ":var7"),
        (position_rotate_y, pos47, 90),
        (738, 47, ":var3"),
        (position_rotate_y, pos47, -90),
        (738, 47, "$deathcam_total_rotx"),
        (738, 47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20, 1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 0, 5, 
    [
      (lt, "$defender_reinforcement_stage", "$g_defender_reinforcement_limit"),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 0),
      (lt, ":var1", 12),
    ],
    [
      (add_reinforcements_to_entry, 0, 18),
      (val_add, "$defender_reinforcement_stage", 1),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", "$g_attacker_reinforcement_limit"),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 12),
    ],
    [
      (add_reinforcements_to_entry, 3, 18),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (1, 10, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (try_begin),
        (eq, "$g_village_raid_evil", 0),
        (call_script, "script_play_victorious_sound"),
      (else_try),
        (play_track, "track_victorious_evil", 1),
      (try_end),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (display_message, "@You have fallen in battle!"),
      (team_give_order, "$fplayer_team_no", 9, 2),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (2073, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
      (call_script, "script_apply_death_effect_on_courage_scores", ":var0", ":var1"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, 0, 
    [],
    [
      (try_begin),
        (this_or_next|key_is_down, key_left_control),
        (key_is_down, key_right_control),
        (try_begin),
          (key_clicked, key_h),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (else_try),
          (this_or_next|key_is_down, key_left_alt),
          (key_is_down, key_right_alt),
          (key_clicked, key_f4),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (try_end),
      (try_end),
      (game_key_clicked, 22),
      (neg|903, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (903, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (1, 0, ti_once, 
    [
      (neg|903, "prsnt_killcount"),
      (neg|903, "prsnt_troop_ratio_bar"),
      (neg|903, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 0),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_option_show_killcount", 0),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$g_option_ratio_bar_is_global", 1),
      (this_or_next|eq, "$g_option_message_on_player_kill", 1),
      (eq, "$g_option_message_on_soldier_death", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (2073, ":var2"),
      (agent_is_human, ":var0"),
      (try_begin),
        (ge, ":var0", 0),
        (try_begin),
          (neg|agent_is_ally, ":var0"),
          (val_sub, "$enemy_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (agent_get_party_id, ":var3", ":var0"),
          (eq, ":var3", "p_main_party"),
          (val_sub, "$player_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (neq, ":var3", "p_main_party"),
          (val_sub, "$ally_count_alive", 1),
        (try_end),
        (assign, reg1, "$enemy_count_alive"),
        (assign, reg2, "$player_count_alive"),
        (assign, reg3, "$ally_count_alive"),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_soldier_death", 1),
        (agent_is_ally, ":var0"),
        (agent_get_party_id, ":var3", ":var0"),
        (eq, ":var3", "p_main_party"),
        (neq, ":var2", 1),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (display_message, "@{s13} has died", 0xEC251A),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_player_kill", 1),
        (agent_get_troop_id, ":var5", ":var1"),
        (eq, ":var5", "trp_player"),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (try_begin),
          (neq, ":var2", 1),
          (display_message, "@You have killed {s13}", 0x33D0BC),
        (else_try),
          (display_message, "@You have knocked out {s13}", 0x33D0BC),
        (try_end),
      (try_end),
    ]),

    (ti_on_order_issued, 0, 0, 
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (eq, ":var0", 9),
        (assign, "$dont_use_fist_enable", 1),
      (else_try),
        (this_or_next|eq, ":var0", 10),
        (this_or_next|eq, ":var0", 13),
        (this_or_next|eq, ":var0", 15),
        (this_or_next|eq, ":var0", 16),
        (this_or_next|eq, ":var0", 17),
        (this_or_next|eq, ":var0", 18),
        (this_or_next|eq, ":var0", 19),
        (this_or_next|eq, ":var0", 20),
        (eq, ":var0", 21),
        (assign, "$dont_use_fist_enable", 0),
      (try_end),
    ],
    []),

    (3, 3, 0, 
    [
      (eq, "$dont_use_fist_enable", 1),
      (set_show_messages, 0),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (le, ":var1", -1),
        (agent_get_team, ":var2", ":var0"),
        (1773, ":var3", ":var0"),
        (team_give_order, ":var2", ":var3", 10),
      (try_end),
      (set_show_messages, 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (assign, ":var1", 4),
        (try_for_range, ":var2", 0, ":var1"),
          (1804, ":var3", ":var0", ":var2"),
          (gt, ":var3", 0),
          (2721, ":var4", ":var3"),
          (eq, ":var4", 2),
          (1747, ":var0", ":var3"),
          (assign, ":var1", -1),
        (try_end),
      (try_end),
    ]),

  ]),

  ("besiege_inner_battle_castle", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (6, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (7, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_put_stay_back_companions_end_of_party"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (assign, reg18, "$g_battle_won"),
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 1 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_empty_string"),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 2 - battle is won: {reg18}"),
        (try_end),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 3 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 4 - battle is won: {reg18}"),
        (try_end),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 5 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (display_message, "str_can_not_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 6 - battle is won: {reg18}"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 5, 20, 0),
      (assign, "$g_battle_result", -1),
      (set_mission_result, -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (call_script, "script_music_set_situation_with_culture", 4096),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have fallen in battle!"),
      (team_give_order, "$fplayer_team_no", 9, 2),
    ]),

    (0, 0, 0, 
    [],
    [
      (try_begin),
        (this_or_next|key_is_down, key_left_control),
        (key_is_down, key_right_control),
        (try_begin),
          (key_clicked, key_h),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (else_try),
          (this_or_next|key_is_down, key_left_alt),
          (key_is_down, key_right_alt),
          (key_clicked, key_f4),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (try_end),
      (try_end),
      (game_key_clicked, 22),
      (neg|903, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (903, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (1, 0, ti_once, 
    [
      (neg|903, "prsnt_killcount"),
      (neg|903, "prsnt_troop_ratio_bar"),
      (neg|903, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 0),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_option_show_killcount", 0),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$g_option_ratio_bar_is_global", 1),
      (this_or_next|eq, "$g_option_message_on_player_kill", 1),
      (eq, "$g_option_message_on_soldier_death", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (2073, ":var2"),
      (agent_is_human, ":var0"),
      (try_begin),
        (ge, ":var0", 0),
        (try_begin),
          (neg|agent_is_ally, ":var0"),
          (val_sub, "$enemy_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (agent_get_party_id, ":var3", ":var0"),
          (eq, ":var3", "p_main_party"),
          (val_sub, "$player_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (neq, ":var3", "p_main_party"),
          (val_sub, "$ally_count_alive", 1),
        (try_end),
        (assign, reg1, "$enemy_count_alive"),
        (assign, reg2, "$player_count_alive"),
        (assign, reg3, "$ally_count_alive"),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_soldier_death", 1),
        (agent_is_ally, ":var0"),
        (agent_get_party_id, ":var3", ":var0"),
        (eq, ":var3", "p_main_party"),
        (neq, ":var2", 1),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (display_message, "@{s13} has died", 0xEC251A),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_player_kill", 1),
        (agent_get_troop_id, ":var5", ":var1"),
        (eq, ":var5", "trp_player"),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (try_begin),
          (neq, ":var2", 1),
          (display_message, "@You have killed {s13}", 0x33D0BC),
        (else_try),
          (display_message, "@You have knocked out {s13}", 0x33D0BC),
        (try_end),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (ti_on_order_issued, 0, 0, 
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (eq, ":var0", 9),
        (assign, "$dont_use_fist_enable", 1),
      (else_try),
        (this_or_next|eq, ":var0", 10),
        (this_or_next|eq, ":var0", 13),
        (this_or_next|eq, ":var0", 15),
        (this_or_next|eq, ":var0", 16),
        (this_or_next|eq, ":var0", 17),
        (this_or_next|eq, ":var0", 18),
        (this_or_next|eq, ":var0", 19),
        (this_or_next|eq, ":var0", 20),
        (eq, ":var0", 21),
        (assign, "$dont_use_fist_enable", 0),
      (try_end),
    ],
    []),

    (3, 3, 0, 
    [
      (eq, "$dont_use_fist_enable", 1),
      (set_show_messages, 0),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (le, ":var1", -1),
        (agent_get_team, ":var2", ":var0"),
        (1773, ":var3", ":var0"),
        (team_give_order, ":var2", ":var3", 10),
      (try_end),
      (set_show_messages, 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (assign, ":var1", 4),
        (try_for_range, ":var2", 0, ":var1"),
          (1804, ":var3", ":var0", ":var2"),
          (gt, ":var3", 0),
          (2721, ":var4", ":var3"),
          (eq, ":var4", 2),
          (1747, ":var0", ":var3"),
          (assign, ":var1", -1),
        (try_end),
      (try_end),
    ]),

  ]),

  ("besiege_inner_battle_town_center", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 8, []),
    (2, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 3, []),
    (23, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 3, []),
    (24, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 3, []),
    (25, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 3, []),
    (26, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 3, []),
    (27, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 3, []),
    (28, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 3, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_put_stay_back_companions_end_of_party"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (assign, reg18, "$g_battle_won"),
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 1 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_empty_string"),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 2 - battle is won: {reg18}"),
        (try_end),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 3 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 4 - battle is won: {reg18}"),
        (try_end),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 5 - battle is won: {reg18}"),
        (try_end),
      (else_try),
        (display_message, "str_can_not_retreat"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "@{!}debug : tab situation 6 - battle is won: {reg18}"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 5, 20, 0),
      (assign, "$g_battle_result", -1),
      (set_mission_result, -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (call_script, "script_music_set_situation_with_culture", 4096),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have fallen in battle!"),
      (team_give_order, "$fplayer_team_no", 9, 2),
    ]),

    (0, 0, 0, 
    [],
    [
      (try_begin),
        (this_or_next|key_is_down, key_left_control),
        (key_is_down, key_right_control),
        (try_begin),
          (key_clicked, key_h),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (else_try),
          (this_or_next|key_is_down, key_left_alt),
          (key_is_down, key_right_alt),
          (key_clicked, key_f4),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (try_end),
      (try_end),
      (game_key_clicked, 22),
      (neg|903, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (903, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (1, 0, ti_once, 
    [
      (neg|903, "prsnt_killcount"),
      (neg|903, "prsnt_troop_ratio_bar"),
      (neg|903, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 0),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_option_show_killcount", 0),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$g_option_ratio_bar_is_global", 1),
      (this_or_next|eq, "$g_option_message_on_player_kill", 1),
      (eq, "$g_option_message_on_soldier_death", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (2073, ":var2"),
      (agent_is_human, ":var0"),
      (try_begin),
        (ge, ":var0", 0),
        (try_begin),
          (neg|agent_is_ally, ":var0"),
          (val_sub, "$enemy_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (agent_get_party_id, ":var3", ":var0"),
          (eq, ":var3", "p_main_party"),
          (val_sub, "$player_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (neq, ":var3", "p_main_party"),
          (val_sub, "$ally_count_alive", 1),
        (try_end),
        (assign, reg1, "$enemy_count_alive"),
        (assign, reg2, "$player_count_alive"),
        (assign, reg3, "$ally_count_alive"),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_soldier_death", 1),
        (agent_is_ally, ":var0"),
        (agent_get_party_id, ":var3", ":var0"),
        (eq, ":var3", "p_main_party"),
        (neq, ":var2", 1),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (display_message, "@{s13} has died", 0xEC251A),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_player_kill", 1),
        (agent_get_troop_id, ":var5", ":var1"),
        (eq, ":var5", "trp_player"),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (try_begin),
          (neq, ":var2", 1),
          (display_message, "@You have killed {s13}", 0x33D0BC),
        (else_try),
          (display_message, "@You have knocked out {s13}", 0x33D0BC),
        (try_end),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (ti_on_order_issued, 0, 0, 
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (eq, ":var0", 9),
        (assign, "$dont_use_fist_enable", 1),
      (else_try),
        (this_or_next|eq, ":var0", 10),
        (this_or_next|eq, ":var0", 13),
        (this_or_next|eq, ":var0", 15),
        (this_or_next|eq, ":var0", 16),
        (this_or_next|eq, ":var0", 17),
        (this_or_next|eq, ":var0", 18),
        (this_or_next|eq, ":var0", 19),
        (this_or_next|eq, ":var0", 20),
        (eq, ":var0", 21),
        (assign, "$dont_use_fist_enable", 0),
      (try_end),
    ],
    []),

    (3, 3, 0, 
    [
      (eq, "$dont_use_fist_enable", 1),
      (set_show_messages, 0),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (le, ":var1", -1),
        (agent_get_team, ":var2", ":var0"),
        (1773, ":var3", ":var0"),
        (team_give_order, ":var2", ":var3", 10),
      (try_end),
      (set_show_messages, 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (assign, ":var1", 4),
        (try_for_range, ":var2", 0, ":var1"),
          (1804, ":var3", ":var0", ":var2"),
          (gt, ":var3", 0),
          (2721, ":var4", ":var3"),
          (eq, ":var4", 2),
          (1747, ":var0", ":var3"),
          (assign, ":var1", -1),
        (try_end),
      (try_end),
    ]),

  ]),

  ("castle_attack_walls_defenders_sally", mtf_battle_mode|mtf_synch_inventory, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 32, []),
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (3, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 40, []),
    (3, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_put_stay_back_companions_end_of_party"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (try_begin),
        (eq, ":var1", "trp_player_knight"),
        (troop_get_inventory_capacity, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (troop_get_inventory_slot, ":var4", "trp_player_knight", ":var3"),
          (gt, ":var4", 0),
          (item_get_type, ":var5", ":var4"),
          (try_begin),
            (this_or_next|is_between, ":var5", 2, 11),
            (is_between, ":var5", 16, 19),
            (agent_has_item_equipped, ":var0", ":var4"),
            (1774, ":var0", ":var4"),
          (try_end),
        (try_end),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var7", "trp_player_knight_save", ":var6"),
          (try_begin),
            (gt, ":var7", 0),
            (store_add, ":var8", ":var6", 1),
            (1779, ":var0", ":var7", ":var8"),
          (try_end),
        (try_end),
      (else_try),
        (eq, ":var1", "trp_player_sergeant"),
        (troop_get_inventory_capacity, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (troop_get_inventory_slot, ":var4", "trp_player_sergeant", ":var3"),
          (gt, ":var4", 0),
          (item_get_type, ":var5", ":var4"),
          (try_begin),
            (this_or_next|is_between, ":var5", 2, 11),
            (is_between, ":var5", 16, 19),
            (agent_has_item_equipped, ":var0", ":var4"),
            (1774, ":var0", ":var4"),
          (try_end),
        (try_end),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var7", "trp_player_sergeant_save", ":var6"),
          (try_begin),
            (gt, ":var7", 0),
            (store_add, ":var8", ":var6", 1),
            (1779, ":var0", ":var7", ":var8"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_reassign_team", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_remove_siege_objects"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (get_player_agent_no, "$fplayer_agent_no"),
        (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
        (this_or_next|eq, "$attacker_team", "$fplayer_team_no"),
        (eq, "$attacker_team_2", "$fplayer_team_no"),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (get_player_agent_no, "$fplayer_agent_no"),
        (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
        (this_or_next|eq, "$attacker_team", "$fplayer_team_no"),
        (eq, "$attacker_team_2", "$fplayer_team_no"),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (team_give_order, "$deathcam_player_team", 9, 2),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, 0),
      (this_or_next|game_key_is_down, 1),
      (this_or_next|game_key_is_down, 2),
      (this_or_next|game_key_is_down, 3),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, 0),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, 1),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, 3),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, 2),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, pos47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|903, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|903, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (738, 47, ":var7"),
        (position_rotate_y, pos47, 90),
        (738, 47, ":var3"),
        (position_rotate_y, pos47, -90),
        (738, 47, "$deathcam_total_rotx"),
        (738, 47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (2073, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (str_store_troop_name, s6, ":var3"),
        (assign, reg0, ":var0"),
        (assign, reg1, ":var1"),
        (assign, reg2, ":var2"),
        (agent_get_team, reg3, ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (display_message, "@You can't retreat because the enemy is too close!"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", -1),
      (assign, "$attacker_team", -2),
      (assign, "$defender_team_2", -3),
      (assign, "$attacker_team_2", -4),
    ],
    []),

    (0.1, 0.5, ti_once, 
    [],
    [
      (call_script, "script_set_player_agent_ammo", 0, 6),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (neg|main_hero_fallen, 0),
      (set_mission_result, 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (assign, "$g_siege_sallied_out_once", 1),
      (assign, "$g_siege_method", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (try_begin),
        (store_add, ":var0", "p_player_casualties", "p_ally_casualties"),
        (store_add, ":var1", ":var0", "p_enemy_casualties"),
        (val_mul, ":var0", 100),
        (store_div, ":var2", ":var0", ":var1"),
        (ge, ":var2", 33),
        (assign, "$g_siege_sallied_out_once", 0),
      (try_end),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (display_message, "@You have fallen in battle!"),
      (team_give_order, "$fplayer_team_no", 9, 2),
    ]),

    (0, 0, 0, 
    [],
    [
      (try_begin),
        (this_or_next|key_is_down, key_left_control),
        (key_is_down, key_right_control),
        (try_begin),
          (key_clicked, key_h),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (else_try),
          (this_or_next|key_is_down, key_left_alt),
          (key_is_down, key_right_alt),
          (key_clicked, key_f4),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (try_end),
      (try_end),
      (game_key_clicked, 22),
      (neg|903, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (903, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (1, 0, ti_once, 
    [
      (neg|903, "prsnt_killcount"),
      (neg|903, "prsnt_troop_ratio_bar"),
      (neg|903, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 0),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_option_show_killcount", 0),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$g_option_ratio_bar_is_global", 1),
      (this_or_next|eq, "$g_option_message_on_player_kill", 1),
      (eq, "$g_option_message_on_soldier_death", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (2073, ":var2"),
      (agent_is_human, ":var0"),
      (try_begin),
        (ge, ":var0", 0),
        (try_begin),
          (neg|agent_is_ally, ":var0"),
          (val_sub, "$enemy_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (agent_get_party_id, ":var3", ":var0"),
          (eq, ":var3", "p_main_party"),
          (val_sub, "$player_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (neq, ":var3", "p_main_party"),
          (val_sub, "$ally_count_alive", 1),
        (try_end),
        (assign, reg1, "$enemy_count_alive"),
        (assign, reg2, "$player_count_alive"),
        (assign, reg3, "$ally_count_alive"),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_soldier_death", 1),
        (agent_is_ally, ":var0"),
        (agent_get_party_id, ":var3", ":var0"),
        (eq, ":var3", "p_main_party"),
        (neq, ":var2", 1),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (display_message, "@{s13} has died", 0xEC251A),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_player_kill", 1),
        (agent_get_troop_id, ":var5", ":var1"),
        (eq, ":var5", "trp_player"),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (try_begin),
          (neq, ":var2", 1),
          (display_message, "@You have killed {s13}", 0x33D0BC),
        (else_try),
          (display_message, "@You have knocked out {s13}", 0x33D0BC),
        (try_end),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_set_disciplined_faction"),
      (try_begin),
        (eq, "$g_option_formations", 1),
        (assign, "$gk_order", 0),
        (assign, "$gk_order_hold_over_there", 0),
        (assign, "$autorotate_at_player", 1),
        (assign, "$infantry_formation_type", 1),
        (assign, "$archer_formation_type", 1),
        (assign, "$cavalry_formation_type", 4),
        (assign, "$infantry_space", 2),
        (assign, "$archer_space", 2),
        (assign, "$cavalry_space", 0),
        (assign, "$fclock", 1),
        (assign, "$yield", 0),
      (try_end),
    ]),

    (0.1, 0, ti_once, 
    [],
    [
      (assign, "$yield", 0),
      (call_script, "script_get_yield"),
      (val_add, "$yield", 50),
    ]),

    (0, 0.4, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$g_option_formations", 1),
        (get_player_agent_no, "$fplayer_agent_no"),
        (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
        (assign, ":var0", 0),
        (assign, ":var1", 0),
        (assign, ":var2", 0),
        (assign, ":var3", 0),
        (assign, "$team0_size", 0),
        (assign, "$team1_size", 0),
        (assign, "$team2_size", 0),
        (assign, "$team3_size", 0),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_get_team, ":var5", ":var4"),
          (agent_get_troop_id, ":var6", ":var4"),
          (store_troop_faction, ":var7", ":var6"),
          (try_begin),
            (eq, ":var5", 0),
            (val_add, ":var0", ":var7"),
            (val_add, "$team0_size", 1),
          (else_try),
            (eq, ":var5", 1),
            (val_add, ":var1", ":var7"),
            (val_add, "$team1_size", 1),
          (else_try),
            (eq, ":var5", 2),
            (val_add, ":var2", ":var7"),
            (val_add, "$team2_size", 1),
          (else_try),
            (eq, ":var5", 3),
            (val_add, ":var3", ":var7"),
            (val_add, "$team3_size", 1),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team0_size", 0),
          (team_get_leader, ":var8", 0),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team0_faction", ":var9"),
          (else_try),
            (store_mul, "$team0_faction", ":var0", 10),
            (val_div, "$team0_faction", "$team0_size"),
            (val_add, "$team0_faction", 5),
            (val_div, "$team0_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team1_size", 0),
          (team_get_leader, ":var8", 1),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team1_faction", ":var9"),
          (else_try),
            (store_mul, "$team1_faction", ":var1", 10),
            (val_div, "$team1_faction", "$team1_size"),
            (val_add, "$team1_faction", 5),
            (val_div, "$team1_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team2_size", 0),
          (team_get_leader, ":var8", 2),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team2_faction", ":var9"),
          (else_try),
            (store_mul, "$team2_faction", ":var2", 10),
            (val_div, "$team2_faction", "$team2_size"),
            (val_add, "$team2_faction", 5),
            (val_div, "$team2_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team3_size", 0),
          (team_get_leader, ":var8", 3),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team3_faction", ":var9"),
          (else_try),
            (store_mul, "$team3_faction", ":var3", 10),
            (val_div, "$team3_faction", "$team3_size"),
            (val_add, "$team3_faction", 5),
            (val_div, "$team3_faction", 10),
          (try_end),
        (try_end),
      (try_end),
      (call_script, "script_initial_battle_positions"),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_j),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_ranks_fem", 19),
        (else_try),
          (599, "snd_th3_formation_ranks", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 2),
      (call_script, "script_player_attempt_formation", 1, 2),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_k),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_shield_fem", 19),
        (else_try),
          (599, "snd_th3_formation_shield", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 3),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_l),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_wedge_fem", 19),
        (else_try),
          (599, "snd_th3_formation_wedge", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 4),
      (call_script, "script_player_attempt_formation", 2, 4),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_semicolon),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_square_fem", 19),
        (else_try),
          (599, "snd_th3_formation_square", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 5),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_u),
    ],
    [
      (call_script, "script_player_order_formations", 2),
    ]),

    (0, 0.3, 0, 
    [
      (eq, "$g_option_formations", 1),
      (game_key_clicked, 23),
    ],
    [
      (eq, "$gk_order", 23),
      (game_key_is_down, 23),
      (assign, "$gk_order_hold_over_there", 1),
      (assign, "$gk_order", 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 23),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 0),
        (assign, "$gk_order", 23),
      (else_try),
        (try_begin),
          (eq, "$gk_order", 23),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_hold_fem", 19),
            (else_try),
              (599, "snd_th3_order_hold", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 0),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 24),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_advance_fem", 19),
            (else_try),
              (599, "snd_th3_order_advance", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 5),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 25),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_holdfire_fem", 19),
            (else_try),
              (599, "snd_snouz_order_holdfire", 19),
            (try_end),
          (try_end),
          (assign, "$gk_order", 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (game_key_clicked, 24),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 0),
        (assign, "$gk_order", 24),
      (else_try),
        (try_begin),
          (eq, "$gk_order", 23),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_follow_fem", 19),
            (else_try),
              (599, "snd_th3_order_follow", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 1),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 24),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_fallback_fem", 19),
            (else_try),
              (599, "snd_th3_order_fallback", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 6),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 25),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_fireatwill_fem", 19),
            (else_try),
              (599, "snd_snouz_order_fireatwill", 19),
            (try_end),
          (try_end),
          (assign, "$gk_order", 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 25),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 0),
        (assign, "$gk_order", 25),
      (else_try),
        (try_begin),
          (eq, "$gk_order", 23),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_charge_fem", 19),
            (else_try),
              (599, "snd_th3_order_charge", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 2),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 24),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_spreadout_fem", 19),
            (else_try),
              (599, "snd_snouz_order_spreadout", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 8),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 25),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_bluntweapons_fem", 19),
            (else_try),
              (599, "snd_snouz_order_bluntweapons", 19),
            (try_end),
          (try_end),
          (assign, "$gk_order", 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (game_key_clicked, 26),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 23),
        (call_script, "script_player_order_formations", 11),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 24),
        (call_script, "script_player_order_formations", 7),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_standcloser_fem", 19),
          (else_try),
            (599, "snd_snouz_order_standcloser", 19),
          (try_end),
        (try_end),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 25),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_anyweapons_fem", 19),
          (else_try),
            (599, "snd_snouz_order_anyweapons", 19),
          (try_end),
        (try_end),
        (assign, "$gk_order", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 27),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 23),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_retreat_fem", 19),
          (else_try),
            (599, "snd_th3_order_retreat", 19),
          (try_end),
        (try_end),
        (call_script, "script_player_order_formations", 14),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 24),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_mount_fem", 19),
          (else_try),
            (599, "snd_snouz_order_mount", 19),
          (try_end),
        (try_end),
        (assign, "$gk_order", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 28),
    ],
    [
      (eq, "$gk_order", 24),
      (try_begin),
        (class_is_listening_order, "$fplayer_team_no", 2),
        (call_script, "script_formation_end", "$fplayer_team_no", 2),
      (try_end),
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_order_dismount_fem", 19),
        (else_try),
          (599, "snd_snouz_order_dismount", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_order_formations", 4),
      (assign, "$gk_order", 0),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_1),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_infantry_fem", 19),
        (else_try),
          (599, "snd_th3_address_infantry", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_2),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_archers_fem", 19),
        (else_try),
          (599, "snd_th3_address_archers", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_3),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_cavalry_fem", 19),
        (else_try),
          (599, "snd_th3_address_cavalry", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_0),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_everyone_fem", 19),
        (else_try),
          (599, "snd_th3_address_everyone", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (this_or_next|key_clicked, key_1),
      (this_or_next|key_clicked, key_2),
      (this_or_next|key_clicked, key_3),
      (this_or_next|key_clicked, key_4),
      (this_or_next|key_clicked, key_5),
      (this_or_next|key_clicked, key_6),
      (this_or_next|key_clicked, key_7),
      (this_or_next|key_clicked, key_8),
      (this_or_next|key_clicked, key_9),
      (this_or_next|key_clicked, key_0),
      (key_clicked, key_escape),
    ],
    [
      (assign, "$gk_order", 0),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (eq, "$gk_order_hold_over_there", 1),
      (neg|game_key_is_down, 23),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_order_hold_fem", 19),
        (else_try),
          (599, "snd_th3_order_hold", 19),
        (try_end),
      (try_end),
      (call_script, "script_team_get_average_position_of_enemies_augmented", 60, "$fplayer_team_no", 9),
      (assign, ":var3", 0),
      (try_for_range, reg36, 0, 9),
        (class_is_listening_order, "$fplayer_team_no", reg36),
        (val_add, ":var3", 1),
      (try_end),
      (agent_get_position, pos21, "$fplayer_agent_no"),
      (try_begin),
        (neq, "$infantry_formation_type", 0),
        (class_is_listening_order, "$fplayer_team_no", 0),
        (team_get_order_position, pos2, "$fplayer_team_no", 0),
        (call_script, "script_point_y_toward_position", 2, 60),
        (try_begin),
          (gt, ":var3", 1),
          (agent_set_position, "$fplayer_agent_no", pos2),
          (try_begin),
            (call_script, "script_cf_formation", "$fplayer_team_no", 0, "$infantry_space", "$infantry_formation_type"),
          (try_end),
        (else_try),
          (assign, ":var4", 0),
          (try_for_agents, reg36),
            (call_script, "script_cf_valid_formation_member", "$fplayer_team_no", 0, "$fplayer_agent_no", reg36),
            (val_add, ":var4", 1),
          (try_end),
          (call_script, "script_get_centering_amount", "$infantry_formation_type", ":var4", "$infantry_space"),
          (position_move_x, pos2, reg0),
          (copy_position, pos1, pos2),
          (call_script, "script_set_formation_position", "$fplayer_team_no", 0, 1),
          (call_script, "script_form_infantry", "$fplayer_team_no", "$fplayer_agent_no", "$infantry_space", "$infantry_formation_type"),
        (try_end),
        (assign, "$infantry_formation_move_order", 0),
      (try_end),
      (try_begin),
        (neq, "$cavalry_formation_type", 0),
        (class_is_listening_order, "$fplayer_team_no", 2),
        (team_get_order_position, pos2, "$fplayer_team_no", 2),
        (call_script, "script_point_y_toward_position", 2, 60),
        (try_begin),
          (gt, ":var3", 1),
          (agent_set_position, "$fplayer_agent_no", pos2),
          (try_begin),
            (call_script, "script_cf_formation", "$fplayer_team_no", 2, "$cavalry_space", "$cavalry_formation_type"),
          (try_end),
        (else_try),
          (copy_position, pos1, pos2),
          (call_script, "script_set_formation_position", "$fplayer_team_no", 2, 1),
          (call_script, "script_form_cavalry", "$fplayer_team_no", "$fplayer_agent_no", "$cavalry_space"),
        (try_end),
        (assign, "$cavalry_formation_move_order", 0),
      (try_end),
      (try_begin),
        (neq, "$archer_formation_type", 0),
        (class_is_listening_order, "$fplayer_team_no", 1),
        (team_get_order_position, pos2, "$fplayer_team_no", 1),
        (call_script, "script_point_y_toward_position", 2, 60),
        (try_begin),
          (gt, ":var3", 1),
          (agent_set_position, "$fplayer_agent_no", pos2),
          (try_begin),
            (call_script, "script_cf_formation", "$fplayer_team_no", 1, "$archer_space", "$archer_formation_type"),
          (try_end),
        (else_try),
          (assign, ":var4", 0),
          (try_for_agents, reg36),
            (call_script, "script_cf_valid_formation_member", "$fplayer_team_no", 1, "$fplayer_agent_no", reg36),
            (val_add, ":var4", 1),
          (try_end),
          (call_script, "script_get_centering_amount", 1, ":var4", "$archer_space"),
          (val_mul, reg0, -1),
          (position_move_x, pos2, reg0),
          (copy_position, pos1, pos2),
          (call_script, "script_set_formation_position", "$fplayer_team_no", 1, 1),
          (call_script, "script_form_archers", "$fplayer_team_no", "$fplayer_agent_no", "$archer_space", "$archer_formation_type"),
        (try_end),
        (assign, "$archer_formation_move_order", 0),
      (try_end),
      (agent_set_position, "$fplayer_agent_no", pos21),
      (assign, "$gk_order_hold_over_there", 0),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (neg|key_is_down, key_j),
      (neg|key_is_down, key_k),
      (neg|key_is_down, key_l),
      (neg|key_is_down, key_semicolon),
      (neg|key_is_down, key_u),
      (neg|game_key_is_down, 23),
      (neg|game_key_is_down, 24),
      (neg|game_key_is_down, 25),
      (neg|game_key_is_down, 26),
      (neg|game_key_is_down, 27),
      (neg|game_key_is_down, 28),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (store_mod, ":var0", "$fclock", 5),
      (call_script, "script_team_get_average_position_of_enemies_augmented", 60, "$fplayer_team_no", 9),
      (try_begin),
        (eq, reg0, 0),
        (neq, "$g_encountered_party", -1),
        (call_script, "script_formation_end", "$fplayer_team_no", 9),
      (else_try),
        (assign, "$autorotate_at_player", 0),
        (try_begin),
          (neq, "$infantry_formation_type", 0),
          (try_begin),
            (eq, "$infantry_formation_move_order", 1),
            (call_script, "script_cf_formation", "$fplayer_team_no", 0, "$infantry_space", "$infantry_formation_type"),
          (else_try),
            (eq, ":var0", 0),
            (call_script, "script_get_formation_position", 0, "$fplayer_team_no", 0),
            (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", "$fplayer_team_no", 0),
            (call_script, "script_point_y_toward_position", 1, 60),
            (position_copy_rotation, pos0, pos1),
            (call_script, "script_set_formation_position", "$fplayer_team_no", 0, 0),
            (copy_position, pos1, pos0),
            (call_script, "script_form_infantry", "$fplayer_team_no", "$fplayer_agent_no", "$infantry_space", "$infantry_formation_type"),
          (try_end),
        (try_end),
        (try_begin),
          (neq, "$cavalry_formation_type", 0),
          (try_begin),
            (eq, "$cavalry_formation_move_order", 1),
            (call_script, "script_cf_formation", "$fplayer_team_no", 2, "$cavalry_space", "$cavalry_formation_type"),
          (else_try),
            (eq, ":var0", 0),
            (call_script, "script_get_formation_position", 0, "$fplayer_team_no", 2),
            (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", "$fplayer_team_no", 2),
            (call_script, "script_point_y_toward_position", 1, 60),
            (position_copy_rotation, pos0, pos1),
            (call_script, "script_set_formation_position", "$fplayer_team_no", 2, 0),
            (copy_position, pos1, pos0),
            (call_script, "script_form_cavalry", "$fplayer_team_no", "$fplayer_agent_no", "$cavalry_space"),
          (try_end),
        (try_end),
        (try_begin),
          (neq, "$archer_formation_type", 0),
          (try_begin),
            (eq, "$archer_formation_move_order", 1),
            (call_script, "script_cf_formation", "$fplayer_team_no", 1, "$archer_space", "$archer_formation_type"),
          (else_try),
            (eq, ":var0", 0),
            (call_script, "script_get_formation_position", 0, "$fplayer_team_no", 1),
            (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", "$fplayer_team_no", 1),
            (call_script, "script_point_y_toward_position", 1, 60),
            (position_copy_rotation, pos0, pos1),
            (call_script, "script_set_formation_position", "$fplayer_team_no", 1, 0),
            (copy_position, pos1, pos0),
            (call_script, "script_form_archers", "$fplayer_team_no", "$fplayer_agent_no", "$archer_space", "$archer_formation_type"),
          (try_end),
        (try_end),
        (assign, "$autorotate_at_player", 1),
      (try_end),
      (val_add, "$fclock", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_option_formations", 1),
        (assign, "$cur_casualties", 0),
        (assign, "$prev_casualties", 0),
        (assign, "$prev_casualties2", 0),
        (assign, "$ranged_clock", 1),
        (assign, "$battle_phase", 1),
        (assign, "$clock_reset", 0),
        (assign, "$charge_activated", 0),
        (assign, "$charge_ongoing", 0),
        (assign, "$inf_charge_activated", 0),
        (assign, "$inf_charge_ongoing", 0),
        (assign, "$arc_charge_activated", 0),
        (assign, "$att_reinforcements_arrived", 0),
        (assign, "$def_reinforcements_arrived", 0),
        (assign, "$att_reinforcements_needed", 0),
        (assign, "$def_reinforcements_needed", 0),
        (assign, "$disengage", 0),
        (assign, "$patrol_mode", 0),
        (store_random_in_range, "$rand0", -1000, 1000),
        (store_random_in_range, "$rand2", 800, 1501),
        (store_random_in_range, "$rand1", 0, 501),
        (store_random_in_range, "$rand3", 2000, 3001),
        (store_random_in_range, "$rand4", 1000, 3001),
        (store_random_in_range, "$rand5", -1000, 0),
        (store_random_in_range, "$rand6", 4000, 5001),
        (store_random_in_range, "$rand7", 49, 56),
        (store_random_in_range, "$rand8", -100, 101),
        (assign, "$team0_default_formation", 1),
        (assign, "$team1_default_formation", 1),
        (assign, "$team2_default_formation", 1),
        (assign, "$team3_default_formation", 1),
        (init_position, pos56),
        (init_position, pos57),
        (init_position, pos58),
        (init_position, pos59),
        (assign, "$team0_reinforcement_stage", 0),
        (assign, "$team1_reinforcement_stage", 0),
        (init_position, pos17),
        (init_position, pos18),
      (try_end),
    ]),

    (0, 0.5, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$g_option_formations", 1),
        (eq, "$g_disciplined_faction", 1),
        (try_for_agents, ":var0"),
          (agent_set_slot, ":var0", 15, 0),
        (try_end),
        (set_fixed_point_multiplier, 100),
        (call_script, "script_store_battlegroup_data"),
        (call_script, "script_battlegroup_get_position", 12, 0, 9),
        (call_script, "script_battlegroup_get_position", 13, 1, 9),
        (call_script, "script_battlegroup_get_position", 14, 2, 9),
        (call_script, "script_battlegroup_get_position", 16, 3, 9),
        (call_script, "script_field_tactics", 1),
      (try_end),
    ]),

    (60, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (eq, "$g_disciplined_faction", 1),
    ],
    [
      (store_random_in_range, "$rand0", -1000, 1000),
      (store_random_in_range, "$rand2", 800, 1501),
      (store_random_in_range, "$rand1", -1000, 1000),
      (store_random_in_range, "$rand3", 2000, 3001),
      (store_random_in_range, "$rand4", 1000, 3001),
      (store_random_in_range, "$rand5", -1000, 0),
      (store_random_in_range, "$rand6", 4000, 5001),
      (store_random_in_range, "$rand7", 45, 56),
      (store_random_in_range, "$rand8", -100, 101),
    ]),

    (1, 0.9, 0, 
    [
      (eq, "$g_option_formations", 1),
      (eq, "$g_disciplined_faction", 1),
    ],
    [
      (try_begin),
        (assign, "$prev_casualties2", "$cur_casualties"),
        (call_script, "script_cf_count_casualties"),
        (assign, "$cur_casualties", reg0),
        (assign, "$battle_phase", 3),
      (try_end),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_store_battlegroup_data"),
      (try_begin),
        (eq, "$battle_phase", 3),
        (eq, "$clock_reset", 0),
        (call_script, "script_field_tactics", 1),
        (assign, "$ranged_clock", 0),
        (assign, "$clock_reset", 1),
      (else_try),
        (ge, "$battle_phase", 2),
        (store_mod, reg0, "$ranged_clock", 5),
        (eq, reg0, 0),
        (call_script, "script_field_tactics", 1),
        (assign, "$team0_reinforcement_stage", "$defender_reinforcement_stage"),
        (assign, "$team1_reinforcement_stage", "$attacker_reinforcement_stage"),
      (else_try),
        (call_script, "script_field_tactics", 0),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 1),
        (assign, ":var0", 0),
        (try_for_range, ":var1", 0, 4),
          (neq, ":var1", "$fplayer_team_no"),
          (call_script, "script_battlegroup_get_size", ":var1", 9),
          (gt, reg0, 0),
          (call_script, "script_battlegroup_get_position", 1, ":var1", 1),
          (team_get_order_position, pos0, ":var1", 1),
          (get_distance_between_positions, reg0, pos0, pos1),
          (gt, reg0, 500),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 0),
        (assign, "$battle_phase", 2),
      (try_end),
      (val_add, "$ranged_clock", 1),
    ]),

    (ti_on_order_issued, 0, 0, 
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (eq, ":var0", 9),
        (assign, "$dont_use_fist_enable", 1),
      (else_try),
        (this_or_next|eq, ":var0", 10),
        (this_or_next|eq, ":var0", 13),
        (this_or_next|eq, ":var0", 15),
        (this_or_next|eq, ":var0", 16),
        (this_or_next|eq, ":var0", 17),
        (this_or_next|eq, ":var0", 18),
        (this_or_next|eq, ":var0", 19),
        (this_or_next|eq, ":var0", 20),
        (eq, ":var0", 21),
        (assign, "$dont_use_fist_enable", 0),
      (try_end),
    ],
    []),

    (3, 3, 0, 
    [
      (eq, "$dont_use_fist_enable", 1),
      (set_show_messages, 0),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (le, ":var1", -1),
        (agent_get_team, ":var2", ":var0"),
        (1773, ":var3", ":var0"),
        (team_give_order, ":var2", ":var3", 10),
      (try_end),
      (set_show_messages, 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (assign, ":var1", 4),
        (try_for_range, ":var2", 0, ":var1"),
          (1804, ":var3", ":var0", ":var2"),
          (gt, ":var3", 0),
          (2721, ":var4", ":var3"),
          (eq, ":var4", 2),
          (1747, ":var0", ":var3"),
          (assign, ":var1", -1),
        (try_end),
      (try_end),
    ]),

  ]),

  ("castle_attack_walls_belfry", mtf_battle_mode|mtf_synch_inventory, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 32, []),
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (10, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (11, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 28, []),
    (15, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (40, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
    (41, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
    (42, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
    (43, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
    (44, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
    (45, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
    (46, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
    (47, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_put_stay_back_companions_end_of_party"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_o),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_wielded_item, ":var1", ":var0", 0),
      (item_get_type, ":var2", ":var1"),
      (this_or_next|eq, ":var2", 8),
      (eq, ":var2", 9),
      (agent_get_position, pos5, ":var0"),
      (assign, ":var3", -1),
      (try_for_agents, ":var4"),
        (neq, ":var4", ":var0"),
        (agent_is_alive, ":var4"),
        (agent_is_human, ":var4"),
        (agent_get_party_id, ":var5", ":var4"),
        (eq, ":var5", "p_main_party"),
        (agent_get_wielded_item, ":var6", ":var4", 0),
        (gt, ":var6", 0),
        (item_get_type, ":var7", ":var6"),
        (eq, ":var7", ":var2"),
        (try_begin),
          (eq, ":var3", -1),
          (assign, ":var3", ":var4"),
          (agent_get_position, pos1, ":var4"),
          (get_distance_between_positions, ":var8", pos1, pos5),
        (else_try),
          (agent_get_position, pos2, ":var4"),
          (get_distance_between_positions, ":var9", pos2, pos5),
          (lt, ":var9", ":var8"),
          (assign, ":var3", ":var4"),
          (assign, ":var8", ":var9"),
        (try_end),
      (try_end),
      (gt, ":var3", -1),
      (lt, ":var8", 100),
      (try_begin),
        (eq, ":var2", 8),
        (assign, ":var10", 5),
      (else_try),
        (assign, ":var10", 6),
      (try_end),
      (assign, ":var11", 0),
      (try_for_range, ":var12", 0, 4),
        (1804, ":var13", ":var0", ":var12"),
        (ge, ":var13", 1),
        (item_get_type, ":var14", ":var13"),
        (eq, ":var14", ":var10"),
        (2710, ":var15", ":var13"),
        (1977, ":var16", ":var0", ":var12"),
        (store_sub, ":var17", ":var15", ":var16"),
        (val_add, ":var11", ":var17"),
      (try_end),
      (assign, ":var18", 0),
      (try_for_range, ":var12", 0, 4),
        (1804, ":var13", ":var3", ":var12"),
        (ge, ":var13", 1),
        (item_get_type, ":var14", ":var13"),
        (eq, ":var14", ":var10"),
        (1977, ":var16", ":var3", ":var12"),
        (val_add, ":var18", ":var16"),
      (try_end),
      (try_begin),
        (ge, ":var11", ":var18"),
        (try_for_range, ":var12", 0, 4),
          (1804, ":var13", ":var3", ":var12"),
          (ge, ":var13", 1),
          (item_get_type, ":var14", ":var13"),
          (try_begin),
            (eq, ":var14", ":var10"),
            (1776, ":var3", ":var13", 0),
          (else_try),
            (eq, ":var14", ":var2"),
            (1774, ":var3", ":var13", ":var12"),
          (try_end),
        (try_end),
        (try_for_range, ":var12", 0, 4),
          (1804, ":var13", ":var0", ":var12"),
          (ge, ":var13", 1),
          (item_get_type, ":var14", ":var13"),
          (eq, ":var14", ":var10"),
          (2710, ":var15", ":var13"),
          (1977, ":var16", ":var0", ":var12"),
          (store_sub, ":var17", ":var15", ":var16"),
          (try_begin),
            (ge, ":var18", ":var17"),
            (1776, ":var0", ":var13", ":var15"),
            (val_sub, ":var18", ":var17"),
          (else_try),
            (val_add, ":var16", ":var18"),
            (1776, ":var0", ":var13", ":var16"),
          (try_end),
        (try_end),
      (else_try),
        (try_for_range, ":var12", 0, 4),
          (1804, ":var13", ":var0", ":var12"),
          (ge, ":var13", 1),
          (item_get_type, ":var14", ":var13"),
          (eq, ":var14", ":var10"),
          (2710, ":var15", ":var13"),
          (1977, ":var16", ":var0", ":var12"),
          (store_sub, ":var17", ":var15", ":var16"),
          (1776, ":var0", ":var13", ":var15"),
        (try_end),
        (try_for_range, ":var12", 0, 4),
          (1804, ":var13", ":var3", ":var12"),
          (ge, ":var13", 1),
          (item_get_type, ":var14", ":var13"),
          (eq, ":var14", ":var10"),
          (1977, ":var16", ":var3", ":var12"),
          (try_begin),
            (ge, ":var11", ":var16"),
            (1776, ":var3", ":var13", 0),
            (val_sub, ":var11", ":var16"),
          (else_try),
            (val_sub, ":var16", ":var11"),
            (1776, ":var3", ":var13", ":var16"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (team_give_order, "$deathcam_player_team", 9, 2),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, 0),
      (this_or_next|game_key_is_down, 1),
      (this_or_next|game_key_is_down, 2),
      (this_or_next|game_key_is_down, 3),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, 0),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, 1),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, 3),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, 2),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, pos47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|903, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|903, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (738, 47, ":var7"),
        (position_rotate_y, pos47, 90),
        (738, 47, ":var3"),
        (position_rotate_y, pos47, -90),
        (738, 47, "$deathcam_total_rotx"),
        (738, 47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (get_player_agent_no, "$fplayer_agent_no"),
        (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
        (this_or_next|eq, "$attacker_team", "$fplayer_team_no"),
        (eq, "$attacker_team_2", "$fplayer_team_no"),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (get_player_agent_no, "$fplayer_agent_no"),
        (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
        (this_or_next|eq, "$attacker_team", "$fplayer_team_no"),
        (eq, "$attacker_team_2", "$fplayer_team_no"),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_begin),
        (neq, "$attacker_team", ":var2"),
        (neq, "$attacker_team_2", ":var2"),
        (str_store_string, s5, "str_siege_continues"),
        (call_script, "script_simulate_retreat", 8, 15, 0),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_simulate_retreat", 5, 20, 0),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (call_script, "script_music_set_situation_with_culture", 262144),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
      (try_begin),
        (get_player_agent_no, "$fplayer_agent_no"),
        (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
        (this_or_next|eq, "$attacker_team", "$fplayer_team_no"),
        (eq, "$attacker_team_2", "$fplayer_team_no"),
        (agent_get_position, pos1, "$fplayer_agent_no"),
        (set_show_messages, 0),
        (team_give_order, "$fplayer_team_no", 9, 0),
        (position_move_y, pos1, 500),
        (team_set_order_position, "$fplayer_team_no", 0, pos1),
        (agent_get_position, pos1, "$fplayer_agent_no"),
        (position_move_y, pos1, 100),
        (team_set_order_position, "$fplayer_team_no", 1, pos1),
        (team_give_order, "$fplayer_team_no", 1, 8),
        (set_show_messages, 1),
      (else_try),
        (entry_point_get_position, pos1, 15),
        (set_spawn_position, pos1),
        (1974, "spr_inventory", 0),
      (try_end),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (try_for_range, ":var0", 0, 9),
        (neq, ":var0", 1),
        (team_give_order, "$defender_team", ":var0", 0),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 0),
        (team_give_order, "$defender_team_2", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 7),
      (try_end),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 9, pos10),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 9, pos10),
      (set_show_messages, 1),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (try_begin),
        (eq, ":var1", "trp_player_knight"),
        (troop_get_inventory_capacity, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (troop_get_inventory_slot, ":var4", "trp_player_knight", ":var3"),
          (gt, ":var4", 0),
          (item_get_type, ":var5", ":var4"),
          (try_begin),
            (this_or_next|is_between, ":var5", 2, 11),
            (is_between, ":var5", 16, 19),
            (agent_has_item_equipped, ":var0", ":var4"),
            (1774, ":var0", ":var4"),
          (try_end),
        (try_end),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var7", "trp_player_knight_save", ":var6"),
          (try_begin),
            (gt, ":var7", 0),
            (store_add, ":var8", ":var6", 1),
            (1779, ":var0", ":var7", ":var8"),
          (try_end),
        (try_end),
      (else_try),
        (eq, ":var1", "trp_player_sergeant"),
        (troop_get_inventory_capacity, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (troop_get_inventory_slot, ":var4", "trp_player_sergeant", ":var3"),
          (gt, ":var4", 0),
          (item_get_type, ":var5", ":var4"),
          (try_begin),
            (this_or_next|is_between, ":var5", 2, 11),
            (is_between, ":var5", 16, 19),
            (agent_has_item_equipped, ":var0", ":var4"),
            (1774, ":var0", ":var4"),
          (try_end),
        (try_end),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var7", "trp_player_sergeant_save", ":var6"),
          (try_begin),
            (gt, ":var7", 0),
            (store_add, ":var8", ":var6", 1),
            (1779, ":var0", ":var7", ":var8"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (team_give_order, "$attacker_team", 9, 8),
      (team_give_order, "$attacker_team", 9, 8),
      (team_give_order, "$attacker_team", 9, 8),
      (set_show_messages, 1),
    ],
    []),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (2073, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (str_store_troop_name, s6, ":var3"),
        (assign, reg0, ":var0"),
        (assign, reg1, ":var1"),
        (assign, reg2, ":var2"),
        (agent_get_team, reg3, ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (0, 2, ti_once, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 5, 1),
      (try_end),
    ]),

    (3, 0, 5, 
    [],
    [
      (lt, "$defender_reinforcement_stage", "$g_defender_reinforcement_limit_siege"),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (store_normalized_team_count, ":var1", 0),
      (lt, ":var1", 30),
      (add_reinforcements_to_entry, 4, 10),
      (val_add, "$defender_reinforcement_stage", 1),
      (try_begin),
        (gt, ":var0", 300),
        (get_player_agent_no, ":var2"),
        (agent_get_team, ":var3", ":var2"),
        (neq, ":var3", "$defender_team"),
        (neq, ":var3", "$defender_team_2"),
        (ge, "$defender_reinforcement_stage", 2),
        (set_show_messages, 0),
        (team_give_order, "$defender_team", 0, 2),
        (team_give_order, "$defender_team_2", 0, 2),
        (team_give_order, "$defender_team", 2, 2),
        (team_give_order, "$defender_team_2", 2, 2),
        (set_show_messages, 1),
        (ge, "$defender_reinforcement_stage", 4),
        (set_show_messages, 0),
        (team_give_order, "$defender_team", 9, 2),
        (team_give_order, "$defender_team_2", 9, 2),
        (set_show_messages, 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_siege_move_archers_to_archer_positions"),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", "$g_attacker_reinforcement_limit_siege"),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 25),
    ],
    [
      (add_reinforcements_to_entry, 1, 9),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$attacker_team"),
        (eq, ":var1", "$attacker_team_2"),
        (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
    ]),

    (60, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var1"),
      (try_end),
    ]),

    (180, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (this_or_next|eq, ":var1", "$defender_team"),
      (eq, ":var1", "$defender_team_2"),
      (agent_refill_ammo, ":var0"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have fallen in battle!"),
      (team_give_order, "$fplayer_team_no", 9, 2),
    ]),

    (0, 0, 0, 
    [],
    [
      (try_begin),
        (this_or_next|key_is_down, key_left_control),
        (key_is_down, key_right_control),
        (try_begin),
          (key_clicked, key_h),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (else_try),
          (this_or_next|key_is_down, key_left_alt),
          (key_is_down, key_right_alt),
          (key_clicked, key_f4),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (try_end),
      (try_end),
      (game_key_clicked, 22),
      (neg|903, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (903, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (1, 0, ti_once, 
    [
      (neg|903, "prsnt_killcount"),
      (neg|903, "prsnt_troop_ratio_bar"),
      (neg|903, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 0),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_option_show_killcount", 0),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$g_option_ratio_bar_is_global", 1),
      (this_or_next|eq, "$g_option_message_on_player_kill", 1),
      (eq, "$g_option_message_on_soldier_death", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (2073, ":var2"),
      (agent_is_human, ":var0"),
      (try_begin),
        (ge, ":var0", 0),
        (try_begin),
          (neg|agent_is_ally, ":var0"),
          (val_sub, "$enemy_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (agent_get_party_id, ":var3", ":var0"),
          (eq, ":var3", "p_main_party"),
          (val_sub, "$player_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (neq, ":var3", "p_main_party"),
          (val_sub, "$ally_count_alive", 1),
        (try_end),
        (assign, reg1, "$enemy_count_alive"),
        (assign, reg2, "$player_count_alive"),
        (assign, reg3, "$ally_count_alive"),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_soldier_death", 1),
        (agent_is_ally, ":var0"),
        (agent_get_party_id, ":var3", ":var0"),
        (eq, ":var3", "p_main_party"),
        (neq, ":var2", 1),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (display_message, "@{s13} has died", 0xEC251A),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_player_kill", 1),
        (agent_get_troop_id, ":var5", ":var1"),
        (eq, ":var5", "trp_player"),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (try_begin),
          (neq, ":var2", 1),
          (display_message, "@You have killed {s13}", 0x33D0BC),
        (else_try),
          (display_message, "@You have knocked out {s13}", 0x33D0BC),
        (try_end),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (call_script, "script_siege_init_ai_and_belfry"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_move_belfry"),
    ],
    []),

    (0, 2, ti_once, 
    [
      (call_script, "script_cf_siege_rotate_belfry_platform"),
    ],
    [
      (assign, "$belfry_positioned", 3),
    ]),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_assign_men_to_belfry"),
    ],
    []),

    (ti_on_order_issued, 0, 0, 
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (eq, ":var0", 9),
        (assign, "$dont_use_fist_enable", 1),
      (else_try),
        (this_or_next|eq, ":var0", 10),
        (this_or_next|eq, ":var0", 13),
        (this_or_next|eq, ":var0", 15),
        (this_or_next|eq, ":var0", 16),
        (this_or_next|eq, ":var0", 17),
        (this_or_next|eq, ":var0", 18),
        (this_or_next|eq, ":var0", 19),
        (this_or_next|eq, ":var0", 20),
        (eq, ":var0", 21),
        (assign, "$dont_use_fist_enable", 0),
      (try_end),
    ],
    []),

    (3, 3, 0, 
    [
      (eq, "$dont_use_fist_enable", 1),
      (set_show_messages, 0),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (le, ":var1", -1),
        (agent_get_team, ":var2", ":var0"),
        (1773, ":var3", ":var0"),
        (team_give_order, ":var2", ":var3", 10),
      (try_end),
      (set_show_messages, 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (assign, ":var1", 4),
        (try_for_range, ":var2", 0, ":var1"),
          (1804, ":var3", ":var0", ":var2"),
          (gt, ":var3", 0),
          (2721, ":var4", ":var3"),
          (eq, ":var4", 2),
          (1747, ":var0", ":var3"),
          (assign, ":var1", -1),
        (try_end),
      (try_end),
    ]),

  ]),

  ("castle_attack_walls_ladder", mtf_battle_mode|mtf_synch_inventory, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 32, []),
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (10, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (11, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 30, []),
    (15, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (40, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
    (41, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
    (42, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
    (43, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
    (44, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
    (45, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
    (46, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 2, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_put_stay_back_companions_end_of_party"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_o),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_wielded_item, ":var1", ":var0", 0),
      (item_get_type, ":var2", ":var1"),
      (this_or_next|eq, ":var2", 8),
      (eq, ":var2", 9),
      (agent_get_position, pos5, ":var0"),
      (assign, ":var3", -1),
      (try_for_agents, ":var4"),
        (neq, ":var4", ":var0"),
        (agent_is_alive, ":var4"),
        (agent_is_human, ":var4"),
        (agent_get_party_id, ":var5", ":var4"),
        (eq, ":var5", "p_main_party"),
        (agent_get_wielded_item, ":var6", ":var4", 0),
        (gt, ":var6", 0),
        (item_get_type, ":var7", ":var6"),
        (eq, ":var7", ":var2"),
        (try_begin),
          (eq, ":var3", -1),
          (assign, ":var3", ":var4"),
          (agent_get_position, pos1, ":var4"),
          (get_distance_between_positions, ":var8", pos1, pos5),
        (else_try),
          (agent_get_position, pos2, ":var4"),
          (get_distance_between_positions, ":var9", pos2, pos5),
          (lt, ":var9", ":var8"),
          (assign, ":var3", ":var4"),
          (assign, ":var8", ":var9"),
        (try_end),
      (try_end),
      (gt, ":var3", -1),
      (lt, ":var8", 100),
      (try_begin),
        (eq, ":var2", 8),
        (assign, ":var10", 5),
      (else_try),
        (assign, ":var10", 6),
      (try_end),
      (assign, ":var11", 0),
      (try_for_range, ":var12", 0, 4),
        (1804, ":var13", ":var0", ":var12"),
        (ge, ":var13", 1),
        (item_get_type, ":var14", ":var13"),
        (eq, ":var14", ":var10"),
        (2710, ":var15", ":var13"),
        (1977, ":var16", ":var0", ":var12"),
        (store_sub, ":var17", ":var15", ":var16"),
        (val_add, ":var11", ":var17"),
      (try_end),
      (assign, ":var18", 0),
      (try_for_range, ":var12", 0, 4),
        (1804, ":var13", ":var3", ":var12"),
        (ge, ":var13", 1),
        (item_get_type, ":var14", ":var13"),
        (eq, ":var14", ":var10"),
        (1977, ":var16", ":var3", ":var12"),
        (val_add, ":var18", ":var16"),
      (try_end),
      (try_begin),
        (ge, ":var11", ":var18"),
        (try_for_range, ":var12", 0, 4),
          (1804, ":var13", ":var3", ":var12"),
          (ge, ":var13", 1),
          (item_get_type, ":var14", ":var13"),
          (try_begin),
            (eq, ":var14", ":var10"),
            (1776, ":var3", ":var13", 0),
          (else_try),
            (eq, ":var14", ":var2"),
            (1774, ":var3", ":var13", ":var12"),
          (try_end),
        (try_end),
        (try_for_range, ":var12", 0, 4),
          (1804, ":var13", ":var0", ":var12"),
          (ge, ":var13", 1),
          (item_get_type, ":var14", ":var13"),
          (eq, ":var14", ":var10"),
          (2710, ":var15", ":var13"),
          (1977, ":var16", ":var0", ":var12"),
          (store_sub, ":var17", ":var15", ":var16"),
          (try_begin),
            (ge, ":var18", ":var17"),
            (1776, ":var0", ":var13", ":var15"),
            (val_sub, ":var18", ":var17"),
          (else_try),
            (val_add, ":var16", ":var18"),
            (1776, ":var0", ":var13", ":var16"),
          (try_end),
        (try_end),
      (else_try),
        (try_for_range, ":var12", 0, 4),
          (1804, ":var13", ":var0", ":var12"),
          (ge, ":var13", 1),
          (item_get_type, ":var14", ":var13"),
          (eq, ":var14", ":var10"),
          (2710, ":var15", ":var13"),
          (1977, ":var16", ":var0", ":var12"),
          (store_sub, ":var17", ":var15", ":var16"),
          (1776, ":var0", ":var13", ":var15"),
        (try_end),
        (try_for_range, ":var12", 0, 4),
          (1804, ":var13", ":var3", ":var12"),
          (ge, ":var13", 1),
          (item_get_type, ":var14", ":var13"),
          (eq, ":var14", ":var10"),
          (1977, ":var16", ":var3", ":var12"),
          (try_begin),
            (ge, ":var11", ":var16"),
            (1776, ":var3", ":var13", 0),
            (val_sub, ":var11", ":var16"),
          (else_try),
            (val_sub, ":var16", ":var11"),
            (1776, ":var3", ":var13", ":var16"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (team_give_order, "$deathcam_player_team", 9, 2),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, 0),
      (this_or_next|game_key_is_down, 1),
      (this_or_next|game_key_is_down, 2),
      (this_or_next|game_key_is_down, 3),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, 0),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, 1),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, 3),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, 2),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, pos47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|903, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|903, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (738, 47, ":var7"),
        (position_rotate_y, pos47, 90),
        (738, 47, ":var3"),
        (position_rotate_y, pos47, -90),
        (738, 47, "$deathcam_total_rotx"),
        (738, 47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (get_player_agent_no, "$fplayer_agent_no"),
        (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
        (this_or_next|eq, "$attacker_team", "$fplayer_team_no"),
        (eq, "$attacker_team_2", "$fplayer_team_no"),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (get_player_agent_no, "$fplayer_agent_no"),
        (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
        (this_or_next|eq, "$attacker_team", "$fplayer_team_no"),
        (eq, "$attacker_team_2", "$fplayer_team_no"),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_begin),
        (neq, "$attacker_team", ":var2"),
        (neq, "$attacker_team_2", ":var2"),
        (str_store_string, s5, "str_siege_continues"),
        (call_script, "script_simulate_retreat", 8, 15, 0),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_simulate_retreat", 5, 20, 0),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (call_script, "script_music_set_situation_with_culture", 262144),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
      (try_begin),
        (get_player_agent_no, "$fplayer_agent_no"),
        (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
        (this_or_next|eq, "$attacker_team", "$fplayer_team_no"),
        (eq, "$attacker_team_2", "$fplayer_team_no"),
        (agent_get_position, pos1, "$fplayer_agent_no"),
        (set_show_messages, 0),
        (team_give_order, "$fplayer_team_no", 9, 0),
        (position_move_y, pos1, 500),
        (team_set_order_position, "$fplayer_team_no", 0, pos1),
        (agent_get_position, pos1, "$fplayer_agent_no"),
        (position_move_y, pos1, 100),
        (team_set_order_position, "$fplayer_team_no", 1, pos1),
        (team_give_order, "$fplayer_team_no", 1, 8),
        (set_show_messages, 1),
      (else_try),
        (entry_point_get_position, pos1, 15),
        (set_spawn_position, pos1),
        (1974, "spr_inventory", 0),
      (try_end),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (try_for_range, ":var0", 0, 9),
        (neq, ":var0", 1),
        (team_give_order, "$defender_team", ":var0", 0),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 0),
        (team_give_order, "$defender_team_2", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 7),
      (try_end),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 9, pos10),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 9, pos10),
      (set_show_messages, 1),
    ],
    []),

    (0, 2, ti_once, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 5, 1),
      (try_end),
    ]),

    (3, 0, 5, 
    [],
    [
      (lt, "$defender_reinforcement_stage", "$g_defender_reinforcement_limit_siege"),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (store_normalized_team_count, ":var1", 0),
      (lt, ":var1", 30),
      (add_reinforcements_to_entry, 4, 10),
      (val_add, "$defender_reinforcement_stage", 1),
      (try_begin),
        (gt, ":var0", 300),
        (get_player_agent_no, ":var2"),
        (agent_get_team, ":var3", ":var2"),
        (neq, ":var3", "$defender_team"),
        (neq, ":var3", "$defender_team_2"),
        (ge, "$defender_reinforcement_stage", 2),
        (set_show_messages, 0),
        (team_give_order, "$defender_team", 0, 2),
        (team_give_order, "$defender_team_2", 0, 2),
        (team_give_order, "$defender_team", 2, 2),
        (team_give_order, "$defender_team_2", 2, 2),
        (set_show_messages, 1),
        (ge, "$defender_reinforcement_stage", 4),
        (set_show_messages, 0),
        (team_give_order, "$defender_team", 9, 2),
        (team_give_order, "$defender_team_2", 9, 2),
        (set_show_messages, 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_siege_move_archers_to_archer_positions"),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", "$g_attacker_reinforcement_limit_siege"),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 25),
    ],
    [
      (add_reinforcements_to_entry, 1, 9),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$attacker_team"),
        (eq, ":var1", "$attacker_team_2"),
        (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
    ]),

    (60, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var1"),
      (try_end),
    ]),

    (180, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (this_or_next|eq, ":var1", "$defender_team"),
      (eq, ":var1", "$defender_team_2"),
      (agent_refill_ammo, ":var0"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have fallen in battle!"),
      (team_give_order, "$fplayer_team_no", 9, 2),
    ]),

    (0, 0, 0, 
    [],
    [
      (try_begin),
        (this_or_next|key_is_down, key_left_control),
        (key_is_down, key_right_control),
        (try_begin),
          (key_clicked, key_h),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (else_try),
          (this_or_next|key_is_down, key_left_alt),
          (key_is_down, key_right_alt),
          (key_clicked, key_f4),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (try_end),
      (try_end),
      (game_key_clicked, 22),
      (neg|903, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (903, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (1, 0, ti_once, 
    [
      (neg|903, "prsnt_killcount"),
      (neg|903, "prsnt_troop_ratio_bar"),
      (neg|903, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 0),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_option_show_killcount", 0),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$g_option_ratio_bar_is_global", 1),
      (this_or_next|eq, "$g_option_message_on_player_kill", 1),
      (eq, "$g_option_message_on_soldier_death", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (2073, ":var2"),
      (agent_is_human, ":var0"),
      (try_begin),
        (ge, ":var0", 0),
        (try_begin),
          (neg|agent_is_ally, ":var0"),
          (val_sub, "$enemy_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (agent_get_party_id, ":var3", ":var0"),
          (eq, ":var3", "p_main_party"),
          (val_sub, "$player_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (neq, ":var3", "p_main_party"),
          (val_sub, "$ally_count_alive", 1),
        (try_end),
        (assign, reg1, "$enemy_count_alive"),
        (assign, reg2, "$player_count_alive"),
        (assign, reg3, "$ally_count_alive"),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_soldier_death", 1),
        (agent_is_ally, ":var0"),
        (agent_get_party_id, ":var3", ":var0"),
        (eq, ":var3", "p_main_party"),
        (neq, ":var2", 1),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (display_message, "@{s13} has died", 0xEC251A),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_player_kill", 1),
        (agent_get_troop_id, ":var5", ":var1"),
        (eq, ":var5", "trp_player"),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (try_begin),
          (neq, ":var2", 1),
          (display_message, "@You have killed {s13}", 0x33D0BC),
        (else_try),
          (display_message, "@You have knocked out {s13}", 0x33D0BC),
        (try_end),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (try_begin),
        (eq, ":var1", "trp_player_knight"),
        (troop_get_inventory_capacity, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (troop_get_inventory_slot, ":var4", "trp_player_knight", ":var3"),
          (gt, ":var4", 0),
          (item_get_type, ":var5", ":var4"),
          (try_begin),
            (this_or_next|is_between, ":var5", 2, 11),
            (is_between, ":var5", 16, 19),
            (agent_has_item_equipped, ":var0", ":var4"),
            (1774, ":var0", ":var4"),
          (try_end),
        (try_end),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var7", "trp_player_knight_save", ":var6"),
          (try_begin),
            (gt, ":var7", 0),
            (store_add, ":var8", ":var6", 1),
            (1779, ":var0", ":var7", ":var8"),
          (try_end),
        (try_end),
      (else_try),
        (eq, ":var1", "trp_player_sergeant"),
        (troop_get_inventory_capacity, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (troop_get_inventory_slot, ":var4", "trp_player_sergeant", ":var3"),
          (gt, ":var4", 0),
          (item_get_type, ":var5", ":var4"),
          (try_begin),
            (this_or_next|is_between, ":var5", 2, 11),
            (is_between, ":var5", 16, 19),
            (agent_has_item_equipped, ":var0", ":var4"),
            (1774, ":var0", ":var4"),
          (try_end),
        (try_end),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var7", "trp_player_sergeant_save", ":var6"),
          (try_begin),
            (gt, ":var7", 0),
            (store_add, ":var8", ":var6", 1),
            (1779, ":var0", ":var7", ":var8"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (2073, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (str_store_troop_name, s6, ":var3"),
        (assign, reg0, ":var0"),
        (assign, reg1, ":var1"),
        (assign, reg2, ":var2"),
        (agent_get_team, reg3, ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (ti_on_order_issued, 0, 0, 
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (eq, ":var0", 9),
        (assign, "$dont_use_fist_enable", 1),
      (else_try),
        (this_or_next|eq, ":var0", 10),
        (this_or_next|eq, ":var0", 13),
        (this_or_next|eq, ":var0", 15),
        (this_or_next|eq, ":var0", 16),
        (this_or_next|eq, ":var0", 17),
        (this_or_next|eq, ":var0", 18),
        (this_or_next|eq, ":var0", 19),
        (this_or_next|eq, ":var0", 20),
        (eq, ":var0", 21),
        (assign, "$dont_use_fist_enable", 0),
      (try_end),
    ],
    []),

    (3, 3, 0, 
    [
      (eq, "$dont_use_fist_enable", 1),
      (set_show_messages, 0),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (le, ":var1", -1),
        (agent_get_team, ":var2", ":var0"),
        (1773, ":var3", ":var0"),
        (team_give_order, ":var2", ":var3", 10),
      (try_end),
      (set_show_messages, 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (assign, ":var1", 4),
        (try_for_range, ":var2", 0, ":var1"),
          (1804, ":var3", ":var0", ":var2"),
          (gt, ":var3", 0),
          (2721, ":var4", ":var3"),
          (eq, ":var4", 2),
          (1747, ":var0", ":var3"),
          (assign, ":var1", -1),
        (try_end),
      (try_end),
    ]),

  ]),

  ("castle_visit", 0, -1,
  "Castle visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (14, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (15, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (16, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (41, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (42, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (43, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (44, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (45, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (46, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_before_mission_start, 0, 0, 
    [
      (eq, "$fadefromblack", 1),
    ],
    [
      (start_presentation, "prsnt_fade_from_black", 0),
    ]),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
      (get_player_agent_no, ":var1"),
      (try_begin),
        (neq, ":var1", ":var0"),
        (agent_set_team, ":var0", 7),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (agent_get_troop_id, ":var2", ":var0"),
        (troop_get_slot, ":var3", ":var2", 155),
        (eq, ":var3", 1),
        (agent_set_team, ":var0", 0),
        (1753, ":var0", 5),
        (troop_set_slot, ":var2", 155, 0),
        (try_begin),
          (troop_slot_eq, ":var2", 149, 3),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination, ":var0", pos1),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (try_begin),
        (this_or_next|eq, ":var2", "trp_sarleon_prison_guard"),
        (this_or_next|eq, ":var2", "trp_rav_prison_guard"),
        (this_or_next|eq, ":var2", "trp_dshar_prison_guard"),
        (this_or_next|eq, ":var2", "trp_fierd_prison_guard"),
        (eq, ":var2", "trp_empire_prison_guard"),
        (eq, ":var3", "trp_player"),
        (display_message, "@You've got the keys to the dungeon."),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (this_or_next|eq, "$talk_context", 18),
      (eq, "$talk_context", 19),
    ],
    [
      (call_script, "script_neutral_behavior_in_fight"),
      (mission_disable_talk),
    ]),

    (1, 0, ti_once, 
    [
      (eq, "$talk_context", 19),
    ],
    [
      (get_player_agent_no, ":var0"),
      (assign, reg6, ":var0"),
      (call_script, "script_activate_town_guard"),
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos4, ":var0"),
      (try_for_range, ":var1", "trp_npc_adonja", "trp_heroes_end"),
        (troop_slot_ge, ":var1", 149, 1),
        (str_store_troop_name, s4, ":var1"),
        (display_message, "str_s4_joins_prison_break"),
        (store_current_scene, ":var2"),
        (modify_visitors_at_site, ":var2"),
        (store_current_scene, ":var2"),
        (modify_visitors_at_site, ":var2"),
        (assign, ":var3", 24),
        (add_visitors_to_current_scene, ":var3", ":var1", 1, 0, 0),
        (troop_set_slot, ":var1", 155, 1),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (this_or_next|eq, "$g_mt_mode", 0),
        (eq, "$g_mt_mode", 1),
        (set_trigger_result, 1),
        (mission_enable_talk),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_remove_siege_objects"),
    ]),

    (3, 0, 0, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$talk_context", 18),
        (eq, "$talk_context", 19),
        (call_script, "script_deduct_casualties_from_garrison"),
        (jump_to_menu, "mnu_captivity_start_castle_defeat"),
        (assign, ":var0", "trp_heroes_end"),
        (try_for_range, ":var1", "trp_npc_adonja", ":var0"),
          (troop_set_slot, ":var1", 149, 0),
        (try_end),
        (mission_enable_talk),
        (finish_mission, 0),
      (else_try),
        (mission_enable_talk),
        (finish_mission, 0),
        (set_trigger_result, 1),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$talk_context", 19),
      (neg|main_hero_fallen, 0),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (all_enemies_defeated),
    ],
    [
      (call_script, "script_deduct_casualties_from_garrison"),
      (try_for_agents, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (troop_slot_ge, ":var1", 149, 2),
        (try_begin),
          (agent_is_alive, ":var0"),
          (troop_set_slot, ":var1", 149, 4),
        (else_try),
          (troop_set_slot, ":var1", 149, 5),
        (try_end),
      (try_end),
      (jump_to_menu, "mnu_sneak_into_town_caught_ran_away"),
      (mission_enable_talk),
      (finish_mission, 0),
    ]),

  ]),

  ("training_ground_trainer_talk", 0, -1,
  "Training.",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_before_mission_start, 0, 0, 
    [
      (eq, "$fadefromblack", 1),
    ],
    [
      (start_presentation, "prsnt_fade_from_black", 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (0, 1, 2, 
    [
      (lt, "$trainer_help_message", 2),
    ],
    [
      (try_begin),
        (eq, "$trainer_help_message", 0),
      (else_try),
      (try_end),
      (val_add, "$trainer_help_message", 1),
    ]),

  ]),

  ("training_ground_trainer_training", mtf_arena_fight, -1,
  "You will fight a match in the arena.",
  [
    (16, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_shield,itm_practice_sword,itm_practice_boots]),
    (17, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_practice_boots]),
    (18, mtef_team_2|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_practice_boots]),
    (19, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_boots]),
    (20, mtef_visitor_source, 0, 0, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_give_up_fight"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (set_jump_mission, "mt_training_ground_trainer_talk"),
      (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
      (reset_visitors),
      (set_jump_entry, 5),
      (jump_to_scene, "$g_training_ground_melee_training_scene"),
    ]),

    (1, 3, ti_once, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (set_jump_mission, "mt_training_ground_trainer_talk"),
      (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
      (reset_visitors),
      (set_jump_entry, 5),
      (jump_to_scene, "$g_training_ground_melee_training_scene"),
    ]),

    (1, 3, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 1),
      (num_active_teams_le, 1),
      (neg|main_hero_fallen),
      (assign, "$training_fight_won", 1),
    ],
    [
      (set_jump_mission, "mt_training_ground_trainer_talk"),
      (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
      (reset_visitors),
      (set_jump_entry, 5),
      (jump_to_scene, "$g_training_ground_melee_training_scene"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

  ]),

  ("training_ground_training", mtf_arena_fight, -1,
  "Training.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff]),
    (1, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff]),
    (2, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff]),
    (3, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff]),
    (4, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff]),
    (8, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (9, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (10, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (11, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (12, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (13, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (14, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (15, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_last_destroyed_gourds", 0),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_give_up_fight"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_training_ground_training_success_ratio", 0),
      (try_begin),
        (eq, "$g_encountered_party", "p_castle_noldor"),
        (change_screen_map),
      (else_try),
        (jump_to_menu, "mnu_training_ground_training_result"),
      (try_end),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (set_fixed_point_multiplier, 100),
        (entry_point_get_position, pos1, 0),
        (init_position, pos2),
        (position_set_y, pos2, "$g_training_ground_ranged_distance"),
        (position_transform_position_to_local, pos3, pos1, pos2),
        (copy_position, pos1, pos3),
        (assign, ":var0", 10),
        (assign, ":var1", 0),
        (try_for_range, ":var2", 0, ":var0"),
          (store_sub, ":var3", ":var2", ":var1"),
          (scene_prop_get_instance, ":var4", "spr_gourd", ":var3"),
          (copy_position, pos2, pos1),
          (init_position, pos0),
          (store_random_in_range, ":var5", 0, 360),
          (position_rotate_z, pos2, ":var5"),
          (store_random_in_range, ":var5", 50, 600),
          (position_move_x, pos2, ":var5"),
          (store_random_in_range, ":var5", 0, 360),
          (717, 3, 1, 2),
          (position_rotate_z, pos0, ":var5"),
          (position_transform_position_to_local, pos4, pos0, pos3),
          (position_transform_position_to_local, pos2, pos1, pos4),
          (position_set_z_to_ground_level, pos2),
          (position_move_z, pos2, 150),
          (assign, ":var6", 1),
          (try_for_range, ":var7", 0, 10),
            (eq, ":var6", 1),
            (neq, ":var3", ":var7"),
            (scene_prop_get_instance, ":var8", "spr_gourd", ":var7"),
            (prop_instance_get_position, pos3, ":var8"),
            (get_distance_between_positions, ":var9", pos2, pos3),
            (lt, ":var9", 100),
            (assign, ":var6", 0),
          (try_end),
          (try_begin),
            (eq, ":var6", 0),
            (val_add, ":var0", 1),
            (val_add, ":var1", 1),
          (else_try),
            (prop_instance_set_position, ":var4", pos2),
            (prop_instance_animate_to_position, ":var4", pos2, 1),
            (scene_prop_get_instance, ":var8", "spr_gourd_spike", ":var3"),
            (position_move_z, pos2, -150),
            (prop_instance_set_position, ":var8", pos2),
            (prop_instance_animate_to_position, ":var8", pos2, 1),
          (try_end),
        (try_end),
      (else_try),
        (eq, "$g_mt_mode", 3),
        (assign, ":var10", 0),
        (try_for_range, ":var2", 0, 100),
          (scene_prop_get_instance, ":var4", "spr_gourd", ":var2"),
          (scene_prop_get_instance, ":var8", "spr_gourd_spike", ":var2"),
          (ge, ":var4", 0),
          (ge, ":var8", 0),
          (val_add, ":var10", 1),
          (prop_instance_get_position, pos0, ":var8"),
          (position_move_z, pos0, 150),
          (prop_instance_set_position, ":var4", pos0),
          (prop_instance_animate_to_position, ":var4", pos0, 1),
        (try_end),
        (store_sub, ":var0", ":var10", "$g_training_ground_training_num_gourds_to_destroy"),
        (try_for_range, ":var2", 0, ":var0"),
          (store_random_in_range, ":var11", 0, ":var10"),
          (scene_prop_get_instance, ":var4", "spr_gourd", ":var11"),
          (prop_instance_get_position, pos0, ":var4"),
          (position_get_z, ":var12", pos0),
          (try_begin),
            (lt, ":var12", -50000),
          (else_try),
            (position_set_z, pos0, -100000),
            (prop_instance_set_position, ":var4", pos0),
            (prop_instance_animate_to_position, ":var4", pos0, 1),
            (scene_prop_get_instance, ":var8", "spr_gourd_spike", ":var11"),
            (prop_instance_set_position, ":var8", pos0),
            (prop_instance_animate_to_position, ":var8", pos0, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (1, 3, ti_once, 
    [
      (eq, "$g_mt_mode", 1),
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_training_ground_training_success_ratio", 100),
      (else_try),
        (assign, ":var0", 0),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var2", ":var1"),
          (eq, ":var2", 1),
          (val_add, ":var0", 1),
        (try_end),
        (store_sub, ":var3", "$g_training_ground_training_num_enemies", ":var0"),
        (store_mul, "$g_training_ground_training_success_ratio", ":var3", 100),
        (val_div, "$g_training_ground_training_success_ratio", "$g_training_ground_training_num_enemies"),
      (try_end),
      (try_begin),
        (eq, "$g_encountered_party", "p_castle_noldor"),
        (change_screen_map),
      (else_try),
        (jump_to_menu, "mnu_training_ground_training_result"),
      (try_end),
      (finish_mission),
    ]),

    (1, 3, ti_once, 
    [
      (eq, "$g_mt_mode", 2),
      (get_player_agent_no, ":var0"),
      (agent_get_ammo, ":var1", ":var0"),
      (store_mission_timer_a, ":var2"),
      (this_or_next|main_hero_fallen),
      (this_or_next|eq, ":var1", 0),
      (gt, ":var2", 116),
    ],
    [
      (store_mul, "$g_training_ground_training_success_ratio", "$scene_num_total_gourds_destroyed", 10),
      (jump_to_menu, "mnu_training_ground_training_result"),
      (finish_mission),
    ]),

    (1, 3, ti_once, 
    [
      (eq, "$g_mt_mode", 3),
      (get_player_agent_no, ":var0"),
      (agent_get_horse, ":var1", ":var0"),
      (store_mission_timer_a, ":var2"),
      (this_or_next|lt, ":var1", 0),
      (this_or_next|main_hero_fallen),
      (this_or_next|ge, "$scene_num_total_gourds_destroyed", "$g_training_ground_training_num_gourds_to_destroy"),
      (gt, ":var2", 120),
    ],
    [
      (store_mul, "$g_training_ground_training_success_ratio", "$scene_num_total_gourds_destroyed", 100),
      (val_div, "$g_training_ground_training_success_ratio", "$g_training_ground_training_num_gourds_to_destroy"),
      (jump_to_menu, "mnu_training_ground_training_result"),
      (finish_mission),
    ]),

    (0, 0, 0, 
    [
      (gt, "$g_last_destroyed_gourds", 0),
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (entry_point_get_position, pos1, 0),
        (position_move_y, pos1, 100, 0),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos2, ":var0"),
        (try_begin),
          (714, 2, 1),
          (val_add, "$scene_num_total_gourds_destroyed", "$g_last_destroyed_gourds"),
        (else_try),
          (display_message, "@You must stay behind the line on the ground! Point is not counted."),
        (try_end),
      (else_try),
        (val_add, "$scene_num_total_gourds_destroyed", "$g_last_destroyed_gourds"),
      (try_end),
      (assign, "$g_last_destroyed_gourds", 0),
    ],
    []),

  ]),

  ("sneak_caught_fight", mtf_battle_mode, -1,
  "You must fight your way out!",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_all, aif_start_alarmed, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, af_override_all, aif_start_alarmed, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_lute,itm_hidden_dagger,itm_only_sandals,itm_throwing_daggers]),
    (2, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (5, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (6, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (7, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (8, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (9, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (10, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (11, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (12, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (13, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (14, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (15, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (64, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (assign, ":var0", 5),
      (try_begin),
        (party_get_slot, ":var1", "$current_town", 240),
        (store_current_hours, ":var2"),
        (store_add, ":var3", ":var1", 4),
        (is_between, ":var2", ":var3", ":var1"),
        (assign, ":var0", 2),
      (else_try),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (assign, ":var0", 4),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (entry_point_get_position, pos0, 7),
      (else_try),
        (party_slot_eq, "$current_town", 0, 3),
        (entry_point_get_position, pos0, 0),
      (else_try),
        (entry_point_get_position, pos0, 1),
      (try_end),
      (assign, ":var4", -1),
      (assign, ":var5", -1),
      (try_for_range, ":var6", 0, ":var0"),
        (assign, ":var7", 100000),
        (try_for_range, ":var8", 2, 64),
          (neq, ":var5", ":var8"),
          (entry_point_get_position, pos1, ":var8"),
          (get_distance_between_positions, ":var9", pos0, pos1),
          (lt, ":var9", ":var7"),
          (gt, ":var9", ":var4"),
          (assign, ":var7", ":var9"),
          (assign, ":var10", ":var8"),
        (try_end),
        (store_faction_of_party, ":var11", "$current_town"),
        (try_begin),
          (this_or_next|eq, ":var6", 0),
          (eq, ":var6", 2),
          (faction_get_slot, ":var12", ":var11", 43),
        (else_try),
          (faction_get_slot, ":var12", ":var11", 42),
        (try_end),
        (assign, ":var5", ":var10"),
        (assign, ":var4", ":var7"),
        (add_visitors_to_current_scene, ":var10", ":var12", 1, 0),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_do_you_wish_to_surrender"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (jump_to_menu, "mnu_captivity_start_castle_defeat"),
      (finish_mission, 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (play_sound, "snd_sneak_town_halt"),
      (call_script, "script_music_set_situation_with_culture", 1024),
    ]),

    (0, 3, 0, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (jump_to_menu, "mnu_captivity_start_castle_defeat"),
      (finish_mission, 0),
    ]),

    (1, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (eq, ":var2", 1),
        (agent_get_position, pos1, ":var1"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (try_begin),
          (le, ":var3", 800),
          (agent_clear_scripted_mode, ":var1"),
        (else_try),
          (agent_set_scripted_destination, ":var1", pos0, 0),
        (try_end),
      (try_end),
    ]),

    (5, 1, ti_once, 
    [
      (num_active_teams_le, 1),
      (neg|main_hero_fallen),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (assign, "$auto_menu", -1),
      (jump_to_menu, "mnu_sneak_into_town_caught_dispersed_guards"),
      (finish_mission, 1),
    ]),

    (ti_on_leave_area, 0, ti_once, 
    [],
    [
      (assign, "$auto_menu", -1),
      (jump_to_menu, "mnu_sneak_into_town_caught_ran_away"),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

  ]),

  ("ai_training", 0, -1,
  "You start training.",
  [
    (0, 0, 0, aif_start_alarmed, 30, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (finish_mission, 0),
    ]),

  ]),

  ("camera_test", 0, -1,
  "camera Test.",
  [
  ],
  [
    (1, 0, 0, 
    [
      (mission_cam_set_mode, 1),
      (entry_point_get_position, pos3, 3),
      (mission_cam_set_position, pos3),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (finish_mission, 0),
    ]),

  ]),

  ("ai_training_with_formations", 0, -1,
  "You start training.",
  [
    (0, 0, 0, aif_start_alarmed, 30, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (finish_mission, 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (mission_disable_talk),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, 0, 
    [],
    [
      (try_begin),
        (this_or_next|key_is_down, key_left_control),
        (key_is_down, key_right_control),
        (try_begin),
          (key_clicked, key_h),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (else_try),
          (this_or_next|key_is_down, key_left_alt),
          (key_is_down, key_right_alt),
          (key_clicked, key_f4),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (try_end),
      (try_end),
      (game_key_clicked, 22),
      (neg|903, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (903, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_set_disciplined_faction"),
      (try_begin),
        (eq, "$g_option_formations", 1),
        (assign, "$gk_order", 0),
        (assign, "$gk_order_hold_over_there", 0),
        (assign, "$autorotate_at_player", 1),
        (assign, "$infantry_formation_type", 1),
        (assign, "$archer_formation_type", 1),
        (assign, "$cavalry_formation_type", 4),
        (assign, "$infantry_space", 2),
        (assign, "$archer_space", 2),
        (assign, "$cavalry_space", 0),
        (assign, "$fclock", 1),
        (assign, "$yield", 0),
      (try_end),
    ]),

    (0.1, 0, ti_once, 
    [],
    [
      (assign, "$yield", 0),
      (call_script, "script_get_yield"),
      (val_add, "$yield", 50),
    ]),

    (0, 0.4, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$g_option_formations", 1),
        (get_player_agent_no, "$fplayer_agent_no"),
        (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
        (assign, ":var0", 0),
        (assign, ":var1", 0),
        (assign, ":var2", 0),
        (assign, ":var3", 0),
        (assign, "$team0_size", 0),
        (assign, "$team1_size", 0),
        (assign, "$team2_size", 0),
        (assign, "$team3_size", 0),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_get_team, ":var5", ":var4"),
          (agent_get_troop_id, ":var6", ":var4"),
          (store_troop_faction, ":var7", ":var6"),
          (try_begin),
            (eq, ":var5", 0),
            (val_add, ":var0", ":var7"),
            (val_add, "$team0_size", 1),
          (else_try),
            (eq, ":var5", 1),
            (val_add, ":var1", ":var7"),
            (val_add, "$team1_size", 1),
          (else_try),
            (eq, ":var5", 2),
            (val_add, ":var2", ":var7"),
            (val_add, "$team2_size", 1),
          (else_try),
            (eq, ":var5", 3),
            (val_add, ":var3", ":var7"),
            (val_add, "$team3_size", 1),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team0_size", 0),
          (team_get_leader, ":var8", 0),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team0_faction", ":var9"),
          (else_try),
            (store_mul, "$team0_faction", ":var0", 10),
            (val_div, "$team0_faction", "$team0_size"),
            (val_add, "$team0_faction", 5),
            (val_div, "$team0_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team1_size", 0),
          (team_get_leader, ":var8", 1),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team1_faction", ":var9"),
          (else_try),
            (store_mul, "$team1_faction", ":var1", 10),
            (val_div, "$team1_faction", "$team1_size"),
            (val_add, "$team1_faction", 5),
            (val_div, "$team1_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team2_size", 0),
          (team_get_leader, ":var8", 2),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team2_faction", ":var9"),
          (else_try),
            (store_mul, "$team2_faction", ":var2", 10),
            (val_div, "$team2_faction", "$team2_size"),
            (val_add, "$team2_faction", 5),
            (val_div, "$team2_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team3_size", 0),
          (team_get_leader, ":var8", 3),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team3_faction", ":var9"),
          (else_try),
            (store_mul, "$team3_faction", ":var3", 10),
            (val_div, "$team3_faction", "$team3_size"),
            (val_add, "$team3_faction", 5),
            (val_div, "$team3_faction", 10),
          (try_end),
        (try_end),
      (try_end),
      (call_script, "script_initial_battle_positions"),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_j),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_ranks_fem", 19),
        (else_try),
          (599, "snd_th3_formation_ranks", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 2),
      (call_script, "script_player_attempt_formation", 1, 2),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_k),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_shield_fem", 19),
        (else_try),
          (599, "snd_th3_formation_shield", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 3),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_l),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_wedge_fem", 19),
        (else_try),
          (599, "snd_th3_formation_wedge", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 4),
      (call_script, "script_player_attempt_formation", 2, 4),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_semicolon),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_square_fem", 19),
        (else_try),
          (599, "snd_th3_formation_square", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 5),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_u),
    ],
    [
      (call_script, "script_player_order_formations", 2),
    ]),

    (0, 0.3, 0, 
    [
      (eq, "$g_option_formations", 1),
      (game_key_clicked, 23),
    ],
    [
      (eq, "$gk_order", 23),
      (game_key_is_down, 23),
      (assign, "$gk_order_hold_over_there", 1),
      (assign, "$gk_order", 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 23),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 0),
        (assign, "$gk_order", 23),
      (else_try),
        (try_begin),
          (eq, "$gk_order", 23),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_hold_fem", 19),
            (else_try),
              (599, "snd_th3_order_hold", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 0),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 24),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_advance_fem", 19),
            (else_try),
              (599, "snd_th3_order_advance", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 5),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 25),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_holdfire_fem", 19),
            (else_try),
              (599, "snd_snouz_order_holdfire", 19),
            (try_end),
          (try_end),
          (assign, "$gk_order", 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (game_key_clicked, 24),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 0),
        (assign, "$gk_order", 24),
      (else_try),
        (try_begin),
          (eq, "$gk_order", 23),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_follow_fem", 19),
            (else_try),
              (599, "snd_th3_order_follow", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 1),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 24),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_fallback_fem", 19),
            (else_try),
              (599, "snd_th3_order_fallback", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 6),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 25),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_fireatwill_fem", 19),
            (else_try),
              (599, "snd_snouz_order_fireatwill", 19),
            (try_end),
          (try_end),
          (assign, "$gk_order", 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 25),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 0),
        (assign, "$gk_order", 25),
      (else_try),
        (try_begin),
          (eq, "$gk_order", 23),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_charge_fem", 19),
            (else_try),
              (599, "snd_th3_order_charge", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 2),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 24),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_spreadout_fem", 19),
            (else_try),
              (599, "snd_snouz_order_spreadout", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 8),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 25),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_bluntweapons_fem", 19),
            (else_try),
              (599, "snd_snouz_order_bluntweapons", 19),
            (try_end),
          (try_end),
          (assign, "$gk_order", 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (game_key_clicked, 26),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 23),
        (call_script, "script_player_order_formations", 11),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 24),
        (call_script, "script_player_order_formations", 7),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_standcloser_fem", 19),
          (else_try),
            (599, "snd_snouz_order_standcloser", 19),
          (try_end),
        (try_end),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 25),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_anyweapons_fem", 19),
          (else_try),
            (599, "snd_snouz_order_anyweapons", 19),
          (try_end),
        (try_end),
        (assign, "$gk_order", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 27),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 23),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_retreat_fem", 19),
          (else_try),
            (599, "snd_th3_order_retreat", 19),
          (try_end),
        (try_end),
        (call_script, "script_player_order_formations", 14),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 24),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_mount_fem", 19),
          (else_try),
            (599, "snd_snouz_order_mount", 19),
          (try_end),
        (try_end),
        (assign, "$gk_order", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 28),
    ],
    [
      (eq, "$gk_order", 24),
      (try_begin),
        (class_is_listening_order, "$fplayer_team_no", 2),
        (call_script, "script_formation_end", "$fplayer_team_no", 2),
      (try_end),
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_order_dismount_fem", 19),
        (else_try),
          (599, "snd_snouz_order_dismount", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_order_formations", 4),
      (assign, "$gk_order", 0),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_1),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_infantry_fem", 19),
        (else_try),
          (599, "snd_th3_address_infantry", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_2),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_archers_fem", 19),
        (else_try),
          (599, "snd_th3_address_archers", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_3),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_cavalry_fem", 19),
        (else_try),
          (599, "snd_th3_address_cavalry", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_0),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_everyone_fem", 19),
        (else_try),
          (599, "snd_th3_address_everyone", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (this_or_next|key_clicked, key_1),
      (this_or_next|key_clicked, key_2),
      (this_or_next|key_clicked, key_3),
      (this_or_next|key_clicked, key_4),
      (this_or_next|key_clicked, key_5),
      (this_or_next|key_clicked, key_6),
      (this_or_next|key_clicked, key_7),
      (this_or_next|key_clicked, key_8),
      (this_or_next|key_clicked, key_9),
      (this_or_next|key_clicked, key_0),
      (key_clicked, key_escape),
    ],
    [
      (assign, "$gk_order", 0),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (eq, "$gk_order_hold_over_there", 1),
      (neg|game_key_is_down, 23),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_order_hold_fem", 19),
        (else_try),
          (599, "snd_th3_order_hold", 19),
        (try_end),
      (try_end),
      (call_script, "script_team_get_average_position_of_enemies_augmented", 60, "$fplayer_team_no", 9),
      (assign, ":var3", 0),
      (try_for_range, reg36, 0, 9),
        (class_is_listening_order, "$fplayer_team_no", reg36),
        (val_add, ":var3", 1),
      (try_end),
      (agent_get_position, pos21, "$fplayer_agent_no"),
      (try_begin),
        (neq, "$infantry_formation_type", 0),
        (class_is_listening_order, "$fplayer_team_no", 0),
        (team_get_order_position, pos2, "$fplayer_team_no", 0),
        (call_script, "script_point_y_toward_position", 2, 60),
        (try_begin),
          (gt, ":var3", 1),
          (agent_set_position, "$fplayer_agent_no", pos2),
          (try_begin),
            (call_script, "script_cf_formation", "$fplayer_team_no", 0, "$infantry_space", "$infantry_formation_type"),
          (try_end),
        (else_try),
          (assign, ":var4", 0),
          (try_for_agents, reg36),
            (call_script, "script_cf_valid_formation_member", "$fplayer_team_no", 0, "$fplayer_agent_no", reg36),
            (val_add, ":var4", 1),
          (try_end),
          (call_script, "script_get_centering_amount", "$infantry_formation_type", ":var4", "$infantry_space"),
          (position_move_x, pos2, reg0),
          (copy_position, pos1, pos2),
          (call_script, "script_set_formation_position", "$fplayer_team_no", 0, 1),
          (call_script, "script_form_infantry", "$fplayer_team_no", "$fplayer_agent_no", "$infantry_space", "$infantry_formation_type"),
        (try_end),
        (assign, "$infantry_formation_move_order", 0),
      (try_end),
      (try_begin),
        (neq, "$cavalry_formation_type", 0),
        (class_is_listening_order, "$fplayer_team_no", 2),
        (team_get_order_position, pos2, "$fplayer_team_no", 2),
        (call_script, "script_point_y_toward_position", 2, 60),
        (try_begin),
          (gt, ":var3", 1),
          (agent_set_position, "$fplayer_agent_no", pos2),
          (try_begin),
            (call_script, "script_cf_formation", "$fplayer_team_no", 2, "$cavalry_space", "$cavalry_formation_type"),
          (try_end),
        (else_try),
          (copy_position, pos1, pos2),
          (call_script, "script_set_formation_position", "$fplayer_team_no", 2, 1),
          (call_script, "script_form_cavalry", "$fplayer_team_no", "$fplayer_agent_no", "$cavalry_space"),
        (try_end),
        (assign, "$cavalry_formation_move_order", 0),
      (try_end),
      (try_begin),
        (neq, "$archer_formation_type", 0),
        (class_is_listening_order, "$fplayer_team_no", 1),
        (team_get_order_position, pos2, "$fplayer_team_no", 1),
        (call_script, "script_point_y_toward_position", 2, 60),
        (try_begin),
          (gt, ":var3", 1),
          (agent_set_position, "$fplayer_agent_no", pos2),
          (try_begin),
            (call_script, "script_cf_formation", "$fplayer_team_no", 1, "$archer_space", "$archer_formation_type"),
          (try_end),
        (else_try),
          (assign, ":var4", 0),
          (try_for_agents, reg36),
            (call_script, "script_cf_valid_formation_member", "$fplayer_team_no", 1, "$fplayer_agent_no", reg36),
            (val_add, ":var4", 1),
          (try_end),
          (call_script, "script_get_centering_amount", 1, ":var4", "$archer_space"),
          (val_mul, reg0, -1),
          (position_move_x, pos2, reg0),
          (copy_position, pos1, pos2),
          (call_script, "script_set_formation_position", "$fplayer_team_no", 1, 1),
          (call_script, "script_form_archers", "$fplayer_team_no", "$fplayer_agent_no", "$archer_space", "$archer_formation_type"),
        (try_end),
        (assign, "$archer_formation_move_order", 0),
      (try_end),
      (agent_set_position, "$fplayer_agent_no", pos21),
      (assign, "$gk_order_hold_over_there", 0),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (neg|key_is_down, key_j),
      (neg|key_is_down, key_k),
      (neg|key_is_down, key_l),
      (neg|key_is_down, key_semicolon),
      (neg|key_is_down, key_u),
      (neg|game_key_is_down, 23),
      (neg|game_key_is_down, 24),
      (neg|game_key_is_down, 25),
      (neg|game_key_is_down, 26),
      (neg|game_key_is_down, 27),
      (neg|game_key_is_down, 28),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (store_mod, ":var0", "$fclock", 5),
      (call_script, "script_team_get_average_position_of_enemies_augmented", 60, "$fplayer_team_no", 9),
      (try_begin),
        (eq, reg0, 0),
        (neq, "$g_encountered_party", -1),
        (call_script, "script_formation_end", "$fplayer_team_no", 9),
      (else_try),
        (assign, "$autorotate_at_player", 0),
        (try_begin),
          (neq, "$infantry_formation_type", 0),
          (try_begin),
            (eq, "$infantry_formation_move_order", 1),
            (call_script, "script_cf_formation", "$fplayer_team_no", 0, "$infantry_space", "$infantry_formation_type"),
          (else_try),
            (eq, ":var0", 0),
            (call_script, "script_get_formation_position", 0, "$fplayer_team_no", 0),
            (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", "$fplayer_team_no", 0),
            (call_script, "script_point_y_toward_position", 1, 60),
            (position_copy_rotation, pos0, pos1),
            (call_script, "script_set_formation_position", "$fplayer_team_no", 0, 0),
            (copy_position, pos1, pos0),
            (call_script, "script_form_infantry", "$fplayer_team_no", "$fplayer_agent_no", "$infantry_space", "$infantry_formation_type"),
          (try_end),
        (try_end),
        (try_begin),
          (neq, "$cavalry_formation_type", 0),
          (try_begin),
            (eq, "$cavalry_formation_move_order", 1),
            (call_script, "script_cf_formation", "$fplayer_team_no", 2, "$cavalry_space", "$cavalry_formation_type"),
          (else_try),
            (eq, ":var0", 0),
            (call_script, "script_get_formation_position", 0, "$fplayer_team_no", 2),
            (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", "$fplayer_team_no", 2),
            (call_script, "script_point_y_toward_position", 1, 60),
            (position_copy_rotation, pos0, pos1),
            (call_script, "script_set_formation_position", "$fplayer_team_no", 2, 0),
            (copy_position, pos1, pos0),
            (call_script, "script_form_cavalry", "$fplayer_team_no", "$fplayer_agent_no", "$cavalry_space"),
          (try_end),
        (try_end),
        (try_begin),
          (neq, "$archer_formation_type", 0),
          (try_begin),
            (eq, "$archer_formation_move_order", 1),
            (call_script, "script_cf_formation", "$fplayer_team_no", 1, "$archer_space", "$archer_formation_type"),
          (else_try),
            (eq, ":var0", 0),
            (call_script, "script_get_formation_position", 0, "$fplayer_team_no", 1),
            (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", "$fplayer_team_no", 1),
            (call_script, "script_point_y_toward_position", 1, 60),
            (position_copy_rotation, pos0, pos1),
            (call_script, "script_set_formation_position", "$fplayer_team_no", 1, 0),
            (copy_position, pos1, pos0),
            (call_script, "script_form_archers", "$fplayer_team_no", "$fplayer_agent_no", "$archer_space", "$archer_formation_type"),
          (try_end),
        (try_end),
        (assign, "$autorotate_at_player", 1),
      (try_end),
      (val_add, "$fclock", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_option_formations", 1),
        (assign, "$cur_casualties", 0),
        (assign, "$prev_casualties", 0),
        (assign, "$prev_casualties2", 0),
        (assign, "$ranged_clock", 1),
        (assign, "$battle_phase", 1),
        (assign, "$clock_reset", 0),
        (assign, "$charge_activated", 0),
        (assign, "$charge_ongoing", 0),
        (assign, "$inf_charge_activated", 0),
        (assign, "$inf_charge_ongoing", 0),
        (assign, "$arc_charge_activated", 0),
        (assign, "$att_reinforcements_arrived", 0),
        (assign, "$def_reinforcements_arrived", 0),
        (assign, "$att_reinforcements_needed", 0),
        (assign, "$def_reinforcements_needed", 0),
        (assign, "$disengage", 0),
        (assign, "$patrol_mode", 0),
        (store_random_in_range, "$rand0", -1000, 1000),
        (store_random_in_range, "$rand2", 800, 1501),
        (store_random_in_range, "$rand1", 0, 501),
        (store_random_in_range, "$rand3", 2000, 3001),
        (store_random_in_range, "$rand4", 1000, 3001),
        (store_random_in_range, "$rand5", -1000, 0),
        (store_random_in_range, "$rand6", 4000, 5001),
        (store_random_in_range, "$rand7", 49, 56),
        (store_random_in_range, "$rand8", -100, 101),
        (assign, "$team0_default_formation", 1),
        (assign, "$team1_default_formation", 1),
        (assign, "$team2_default_formation", 1),
        (assign, "$team3_default_formation", 1),
        (init_position, pos56),
        (init_position, pos57),
        (init_position, pos58),
        (init_position, pos59),
        (assign, "$team0_reinforcement_stage", 0),
        (assign, "$team1_reinforcement_stage", 0),
        (init_position, pos17),
        (init_position, pos18),
      (try_end),
    ]),

    (0, 0.5, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$g_option_formations", 1),
        (eq, "$g_disciplined_faction", 1),
        (try_for_agents, ":var0"),
          (agent_set_slot, ":var0", 15, 0),
        (try_end),
        (set_fixed_point_multiplier, 100),
        (call_script, "script_store_battlegroup_data"),
        (call_script, "script_battlegroup_get_position", 12, 0, 9),
        (call_script, "script_battlegroup_get_position", 13, 1, 9),
        (call_script, "script_battlegroup_get_position", 14, 2, 9),
        (call_script, "script_battlegroup_get_position", 16, 3, 9),
        (call_script, "script_field_tactics", 1),
      (try_end),
    ]),

    (60, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (eq, "$g_disciplined_faction", 1),
    ],
    [
      (store_random_in_range, "$rand0", -1000, 1000),
      (store_random_in_range, "$rand2", 800, 1501),
      (store_random_in_range, "$rand1", -1000, 1000),
      (store_random_in_range, "$rand3", 2000, 3001),
      (store_random_in_range, "$rand4", 1000, 3001),
      (store_random_in_range, "$rand5", -1000, 0),
      (store_random_in_range, "$rand6", 4000, 5001),
      (store_random_in_range, "$rand7", 45, 56),
      (store_random_in_range, "$rand8", -100, 101),
    ]),

    (1, 0.9, 0, 
    [
      (eq, "$g_option_formations", 1),
      (eq, "$g_disciplined_faction", 1),
    ],
    [
      (try_begin),
        (assign, "$prev_casualties2", "$cur_casualties"),
        (call_script, "script_cf_count_casualties"),
        (assign, "$cur_casualties", reg0),
        (assign, "$battle_phase", 3),
      (try_end),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_store_battlegroup_data"),
      (try_begin),
        (eq, "$battle_phase", 3),
        (eq, "$clock_reset", 0),
        (call_script, "script_field_tactics", 1),
        (assign, "$ranged_clock", 0),
        (assign, "$clock_reset", 1),
      (else_try),
        (ge, "$battle_phase", 2),
        (store_mod, reg0, "$ranged_clock", 5),
        (eq, reg0, 0),
        (call_script, "script_field_tactics", 1),
        (assign, "$team0_reinforcement_stage", "$defender_reinforcement_stage"),
        (assign, "$team1_reinforcement_stage", "$attacker_reinforcement_stage"),
      (else_try),
        (call_script, "script_field_tactics", 0),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 1),
        (assign, ":var0", 0),
        (try_for_range, ":var1", 0, 4),
          (neq, ":var1", "$fplayer_team_no"),
          (call_script, "script_battlegroup_get_size", ":var1", 9),
          (gt, reg0, 0),
          (call_script, "script_battlegroup_get_position", 1, ":var1", 1),
          (team_get_order_position, pos0, ":var1", 1),
          (get_distance_between_positions, reg0, pos0, pos1),
          (gt, reg0, 500),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 0),
        (assign, "$battle_phase", 2),
      (try_end),
      (val_add, "$ranged_clock", 1),
    ]),

  ]),

  ("camp_review_soldiers", 0, -1,
  "You review your soldiers.",
  [
    (0, 0, 0, aif_start_alarmed, 30, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (finish_mission, 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (mission_disable_talk),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_set_disciplined_faction"),
      (try_begin),
        (eq, "$g_option_formations", 1),
        (assign, "$gk_order", 0),
        (assign, "$gk_order_hold_over_there", 0),
        (assign, "$autorotate_at_player", 1),
        (assign, "$infantry_formation_type", 1),
        (assign, "$archer_formation_type", 1),
        (assign, "$cavalry_formation_type", 4),
        (assign, "$infantry_space", 2),
        (assign, "$archer_space", 2),
        (assign, "$cavalry_space", 0),
        (assign, "$fclock", 1),
        (assign, "$yield", 0),
      (try_end),
    ]),

    (0.1, 0, ti_once, 
    [],
    [
      (assign, "$yield", 0),
      (call_script, "script_get_yield"),
      (val_add, "$yield", 50),
    ]),

    (0, 0.4, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$g_option_formations", 1),
        (get_player_agent_no, "$fplayer_agent_no"),
        (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
        (assign, ":var0", 0),
        (assign, ":var1", 0),
        (assign, ":var2", 0),
        (assign, ":var3", 0),
        (assign, "$team0_size", 0),
        (assign, "$team1_size", 0),
        (assign, "$team2_size", 0),
        (assign, "$team3_size", 0),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_get_team, ":var5", ":var4"),
          (agent_get_troop_id, ":var6", ":var4"),
          (store_troop_faction, ":var7", ":var6"),
          (try_begin),
            (eq, ":var5", 0),
            (val_add, ":var0", ":var7"),
            (val_add, "$team0_size", 1),
          (else_try),
            (eq, ":var5", 1),
            (val_add, ":var1", ":var7"),
            (val_add, "$team1_size", 1),
          (else_try),
            (eq, ":var5", 2),
            (val_add, ":var2", ":var7"),
            (val_add, "$team2_size", 1),
          (else_try),
            (eq, ":var5", 3),
            (val_add, ":var3", ":var7"),
            (val_add, "$team3_size", 1),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team0_size", 0),
          (team_get_leader, ":var8", 0),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team0_faction", ":var9"),
          (else_try),
            (store_mul, "$team0_faction", ":var0", 10),
            (val_div, "$team0_faction", "$team0_size"),
            (val_add, "$team0_faction", 5),
            (val_div, "$team0_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team1_size", 0),
          (team_get_leader, ":var8", 1),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team1_faction", ":var9"),
          (else_try),
            (store_mul, "$team1_faction", ":var1", 10),
            (val_div, "$team1_faction", "$team1_size"),
            (val_add, "$team1_faction", 5),
            (val_div, "$team1_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team2_size", 0),
          (team_get_leader, ":var8", 2),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team2_faction", ":var9"),
          (else_try),
            (store_mul, "$team2_faction", ":var2", 10),
            (val_div, "$team2_faction", "$team2_size"),
            (val_add, "$team2_faction", 5),
            (val_div, "$team2_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team3_size", 0),
          (team_get_leader, ":var8", 3),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_troop_faction, "$team3_faction", ":var9"),
          (else_try),
            (store_mul, "$team3_faction", ":var3", 10),
            (val_div, "$team3_faction", "$team3_size"),
            (val_add, "$team3_faction", 5),
            (val_div, "$team3_faction", 10),
          (try_end),
        (try_end),
      (try_end),
      (call_script, "script_initial_battle_positions"),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_j),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_ranks_fem", 19),
        (else_try),
          (599, "snd_th3_formation_ranks", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 2),
      (call_script, "script_player_attempt_formation", 1, 2),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_k),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_shield_fem", 19),
        (else_try),
          (599, "snd_th3_formation_shield", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 3),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_l),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_wedge_fem", 19),
        (else_try),
          (599, "snd_th3_formation_wedge", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 4),
      (call_script, "script_player_attempt_formation", 2, 4),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_semicolon),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_formation_square_fem", 19),
        (else_try),
          (599, "snd_th3_formation_square", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_attempt_formation", 0, 5),
    ]),

    (0, 0, 1, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_u),
    ],
    [
      (call_script, "script_player_order_formations", 2),
    ]),

    (0, 0.3, 0, 
    [
      (eq, "$g_option_formations", 1),
      (game_key_clicked, 23),
    ],
    [
      (eq, "$gk_order", 23),
      (game_key_is_down, 23),
      (assign, "$gk_order_hold_over_there", 1),
      (assign, "$gk_order", 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 23),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 0),
        (assign, "$gk_order", 23),
      (else_try),
        (try_begin),
          (eq, "$gk_order", 23),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_hold_fem", 19),
            (else_try),
              (599, "snd_th3_order_hold", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 0),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 24),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_advance_fem", 19),
            (else_try),
              (599, "snd_th3_order_advance", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 5),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 25),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_holdfire_fem", 19),
            (else_try),
              (599, "snd_snouz_order_holdfire", 19),
            (try_end),
          (try_end),
          (assign, "$gk_order", 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (game_key_clicked, 24),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 0),
        (assign, "$gk_order", 24),
      (else_try),
        (try_begin),
          (eq, "$gk_order", 23),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_follow_fem", 19),
            (else_try),
              (599, "snd_th3_order_follow", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 1),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 24),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_fallback_fem", 19),
            (else_try),
              (599, "snd_th3_order_fallback", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 6),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 25),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_fireatwill_fem", 19),
            (else_try),
              (599, "snd_snouz_order_fireatwill", 19),
            (try_end),
          (try_end),
          (assign, "$gk_order", 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 25),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 0),
        (assign, "$gk_order", 25),
      (else_try),
        (try_begin),
          (eq, "$gk_order", 23),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_charge_fem", 19),
            (else_try),
              (599, "snd_th3_order_charge", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 2),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 24),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_spreadout_fem", 19),
            (else_try),
              (599, "snd_snouz_order_spreadout", 19),
            (try_end),
          (try_end),
          (call_script, "script_player_order_formations", 8),
          (assign, "$gk_order", 0),
        (else_try),
          (eq, "$gk_order", 25),
          (try_begin),
            (store_random_in_range, ":var0", 1, 101),
            (le, ":var0", "$yield"),
            (get_player_agent_no, ":var1"),
            (agent_get_position, pos19, ":var1"),
            (troop_get_type, ":var2", "trp_player"),
            (try_begin),
              (is_between, ":var2", 1, 3),
              (599, "snd_snouz_order_bluntweapons_fem", 19),
            (else_try),
              (599, "snd_snouz_order_bluntweapons", 19),
            (try_end),
          (try_end),
          (assign, "$gk_order", 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (game_key_clicked, 26),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 23),
        (call_script, "script_player_order_formations", 11),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 24),
        (call_script, "script_player_order_formations", 7),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_standcloser_fem", 19),
          (else_try),
            (599, "snd_snouz_order_standcloser", 19),
          (try_end),
        (try_end),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 25),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_anyweapons_fem", 19),
          (else_try),
            (599, "snd_snouz_order_anyweapons", 19),
          (try_end),
        (try_end),
        (assign, "$gk_order", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 27),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 23),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_retreat_fem", 19),
          (else_try),
            (599, "snd_th3_order_retreat", 19),
          (try_end),
        (try_end),
        (call_script, "script_player_order_formations", 14),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 24),
        (try_begin),
          (store_random_in_range, ":var0", 1, 101),
          (le, ":var0", "$yield"),
          (get_player_agent_no, ":var1"),
          (agent_get_position, pos19, ":var1"),
          (troop_get_type, ":var2", "trp_player"),
          (try_begin),
            (is_between, ":var2", 1, 3),
            (599, "snd_snouz_order_mount_fem", 19),
          (else_try),
            (599, "snd_snouz_order_mount", 19),
          (try_end),
        (try_end),
        (assign, "$gk_order", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, 28),
    ],
    [
      (eq, "$gk_order", 24),
      (try_begin),
        (class_is_listening_order, "$fplayer_team_no", 2),
        (call_script, "script_formation_end", "$fplayer_team_no", 2),
      (try_end),
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_order_dismount_fem", 19),
        (else_try),
          (599, "snd_snouz_order_dismount", 19),
        (try_end),
      (try_end),
      (call_script, "script_player_order_formations", 4),
      (assign, "$gk_order", 0),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_1),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_infantry_fem", 19),
        (else_try),
          (599, "snd_th3_address_infantry", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_2),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_archers_fem", 19),
        (else_try),
          (599, "snd_th3_address_archers", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_3),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_cavalry_fem", 19),
        (else_try),
          (599, "snd_th3_address_cavalry", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (key_clicked, key_0),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_th3_address_everyone_fem", 19),
        (else_try),
          (599, "snd_th3_address_everyone", 19),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (this_or_next|key_clicked, key_1),
      (this_or_next|key_clicked, key_2),
      (this_or_next|key_clicked, key_3),
      (this_or_next|key_clicked, key_4),
      (this_or_next|key_clicked, key_5),
      (this_or_next|key_clicked, key_6),
      (this_or_next|key_clicked, key_7),
      (this_or_next|key_clicked, key_8),
      (this_or_next|key_clicked, key_9),
      (this_or_next|key_clicked, key_0),
      (key_clicked, key_escape),
    ],
    [
      (assign, "$gk_order", 0),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (eq, "$gk_order_hold_over_there", 1),
      (neg|game_key_is_down, 23),
    ],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 101),
        (le, ":var0", "$yield"),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos19, ":var1"),
        (troop_get_type, ":var2", "trp_player"),
        (try_begin),
          (is_between, ":var2", 1, 3),
          (599, "snd_snouz_order_hold_fem", 19),
        (else_try),
          (599, "snd_th3_order_hold", 19),
        (try_end),
      (try_end),
      (call_script, "script_team_get_average_position_of_enemies_augmented", 60, "$fplayer_team_no", 9),
      (assign, ":var3", 0),
      (try_for_range, reg36, 0, 9),
        (class_is_listening_order, "$fplayer_team_no", reg36),
        (val_add, ":var3", 1),
      (try_end),
      (agent_get_position, pos21, "$fplayer_agent_no"),
      (try_begin),
        (neq, "$infantry_formation_type", 0),
        (class_is_listening_order, "$fplayer_team_no", 0),
        (team_get_order_position, pos2, "$fplayer_team_no", 0),
        (call_script, "script_point_y_toward_position", 2, 60),
        (try_begin),
          (gt, ":var3", 1),
          (agent_set_position, "$fplayer_agent_no", pos2),
          (try_begin),
            (call_script, "script_cf_formation", "$fplayer_team_no", 0, "$infantry_space", "$infantry_formation_type"),
          (try_end),
        (else_try),
          (assign, ":var4", 0),
          (try_for_agents, reg36),
            (call_script, "script_cf_valid_formation_member", "$fplayer_team_no", 0, "$fplayer_agent_no", reg36),
            (val_add, ":var4", 1),
          (try_end),
          (call_script, "script_get_centering_amount", "$infantry_formation_type", ":var4", "$infantry_space"),
          (position_move_x, pos2, reg0),
          (copy_position, pos1, pos2),
          (call_script, "script_set_formation_position", "$fplayer_team_no", 0, 1),
          (call_script, "script_form_infantry", "$fplayer_team_no", "$fplayer_agent_no", "$infantry_space", "$infantry_formation_type"),
        (try_end),
        (assign, "$infantry_formation_move_order", 0),
      (try_end),
      (try_begin),
        (neq, "$cavalry_formation_type", 0),
        (class_is_listening_order, "$fplayer_team_no", 2),
        (team_get_order_position, pos2, "$fplayer_team_no", 2),
        (call_script, "script_point_y_toward_position", 2, 60),
        (try_begin),
          (gt, ":var3", 1),
          (agent_set_position, "$fplayer_agent_no", pos2),
          (try_begin),
            (call_script, "script_cf_formation", "$fplayer_team_no", 2, "$cavalry_space", "$cavalry_formation_type"),
          (try_end),
        (else_try),
          (copy_position, pos1, pos2),
          (call_script, "script_set_formation_position", "$fplayer_team_no", 2, 1),
          (call_script, "script_form_cavalry", "$fplayer_team_no", "$fplayer_agent_no", "$cavalry_space"),
        (try_end),
        (assign, "$cavalry_formation_move_order", 0),
      (try_end),
      (try_begin),
        (neq, "$archer_formation_type", 0),
        (class_is_listening_order, "$fplayer_team_no", 1),
        (team_get_order_position, pos2, "$fplayer_team_no", 1),
        (call_script, "script_point_y_toward_position", 2, 60),
        (try_begin),
          (gt, ":var3", 1),
          (agent_set_position, "$fplayer_agent_no", pos2),
          (try_begin),
            (call_script, "script_cf_formation", "$fplayer_team_no", 1, "$archer_space", "$archer_formation_type"),
          (try_end),
        (else_try),
          (assign, ":var4", 0),
          (try_for_agents, reg36),
            (call_script, "script_cf_valid_formation_member", "$fplayer_team_no", 1, "$fplayer_agent_no", reg36),
            (val_add, ":var4", 1),
          (try_end),
          (call_script, "script_get_centering_amount", 1, ":var4", "$archer_space"),
          (val_mul, reg0, -1),
          (position_move_x, pos2, reg0),
          (copy_position, pos1, pos2),
          (call_script, "script_set_formation_position", "$fplayer_team_no", 1, 1),
          (call_script, "script_form_archers", "$fplayer_team_no", "$fplayer_agent_no", "$archer_space", "$archer_formation_type"),
        (try_end),
        (assign, "$archer_formation_move_order", 0),
      (try_end),
      (agent_set_position, "$fplayer_agent_no", pos21),
      (assign, "$gk_order_hold_over_there", 0),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (neg|key_is_down, key_j),
      (neg|key_is_down, key_k),
      (neg|key_is_down, key_l),
      (neg|key_is_down, key_semicolon),
      (neg|key_is_down, key_u),
      (neg|game_key_is_down, 23),
      (neg|game_key_is_down, 24),
      (neg|game_key_is_down, 25),
      (neg|game_key_is_down, 26),
      (neg|game_key_is_down, 27),
      (neg|game_key_is_down, 28),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (store_mod, ":var0", "$fclock", 5),
      (call_script, "script_team_get_average_position_of_enemies_augmented", 60, "$fplayer_team_no", 9),
      (try_begin),
        (eq, reg0, 0),
        (neq, "$g_encountered_party", -1),
        (call_script, "script_formation_end", "$fplayer_team_no", 9),
      (else_try),
        (assign, "$autorotate_at_player", 0),
        (try_begin),
          (neq, "$infantry_formation_type", 0),
          (try_begin),
            (eq, "$infantry_formation_move_order", 1),
            (call_script, "script_cf_formation", "$fplayer_team_no", 0, "$infantry_space", "$infantry_formation_type"),
          (else_try),
            (eq, ":var0", 0),
            (call_script, "script_get_formation_position", 0, "$fplayer_team_no", 0),
            (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", "$fplayer_team_no", 0),
            (call_script, "script_point_y_toward_position", 1, 60),
            (position_copy_rotation, pos0, pos1),
            (call_script, "script_set_formation_position", "$fplayer_team_no", 0, 0),
            (copy_position, pos1, pos0),
            (call_script, "script_form_infantry", "$fplayer_team_no", "$fplayer_agent_no", "$infantry_space", "$infantry_formation_type"),
          (try_end),
        (try_end),
        (try_begin),
          (neq, "$cavalry_formation_type", 0),
          (try_begin),
            (eq, "$cavalry_formation_move_order", 1),
            (call_script, "script_cf_formation", "$fplayer_team_no", 2, "$cavalry_space", "$cavalry_formation_type"),
          (else_try),
            (eq, ":var0", 0),
            (call_script, "script_get_formation_position", 0, "$fplayer_team_no", 2),
            (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", "$fplayer_team_no", 2),
            (call_script, "script_point_y_toward_position", 1, 60),
            (position_copy_rotation, pos0, pos1),
            (call_script, "script_set_formation_position", "$fplayer_team_no", 2, 0),
            (copy_position, pos1, pos0),
            (call_script, "script_form_cavalry", "$fplayer_team_no", "$fplayer_agent_no", "$cavalry_space"),
          (try_end),
        (try_end),
        (try_begin),
          (neq, "$archer_formation_type", 0),
          (try_begin),
            (eq, "$archer_formation_move_order", 1),
            (call_script, "script_cf_formation", "$fplayer_team_no", 1, "$archer_space", "$archer_formation_type"),
          (else_try),
            (eq, ":var0", 0),
            (call_script, "script_get_formation_position", 0, "$fplayer_team_no", 1),
            (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", "$fplayer_team_no", 1),
            (call_script, "script_point_y_toward_position", 1, 60),
            (position_copy_rotation, pos0, pos1),
            (call_script, "script_set_formation_position", "$fplayer_team_no", 1, 0),
            (copy_position, pos1, pos0),
            (call_script, "script_form_archers", "$fplayer_team_no", "$fplayer_agent_no", "$archer_space", "$archer_formation_type"),
          (try_end),
        (try_end),
        (assign, "$autorotate_at_player", 1),
      (try_end),
      (val_add, "$fclock", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_option_formations", 1),
        (assign, "$cur_casualties", 0),
        (assign, "$prev_casualties", 0),
        (assign, "$prev_casualties2", 0),
        (assign, "$ranged_clock", 1),
        (assign, "$battle_phase", 1),
        (assign, "$clock_reset", 0),
        (assign, "$charge_activated", 0),
        (assign, "$charge_ongoing", 0),
        (assign, "$inf_charge_activated", 0),
        (assign, "$inf_charge_ongoing", 0),
        (assign, "$arc_charge_activated", 0),
        (assign, "$att_reinforcements_arrived", 0),
        (assign, "$def_reinforcements_arrived", 0),
        (assign, "$att_reinforcements_needed", 0),
        (assign, "$def_reinforcements_needed", 0),
        (assign, "$disengage", 0),
        (assign, "$patrol_mode", 0),
        (store_random_in_range, "$rand0", -1000, 1000),
        (store_random_in_range, "$rand2", 800, 1501),
        (store_random_in_range, "$rand1", 0, 501),
        (store_random_in_range, "$rand3", 2000, 3001),
        (store_random_in_range, "$rand4", 1000, 3001),
        (store_random_in_range, "$rand5", -1000, 0),
        (store_random_in_range, "$rand6", 4000, 5001),
        (store_random_in_range, "$rand7", 49, 56),
        (store_random_in_range, "$rand8", -100, 101),
        (assign, "$team0_default_formation", 1),
        (assign, "$team1_default_formation", 1),
        (assign, "$team2_default_formation", 1),
        (assign, "$team3_default_formation", 1),
        (init_position, pos56),
        (init_position, pos57),
        (init_position, pos58),
        (init_position, pos59),
        (assign, "$team0_reinforcement_stage", 0),
        (assign, "$team1_reinforcement_stage", 0),
        (init_position, pos17),
        (init_position, pos18),
      (try_end),
    ]),

    (0, 0.5, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$g_option_formations", 1),
        (eq, "$g_disciplined_faction", 1),
        (try_for_agents, ":var0"),
          (agent_set_slot, ":var0", 15, 0),
        (try_end),
        (set_fixed_point_multiplier, 100),
        (call_script, "script_store_battlegroup_data"),
        (call_script, "script_battlegroup_get_position", 12, 0, 9),
        (call_script, "script_battlegroup_get_position", 13, 1, 9),
        (call_script, "script_battlegroup_get_position", 14, 2, 9),
        (call_script, "script_battlegroup_get_position", 16, 3, 9),
        (call_script, "script_field_tactics", 1),
      (try_end),
    ]),

    (60, 0, 0, 
    [
      (eq, "$g_option_formations", 1),
      (eq, "$g_disciplined_faction", 1),
    ],
    [
      (store_random_in_range, "$rand0", -1000, 1000),
      (store_random_in_range, "$rand2", 800, 1501),
      (store_random_in_range, "$rand1", -1000, 1000),
      (store_random_in_range, "$rand3", 2000, 3001),
      (store_random_in_range, "$rand4", 1000, 3001),
      (store_random_in_range, "$rand5", -1000, 0),
      (store_random_in_range, "$rand6", 4000, 5001),
      (store_random_in_range, "$rand7", 45, 56),
      (store_random_in_range, "$rand8", -100, 101),
    ]),

    (1, 0.9, 0, 
    [
      (eq, "$g_option_formations", 1),
      (eq, "$g_disciplined_faction", 1),
    ],
    [
      (try_begin),
        (assign, "$prev_casualties2", "$cur_casualties"),
        (call_script, "script_cf_count_casualties"),
        (assign, "$cur_casualties", reg0),
        (assign, "$battle_phase", 3),
      (try_end),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_store_battlegroup_data"),
      (try_begin),
        (eq, "$battle_phase", 3),
        (eq, "$clock_reset", 0),
        (call_script, "script_field_tactics", 1),
        (assign, "$ranged_clock", 0),
        (assign, "$clock_reset", 1),
      (else_try),
        (ge, "$battle_phase", 2),
        (store_mod, reg0, "$ranged_clock", 5),
        (eq, reg0, 0),
        (call_script, "script_field_tactics", 1),
        (assign, "$team0_reinforcement_stage", "$defender_reinforcement_stage"),
        (assign, "$team1_reinforcement_stage", "$attacker_reinforcement_stage"),
      (else_try),
        (call_script, "script_field_tactics", 0),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 1),
        (assign, ":var0", 0),
        (try_for_range, ":var1", 0, 4),
          (neq, ":var1", "$fplayer_team_no"),
          (call_script, "script_battlegroup_get_size", ":var1", 9),
          (gt, reg0, 0),
          (call_script, "script_battlegroup_get_position", 1, ":var1", 1),
          (team_get_order_position, pos0, ":var1", 1),
          (get_distance_between_positions, reg0, pos0, pos1),
          (gt, reg0, 500),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 0),
        (assign, "$battle_phase", 2),
      (try_end),
      (val_add, "$ranged_clock", 1),
    ]),

    (ti_on_order_issued, 0, 0, 
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (eq, ":var0", 9),
        (assign, "$dont_use_fist_enable", 1),
      (else_try),
        (this_or_next|eq, ":var0", 10),
        (this_or_next|eq, ":var0", 13),
        (this_or_next|eq, ":var0", 15),
        (this_or_next|eq, ":var0", 16),
        (this_or_next|eq, ":var0", 17),
        (this_or_next|eq, ":var0", 18),
        (this_or_next|eq, ":var0", 19),
        (this_or_next|eq, ":var0", 20),
        (eq, ":var0", 21),
        (assign, "$dont_use_fist_enable", 0),
      (try_end),
    ],
    []),

    (3, 3, 0, 
    [
      (eq, "$dont_use_fist_enable", 1),
      (set_show_messages, 0),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (le, ":var1", -1),
        (agent_get_team, ":var2", ":var0"),
        (1773, ":var3", ":var0"),
        (team_give_order, ":var2", ":var3", 10),
      (try_end),
      (set_show_messages, 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (assign, ":var1", 4),
        (try_for_range, ":var2", 0, ":var1"),
          (1804, ":var3", ":var0", ":var2"),
          (gt, ":var3", 0),
          (2721, ":var4", ":var3"),
          (eq, ":var4", 2),
          (1747, ":var0", ":var3"),
          (assign, ":var1", -1),
        (try_end),
      (try_end),
    ]),

  ]),

  ("arena_melee_fight", mtf_arena_fight, -1,
  "You enter a melee fight in the arena.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_red,itm_red_tourney_helmet]),
    (1, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword,itm_arena_tunic_red]),
    (2, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_red,itm_red_tourney_helmet]),
    (3, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_red,itm_red_tourney_helmet]),
    (4, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_bow,itm_practice_arrows,itm_practice_dagger,itm_arena_tunic_red]),
    (5, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_sword,itm_practice_shield,itm_arena_tunic_red]),
    (6, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_red]),
    (7, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_red,itm_red_tourney_helmet]),
    (8, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_bow,itm_practice_arrows,itm_practice_dagger,itm_arena_tunic_blue]),
    (9, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_blue,itm_blue_tourney_helmet]),
    (10, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword,itm_arena_tunic_blue]),
    (11, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_sword,itm_practice_shield,itm_arena_tunic_blue,itm_blue_tourney_helmet]),
    (12, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_blue]),
    (13, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_blue,itm_blue_tourney_helmet]),
    (14, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword,itm_arena_tunic_blue]),
    (15, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_sword,itm_practice_shield,itm_arena_tunic_blue]),
    (16, mtef_team_2|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (17, mtef_team_2|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (18, mtef_team_2|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (19, mtef_team_2|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (20, mtef_team_2|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_bow,itm_practice_arrows,itm_practice_dagger,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (21, mtef_team_2|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_sword,itm_practice_shield,itm_arena_tunic_green]),
    (22, mtef_team_2|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_green]),
    (23, mtef_team_2|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (25, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (26, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (27, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (28, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_bow,itm_practice_arrows,itm_practice_dagger,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (29, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_sword,itm_practice_shield,itm_arena_tunic_yellow]),
    (30, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_yellow]),
    (31, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (32, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword]),
    (33, mtef_team_2|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_staff]),
    (34, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_sword,itm_practice_shield]),
    (35, mtef_team_4|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_staff]),
    (36, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_bow,itm_practice_arrows,itm_practice_dagger]),
    (37, mtef_team_2|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_sword,itm_practice_shield]),
    (38, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword]),
    (39, mtef_team_4|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_staff]),
    (24, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_bow,itm_practice_arrows,itm_practice_dagger,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_sword,itm_practice_shield,itm_arena_tunic_yellow]),
    (24, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_yellow]),
    (24, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_leather_boots,itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (50, mtef_scene_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (51, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (52, mtef_scene_source, af_override_horse, 0, 1, []),
    (53, mtef_scene_source, af_override_horse, 0, 1, []),
    (54, mtef_scene_source, af_override_horse, 0, 1, []),
    (55, mtef_scene_source, af_override_horse, 0, 1, []),
    (56, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_padded_cloth,itm_nordic_fighter_helmet]),
    (57, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_padded_cloth,itm_nordic_fighter_helmet]),
  ],
  [
    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (gt, "$horse_archer_ai_state", 0),
    ],
    [
      (set_fixed_point_multiplier, 1000),
      (try_for_agents, ":var0"),
        (1707, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (neg|agent_slot_eq, ":var0", 1003, 1),
        (agent_get_troop_id, ":var1", ":var0"),
        (assign, ":var2", 1),
        (try_begin),
          (eq, "$horse_archer_ai_state", 1),
          (neg|is_between, ":var1", "trp_npc_adonja", "trp_knight_1_1_wife"),
          (neg|is_between, ":var1", "trp_hero_burilgi", "trp_omen_seeker"),
          (neg|is_between, ":var1", "trp_merc_leader_mettenheim", "trp_andy"),
          (neq, ":var1", "trp_seeress"),
          (assign, ":var2", 0),
        (try_end),
        (eq, ":var2", 1),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (neg|agent_slot_eq, ":var0", 15, 1),
          (gt, ":var3", -1),
          (agent_get_team, ":var4", ":var0"),
          (gt, ":var4", -1),
          (1773, ":var5", ":var0"),
          (gt, ":var5", -1),
          (agent_get_combat_state, ":var6", ":var0"),
          (team_get_weapon_usage_order, ":var7", ":var4", ":var5"),
          (team_get_hold_fire_order, ":var8", ":var4", ":var5"),
          (agent_get_ammo, ":var9", ":var0", 0),
          (assign, ":var10", 0),
          (assign, ":var11", -1),
          (assign, ":var12", -1),
          (try_begin),
            (try_for_range, ":var13", 0, 4),
              (1804, ":var14", ":var0", ":var13"),
              (gt, ":var14", 0),
              (item_get_type, ":var15", ":var14"),
              (try_begin),
                (eq, ":var15", 10),
                (1825, ":var16", ":var0", ":var13"),
                (val_add, ":var10", ":var16"),
              (try_end),
              (try_begin),
                (eq, ":var11", -1),
                (this_or_next|eq, ":var15", 8),
                (this_or_next|eq, ":var15", 10),
                (this_or_next|eq, ":var15", 16),
                (eq, ":var15", 17),
                (assign, ":var11", ":var14"),
                (assign, ":var12", ":var15"),
              (try_end),
            (try_end),
          (try_end),
          (gt, ":var12", -1),
          (neg|2723, ":var11", 1048576),
          (assign, ":var17", 1),
          (try_begin),
            (store_sub, ":var18", ":var9", ":var10"),
            (eq, ":var18", 0),
            (agent_set_speed_limit, ":var0", 1000),
            (assign, ":var17", 0),
          (try_end),
          (eq, ":var17", 1),
          (gt, ":var9", 0),
          (agent_set_slot, ":var0", 1003, 2),
          (neq, ":var8", 1),
          (neq, ":var7", 2),
          (neq, ":var7", 1),
          (agent_get_wielded_item, ":var19", ":var0", 0),
          (gt, ":var19", 0),
          (item_get_type, ":var20", ":var19"),
          (try_begin),
            (2080, ":var21", ":var0"),
            (gt, ":var21", -1),
            (agent_is_human, ":var21"),
            (agent_is_alive, ":var21"),
            (agent_get_team, ":var22", ":var21"),
            (gt, ":var22", -1),
            (neg|teams_are_enemies, ":var4", ":var22"),
            (1713, ":var0", -1),
            (1732, ":var0"),
          (try_end),
          (assign, ":var23", 1000),
          (agent_get_position, pos20, ":var0"),
          (position_move_z, pos20, 250, 1),
          (assign, ":var24", 100000),
          (assign, ":var25", -1),
          (team_get_movement_order, ":var26", ":var4", ":var5"),
          (eq, ":var26", 2),
          (try_for_agents, ":var27"),
            (agent_is_alive, ":var27"),
            (agent_is_human, ":var27"),
            (agent_get_position, pos15, ":var27"),
            (agent_get_team, ":var28", ":var27"),
            (gt, ":var28", -1),
            (teams_are_enemies, ":var4", ":var28"),
            (get_distance_between_positions, ":var29", pos20, pos15),
            (try_begin),
              (agent_slot_eq, ":var27", 15, 1),
              (val_add, ":var29", 10000),
            (try_end),
            (assign, ":var30", 0),
            (try_begin),
              (agent_get_horse, ":var31", ":var27"),
              (gt, ":var31", -1),
              (store_div, ":var30", ":var29", 3),
              (val_mul, ":var30", 2),
              (val_min, ":var30", 2000),
              (val_sub, ":var29", ":var30"),
              (assign, ":var32", ":var30"),
            (try_end),
            (lt, ":var29", ":var24"),
            (assign, ":var24", ":var29"),
            (assign, ":var25", ":var27"),
          (try_end),
          (neq, ":var25", -1),
          (agent_get_position, pos23, ":var25"),
          (try_begin),
            (agent_get_horse, ":var33", ":var25"),
            (gt, ":var33", -1),
            (store_add, ":var34", ":var32", ":var24"),
            (position_move_z, pos23, 250, 1),
          (else_try),
            (assign, ":var34", ":var24"),
            (position_move_z, pos23, 140, 1),
          (try_end),
          (try_begin),
            (agent_slot_eq, ":var25", 15, 1),
            (val_sub, ":var34", 10000),
          (else_try),
            (gt, ":var34", 300),
            (1747, ":var0", ":var11"),
          (try_end),
          (try_begin),
            (this_or_next|eq, ":var20", 8),
            (this_or_next|eq, ":var20", 16),
            (eq, ":var20", 17),
            (1763, ":var35", ":var0"),
            (707, 20, 23),
            (1713, ":var0", ":var25"),
            (try_begin),
              (eq, ":var35", 1),
              (try_begin),
                (eq, ":var26", 2),
                (1689, 8, ":var0"),
                (position_get_y, ":var36", pos8),
                (try_begin),
                  (gt, ":var24", 700),
                  (lt, ":var24", 6000),
                  (store_div, ":var23", ":var36", 300),
                  (store_sub, ":var37", ":var24", 2500),
                  (val_div, ":var37", 20),
                  (val_max, ":var23", ":var37"),
                  (val_max, ":var23", 1),
                (try_end),
              (try_end),
              (eq, ":var20", 8),
              (lt, ":var34", 4000),
              (1745, ":var0", 3, 0),
            (else_try),
              (eq, ":var20", 8),
              (lt, ":var34", 4000),
              (neq, ":var6", 8),
              (1745, ":var0", 3, 1),
            (try_end),
          (try_end),
          (agent_set_speed_limit, ":var0", ":var23"),
          (try_begin),
            (1707, ":var0"),
            (neq, ":var12", 10),
            (gt, ":var25", -1),
            (try_begin),
              (eq, ":var26", 2),
              (this_or_next|agent_slot_eq, ":var25", 15, 1),
              (lt, ":var24", 10000),
              (try_begin),
                (get_scene_boundaries, pos9, pos10),
                (position_get_x, ":var38", pos9),
                (position_get_y, ":var39", pos9),
                (position_get_x, ":var40", pos10),
                (position_get_y, ":var41", pos10),
                (position_get_x, ":var42", pos20),
                (position_get_y, ":var43", pos20),
                (position_copy_origin, pos19, pos9),
                (store_sub, ":var44", ":var42", ":var38"),
                (store_sub, ":var45", ":var43", ":var39"),
                (store_sub, ":var46", ":var40", ":var42"),
                (store_sub, ":var47", ":var41", ":var43"),
                (val_abs, ":var44"),
                (val_abs, ":var45"),
                (val_abs, ":var46"),
                (val_abs, ":var47"),
                (store_sub, ":var48", ":var40", ":var38"),
                (store_sub, ":var49", ":var41", ":var39"),
                (val_div, ":var48", 20),
                (val_div, ":var49", 20),
                (position_move_x, pos19, ":var48", 1),
                (position_move_y, pos19, ":var49", 1),
                (get_distance_between_positions, ":var50", pos19, pos20),
                (717, 19, 20, 19),
                (717, 11, 20, 23),
                (position_get_x, ":var48", pos19),
                (position_get_y, ":var49", pos19),
                (position_get_x, ":var51", pos11),
                (position_get_y, ":var52", pos11),
                (assign, ":var53", 0),
                (try_begin),
                  (le, ":var24", 1000),
                  (store_sub, ":var53", ":var24", 1500),
                  (val_mul, ":var53", 60),
                  (val_max, ":var53", -80000),
                  (assign, ":var53", -80000),
                (else_try),
                  (gt, ":var24", 2500),
                  (store_sub, ":var53", ":var24", 0),
                  (val_mul, ":var53", 5),
                  (val_clamp, ":var53", 35000, 90000),
                  (try_begin),
                    (gt, ":var33", -1),
                    (val_sub, ":var53", 20000),
                  (try_end),
                (try_end),
                (assign, ":var54", 30000),
                (val_min, ":var54", ":var44"),
                (val_min, ":var54", ":var45"),
                (val_min, ":var54", ":var46"),
                (val_min, ":var54", ":var47"),
                (try_begin),
                  (lt, ":var54", 30000),
                  (lt, ":var24", 1500),
                  (agent_slot_eq, ":var25", 15, 0),
                  (1732, ":var0"),
                  (val_mul, ":var48", 100),
                  (val_mul, ":var49", 100),
                  (val_mul, ":var51", 100),
                  (val_mul, ":var52", 100),
                  (store_div, ":var55", ":var48", ":var50"),
                  (store_div, ":var56", ":var49", ":var50"),
                  (store_div, ":var57", ":var51", ":var34"),
                  (store_div, ":var58", ":var52", ":var34"),
                  (2141, ":var59", ":var55"),
                  (2140, ":var60", ":var56"),
                  (2141, ":var61", ":var57"),
                  (2140, ":var62", ":var58"),
                  (try_begin),
                    (lt, ":var60", 0),
                    (val_mul, ":var59", -1),
                    (val_add, ":var59", 360000),
                  (try_end),
                  (try_begin),
                    (lt, ":var62", 0),
                    (val_mul, ":var61", -1),
                    (val_add, ":var61", 360000),
                  (try_end),
                  (store_sub, ":var63", ":var59", ":var61"),
                  (val_sub, ":var63", 270000),
                  (val_sub, ":var63", ":var53"),
                  (store_add, ":var53", ":var63", ":var53"),
                  (try_begin),
                    (lt, ":var59", ":var61"),
                    (val_add, ":var53", 360000),
                  (try_end),
                  (val_clamp, ":var53", -210000, 15000),
                  (1745, ":var0", 3, 1),
                (try_end),
                (store_cos, ":var64", ":var53"),
                (store_sin, ":var65", ":var53"),
                (store_mul, ":var66", ":var64", ":var52"),
                (store_mul, ":var67", ":var65", ":var51"),
                (store_mul, ":var68", ":var65", ":var52"),
                (store_mul, ":var69", ":var64", ":var51"),
                (store_add, ":var70", ":var66", ":var67"),
                (store_sub, ":var71", ":var68", ":var69"),
                (position_move_x, pos20, ":var70", 0),
                (position_move_y, pos20, ":var71", 0),
              (try_end),
              (agent_set_scripted_destination, ":var0", pos20, 1),
            (else_try),
              (agent_clear_scripted_mode, ":var0"),
              (1732, ":var0"),
            (try_end),
          (try_end),
        (else_try),
          (try_begin),
            (agent_slot_eq, ":var0", 1003, 0),
            (agent_set_slot, ":var0", 1003, 1),
          (else_try),
            (agent_slot_eq, ":var0", 1003, 2),
            (this_or_next|eq, ":var9", 0),
            (this_or_next|le, ":var3", 0),
            (this_or_next|eq, ":var8", 1),
            (this_or_next|eq, ":var7", 1),
            (this_or_next|is_between, ":var26", 0, 2),
            (eq, ":var7", 2),
            (1732, ":var0"),
            (agent_clear_scripted_mode, ":var0"),
            (agent_set_speed_limit, ":var0", 1000),
            (agent_set_slot, ":var0", 1003, 3),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (assign, "$g_arena_training_num_agents_spawned", 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (set_trigger_result, 1),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (try_begin),
        (eq, "$g_mt_mode", 3),
        (call_script, "script_end_tournament_fight", 0),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (get_player_agent_no, ":var1"),
        (agent_get_kill_count, "$g_arena_training_kills", ":var1", 1),
      (try_end),
      (finish_mission, 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 2),
      (call_script, "script_music_set_situation_with_culture", 65536),
      (store_current_scene, reg1),
      (scene_set_slot, reg1, 0, 1),
      (mission_enable_talk),
      (get_player_agent_no, ":var0"),
      (assign, ":var1", 0),
      (try_for_agents, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_get_troop_id, ":var3", ":var2"),
        (is_between, ":var3", "trp_novice_fighter", "trp_ramun_the_slave_trader"),
        (eq, ":var1", 0),
        (agent_set_team, ":var2", 1),
        (assign, ":var1", 1),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 3),
      (play_sound, "snd_arena_ambiance"),
      (call_script, "script_music_set_situation_with_culture", 134217728),
    ]),

    (ti_on_leave_area, 0, 0, 
    [],
    [
      (stop_all_sounds, 1),
      (assign, "$g_mt_mode", 0),
    ]),

    (ti_on_player_exit, 0, 0, 
    [],
    [
      (stop_all_sounds, 1),
      (assign, "$g_mt_mode", 0),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$g_mt_mode", 3),
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (neg|main_hero_fallen),
        (call_script, "script_end_tournament_fight", 1),
        (call_script, "script_play_victorious_sound"),
        (finish_mission),
      (else_try),
        (call_script, "script_end_tournament_fight", 0),
        (finish_mission),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (eq, "$g_mt_mode", 1),
      (start_presentation, "prsnt_arena_training"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 1),
      (assign, "$g_arena_training_max_opponents", 40),
      (assign, "$g_arena_training_num_agents_spawned", 0),
      (assign, "$g_arena_training_kills", 0),
      (assign, "$g_arena_training_won", 0),
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$g_mt_mode", 1),
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 3),
      (assign, ":var1", 0),
      (try_begin),
        (ge, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
        (num_active_teams_le, 1),
        (assign, ":var1", 1),
      (try_end),
      (this_or_next|eq, ":var1", 1),
      (main_hero_fallen),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_kill_count, "$g_arena_training_kills", ":var0", 1),
      (assign, "$g_arena_training_won", 0),
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_arena_training_won", 1),
      (try_end),
      (assign, "$g_mt_mode", 2),
      (set_jump_mission, "mt_arena_melee_fight"),
      (party_get_slot, ":var1", "$current_town", 16),
      (modify_visitors_at_site, ":var1"),
      (reset_visitors),
      (set_visitor, 35, "trp_veteran_fighter"),
      (set_visitor, 36, "trp_hired_blade"),
      (set_jump_entry, 50),
      (jump_to_scene, ":var1"),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$g_mt_mode", 1),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_human, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (is_between, ":var2", 0, 7),
        (val_add, ":var0", 1),
      (try_end),
      (lt, ":var0", 7),
      (neg|main_hero_fallen),
      (store_mission_timer_a, ":var3"),
      (this_or_next|ge, ":var3", "$g_arena_training_next_spawn_time"),
      (this_or_next|lt, "$g_arena_training_num_agents_spawned", 6),
      (num_active_teams_le, 1),
      (lt, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
    ],
    [
      (assign, ":var0", "$g_arena_training_num_agents_spawned"),
      (store_div, ":var0", "$g_arena_training_num_agents_spawned", 6),
      (assign, ":var1", "$g_arena_training_num_agents_spawned"),
      (val_mod, ":var1", 6),
      (val_add, ":var0", ":var1"),
      (val_min, ":var0", 9),
      (try_begin),
        (party_slot_eq, "$current_town", 19, "fac_culture_3"),
        (try_begin),
          (store_random_in_range, ":var2", 1, 100),
          (le, ":var2", 30),
          (val_add, ":var0", "trp_arena_training_fighter_dshar_fem_1"),
        (else_try),
          (val_add, ":var0", "trp_arena_training_fighter_dshar_1"),
        (try_end),
      (else_try),
        (try_begin),
          (store_random_in_range, ":var2", 1, 100),
          (le, ":var2", 30),
          (val_add, ":var0", "trp_arena_training_fighter_fem_1"),
        (else_try),
          (val_add, ":var0", "trp_arena_training_fighter_1"),
        (try_end),
      (try_end),
      (assign, ":var3", 10000),
      (get_player_agent_no, ":var4"),
      (agent_get_position, pos5, ":var4"),
      (try_for_range, ":var5", 0, ":var3"),
        (store_random_in_range, ":var6", 32, 40),
        (neq, ":var6", "$g_player_entry_point"),
        (entry_point_get_position, pos1, ":var6"),
        (get_distance_between_positions, ":var7", pos5, pos1),
        (gt, ":var7", 1200),
        (assign, ":var3", 0),
      (try_end),
      (add_visitors_to_current_scene, ":var6", ":var0", 1),
      (store_add, ":var8", "$g_arena_training_num_agents_spawned", 1),
      (store_mission_timer_a, ":var9"),
      (store_add, "$g_arena_training_next_spawn_time", ":var9", 14),
      (store_div, ":var10", ":var8", 3),
      (val_sub, "$g_arena_training_next_spawn_time", ":var10"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_mt_mode", 1),
    ],
    [
      (assign, ":var0", 6),
      (val_max, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (try_for_agents, ":var2"),
        (agent_is_human, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_slot_eq, ":var2", 7, 0),
        (agent_get_team, ":var3", ":var2"),
        (is_between, ":var3", 0, 7),
        (try_begin),
          (eq, ":var2", ":var1"),
          (agent_set_team, ":var2", 6),
        (else_try),
          (store_random_in_range, ":var4", 0, ":var0"),
          (try_for_range, ":var5", 0, 6),
            (troop_set_slot, "trp_temp_array_a", ":var5", 0),
          (try_end),
          (try_for_agents, ":var6"),
            (agent_is_human, ":var6"),
            (agent_is_alive, ":var6"),
            (neq, ":var2", ":var1"),
            (agent_slot_eq, ":var6", 7, 1),
            (agent_get_team, ":var7", ":var6"),
            (troop_get_slot, ":var8", "trp_temp_array_a", ":var7"),
            (val_add, ":var8", 1),
            (troop_set_slot, "trp_temp_array_a", ":var7", ":var8"),
          (try_end),
          (assign, ":var9", 0),
          (troop_get_slot, ":var10", "trp_temp_array_a", 0),
          (try_for_range, ":var5", 1, 6),
            (troop_slot_ge, "trp_temp_array_a", ":var5", ":var10"),
            (troop_get_slot, ":var10", "trp_temp_array_a", ":var5"),
            (assign, ":var9", ":var5"),
          (try_end),
          (store_random_in_range, ":var11", 5, 100),
          (try_begin),
            (lt, ":var11", "$g_arena_training_num_agents_spawned"),
            (assign, ":var4", ":var9"),
          (try_end),
          (agent_set_team, ":var2", ":var4"),
        (try_end),
        (agent_set_slot, ":var2", 7, 1),
        (try_begin),
          (neq, ":var2", ":var1"),
          (val_add, "$g_arena_training_num_agents_spawned", 1),
        (try_end),
      (try_end),
    ]),

  ]),

  ("arena_challenge_fight", mtf_arena_fight|mtf_commit_casualties, -1,
  "You enter a melee fight in the arena.",
  [
    (56, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_for_lady"),
        (quest_slot_eq, "qst_duel_for_lady", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_for_lady"),
      (else_try),
        (check_quest_active, "qst_duel_for_lady"),
        (quest_slot_eq, "qst_duel_for_lady", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_for_lady"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_courtship_rival"),
        (quest_slot_eq, "qst_duel_courtship_rival", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_courtship_rival"),
      (else_try),
        (check_quest_active, "qst_duel_courtship_rival"),
        (quest_slot_eq, "qst_duel_courtship_rival", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_courtship_rival"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_avenge_insult"),
        (quest_slot_eq, "qst_duel_avenge_insult", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_avenge_insult"),
      (else_try),
        (check_quest_active, "qst_duel_avenge_insult"),
        (quest_slot_eq, "qst_duel_avenge_insult", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_avenge_insult"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_denounce_lord"),
        (quest_slot_eq, "qst_denounce_lord", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_denounce_lord"),
      (else_try),
        (check_quest_active, "qst_denounce_lord"),
        (quest_slot_eq, "qst_denounce_lord", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_denounce_lord"),
      (else_try),
        (quest_get_slot, ":var0", "qst_denounce_lord", 2),
        (str_store_troop_name, s4, ":var0"),
      (try_end),
      (finish_mission),
    ]),

  ]),

  ("arena_heroic_challenge_fight", mtf_arena_fight|mtf_commit_casualties, -1,
  "You enter a fight in the arena.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "@Cannot leave now."),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (assign, "$g_order_challenge_won", -1),
        (display_log_message, "@ You've lost the challenge!!!"),
      (else_try),
        (assign, "$g_order_challenge_won", 1),
        (display_log_message, "@ You've won the challenge!!!"),
      (try_end),
      (finish_mission),
    ]),

  ]),

  ("duel_with_lord", mtf_arena_fight|mtf_commit_casualties, -1,
  "You enter a melee fight in the arena.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_sword_medieval_a,itm_arena_tunic_blue]),
    (16, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_sword_medieval_a,itm_arena_tunic_blue]),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_for_lady"),
        (quest_slot_eq, "qst_duel_for_lady", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_for_lady"),
      (else_try),
        (check_quest_active, "qst_duel_for_lady"),
        (quest_slot_eq, "qst_duel_for_lady", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_for_lady"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_courtship_rival"),
        (quest_slot_eq, "qst_duel_courtship_rival", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_courtship_rival"),
      (else_try),
        (check_quest_active, "qst_duel_courtship_rival"),
        (quest_slot_eq, "qst_duel_courtship_rival", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_courtship_rival"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_avenge_insult"),
        (quest_slot_eq, "qst_duel_avenge_insult", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_avenge_insult"),
      (else_try),
        (check_quest_active, "qst_duel_avenge_insult"),
        (quest_slot_eq, "qst_duel_avenge_insult", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_avenge_insult"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_denounce_lord"),
        (quest_slot_eq, "qst_denounce_lord", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_denounce_lord"),
      (else_try),
        (check_quest_active, "qst_denounce_lord"),
        (quest_slot_eq, "qst_denounce_lord", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_denounce_lord"),
      (else_try),
        (quest_get_slot, ":var0", "qst_denounce_lord", 2),
        (str_store_troop_name, s4, ":var0"),
      (try_end),
      (finish_mission),
    ]),

  ]),

  ("wedding", 0, -1,
  "Wedding",
  [
    (0, mtef_visitor_source, af_override_everything, 0, 1, [itm_tabard,itm_ankle_boots]),
    (1, mtef_visitor_source, af_override_everything, 0, 1, [itm_bride_dress,itm_bride_crown,itm_bride_shoes]),
    (2, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (3, mtef_visitor_source, af_override_everything, 0, 1, [itm_noble_clothing1,itm_blue_hose]),
    (4, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (5, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (6, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (7, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (14, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (15, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (16, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_before_mission_start, 0, 0, 
    [
      (eq, "$fadefromblack", 1),
    ],
    [
      (start_presentation, "prsnt_fade_from_black", 0),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (960, 1),
      (finish_mission, 0),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (960, 1),
      (finish_mission, 0),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_wedding_state", 0),
      (play_track, "track_wedding", 2),
      (960, 0),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (set_fixed_point_multiplier, 100),
      (try_begin),
        (eq, ":var1", "$g_wedding_bishop_troop"),
      (else_try),
        (eq, ":var1", "$g_wedding_bride_troop"),
        (1762, ":var0", 1),
        (init_position, pos1),
        (position_set_z, pos1, -1000),
        (agent_set_position, ":var0", pos1),
      (else_try),
        (eq, ":var1", "$g_wedding_brides_dad_troop"),
        (1762, ":var0", 1),
        (init_position, pos1),
        (position_set_z, pos1, -1000),
        (agent_set_position, ":var0", pos1),
      (else_try),
        (eq, ":var1", "$g_wedding_groom_troop"),
        (1762, ":var0", 1),
        (init_position, pos1),
        (position_move_x, pos1, 175),
        (position_move_z, pos1, 10),
        (position_rotate_z, pos1, 180),
        (agent_set_position, ":var0", pos1),
        (agent_set_animation, ":var0", "anim_wedding_groom_wait"),
      (else_try),
        (try_begin),
          (eq, ":var2", 0),
          (store_random_in_range, ":var3", 0, 3),
          (try_begin),
            (eq, ":var3", 0),
            (agent_set_slot, ":var0", 18, "anim_wedding_guest_notr"),
            (agent_set_animation, ":var0", "anim_wedding_guest_notr"),
          (else_try),
            (agent_set_slot, ":var0", 18, "anim_wedding_guest"),
            (agent_set_animation, ":var0", "anim_wedding_guest"),
          (try_end),
        (else_try),
          (agent_set_slot, ":var0", 18, "anim_wedding_guest_woman"),
          (agent_set_animation, ":var0", "anim_wedding_guest_woman"),
        (try_end),
        (store_random_in_range, ":var4", 0, 100),
        (agent_set_animation_progress, ":var0", ":var4"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (store_mission_timer_a, ":var0"),
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (try_begin),
          (eq, ":var2", "$g_wedding_groom_troop"),
        (else_try),
          (eq, ":var2", "$g_wedding_bride_troop"),
        (else_try),
          (eq, ":var2", "$g_wedding_brides_dad_troop"),
        (else_try),
          (eq, ":var2", "$g_wedding_bishop_troop"),
        (else_try),
          (agent_get_slot, ":var3", ":var1", 18),
          (agent_set_animation, ":var1", ":var3"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$g_wedding_state", 0),
        (mission_cam_set_mode, 1, 0, 0),
        (init_position, pos1),
        (position_rotate_z, pos1, 180),
        (position_rotate_x, pos1, 5),
        (position_set_x, pos1, -500),
        (position_set_y, pos1, 1000),
        (position_set_z, pos1, 600),
        (mission_cam_set_position, pos1),
        (init_position, pos1),
        (position_rotate_z, pos1, 180),
        (position_rotate_x, pos1, -15),
        (position_set_x, pos1, -500),
        (position_set_y, pos1, 1000),
        (position_set_z, pos1, 600),
        (mission_cam_animate_to_position, pos1, 4000, 0),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 1),
        (ge, ":var0", 4),
        (init_position, pos1),
        (position_rotate_z, pos1, 90),
        (position_rotate_x, pos1, -10),
        (position_set_x, pos1, -580),
        (position_set_y, pos1, 700),
        (position_set_z, pos1, 200),
        (mission_cam_set_position, pos1),
        (init_position, pos1),
        (position_rotate_z, pos1, 150),
        (position_rotate_x, pos1, -10),
        (position_set_x, pos1, -580),
        (position_set_y, pos1, 100),
        (position_set_z, pos1, 200),
        (mission_cam_animate_to_position, pos1, 6000, 1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 2),
        (ge, ":var0", 9),
        (2009, 4278190080, 1000),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 3),
        (ge, ":var0", 10),
        (init_position, pos1),
        (position_move_x, pos1, 175),
        (position_move_z, pos1, 10),
        (position_rotate_z, pos1, 180),
        (try_for_agents, ":var1"),
          (agent_get_troop_id, ":var4", ":var1"),
          (try_begin),
            (eq, ":var4", "$g_wedding_bride_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_bride_stairs"),
          (else_try),
            (eq, ":var4", "$g_wedding_brides_dad_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_dad_stairs"),
          (try_end),
        (try_end),
        (init_position, pos1),
        (position_rotate_z, pos1, -90),
        (position_set_x, pos1, 300),
        (position_set_y, pos1, 950),
        (position_set_z, pos1, 420),
        (mission_cam_set_position, pos1),
        (position_set_x, pos1, 175),
        (position_set_y, pos1, 950),
        (position_set_z, pos1, 320),
        (mission_cam_animate_to_position, pos1, 4000, 0),
        (2009, 0, 500),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 4),
        (ge, ":var0", 14),
        (init_position, pos1),
        (position_rotate_z, pos1, -60),
        (position_rotate_x, pos1, 10),
        (position_set_x, pos1, -400),
        (position_set_y, pos1, 200),
        (position_set_z, pos1, 115),
        (mission_cam_set_position, pos1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 5),
        (ge, ":var0", 20),
        (init_position, pos1),
        (position_move_x, pos1, 175),
        (position_move_z, pos1, 10),
        (position_rotate_z, pos1, 180),
        (try_for_agents, ":var1"),
          (agent_get_troop_id, ":var4", ":var1"),
          (try_begin),
            (eq, ":var4", "$g_wedding_bride_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_bride_walk"),
          (else_try),
            (eq, ":var4", "$g_wedding_brides_dad_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_dad_walk"),
          (try_end),
        (try_end),
        (init_position, pos1),
        (position_rotate_z, pos1, -140),
        (position_rotate_x, pos1, -15),
        (position_set_x, pos1, -625),
        (position_set_y, pos1, -530),
        (position_set_z, pos1, 180),
        (mission_cam_set_position, pos1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 6),
        (ge, ":var0", 22),
        (init_position, pos1),
        (position_rotate_z, pos1, 45),
        (position_rotate_x, pos1, -10),
        (position_set_x, pos1, -260),
        (position_set_y, pos1, 120),
        (position_set_z, pos1, 275),
        (mission_cam_set_position, pos1),
        (position_rotate_z, pos1, 10),
        (mission_cam_animate_to_position, pos1, 2000, 0),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 7),
        (ge, ":var0", 24),
        (init_position, pos1),
        (position_move_x, pos1, 175),
        (position_move_z, pos1, 10),
        (position_rotate_z, pos1, 180),
        (try_for_agents, ":var1"),
          (agent_get_troop_id, ":var4", ":var1"),
          (try_begin),
            (eq, ":var4", "$g_wedding_bride_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_bride_last"),
          (else_try),
            (eq, ":var4", "$g_wedding_brides_dad_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_dad_last"),
          (else_try),
            (eq, ":var4", "$g_wedding_groom_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_groom_last"),
          (try_end),
        (try_end),
        (init_position, pos1),
        (position_rotate_z, pos1, -45),
        (position_rotate_x, pos1, -10),
        (position_set_x, pos1, -900),
        (position_set_y, pos1, -850),
        (position_set_z, pos1, 230),
        (mission_cam_set_position, pos1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 8),
        (ge, ":var0", 31),
        (init_position, pos1),
        (position_set_x, pos1, -550),
        (position_set_y, pos1, -625),
        (position_set_z, pos1, 1500),
        (particle_system_burst, "psys_wedding_rose", pos1, 750),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 9),
        (ge, ":var0", 33),
        (init_position, pos1),
        (position_rotate_z, pos1, 180),
        (position_set_x, pos1, -536),
        (position_set_y, pos1, -415),
        (position_set_z, pos1, 135),
        (mission_cam_set_position, pos1),
        (position_rotate_z, pos1, -8),
        (position_set_z, pos1, 350),
        (position_rotate_x, pos1, 35),
        (mission_cam_animate_to_position_and_aperture, pos1, 10, 9000, 1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 10),
        (ge, ":var0", 41),
        (try_begin),
          (neg|this_or_next|255),
          (eq, "$cheat_mode", 0),
          (2008, 16777215),
          (2009, 4294967295, 3000),
        (try_end),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 11),
        (ge, ":var0", 48),
        (960, 1),
        (finish_mission, 0),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_training_ground", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (33, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (34, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (35, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (36, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows]),
    (42, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows]),
    (43, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (62, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (63, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows]),
    (64, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows]),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$g_tutorial_training_ground_state", 20),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_tutorial_show_mouse_movement"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (1733, ":var0", 1),
      (1725, ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_slot, ":var0", 8, -1),
      (get_player_agent_no, ":var1"),
      (try_begin),
        (eq, ":var0", ":var1"),
        (agent_set_team, ":var0", 7),
      (try_end),
      (try_for_range, ":var2", 0, 64),
        (entry_point_get_position, pos2, ":var2"),
        (712, ":var3", 1, 2),
        (lt, ":var3", 100),
        (agent_set_slot, ":var0", 8, ":var2"),
      (try_end),
      (agent_get_troop_id, ":var4", ":var0"),
      (try_begin),
        (eq, ":var4", "trp_tutorial_archer_1"),
        (agent_get_position, pos1, ":var0"),
        (agent_set_scripted_destination, ":var0", pos1),
        (scene_prop_get_num_instances, ":var5", "spr_archery_target_with_hit_a"),
        (assign, ":var6", 10000000),
        (assign, ":var7", -1),
        (try_for_range, ":var8", 0, ":var5"),
          (scene_prop_get_instance, ":var9", "spr_archery_target_with_hit_a", ":var8"),
          (prop_instance_get_position, pos2, ":var9"),
          (712, ":var10", 1, 2),
          (lt, ":var10", ":var6"),
          (assign, ":var6", ":var10"),
          (assign, ":var7", ":var9"),
        (try_end),
        (agent_set_slot, ":var0", 9, ":var7"),
      (else_try),
        (this_or_next|eq, ":var4", "trp_tutorial_rider_1"),
        (eq, ":var4", "trp_tutorial_rider_2"),
        (agent_set_slot, ":var0", 11, 48),
        (agent_set_slot, ":var0", 9, -1),
        (entry_point_get_position, pos1, 48),
        (agent_set_scripted_destination, ":var0", pos1),
      (try_end),
    ]),

    (ti_on_agent_knocked_down, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (try_begin),
        (ge, "$g_tutorial_training_ground_melee_trainer_attack", 0),
      (else_try),
        (ge, "$g_tutorial_training_ground_melee_trainer_parry", 0),
        (try_begin),
          (eq, ":var2", "trp_player"),
          (eq, ":var3", "$g_tutorial_training_ground_melee_trainer_parry"),
          (assign, "$g_tutorial_training_ground_melee_state", 0),
          (agent_set_team, ":var0", 0),
          (agent_set_team, ":var1", 7),
          (tutorial_message, -1),
          (assign, "$g_tutorial_mouse_dir", -1),
          (assign, "$g_tutorial_mouse_click", -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 2),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_parry"),
          (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (1745, ":var0", 0, 0),
          (try_end),
        (else_try),
          (eq, ":var3", "trp_player"),
          (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_parry"),
          (agent_set_team, ":var0", 7),
          (agent_set_team, ":var1", 0),
          (tutorial_message, -1),
          (assign, "$g_tutorial_mouse_dir", -1),
          (assign, "$g_tutorial_mouse_click", -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 3),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_parry"),
          (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (1745, ":var0", 0, 0),
          (try_end),
        (try_end),
      (else_try),
        (ge, "$g_tutorial_training_ground_melee_trainer_chamber", 0),
        (try_begin),
          (eq, ":var2", "trp_player"),
          (eq, ":var3", "$g_tutorial_training_ground_melee_trainer_chamber"),
          (assign, "$g_tutorial_training_ground_melee_state", 0),
          (agent_set_team, ":var0", 0),
          (agent_set_team, ":var1", 7),
          (tutorial_message, -1),
          (assign, "$g_tutorial_mouse_dir", -1),
          (assign, "$g_tutorial_mouse_click", -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 7),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_chamber"),
          (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (1745, ":var0", 0, 0),
          (try_end),
        (else_try),
          (eq, ":var3", "trp_player"),
          (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_chamber"),
          (agent_set_team, ":var0", 7),
          (agent_set_team, ":var1", 0),
          (tutorial_message, -1),
          (assign, "$g_tutorial_mouse_dir", -1),
          (assign, "$g_tutorial_mouse_click", -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 8),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_chamber"),
          (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (1745, ":var0", 0, 0),
          (try_end),
        (try_end),
      (else_try),
        (ge, "$g_tutorial_training_ground_melee_trainer_combat", 0),
        (try_begin),
          (eq, ":var2", "trp_player"),
          (eq, ":var3", "$g_tutorial_training_ground_melee_trainer_combat"),
          (assign, "$g_tutorial_training_ground_melee_state", 0),
          (agent_set_team, ":var0", 0),
          (agent_set_team, ":var1", 7),
          (tutorial_message, -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 4),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_combat"),
          (assign, "$g_tutorial_training_ground_melee_trainer_combat", -1),
        (else_try),
          (eq, ":var3", "trp_player"),
          (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_combat"),
          (assign, "$g_tutorial_training_ground_melee_state", 0),
          (agent_set_team, ":var0", 7),
          (agent_set_team, ":var1", 0),
          (tutorial_message, -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 5),
          (play_sound, "snd_tutorial_2"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_combat"),
          (assign, "$g_tutorial_training_ground_melee_trainer_combat", -1),
        (try_end),
      (else_try),
        (agent_is_human, ":var0"),
        (assign, "$g_tutorial_training_ground_melee_last_winner", ":var1"),
        (assign, "$g_tutorial_training_ground_melee_last_loser", ":var0"),
        (assign, "$g_tutorial_training_ground_melee_state", 0),
        (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_1", 7),
        (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_2", 7),
        (1732, "$g_tutorial_training_ground_melee_cur_fighter_1"),
        (1732, "$g_tutorial_training_ground_melee_cur_fighter_2"),
      (try_end),
      (agent_set_hit_points, ":var0", 100, 0),
      (agent_set_hit_points, ":var1", 100, 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (1266, 13),
      (team_set_relation, 0, 1, 0),
      (team_set_relation, 0, 2, 0),
      (team_set_relation, 0, 3, 0),
      (team_set_relation, 0, 7, 0),
      (team_set_relation, 7, 1, 1),
      (team_set_relation, 7, 2, 1),
      (team_set_relation, 7, 3, 1),
      (team_set_relation, 1, 2, -1),
      (team_set_relation, 1, 3, 1),
      (team_set_relation, 2, 3, 1),
      (assign, "$g_position_to_use_for_replacing_scene_items", 8),
      (call_script, "script_replace_scene_items_with_spawn_items_before_ms"),
      (assign, "$g_tutorial_training_ground_state", 0),
      (assign, "$g_tutorial_training_ground_conversation_state", 0),
      (assign, "$g_tutorial_training_ground_melee_paused", 0),
      (assign, "$g_tutorial_training_ground_melee_state", 0),
      (assign, "$g_tutorial_training_ground_melee_next_action_time", 0),
      (assign, "$g_tutorial_training_ground_melee_last_winner", -1),
      (assign, "$g_tutorial_training_ground_melee_last_loser", -1),
      (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
      (assign, "$g_tutorial_training_ground_melee_cur_fighter_2", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_attack", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_combat", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_next_action_time", 0),
      (assign, "$g_tutorial_training_ground_archer_trainer_state", 0),
      (assign, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 0),
      (assign, "$g_tutorial_training_ground_horseman_trainer_state", 0),
      (assign, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 0),
      (assign, "$g_tutorial_training_ground_next_score_time", 0),
      (assign, "$g_tutorial_mouse_dir", -1),
      (assign, "$g_tutorial_mouse_click", -1),
      (assign, "$g_pointer_arrow_height_adder", -1000),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (1124, 17, 17),
      (1123, 500, 650),
      (1125, 0),
      (mission_enable_talk),
      (call_script, "script_replace_scene_items_with_spawn_items_after_ms"),
      (entry_point_get_position, pos1, 59),
      (set_spawn_position, pos1),
      (spawn_horse, "itm_practice_horse", 0),
      (assign, "$g_tutorial_training_ground_intro_message_being_displayed", 1),
      (1833, ":var0", "itm_practice_bow", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (1833, ":var0", "itm_practice_bow_2", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (1833, ":var0", "itm_practice_arrows", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (1833, ":var0", "itm_practice_arrows_2", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (1833, ":var0", "itm_practice_crossbow", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (1833, ":var0", "itm_practice_bolts", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (1833, ":var0", "itm_practice_javelin", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (1833, ":var0", "itm_arena_lance", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
    ]),

    (0, 1, ti_once, 
    [],
    [
      (1126, 1),
      (tutorial_message, "str_tutorial_training_ground_intro_message"),
    ]),

    (0, 0, 0, 
    [
      (store_mission_timer_a, ":var0"),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "trp_tutorial_archer_1"),
        (try_begin),
          (agent_get_wielded_item, ":var3", ":var1", 0),
          (neq, ":var3", "itm_practice_bow"),
          (1747, ":var1", "itm_practice_bow"),
        (else_try),
          (agent_get_slot, ":var4", ":var1", 9),
          (prop_instance_get_position, pos1, ":var4"),
          (position_move_z, pos1, 10),
          (1744, ":var1", 1),
          (try_begin),
            (neg|agent_slot_ge, ":var1", 19, ":var0"),
            (1745, ":var1", 0),
            (store_random_in_range, ":var5", 3, 13),
            (val_add, ":var5", ":var0"),
            (agent_set_slot, ":var1", 19, ":var5"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "trp_tutorial_rider_1"),
        (eq, ":var1", "trp_tutorial_rider_2"),
        (agent_get_slot, ":var2", ":var0", 11),
        (entry_point_get_position, pos1, ":var2"),
        (agent_get_position, pos2, ":var0"),
        (712, ":var3", 1, 2),
        (try_begin),
          (lt, ":var3", 6400),
          (val_add, ":var2", 1),
          (try_begin),
            (gt, ":var2", 57),
            (assign, ":var2", 48),
          (try_end),
          (agent_set_slot, ":var0", 11, ":var2"),
          (entry_point_get_position, pos1, ":var2"),
          (agent_set_scripted_destination, ":var0", pos1),
        (try_end),
        (try_begin),
          (eq, ":var1", "trp_tutorial_rider_2"),
          (try_begin),
            (agent_get_wielded_item, ":var4", ":var0", 0),
            (neq, ":var4", "itm_practice_bow"),
            (1747, ":var0", "itm_practice_bow"),
          (else_try),
            (scene_prop_get_num_instances, ":var5", "spr_archery_target_with_hit_a"),
            (assign, ":var6", 10000000),
            (assign, ":var7", -1),
            (try_for_range, ":var8", 0, ":var5"),
              (scene_prop_get_instance, ":var9", "spr_archery_target_with_hit_a", ":var8"),
              (neg|agent_slot_eq, ":var0", 9, ":var9"),
              (prop_instance_get_position, pos1, ":var9"),
              (714, 2, 1),
              (712, ":var3", 1, 2),
              (lt, ":var3", ":var6"),
              (assign, ":var6", ":var3"),
              (assign, ":var7", ":var9"),
            (try_end),
            (try_begin),
              (lt, ":var6", 40000),
              (prop_instance_get_position, pos1, ":var7"),
              (position_move_z, pos1, 10),
              (init_position, pos3),
              (position_set_x, pos3, -160),
              (position_transform_position_to_local, pos4, pos1, pos3),
              (copy_position, pos1, pos4),
              (1744, ":var0", 1),
              (lt, ":var6", 22500),
              (agent_set_slot, ":var0", 9, ":var7"),
              (1745, ":var0", 0),
            (else_try),
              (agent_get_slot, ":var10", ":var0", 9),
              (ge, ":var10", 0),
              (prop_instance_get_position, pos1, ":var10"),
              (712, ":var3", 1, 2),
              (lt, ":var3", 40000),
              (position_move_z, pos1, 10),
              (init_position, pos3),
              (position_set_x, pos3, -160),
              (position_transform_position_to_local, pos4, pos1, pos3),
              (copy_position, pos1, pos4),
              (1744, ":var0", 1),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var1", "trp_tutorial_rider_1"),
          (try_begin),
            (agent_get_wielded_item, ":var4", ":var0", 0),
            (neq, ":var4", "itm_practice_sword"),
            (1747, ":var0", "itm_practice_sword"),
          (else_try),
            (scene_prop_get_num_instances, ":var5", "spr_dummy_a_undestructable"),
            (assign, ":var6", 10000000),
            (assign, ":var7", -1),
            (try_for_range, ":var8", 0, ":var5"),
              (scene_prop_get_instance, ":var9", "spr_dummy_a_undestructable", ":var8"),
              (neg|agent_slot_eq, ":var0", 9, ":var9"),
              (prop_instance_get_position, pos1, ":var9"),
              (712, ":var3", 1, 2),
              (lt, ":var3", ":var6"),
              (assign, ":var6", ":var3"),
              (assign, ":var7", ":var9"),
            (try_end),
            (try_begin),
              (lt, ":var6", 10000),
              (prop_instance_get_position, pos1, ":var7"),
              (717, 3, 2, 1),
              (position_get_x, ":var11", pos3),
              (position_get_y, ":var12", pos3),
              (is_between, ":var11", -200, 200),
              (gt, ":var12", -100),
              (init_position, pos3),
              (try_begin),
                (lt, ":var11", 0),
                (position_move_x, pos3, -100),
                (position_move_z, pos3, 100),
              (else_try),
                (position_move_x, pos3, 100),
                (position_move_z, pos3, 150),
              (try_end),
              (position_transform_position_to_local, pos4, pos2, pos3),
              (1744, ":var0", 4),
              (try_begin),
                (lt, ":var11", 0),
                (1745, ":var0", 2, 1),
              (else_try),
                (1745, ":var0", 1, 1),
              (try_end),
              (this_or_next|lt, ":var6", 900),
              (lt, ":var12", 100),
              (1745, ":var0", 0, 0),
              (agent_set_slot, ":var0", 9, ":var7"),
            (else_try),
              (agent_get_slot, ":var10", ":var0", 9),
              (ge, ":var10", 0),
              (prop_instance_get_position, pos1, ":var10"),
              (712, ":var3", 1, 2),
              (lt, ":var3", 10000),
              (717, 3, 2, 1),
              (position_get_x, ":var11", pos3),
              (position_get_y, ":var12", pos3),
              (is_between, ":var11", -200, 200),
              (gt, ":var12", -100),
              (init_position, pos3),
              (try_begin),
                (lt, ":var11", 0),
                (position_move_x, pos3, -100),
                (position_move_z, pos3, 100),
              (else_try),
                (position_move_x, pos3, 100),
                (position_move_z, pos3, 150),
              (try_end),
              (position_transform_position_to_local, pos4, pos2, pos3),
              (1744, ":var0", 4),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (store_mission_timer_a, ":var0"),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "trp_tutorial_archer_1"),
        (try_begin),
          (agent_get_wielded_item, ":var3", ":var1", 0),
          (neq, ":var3", "itm_practice_bow"),
          (1747, ":var1", "itm_practice_bow"),
        (else_try),
          (agent_get_slot, ":var4", ":var1", 9),
          (prop_instance_get_position, pos1, ":var4"),
          (1744, ":var1", 1),
          (try_begin),
            (neg|agent_slot_ge, ":var1", 19, ":var0"),
            (1745, ":var1", 0),
            (store_random_in_range, ":var5", 3, 13),
            (val_add, ":var5", ":var0"),
            (agent_set_slot, ":var1", 19, ":var5"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (call_script, "script_iterate_pointer_arrow"),
    ],
    []),

    (5, 0, 0, 
    [
      (try_begin),
        (store_mission_timer_a, ":var0"),
        (ge, ":var0", 30),
        (eq, "$g_tutorial_training_ground_intro_message_being_displayed", 1),
        (assign, "$g_tutorial_training_ground_intro_message_being_displayed", 0),
        (tutorial_message, -1),
      (try_end),
      (get_player_agent_no, ":var1"),
      (try_for_agents, ":var2"),
        (agent_is_human, ":var2"),
        (neq, ":var2", ":var1"),
        (agent_refill_ammo, ":var2"),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (agent_get_wielded_item, ":var1", ":var0", 0),
      (assign, ":var2", 0),
      (try_begin),
        (eq, ":var1", "itm_practice_bow"),
        (agent_has_item_equipped, ":var0", "itm_practice_arrows"),
        (agent_get_ammo, ":var3", ":var0", 1),
        (eq, ":var3", 0),
        (assign, ":var2", 1),
      (else_try),
        (eq, ":var1", "itm_practice_bow_2"),
        (agent_has_item_equipped, ":var0", "itm_practice_arrows_2"),
        (agent_get_ammo, ":var3", ":var0", 1),
        (eq, ":var3", 0),
        (assign, ":var2", 1),
      (else_try),
        (eq, ":var1", "itm_practice_crossbow"),
        (agent_has_item_equipped, ":var0", "itm_practice_bolts"),
        (agent_get_ammo, ":var3", ":var0", 1),
        (eq, ":var3", 0),
        (assign, ":var2", 1),
      (else_try),
        (eq, ":var1", "itm_practice_javelin"),
        (agent_get_ammo, ":var3", ":var0", 1),
        (le, ":var3", 1),
        (assign, ":var2", 1),
      (try_end),
      (eq, ":var2", 1),
      (agent_refill_ammo, ":var0"),
      (dialog_box, "str_tutorial_training_ground_ammo_refill", "@Tutorial"),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_horseman_trainer_state", 0),
      (mission_disable_talk),
      (try_begin),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (assign, "$g_tutorial_training_ground_current_score", 0),
        (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 2),
        (try_begin),
          (try_begin),
            (ge, "$g_tutorial_training_ground_horseman_trainer_item_1", 0),
            (1833, ":var1", "$g_tutorial_training_ground_horseman_trainer_item_1", 0),
            (prop_instance_get_position, pos0, ":var1"),
            (position_move_z, pos0, 1000, 1),
            (prop_instance_set_position, ":var1", pos0),
            (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
            (prop_instance_set_position, ":var2", pos0),
            (assign, "$g_pointer_arrow_height_adder", 200),
            (try_begin),
              (ge, "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
              (1833, ":var1", "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
              (prop_instance_get_position, pos0, ":var1"),
              (position_move_z, pos0, 1000, 1),
              (prop_instance_set_position, ":var1", pos0),
            (try_end),
          (try_end),
          (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 3),
        (try_begin),
          (ge, "$g_tutorial_training_ground_horseman_trainer_item_1", 0),
          (try_begin),
            (str_store_item_name, s0, "$g_tutorial_training_ground_horseman_trainer_item_1"),
            (tutorial_message, "str_tutorial_training_ground_horseman_text_1"),
            (agent_has_item_equipped, ":var0", "$g_tutorial_training_ground_horseman_trainer_item_1"),
            (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
            (play_sound, "snd_tutorial_1"),
          (try_end),
        (else_try),
          (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 4),
        (try_begin),
          (ge, "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
          (try_begin),
            (str_store_item_name, s0, "$g_tutorial_training_ground_horseman_trainer_item_2"),
            (tutorial_message, "str_tutorial_training_ground_horseman_text_1"),
            (agent_has_item_equipped, ":var0", "$g_tutorial_training_ground_horseman_trainer_item_2"),
            (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
            (play_sound, "snd_tutorial_1"),
          (try_end),
        (else_try),
          (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 5),
        (try_begin),
          (agent_get_horse, ":var3", ":var0"),
          (lt, ":var3", 0),
          (tutorial_message, "str_tutorial_training_ground_horseman_text_2"),
          (try_begin),
            (assign, ":var4", -1),
            (try_for_agents, ":var5"),
              (agent_get_item_id, ":var6", ":var5"),
              (eq, ":var6", "itm_practice_horse"),
              (assign, ":var4", ":var5"),
            (try_end),
            (agent_get_position, pos0, ":var4"),
            (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
            (prop_instance_get_position, pos1, ":var2"),
            (set_fixed_point_multiplier, 100),
            (position_get_x, ":var7", pos0),
            (position_get_x, ":var8", pos1),
            (position_get_y, ":var9", pos0),
            (position_get_y, ":var10", pos1),
            (this_or_next|neq, ":var7", ":var8"),
            (neq, ":var9", ":var10"),
            (prop_instance_set_position, ":var2", pos0),
            (assign, "$g_pointer_arrow_height_adder", 200),
          (try_end),
        (else_try),
          (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 6),
        (try_begin),
          (eq, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 0),
          (tutorial_message, "str_tutorial_training_ground_horseman_text_3"),
        (else_try),
          (eq, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 1),
          (assign, ":var11", "spr_dummy_a_undestructable"),
          (tutorial_message, "str_tutorial_training_ground_horseman_text_4"),
        (else_try),
          (assign, ":var11", "spr_archery_target_with_hit_a"),
          (tutorial_message, "str_tutorial_training_ground_horseman_text_5"),
        (try_end),
        (try_begin),
          (eq, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 0),
          (store_add, ":var12", "$g_tutorial_training_ground_current_score", 48),
          (entry_point_get_position, pos0, ":var12"),
          (init_position, pos2),
          (position_move_y, pos2, -800),
          (position_transform_position_to_local, pos3, pos0, pos2),
          (copy_position, pos0, pos3),
          (agent_get_position, pos2, ":var0"),
          (try_begin),
            (get_distance_between_positions, ":var13", pos0, pos2),
            (lt, ":var13", 500),
            (val_add, "$g_tutorial_training_ground_current_score", 1),
            (ge, "$g_tutorial_training_ground_current_score", 10),
            (assign, "$g_pointer_arrow_height_adder", -1000),
            (tutorial_message, "str_tutorial_training_ground_horseman_text_6", 0, 10),
            (assign, "$g_tutorial_training_ground_horseman_trainer_state", 0),
            (val_add, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 1),
            (play_sound, "snd_tutorial_2"),
          (try_end),
          (try_begin),
            (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
            (prop_instance_get_position, pos1, ":var2"),
            (set_fixed_point_multiplier, 1),
            (position_get_x, ":var7", pos0),
            (position_get_x, ":var8", pos1),
            (position_get_y, ":var9", pos0),
            (position_get_y, ":var10", pos1),
            (this_or_next|neq, ":var7", ":var8"),
            (neq, ":var9", ":var10"),
            (prop_instance_set_position, ":var2", pos0),
            (assign, "$g_pointer_arrow_height_adder", 150),
            (play_sound, "snd_tutorial_1"),
          (try_end),
        (else_try),
          (scene_prop_get_num_instances, ":var14", ":var11"),
          (try_begin),
            (lt, "$g_tutorial_training_ground_current_score", 6),
            (assign, ":var15", -1),
            (store_add, ":var16", "$g_tutorial_training_ground_current_score", 1),
            (try_for_range, ":var17", 0, ":var14"),
              (scene_prop_get_instance, ":var18", ":var11", ":var17"),
              (1841, ":var19", ":var18"),
              (eq, ":var16", ":var19"),
              (assign, ":var15", ":var18"),
              (assign, ":var14", 0),
            (try_end),
            (try_begin),
              (prop_instance_get_position, pos0, ":var15"),
              (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
              (prop_instance_get_position, pos1, ":var2"),
              (set_fixed_point_multiplier, 1),
              (position_get_x, ":var7", pos0),
              (position_get_x, ":var8", pos1),
              (position_get_y, ":var9", pos0),
              (position_get_y, ":var10", pos1),
              (this_or_next|neq, ":var7", ":var8"),
              (neq, ":var9", ":var10"),
              (prop_instance_set_position, ":var2", pos0),
              (assign, "$g_pointer_arrow_height_adder", 200),
              (play_sound, "snd_tutorial_1"),
            (try_end),
          (else_try),
            (assign, "$g_pointer_arrow_height_adder", -1000),
            (try_begin),
              (ge, "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
              (1774, ":var0", "$g_tutorial_training_ground_horseman_trainer_item_2"),
            (try_end),
            (1774, ":var0", "$g_tutorial_training_ground_horseman_trainer_item_1"),
            (tutorial_message, "str_tutorial_training_ground_horseman_text_6", 0, 10),
            (assign, "$g_tutorial_training_ground_horseman_trainer_state", 0),
            (val_add, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 1),
            (play_sound, "snd_tutorial_2"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_archer_trainer_state", 0),
      (mission_disable_talk),
      (try_begin),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_begin),
          (assign, "$g_last_destroyed_gourds", 0),
          (assign, "$g_tutorial_training_ground_current_score", 0),
          (1833, ":var1", "$g_tutorial_training_ground_archer_trainer_item_1", 0),
          (prop_instance_get_position, pos0, ":var1"),
          (position_move_z, pos0, 1000, 1),
          (prop_instance_set_position, ":var1", pos0),
          (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
          (prop_instance_set_position, ":var2", pos0),
          (assign, "$g_pointer_arrow_height_adder", 100),
          (try_begin),
            (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
            (1833, ":var1", "$g_tutorial_training_ground_archer_trainer_item_2", 0),
            (prop_instance_get_position, pos0, ":var1"),
            (position_move_z, pos0, 1000, 1),
            (prop_instance_set_position, ":var1", pos0),
          (try_end),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 2),
        (try_begin),
          (str_store_item_name, s0, "$g_tutorial_training_ground_archer_trainer_item_1"),
          (tutorial_message, "str_tutorial_training_ground_archer_text_1"),
          (agent_has_item_equipped, ":var0", "$g_tutorial_training_ground_archer_trainer_item_1"),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 3),
        (try_begin),
          (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
          (try_begin),
            (str_store_item_name, s0, "$g_tutorial_training_ground_archer_trainer_item_2"),
            (tutorial_message, "str_tutorial_training_ground_archer_text_1"),
            (agent_has_item_equipped, ":var0", "$g_tutorial_training_ground_archer_trainer_item_2"),
            (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
            (play_sound, "snd_tutorial_1"),
          (try_end),
        (else_try),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 4),
        (try_begin),
          (try_for_range, ":var3", 0, 3),
            (scene_prop_get_instance, ":var4", "spr_gourd", ":var3"),
            (1870, ":var4"),
            (entry_point_get_position, pos0, 45),
            (init_position, pos1),
            (store_sub, ":var5", ":var3", 1),
            (val_mul, ":var5", 5),
            (position_rotate_z, pos1, ":var5"),
            (try_begin),
              (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
              (position_move_y, pos1, 1300),
            (else_try),
              (position_move_y, pos1, 800),
              (val_mul, ":var5", 2),
            (try_end),
            (position_transform_position_to_local, pos2, pos0, pos1),
            (position_set_z_to_ground_level, pos2),
            (scene_prop_get_instance, ":var6", "spr_gourd_spike", ":var3"),
            (prop_instance_set_position, ":var6", pos2),
            (position_move_z, pos2, 150, 1),
            (prop_instance_set_position, ":var4", pos2),
          (try_end),
          (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
          (scene_prop_get_instance, ":var6", "spr_gourd_spike", 1),
          (prop_instance_get_position, pos1, ":var6"),
          (prop_instance_set_position, ":var2", pos1),
          (assign, "$g_pointer_arrow_height_adder", 200),
          (tutorial_message, "str_tutorial_training_ground_archer_text_2"),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 5),
        (try_begin),
          (try_begin),
            (neq, "$g_tutorial_training_ground_current_score", "$g_last_destroyed_gourds"),
            (assign, "$g_tutorial_training_ground_current_score", "$g_last_destroyed_gourds"),
            (try_begin),
              (lt, "$g_last_destroyed_gourds", 3),
              (play_sound, "snd_tutorial_1"),
            (else_try),
              (play_sound, "snd_tutorial_2"),
            (try_end),
          (try_end),
          (try_begin),
            (eq, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 0),
            (eq, "$g_last_destroyed_gourds", 0),
            (entry_point_get_position, pos0, 45),
            (agent_get_position, pos1, ":var0"),
            (neg|714, 1, 0),
            (tutorial_message, "str_tutorial_training_ground_archer_text_3"),
          (else_try),
            (eq, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 0),
            (eq, "$g_last_destroyed_gourds", 1),
            (tutorial_message, "str_tutorial_training_ground_archer_text_4"),
          (try_end),
          (ge, "$g_last_destroyed_gourds", 3),
          (assign, "$g_pointer_arrow_height_adder", -1000),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 6),
        (try_begin),
          (try_begin),
            (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
            (1774, ":var0", "$g_tutorial_training_ground_archer_trainer_item_2"),
          (try_end),
          (1774, ":var0", "$g_tutorial_training_ground_archer_trainer_item_1"),
          (tutorial_message, "str_tutorial_training_ground_archer_text_5", 0, 10),
          (assign, "$g_tutorial_training_ground_archer_trainer_state", 0),
          (val_add, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 1),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_melee_trainer_attack", -1),
      (mission_disable_talk),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_attack"),
        (assign, ":var3", ":var1"),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (try_for_agents, ":var1"),
            (agent_get_troop_id, ":var2", ":var1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_3"),
            (eq, ":var2", "trp_tutorial_fighter_4"),
            (agent_set_team, ":var1", 7),
            (agent_get_slot, ":var4", ":var1", 8),
            (entry_point_get_position, pos1, ":var4"),
            (agent_set_scripted_destination, ":var1", pos1),
            (1732, ":var1"),
          (try_end),
          (1747, ":var3", "itm_practice_sword"),
          (store_random_in_range, "$g_tutorial_training_ground_melee_state", 1, 5),
          (assign, "$g_tutorial_update_mouse_presentation", 1),
          (assign, "$g_tutorial_training_ground_next_score_time", 0),
        (try_end),
      (else_try),
        (gt, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (agent_set_team, ":var0", 1),
          (agent_set_team, ":var3", 2),
          (agent_get_position, pos1, ":var0"),
          (1748, ":var3", 1),
          (1763, ":var5", ":var0"),
          (try_begin),
            (eq, ":var5", 2),
            (1767, ":var6", ":var0"),
            (try_begin),
              (eq, ":var6", 0),
              (1746, ":var3", 0, 1),
            (else_try),
              (eq, ":var6", 3),
              (1746, ":var3", 3, 1),
            (else_try),
              (eq, ":var6", 1),
              (1746, ":var3", 2, 1),
            (else_try),
              (eq, ":var6", 2),
              (1746, ":var3", 1, 1),
            (try_end),
          (try_end),
          (try_begin),
            (ge, "$g_tutorial_training_ground_current_score", 5),
            (tutorial_message, -1),
            (assign, "$g_tutorial_training_ground_melee_state", 0),
            (agent_set_team, ":var0", 0),
            (agent_set_team, ":var3", 7),
            (agent_set_hit_points, ":var0", 100, 0),
            (agent_set_hit_points, ":var3", 100, 0),
            (assign, "$g_tutorial_training_ground_conversation_state", 9),
            (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_attack"),
            (assign, "$g_tutorial_training_ground_melee_trainer_attack", -1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (1763, ":var5", ":var0"),
        (eq, ":var5", 2),
        (1767, ":var6", ":var0"),
        (store_add, ":var7", ":var6", 1),
        (agent_get_wielded_item, ":var8", ":var0", 0),
        (call_script, "script_cf_is_melee_weapon_for_tutorial", ":var8"),
        (store_mission_timer_a, ":var9"),
        (gt, ":var9", "$g_tutorial_training_ground_next_score_time"),
        (try_begin),
          (eq, ":var7", "$g_tutorial_training_ground_melee_state"),
          (val_add, "$g_tutorial_training_ground_current_score", 1),
          (try_begin),
            (ge, "$g_tutorial_training_ground_current_score", 5),
            (assign, "$g_tutorial_training_ground_melee_state", 5),
            (play_sound, "snd_tutorial_2"),
          (else_try),
            (play_sound, "snd_tutorial_1"),
            (assign, ":var10", 100),
            (try_for_range, ":var11", 0, ":var10"),
              (store_random_in_range, ":var12", 1, 5),
              (neq, ":var12", "$g_tutorial_training_ground_melee_state"),
              (assign, "$g_tutorial_training_ground_melee_state", ":var12"),
              (assign, ":var10", 0),
            (try_end),
          (try_end),
          (assign, "$g_tutorial_update_mouse_presentation", 1),
        (else_try),
          (val_add, "$g_tutorial_training_ground_current_score_2", 1),
          (play_sound, "snd_tutorial_fail"),
        (try_end),
        (store_add, "$g_tutorial_training_ground_next_score_time", ":var9", 1),
      (try_end),
      (assign, reg0, "$g_tutorial_training_ground_current_score"),
      (assign, reg1, "$g_tutorial_training_ground_current_score_2"),
      (str_clear, s0),
      (assign, "$g_tutorial_mouse_dir", -1),
      (assign, "$g_tutorial_mouse_click", -1),
      (try_begin),
        (neq, "$g_tutorial_training_ground_melee_state", 5),
        (store_mission_timer_a, ":var9"),
        (this_or_next|eq, "$g_tutorial_update_mouse_presentation", 0),
        (gt, ":var9", "$g_tutorial_training_ground_next_score_time"),
        (try_begin),
          (eq, "$g_tutorial_training_ground_melee_state", 1),
          (str_store_string, s0, "str_tutorial_training_ground_attack_training_down"),
        (else_try),
          (eq, "$g_tutorial_training_ground_melee_state", 4),
          (str_store_string, s0, "str_tutorial_training_ground_attack_training_up"),
        (else_try),
          (eq, "$g_tutorial_training_ground_melee_state", 2),
          (str_store_string, s0, "str_tutorial_training_ground_attack_training_right"),
        (else_try),
          (eq, "$g_tutorial_training_ground_melee_state", 3),
          (str_store_string, s0, "str_tutorial_training_ground_attack_training_left"),
        (try_end),
        (store_sub, "$g_tutorial_mouse_dir", "$g_tutorial_training_ground_melee_state", 1),
        (assign, "$g_tutorial_mouse_click", 0),
        (try_begin),
          (eq, "$g_tutorial_update_mouse_presentation", 1),
          (assign, "$g_tutorial_update_mouse_presentation", 0),
          (start_presentation, "prsnt_tutorial_show_mouse_movement"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_get_wielded_item, ":var8", ":var0", 0),
        (call_script, "script_cf_is_melee_weapon_for_tutorial", ":var8"),
        (tutorial_message, "str_tutorial_training_ground_attack_training"),
      (else_try),
        (tutorial_message, "str_tutorial_training_ground_warning_melee"),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_melee_trainer_parry", -1),
      (mission_disable_talk),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_parry"),
        (assign, ":var3", ":var1"),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (try_for_agents, ":var1"),
            (agent_get_troop_id, ":var2", ":var1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_3"),
            (eq, ":var2", "trp_tutorial_fighter_4"),
            (agent_set_team, ":var1", 7),
            (agent_get_slot, ":var4", ":var1", 8),
            (entry_point_get_position, pos1, ":var4"),
            (agent_set_scripted_destination, ":var1", pos1),
            (1732, ":var1"),
          (try_end),
          (1747, ":var3", "itm_practice_sword"),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 1),
        (try_begin),
          (store_mission_timer_a, ":var5"),
          (gt, ":var5", "$g_tutorial_training_ground_melee_next_action_time"),
          (agent_set_team, ":var0", 1),
          (agent_set_team, ":var3", 2),
          (agent_get_position, pos1, ":var0"),
          (1748, ":var3", 1),
          (agent_get_position, pos2, ":var3"),
          (712, ":var6", 1, 2),
          (lt, ":var6", 400),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
            (try_begin),
              (ge, "$g_tutorial_training_ground_current_score", 5),
              (assign, "$g_tutorial_mouse_dir", -1),
              (assign, "$g_tutorial_mouse_click", -1),
              (tutorial_message, -1),
              (assign, "$g_tutorial_training_ground_melee_state", 0),
              (agent_set_team, ":var0", 0),
              (agent_set_team, ":var3", 7),
              (agent_set_hit_points, ":var0", 100, 0),
              (agent_set_hit_points, ":var3", 100, 0),
              (assign, "$g_tutorial_training_ground_conversation_state", 1),
              (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_parry"),
              (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
            (else_try),
              (store_random_in_range, ":var7", 0, 4),
              (1745, ":var3", ":var7", 1),
              (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
              (assign, "$g_tutorial_mouse_dir", ":var7"),
              (try_begin),
                (is_between, ":var7", 1, 3),
                (store_sub, "$g_tutorial_mouse_dir", 3, ":var7"),
              (try_end),
              (assign, "$g_tutorial_mouse_click", 1),
              (start_presentation, "prsnt_tutorial_show_mouse_movement"),
            (try_end),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (1764, ":var8", ":var0"),
            (gt, ":var8", 0),
            (1767, ":var9", ":var0"),
            (1767, ":var10", ":var3"),
            (assign, ":var11", 0),
            (try_begin),
              (eq, ":var10", 0),
              (eq, ":var9", 0),
              (assign, ":var11", 1),
            (else_try),
              (eq, ":var10", 3),
              (eq, ":var9", 3),
              (assign, ":var11", 1),
            (else_try),
              (eq, ":var10", 1),
              (eq, ":var9", 2),
              (assign, ":var11", 1),
            (else_try),
              (eq, ":var10", 2),
              (eq, ":var9", 1),
              (assign, ":var11", 1),
            (try_end),
            (eq, ":var11", 1),
            (assign, "$g_tutorial_mouse_dir", -1),
            (assign, "$g_tutorial_mouse_click", -1),
            (1745, ":var3", 0, 0),
            (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
            (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 2),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 2),
            (try_begin),
              (store_mission_timer_a, ":var5"),
              (gt, ":var5", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (assign, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (1769, ":var3"),
        (agent_get_wielded_item, ":var12", ":var0", 1),
        (eq, ":var12", -1),
        (agent_get_wielded_item, ":var13", ":var0", 0),
        (neq, ":var13", "itm_practice_dagger"),
        (call_script, "script_cf_is_melee_weapon_for_tutorial", ":var13"),
        (store_mission_timer_a, ":var5"),
        (gt, ":var5", "$g_tutorial_training_ground_next_score_time"),
        (val_add, "$g_tutorial_training_ground_current_score", 1),
        (try_begin),
          (lt, "$g_tutorial_training_ground_current_score", 5),
          (play_sound, "snd_tutorial_1"),
        (else_try),
          (play_sound, "snd_tutorial_2"),
        (try_end),
        (store_add, "$g_tutorial_training_ground_next_score_time", ":var5", 1),
      (try_end),
      (assign, reg0, "$g_tutorial_training_ground_current_score"),
      (try_begin),
        (agent_get_wielded_item, ":var12", ":var0", 1),
        (eq, ":var12", -1),
        (agent_get_wielded_item, ":var13", ":var0", 0),
        (neq, ":var13", "itm_practice_dagger"),
        (call_script, "script_cf_is_melee_weapon_for_tutorial", ":var13"),
        (tutorial_message, "str_tutorial_training_ground_parry_training"),
      (else_try),
        (neq, ":var12", -1),
        (tutorial_message, "str_tutorial_training_ground_warning_shield"),
      (else_try),
        (tutorial_message, "str_tutorial_training_ground_warning_melee_with_parry"),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
      (mission_disable_talk),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_chamber"),
        (assign, ":var3", ":var1"),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (try_for_agents, ":var1"),
            (agent_get_troop_id, ":var2", ":var1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_3"),
            (eq, ":var2", "trp_tutorial_fighter_4"),
            (agent_set_team, ":var1", 7),
            (agent_get_slot, ":var4", ":var1", 8),
            (entry_point_get_position, pos1, ":var4"),
            (agent_set_scripted_destination, ":var1", pos1),
            (1732, ":var1"),
          (try_end),
          (1747, ":var3", "itm_practice_sword"),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 1),
        (try_begin),
          (store_mission_timer_a, ":var5"),
          (gt, ":var5", "$g_tutorial_training_ground_melee_next_action_time"),
          (agent_set_team, ":var0", 1),
          (agent_set_team, ":var3", 2),
          (agent_get_position, pos1, ":var0"),
          (1748, ":var3", 1),
          (agent_get_position, pos2, ":var3"),
          (712, ":var6", 1, 2),
          (lt, ":var6", 400),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
            (try_begin),
              (ge, "$g_tutorial_training_ground_current_score", 5),
              (tutorial_message, -1),
              (assign, "$g_tutorial_training_ground_melee_state", 0),
              (agent_set_team, ":var0", 0),
              (agent_set_team, ":var3", 7),
              (agent_set_hit_points, ":var0", 100, 0),
              (agent_set_hit_points, ":var3", 100, 0),
              (assign, "$g_tutorial_training_ground_conversation_state", 6),
              (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_chamber"),
              (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
            (else_try),
              (store_random_in_range, "$g_tutorial_training_ground_melee_trainer_attack_dir", 0, 4),
              (1745, ":var3", "$g_tutorial_training_ground_melee_trainer_attack_dir", 1),
              (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
              (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 1),
            (try_end),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (try_begin),
              (store_mission_timer_a, ":var5"),
              (gt, ":var5", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (1745, ":var3", -1, 0),
              (1746, ":var3", 0, 1),
              (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
              (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 1),
            (try_end),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 2),
            (try_begin),
              (store_mission_timer_a, ":var5"),
              (gt, ":var5", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (1745, ":var3", "$g_tutorial_training_ground_melee_trainer_attack_dir", 0),
              (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
              (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 2),
            (try_end),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 3),
            (try_begin),
              (store_mission_timer_a, ":var5"),
              (gt, ":var5", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (assign, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (1769, ":var3"),
        (1763, ":var7", ":var0"),
        (store_mission_timer_a, ":var5"),
        (gt, ":var5", "$g_tutorial_training_ground_next_score_time"),
        (store_add, "$g_tutorial_training_ground_next_score_time", ":var5", 1),
        (eq, ":var7", 1),
        (val_add, "$g_tutorial_training_ground_current_score", 1),
        (try_begin),
          (lt, "$g_tutorial_training_ground_current_score", 5),
          (play_sound, "snd_tutorial_1"),
        (else_try),
          (play_sound, "snd_tutorial_2"),
        (try_end),
      (try_end),
      (assign, reg0, "$g_tutorial_training_ground_current_score"),
      (tutorial_message, "str_tutorial_training_ground_chamber_training"),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_melee_trainer_combat", -1),
      (mission_disable_talk),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_combat"),
        (assign, ":var3", ":var1"),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (try_for_agents, ":var1"),
            (agent_get_troop_id, ":var2", ":var1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_3"),
            (eq, ":var2", "trp_tutorial_fighter_4"),
            (agent_set_team, ":var1", 7),
            (agent_get_slot, ":var4", ":var1", 8),
            (entry_point_get_position, pos1, ":var4"),
            (agent_set_scripted_destination, ":var1", pos1),
            (1732, ":var1"),
          (try_end),
          (1747, ":var3", "itm_practice_sword"),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 1),
        (try_begin),
          (store_mission_timer_a, ":var5"),
          (gt, ":var5", "$g_tutorial_training_ground_melee_next_action_time"),
          (agent_set_team, ":var0", 1),
          (agent_set_team, ":var3", 2),
          (agent_clear_scripted_mode, ":var3"),
          (1732, ":var3"),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$g_tutorial_training_ground_melee_trainer_attack", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_parry", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_combat", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
      (eq, "$g_tutorial_training_ground_archer_trainer_state", 0),
      (eq, "$g_tutorial_training_ground_horseman_trainer_state", 0),
      (mission_enable_talk),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$g_tutorial_training_ground_melee_trainer_attack", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_parry", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_combat", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var1", 10000000),
      (try_for_agents, ":var2"),
        (agent_get_troop_id, ":var3", ":var2"),
        (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
        (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
        (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
        (eq, ":var3", "trp_tutorial_fighter_4"),
        (agent_get_position, pos2, ":var2"),
        (712, ":var4", 1, 2),
        (lt, ":var4", ":var1"),
        (assign, ":var1", ":var4"),
      (try_end),
      (try_begin),
        (le, ":var1", 1600),
        (assign, "$g_tutorial_training_ground_melee_paused", 1),
        (try_for_agents, ":var2"),
          (agent_get_troop_id, ":var3", ":var2"),
          (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
          (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
          (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
          (eq, ":var3", "trp_tutorial_fighter_4"),
          (agent_set_team, ":var2", 7),
          (agent_get_position, pos2, ":var2"),
          (agent_set_scripted_destination, ":var2", pos2),
          (try_begin),
            (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
            (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
            (1747, ":var2", -1),
          (try_end),
          (1732, ":var2"),
          (1713, ":var2", ":var0"),
        (try_end),
      (else_try),
        (gt, "$g_tutorial_training_ground_melee_paused", 0),
        (assign, "$g_tutorial_training_ground_melee_paused", 0),
        (assign, "$g_tutorial_training_ground_melee_state", 0),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_paused", 0),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
          (assign, "$g_tutorial_training_ground_melee_cur_fighter_2", -1),
          (try_for_range, ":var5", 0, 2),
            (try_begin),
              (ge, "$g_tutorial_training_ground_melee_last_winner", 0),
              (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", "$g_tutorial_training_ground_melee_last_winner"),
              (assign, "$g_tutorial_training_ground_melee_last_winner", -1),
            (try_end),
            (this_or_next|eq, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
            (eq, "$g_tutorial_training_ground_melee_cur_fighter_2", -1),
            (assign, ":var6", 0),
            (try_for_agents, ":var2"),
              (agent_get_troop_id, ":var3", ":var2"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
              (eq, ":var3", "trp_tutorial_fighter_4"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_last_loser"),
              (val_add, ":var6", 1),
            (try_end),
            (store_random_in_range, ":var7", 0, ":var6"),
            (try_for_agents, ":var2"),
              (agent_get_troop_id, ":var3", ":var2"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
              (eq, ":var3", "trp_tutorial_fighter_4"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_last_loser"),
              (val_sub, ":var7", 1),
              (lt, ":var7", 0),
              (try_begin),
                (eq, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
                (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", ":var2"),
              (else_try),
                (assign, "$g_tutorial_training_ground_melee_cur_fighter_2", ":var2"),
              (try_end),
            (try_end),
          (try_end),
          (try_for_agents, ":var2"),
            (agent_get_troop_id, ":var3", ":var2"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
            (eq, ":var3", "trp_tutorial_fighter_4"),
            (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
            (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
            (1747, ":var2", -1),
          (try_end),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 3),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 1),
        (try_begin),
          (store_mission_timer_a, ":var8"),
          (gt, ":var8", "$g_tutorial_training_ground_melee_next_action_time"),
          (try_for_agents, ":var2"),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, ":var3", ":var2"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
            (eq, ":var3", "trp_tutorial_fighter_4"),
            (try_begin),
              (eq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
              (entry_point_get_position, pos1, 30),
              (agent_set_scripted_destination, ":var2", pos1),
            (else_try),
              (eq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
              (entry_point_get_position, pos1, 31),
              (agent_set_scripted_destination, ":var2", pos1),
            (else_try),
              (agent_get_slot, ":var9", ":var2", 8),
              (entry_point_get_position, pos1, ":var9"),
              (agent_set_scripted_destination, ":var2", pos1),
            (try_end),
          (try_end),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 2),
        (try_begin),
          (1713, "$g_tutorial_training_ground_melee_cur_fighter_1", "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (1713, "$g_tutorial_training_ground_melee_cur_fighter_2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (agent_get_position, pos1, "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (entry_point_get_position, pos2, 30),
          (712, ":var10", 1, 2),
          (lt, ":var10", 400),
          (agent_get_position, pos1, "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (entry_point_get_position, pos2, 31),
          (712, ":var11", 1, 2),
          (lt, ":var11", 400),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 3),
        (try_begin),
          (1713, "$g_tutorial_training_ground_melee_cur_fighter_1", "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (1713, "$g_tutorial_training_ground_melee_cur_fighter_2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (store_mission_timer_a, ":var8"),
          (gt, ":var8", "$g_tutorial_training_ground_melee_next_action_time"),
          (agent_clear_scripted_mode, "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (agent_clear_scripted_mode, "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_1", 1),
          (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_2", 2),
          (1732, "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (1732, "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
        (try_end),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_1", 0, -1,
  "You enter the training ground.",
  [
    (0, mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_tutorial_shield,itm_tutorial_sword,itm_tutorial_short_bow,itm_tutorial_arrows,itm_leather_jerkin,itm_leather_boots]),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_1_state", 5),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (1124, 17, 17),
      (1123, 500, 650),
      (1125, 0),
      (assign, "$tutorial_1_state", 0),
      (assign, "$tutorial_1_msg_1_displayed", 0),
      (assign, "$tutorial_1_msg_2_displayed", 0),
      (assign, "$tutorial_1_msg_3_displayed", 0),
      (assign, "$tutorial_1_msg_4_displayed", 0),
      (assign, "$tutorial_1_msg_5_displayed", 0),
      (assign, "$tutorial_1_msg_6_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_1_state", 0),
        (try_begin),
          (eq, "$tutorial_1_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_1_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_1"),
          (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
          (entry_point_get_position, pos1, 1),
          (prop_instance_animate_to_position, ":var1", pos1, 1),
        (try_end),
        (tutorial_message, "str_tutorial_1_msg_1"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 1),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 100),
        (val_add, "$tutorial_1_state", 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (entry_point_get_position, pos1, 2),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_1_state", 1),
        (try_begin),
          (eq, "$tutorial_1_msg_2_displayed", 0),
          (assign, "$tutorial_1_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 100),
        (val_add, "$tutorial_1_state", 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (entry_point_get_position, pos1, 3),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_1_state", 2),
        (try_begin),
          (eq, "$tutorial_1_msg_3_displayed", 0),
          (assign, "$tutorial_1_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_3"),
          (assign, "$tutorial_num_total_dummies_destroyed", 0),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (ge, "$tutorial_num_total_dummies_destroyed", 4),
        (val_add, "$tutorial_1_state", 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 2),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
      (else_try),
        (eq, "$tutorial_1_state", 3),
        (try_begin),
          (eq, "$tutorial_1_msg_4_displayed", 0),
          (assign, "$tutorial_1_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_4"),
          (store_mission_timer_a, "$tutorial_time"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (gt, ":var0", 10),
        (val_add, "$tutorial_1_state", 1),
      (else_try),
        (eq, "$tutorial_1_state", 4),
        (try_begin),
          (eq, "$tutorial_1_msg_5_displayed", 0),
          (assign, "$tutorial_1_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_5"),
          (assign, "$g_last_archery_point_earned", 0),
          (assign, "$tutorial_num_arrows_hit", 0),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (try_begin),
          (get_player_agent_no, ":var2"),
          (agent_get_ammo, ":var5", ":var2"),
          (le, ":var5", 0),
          (agent_refill_ammo, ":var2"),
          (tutorial_message, "str_tutorial_ammo_refilled"),
        (try_end),
        (gt, "$g_last_archery_point_earned", 0),
        (assign, "$g_last_archery_point_earned", 0),
        (val_add, "$tutorial_num_arrows_hit", 1),
        (gt, "$tutorial_num_arrows_hit", 2),
        (val_add, "$tutorial_1_state", 1),
      (else_try),
        (eq, "$tutorial_1_state", 5),
        (eq, "$tutorial_1_msg_6_displayed", 0),
        (assign, "$tutorial_1_msg_6_displayed", 1),
        (tutorial_message, "str_tutorial_1_msg_6"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_1_finished", 1),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_2", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_tutorial_shield,itm_leather_jerkin,itm_leather_boots]),
    (2, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, 0, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_2_state", 9),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_2_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (1124, 17, 17),
      (1123, 500, 650),
      (1125, 0),
      (assign, "$tutorial_2_state", 0),
      (assign, "$tutorial_2_msg_1_displayed", 0),
      (assign, "$tutorial_2_msg_2_displayed", 0),
      (assign, "$tutorial_2_msg_3_displayed", 0),
      (assign, "$tutorial_2_msg_4_displayed", 0),
      (assign, "$tutorial_2_msg_5_displayed", 0),
      (assign, "$tutorial_2_msg_6_displayed", 0),
      (assign, "$tutorial_2_msg_7_displayed", 0),
      (assign, "$tutorial_2_msg_8_displayed", 0),
      (assign, "$tutorial_2_msg_9_displayed", 0),
      (assign, "$tutorial_2_melee_agent_state", 0),
    ],
    []),

    (10, 0, 0, 
    [
      (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_archer"),
      (agent_refill_ammo, reg0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_2_state", 0),
        (try_begin),
          (eq, "$tutorial_2_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_2_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_1"),
          (team_give_order, 1, 9, 11),
          (team_give_order, 1, 0, 2),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
        (try_end),
        (get_player_agent_no, ":var2"),
        (ge, ":var2", 0),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 1),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 200),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 1),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 0),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (714, 2, 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 2),
        (get_player_agent_no, ":var2"),
        (1754, ":var2", 0),
        (try_begin),
          (eq, "$tutorial_2_melee_agent_state", 0),
          (val_add, "$tutorial_2_melee_agent_state", 1),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 3),
          (agent_set_scripted_destination, ":var1", pos1, 0),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 1),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 3),
          (agent_get_position, pos2, ":var1"),
          (get_distance_between_positions, ":var3", pos1, pos2),
          (le, ":var3", 250),
          (agent_clear_scripted_mode, ":var1"),
          (val_add, "$tutorial_2_melee_agent_state", 1),
          (store_mission_timer_a, "$tutorial_time"),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 2),
          (try_begin),
            (eq, "$tutorial_2_msg_2_displayed", 0),
            (assign, "$tutorial_2_msg_2_displayed", 1),
            (play_sound, "snd_tutorial_1"),
          (try_end),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (store_mission_timer_a, ":var0"),
          (val_sub, ":var0", "$tutorial_time"),
          (store_sub, reg3, 20, ":var0"),
          (tutorial_message, "str_tutorial_2_msg_2"),
          (gt, ":var0", 20),
          (entry_point_get_position, pos1, 3),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (val_add, "$tutorial_2_melee_agent_state", 1),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 3),
          (try_begin),
            (eq, "$tutorial_2_msg_3_displayed", 0),
            (assign, "$tutorial_2_msg_3_displayed", 1),
            (tutorial_message, "str_tutorial_2_msg_3"),
            (play_sound, "snd_tutorial_1"),
          (try_end),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 3),
          (agent_get_position, pos2, ":var1"),
          (get_distance_between_positions, ":var3", pos1, pos2),
          (le, ":var3", 250),
          (entry_point_get_position, pos1, 2),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (val_add, "$tutorial_2_melee_agent_state", 1),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 4),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 2),
          (agent_get_position, pos2, ":var1"),
          (get_distance_between_positions, ":var3", pos1, pos2),
          (le, ":var3", 250),
          (entry_point_get_position, pos1, 30),
          (agent_set_position, ":var1", pos1),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 1),
          (prop_instance_get_position, pos1, ":var4"),
          (position_rotate_z, pos1, 90),
          (prop_instance_animate_to_position, ":var4", pos1, 150),
          (val_add, "$tutorial_2_melee_agent_state", 1),
          (val_add, "$tutorial_2_state", 1),
        (try_end),
      (else_try),
        (eq, "$tutorial_2_state", 3),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 1),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (1754, ":var2", 1),
        (agent_get_position, pos2, ":var2"),
        (714, 2, 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (store_mission_timer_a, "$tutorial_time"),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 4),
        (try_begin),
          (eq, "$tutorial_2_msg_4_displayed", 0),
          (assign, "$tutorial_2_msg_4_displayed", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (store_sub, reg3, 20, ":var0"),
        (tutorial_message, "str_tutorial_2_msg_4"),
        (gt, ":var0", 20),
        (entry_point_get_position, pos1, 5),
        (set_spawn_position, pos1),
        (spawn_item, "itm_tutorial_sword"),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 3),
        (agent_set_position, ":var1", pos1),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 2),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 5),
        (try_begin),
          (eq, "$tutorial_2_msg_5_displayed", 0),
          (assign, "$tutorial_2_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_5"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 2),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (714, 2, 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 2),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 6),
        (try_begin),
          (eq, "$tutorial_2_msg_6_displayed", 0),
          (assign, "$tutorial_2_msg_6_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_6"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_has_item_equipped, ":var2", "itm_tutorial_sword"),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 3),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 7),
        (try_begin),
          (eq, "$tutorial_2_msg_7_displayed", 0),
          (assign, "$tutorial_2_msg_7_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_7"),
          (play_sound, "snd_tutorial_1"),
          (get_player_agent_no, ":var2"),
          (agent_set_hit_points, ":var2", 100),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_archer"),
        (assign, ":var1", reg0),
        (neg|agent_is_alive, ":var1"),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (agent_clear_scripted_mode, ":var1"),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 4),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 8),
        (try_begin),
          (eq, "$tutorial_2_msg_8_displayed", 0),
          (assign, "$tutorial_2_msg_8_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_8"),
          (play_sound, "snd_tutorial_1"),
          (get_player_agent_no, ":var2"),
          (agent_set_hit_points, ":var2", 100),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (neg|agent_is_alive, ":var1"),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 9),
        (eq, "$tutorial_2_msg_9_displayed", 0),
        (assign, "$tutorial_2_msg_9_displayed", 1),
        (tutorial_message, "str_tutorial_2_msg_9"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_2_finished", 1),
      (else_try),
        (gt, "$tutorial_2_state", 30),
        (tutorial_message, "str_tutorial_failed"),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_3", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_leather_jerkin,itm_leather_boots]),
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_3_state", 12),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_3_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (1124, 17, 17),
      (1123, 500, 650),
      (1125, 0),
      (assign, "$tutorial_3_state", 0),
      (assign, "$tutorial_3_msg_1_displayed", 0),
      (assign, "$tutorial_3_msg_2_displayed", 0),
      (assign, "$tutorial_3_msg_3_displayed", 0),
      (assign, "$tutorial_3_msg_4_displayed", 0),
      (assign, "$tutorial_3_msg_5_displayed", 0),
      (assign, "$tutorial_3_msg_6_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_3_state", 0),
        (try_begin),
          (eq, "$tutorial_3_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_3_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_1"),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (entry_point_get_position, pos1, 1),
          (set_spawn_position, pos1),
          (spawn_item, "itm_tutorial_staff_no_attack"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (ge, ":var2", 0),
        (agent_has_item_equipped, ":var2", "itm_tutorial_staff_no_attack"),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 1),
        (try_begin),
          (eq, "$tutorial_3_msg_2_displayed", 0),
          (assign, "$tutorial_3_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 200),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 2),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 0),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (714, 2, 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 3),
        (get_player_agent_no, ":var2"),
        (1754, ":var2", 0),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 4),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 4),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 4),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (agent_clear_scripted_mode, ":var1"),
        (val_add, "$tutorial_3_state", 1),
        (store_mission_timer_a, "$tutorial_time"),
      (else_try),
        (eq, "$tutorial_3_state", 5),
        (try_begin),
          (eq, "$tutorial_3_msg_3_displayed", 0),
          (assign, "$tutorial_3_msg_3_displayed", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (store_sub, reg3, 20, ":var0"),
        (tutorial_message, "str_tutorial_3_msg_3"),
        (gt, ":var0", 20),
        (entry_point_get_position, pos1, 4),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 6),
        (try_begin),
          (eq, "$tutorial_3_msg_4_displayed", 0),
          (assign, "$tutorial_3_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 4),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 3),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 7),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 3),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 7),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (agent_set_position, ":var1", pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 3),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 8),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 1),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (714, 2, 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 9),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 6),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 10),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 6),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (agent_clear_scripted_mode, ":var1"),
        (val_add, "$tutorial_3_state", 1),
        (store_mission_timer_a, "$tutorial_time"),
      (else_try),
        (eq, "$tutorial_3_state", 11),
        (try_begin),
          (eq, "$tutorial_3_msg_5_displayed", 0),
          (assign, "$tutorial_3_msg_5_displayed", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (store_sub, reg3, 20, ":var0"),
        (tutorial_message, "str_tutorial_3_msg_5"),
        (gt, ":var0", 20),
        (entry_point_get_position, pos1, 6),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 12),
        (try_begin),
          (eq, "$tutorial_3_msg_6_displayed", 0),
          (assign, "$tutorial_3_msg_6_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_6"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 6),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 5),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 13),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 5),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 7),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (agent_set_position, ":var1", pos1),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (gt, "$tutorial_3_state", 30),
        (tutorial_message, "str_tutorial_failed"),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_3_2", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_tutorial_staff,itm_leather_jerkin,itm_leather_boots]),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_3_state", 5),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_3_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (1124, 17, 17),
      (1123, 500, 650),
      (1125, 0),
      (assign, "$tutorial_3_state", 0),
      (assign, "$tutorial_3_msg_1_displayed", 0),
      (assign, "$tutorial_3_msg_2_displayed", 0),
      (assign, "$tutorial_3_msg_3_displayed", 0),
      (assign, "$tutorial_3_msg_4_displayed", 0),
      (assign, "$tutorial_3_msg_5_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_3_state", 0),
        (try_begin),
          (eq, "$tutorial_3_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_3_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_1"),
          (play_sound, "snd_tutorial_1"),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 200),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 1),
        (try_begin),
          (eq, "$tutorial_3_msg_2_displayed", 0),
          (assign, "$tutorial_3_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 0),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (714, 2, 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (agent_clear_scripted_mode, reg0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 2),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (neg|agent_is_alive, reg0),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 3),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 3),
        (try_begin),
          (eq, "$tutorial_3_msg_3_displayed", 0),
          (assign, "$tutorial_3_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_3"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 1),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (714, 2, 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (agent_clear_scripted_mode, reg0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 4),
        (try_begin),
          (eq, "$tutorial_3_msg_4_displayed", 0),
          (assign, "$tutorial_3_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (neg|agent_is_alive, reg0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 5),
        (eq, "$tutorial_3_msg_5_displayed", 0),
        (assign, "$tutorial_3_msg_5_displayed", 1),
        (tutorial_message, "str_tutorial_3_2_msg_5"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_3_finished", 1),
      (else_try),
        (gt, "$tutorial_3_state", 30),
        (tutorial_message, "str_tutorial_failed"),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_4", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_tutorial_sword,itm_tutorial_short_bow,itm_tutorial_arrows,itm_leather_jerkin,itm_leather_boots]),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_4_state", 11),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (1266, 13),
    ]),

    (0, 0, ti_once, 
    [
      (1124, 17, 17),
      (1123, 500, 650),
      (1125, 0),
      (assign, "$tutorial_4_state", 0),
      (assign, "$tutorial_4_msg_1_displayed", 0),
      (assign, "$tutorial_4_msg_2_displayed", 0),
      (assign, "$tutorial_4_msg_3_displayed", 0),
      (assign, "$tutorial_4_msg_4_displayed", 0),
      (assign, "$tutorial_4_msg_5_displayed", 0),
      (assign, "$tutorial_4_msg_6_displayed", 0),
      (assign, "$tutorial_4_msg_7_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_4_state", 0),
        (try_begin),
          (eq, "$tutorial_4_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_4_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_1"),
          (entry_point_get_position, pos1, 1),
          (set_spawn_position, pos1),
          (spawn_horse, "itm_tutorial_saddle_horse"),
          (assign, "$tutorial_num_total_dummies_destroyed", 0),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (ge, ":var2", 0),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 2),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 1),
        (try_begin),
          (eq, "$tutorial_4_msg_2_displayed", 0),
          (assign, "$tutorial_4_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 3),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 2),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 3),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 4),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 3),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 4),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 5),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 4),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 5),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 6),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 5),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 6),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 1),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 6),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 1),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 7),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 7),
        (try_begin),
          (eq, "$tutorial_4_msg_3_displayed", 0),
          (assign, "$tutorial_4_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_3"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 7),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 20),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 8),
        (try_begin),
          (eq, "$tutorial_4_msg_4_displayed", 0),
          (assign, "$tutorial_4_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (ge, "$tutorial_num_total_dummies_destroyed", 2),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 8),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 9),
        (try_begin),
          (eq, "$tutorial_4_msg_5_displayed", 0),
          (assign, "$tutorial_4_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_5"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 8),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 20),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 10),
        (try_begin),
          (eq, "$tutorial_4_msg_6_displayed", 0),
          (assign, "$tutorial_4_msg_6_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_6"),
          (play_sound, "snd_tutorial_1"),
          (assign, "$g_last_archery_point_earned", 0),
          (assign, "$tutorial_num_arrows_hit", 0),
        (try_end),
        (try_begin),
          (get_player_agent_no, ":var1"),
          (agent_get_ammo, ":var5", ":var1"),
          (le, ":var5", 0),
          (agent_refill_ammo, ":var1"),
          (tutorial_message, "str_tutorial_ammo_refilled"),
        (try_end),
        (gt, "$g_last_archery_point_earned", 0),
        (assign, "$g_last_archery_point_earned", 0),
        (val_add, "$tutorial_num_arrows_hit", 1),
        (gt, "$tutorial_num_arrows_hit", 2),
        (val_add, "$tutorial_4_state", 1),
      (else_try),
        (eq, "$tutorial_4_state", 11),
        (eq, "$tutorial_4_msg_7_displayed", 0),
        (assign, "$tutorial_4_msg_7_displayed", 1),
        (tutorial_message, "str_tutorial_4_msg_7"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_4_finished", 1),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_5", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_tutorial_sword,itm_tutorial_shield,itm_tutorial_short_bow,itm_tutorial_arrows,itm_tutorial_saddle_horse,itm_leather_jerkin,itm_leather_boots]),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (14, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (15, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_5_state", 5),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_5_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (1124, 17, 17),
      (1123, 500, 650),
      (1125, 0),
      (assign, "$tutorial_5_state", 0),
      (assign, "$tutorial_5_msg_1_displayed", 0),
      (assign, "$tutorial_5_msg_2_displayed", 0),
      (assign, "$tutorial_5_msg_3_displayed", 0),
      (assign, "$tutorial_5_msg_4_displayed", 0),
      (assign, "$tutorial_5_msg_5_displayed", 0),
      (assign, "$tutorial_5_msg_6_displayed", 0),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (team_give_order, 0, 9, 11),
      (set_show_messages, 1),
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 3),
    ],
    []),

    (0, 0, 0, 
    [
      (call_script, "script_cf_turn_windmill_fans", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_5_state", 0),
        (try_begin),
          (eq, "$tutorial_5_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_5_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_1"),
          (entry_point_get_position, pos1, 5),
          (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
          (prop_instance_animate_to_position, ":var1", pos1, 1),
        (try_end),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 0),
        (entry_point_get_position, pos2, 5),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (val_add, "$tutorial_5_state", 1),
        (entry_point_get_position, pos1, 6),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_5_state", 1),
        (try_begin),
          (eq, "$tutorial_5_msg_2_displayed", 0),
          (assign, "$tutorial_5_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 0),
        (entry_point_get_position, pos2, 5),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (get_player_agent_no, ":var3"),
        (agent_get_position, pos1, ":var3"),
        (entry_point_get_position, pos2, 6),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 500),
        (val_add, "$tutorial_5_state", 1),
        (entry_point_get_position, pos1, 7),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (entry_point_get_position, pos1, 30),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_5_state", 2),
        (try_begin),
          (eq, "$tutorial_5_msg_3_displayed", 0),
          (assign, "$tutorial_5_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_3"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var3"),
        (agent_get_position, pos1, ":var3"),
        (entry_point_get_position, pos2, 7),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 500),
        (val_add, "$tutorial_5_state", 1),
        (modify_visitors_at_site, "scn_tutorial_5"),
        (reset_visitors),
        (set_visitor, 5, "trp_rav_archer"),
        (set_visitor, 6, "trp_rav_archer"),
        (set_visitor, 7, "trp_rav_archer"),
        (entry_point_get_position, pos1, 11),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (entry_point_get_position, pos1, 12),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (set_show_messages, 0),
        (team_give_order, 0, 1, 11),
        (set_show_messages, 1),
      (else_try),
        (eq, "$tutorial_5_state", 3),
        (try_begin),
          (eq, "$tutorial_5_msg_4_displayed", 0),
          (assign, "$tutorial_5_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 1),
        (entry_point_get_position, pos2, 11),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 0),
        (entry_point_get_position, pos2, 12),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (val_add, "$tutorial_5_state", 1),
        (entry_point_get_position, pos1, 30),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (modify_visitors_at_site, "scn_tutorial_5"),
        (reset_visitors),
        (set_visitor, 8, "trp_bandit"),
        (set_visitor, 9, "trp_bandit"),
        (set_visitor, 10, "trp_bandit"),
        (set_visitor, 11, "trp_bandit"),
        (team_give_order, 1, 9, 2),
      (else_try),
        (eq, "$tutorial_5_state", 4),
        (try_begin),
          (eq, "$tutorial_5_msg_5_displayed", 0),
          (assign, "$tutorial_5_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_5"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (assign, ":var4", 0),
        (try_for_agents, ":var5"),
          (agent_is_human, ":var5"),
          (agent_is_alive, ":var5"),
          (agent_get_team, ":var6", ":var5"),
          (eq, ":var6", 1),
          (val_add, ":var4", 1),
        (try_end),
        (eq, ":var4", 0),
        (val_add, "$tutorial_5_state", 1),
      (else_try),
        (eq, "$tutorial_5_state", 5),
        (eq, "$tutorial_5_msg_6_displayed", 0),
        (assign, "$tutorial_5_msg_6_displayed", 1),
        (tutorial_message, "str_tutorial_5_msg_6"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_5_finished", 1),
      (else_try),
        (gt, "$tutorial_5_state", 30),
        (tutorial_message, "str_tutorial_failed"),
        (entry_point_get_position, pos1, 30),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (try_end),
    ],
    []),

  ]),

  ("quick_battle_battle", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (neq, "$g_battle_result", 0),
        (call_script, "script_custom_battle_end"),
        (finish_mission),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_battle_result", -1),
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (1266, 15),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_result", 0),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (set_mission_result, 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

  ]),

  ("quick_battle_siege", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (33, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (34, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (35, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (36, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (37, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (38, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (39, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (40, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (1266, 15),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (neq, "$g_battle_result", 0),
        (call_script, "script_custom_battle_end"),
        (finish_mission),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_battle_result", -1),
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_result", 0),
      (call_script, "script_music_set_situation_with_culture", 262144),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (set_mission_result, 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (call_script, "script_victory_message"),
      (display_message, "@{s37}"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (5, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$attacker_team"),
        (eq, ":var1", "$attacker_team_2"),
        (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (try_end),
    ]),

    (60, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var1"),
      (try_end),
    ]),

    (180, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (this_or_next|eq, ":var1", "$defender_team"),
      (eq, ":var1", "$defender_team_2"),
      (agent_refill_ammo, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (call_script, "script_siege_init_ai_and_belfry"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_move_belfry"),
    ],
    []),

    (0, 2, ti_once, 
    [
      (call_script, "script_cf_siege_rotate_belfry_platform"),
    ],
    [
      (assign, "$belfry_positioned", 3),
    ]),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_assign_men_to_belfry"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (try_for_range, ":var0", 0, 9),
        (neq, ":var0", 1),
        (team_give_order, "$defender_team", ":var0", 0),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 0),
        (team_give_order, "$defender_team_2", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 7),
      (try_end),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 9, pos10),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 9, pos10),
      (set_show_messages, 1),
    ],
    []),

    (ti_on_order_issued, 0, 0, 
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (eq, ":var0", 9),
        (assign, "$dont_use_fist_enable", 1),
      (else_try),
        (this_or_next|eq, ":var0", 10),
        (this_or_next|eq, ":var0", 13),
        (this_or_next|eq, ":var0", 15),
        (this_or_next|eq, ":var0", 16),
        (this_or_next|eq, ":var0", 17),
        (this_or_next|eq, ":var0", 18),
        (this_or_next|eq, ":var0", 19),
        (this_or_next|eq, ":var0", 20),
        (eq, ":var0", 21),
        (assign, "$dont_use_fist_enable", 0),
      (try_end),
    ],
    []),

    (3, 3, 0, 
    [
      (eq, "$dont_use_fist_enable", 1),
      (set_show_messages, 0),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (le, ":var1", -1),
        (agent_get_team, ":var2", ":var0"),
        (1773, ":var3", ":var0"),
        (team_give_order, ":var2", ":var3", 10),
      (try_end),
      (set_show_messages, 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_ally, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (assign, ":var1", 4),
        (try_for_range, ":var2", 0, ":var1"),
          (1804, ":var3", ":var0", ":var2"),
          (gt, ":var3", 0),
          (2721, ":var4", ":var3"),
          (eq, ":var4", 2),
          (1747, ":var0", ":var3"),
          (assign, ":var1", -1),
        (try_end),
      (try_end),
    ]),

  ]),

  ("multiplayer_dm", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (1, 5, 0, 
    [
      (417),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 0),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (420),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (426, 0, -1),
      (426, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (try_begin),
        (415, ":var0"),
        (is_between, ":var0", 0, 1000),
        (402, ":var1", ":var0"),
        (lt, ":var1", 2),
        (433, ":var2", ":var0"),
        (435, ":var3", ":var0"),
        (store_mul, ":var4", ":var2", 1000),
        (val_sub, ":var4", ":var3"),
        (assign, ":var5", 1),
        (400, ":var6"),
        (assign, ":var7", ":var6"),
        (try_for_range, ":var8", 0, ":var7"),
          (401, ":var8"),
          (402, ":var9", ":var8"),
          (this_or_next|eq, ":var9", 0),
          (eq, ":var9", 1),
          (433, ":var2", ":var8"),
          (435, ":var3", ":var8"),
          (store_mul, ":var10", ":var2", 1000),
          (val_sub, ":var10", ":var3"),
          (gt, ":var10", ":var4"),
          (assign, ":var5", 0),
          (assign, ":var7", 0),
        (try_end),
        (eq, ":var5", 1),
        (372, 68),
      (try_end),
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart_deathmatch"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (400, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (401, ":var1"),
        (neg|438, ":var1"),
        (402, ":var2", ":var1"),
        (lt, ":var2", 2),
        (404, ":var3", ":var1"),
        (ge, ":var3", 0),
        (406, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (528, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (508, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (1760, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var9"),
        (409, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (1707, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (1760, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (417),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (store_random_in_range, ":var1", 0, ":var0"),
        (val_sub, ":var1", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var2", 0),
          (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
        (else_try),
          (assign, ":var2", 1),
          (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
        (try_end),
        (458, ":var3", ":var2"),
        (assign, ":var4", 0),
        (try_for_range, ":var5", "trp_sarleon_longbowman_multiplayer_ai", "trp_sarleon_longbowman_multiplayer"),
          (store_troop_faction, ":var6", ":var5"),
          (eq, ":var6", ":var3"),
          (val_add, ":var4", 1),
        (try_end),
        (store_random_in_range, ":var7", 0, ":var4"),
        (assign, ":var8", "trp_sarleon_longbowman_multiplayer"),
        (try_for_range, ":var5", "trp_sarleon_longbowman_multiplayer_ai", ":var8"),
          (store_troop_faction, ":var6", ":var5"),
          (eq, ":var6", ":var3"),
          (val_sub, ":var7", 1),
          (lt, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", ":var5"),
        (try_end),
        (troop_get_inventory_slot, ":var10", ":var9", ek_horse),
        (try_begin),
          (ge, ":var10", 0),
          (assign, ":var11", 1),
        (else_try),
          (assign, ":var11", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var11"),
        (store_current_scene, ":var12"),
        (modify_visitors_at_site, ":var12"),
        (add_visitors_to_current_scene, reg0, ":var9", 1, ":var2", -1),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (assign, ":var0", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (store_mul, ":var2", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var1", ":var2"),
        (assign, ":var0", 1),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart_deathmatch"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|903, "prsnt_multiplayer_escape_menu"),
      (neg|903, "prsnt_multiplayer_stats_chart_deathmatch"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_tdm", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (417),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 1),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (426, 0, -1),
      (426, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (try_begin),
        (415, ":var0"),
        (is_between, ":var0", 0, 1000),
        (402, ":var1", ":var0"),
        (lt, ":var1", 2),
        (455, ":var2", 0),
        (455, ":var3", 1),
        (assign, ":var4", 0),
        (try_begin),
          (eq, ":var1", 0),
          (gt, ":var2", ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (eq, ":var1", 1),
          (gt, ":var3", ":var2"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (372, 67),
      (try_end),
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (ge, ":var1", 0),
        (agent_is_human, ":var0"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (le, ":var2", 1),
        (agent_get_team, ":var3", ":var0"),
        (neq, ":var2", ":var3"),
        (455, ":var4", ":var2"),
        (val_add, ":var4", 1),
        (456, ":var2", ":var4"),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (400, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (401, ":var1"),
        (neg|438, ":var1"),
        (402, ":var2", ":var1"),
        (lt, ":var2", 2),
        (404, ":var3", ":var1"),
        (ge, ":var3", 0),
        (406, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (528, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (508, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (1760, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 1, ":var9"),
        (409, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (1707, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (1760, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (417),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (455, ":var1", 0),
          (455, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (458, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_sarleon_longbowman_multiplayer_ai", "trp_sarleon_longbowman_multiplayer"),
          (store_troop_faction, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (400, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (401, ":var17"),
          (402, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (568, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (417),
      (try_for_agents, ":var0"),
        (1707, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (1765, ":var1", ":var0"),
        (try_begin),
          (neg|401, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (402, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (20, 0, 0, 
    [],
    [
      (417),
      (call_script, "script_check_team_balance"),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (455, ":var7", 0),
        (455, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (400, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (401, ":var11"),
            (406, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|1707, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_team_score_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|903, "prsnt_multiplayer_escape_menu"),
      (neg|903, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_hq", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (417),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 5),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (store_mul, ":var0", "$g_multiplayer_game_max_points", 10000),
      (assign, "$g_score_team_1", ":var0"),
      (assign, "$g_score_team_2", ":var0"),
      (try_for_range, ":var1", 146, 156),
        (troop_set_slot, "trp_multiplayer_data", ":var1", -1),
      (try_end),
      (try_begin),
        (417),
        (try_for_range, ":var1", 176, 186),
          (troop_set_slot, "trp_multiplayer_data", ":var1", -1),
        (try_end),
      (try_end),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (try_begin),
        (417),
        (456, 0, "$g_multiplayer_game_max_points"),
        (456, 1, "$g_multiplayer_game_max_points"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (call_script, "script_determine_team_flags", 1),
      (426, 0, "$team_1_flag_scene_prop"),
      (426, 1, "$team_2_flag_scene_prop"),
      (try_begin),
        (417),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
        (assign, "$g_number_of_flags", 0),
        (entry_point_get_position, pos1, 64),
        (entry_point_get_position, pos3, 64),
        (set_spawn_position, pos3),
        (1974, "spr_headquarters_pole_code_only", 0),
        (set_spawn_position, pos3),
        (1974, "$team_1_flag_scene_prop", 0),
        (set_spawn_position, pos3),
        (1974, "$team_2_flag_scene_prop", 0),
        (set_spawn_position, pos3),
        (1974, "spr_headquarters_flag_gray_code_only", 0),
        (store_add, ":var0", 146, "$g_number_of_flags"),
        (troop_set_slot, "trp_multiplayer_data", ":var0", 1),
        (val_add, "$g_number_of_flags", 1),
        (entry_point_get_position, pos2, 65),
        (entry_point_get_position, pos3, 65),
        (set_spawn_position, pos3),
        (1974, "spr_headquarters_pole_code_only", 0),
        (set_spawn_position, pos3),
        (1974, "$team_1_flag_scene_prop", 0),
        (set_spawn_position, pos3),
        (1974, "$team_2_flag_scene_prop", 0),
        (set_spawn_position, pos3),
        (1974, "spr_headquarters_flag_gray_code_only", 0),
        (store_add, ":var0", 146, "$g_number_of_flags"),
        (troop_set_slot, "trp_multiplayer_data", ":var0", 2),
        (val_add, "$g_number_of_flags", 1),
        (scene_prop_get_num_instances, ":var1", "spr_headquarters_flag_red"),
        (scene_prop_get_num_instances, ":var2", "spr_headquarters_flag_blue"),
        (scene_prop_get_num_instances, ":var3", "spr_headquarters_flag_gray"),
        (store_add, ":var4", "spr_headquarters_flag_gray", 1),
        (try_for_range, ":var5", "spr_headquarters_flag_red", ":var4"),
          (try_begin),
            (eq, ":var5", "spr_headquarters_flag_red"),
            (assign, ":var6", ":var1"),
          (else_try),
            (eq, ":var5", "spr_headquarters_flag_blue"),
            (assign, ":var6", ":var2"),
          (else_try),
            (eq, ":var5", "spr_headquarters_flag_gray"),
            (assign, ":var6", ":var3"),
          (try_end),
          (gt, ":var6", 0),
          (try_for_range, ":var7", 0, ":var6"),
            (scene_prop_get_instance, ":var8", ":var5", ":var7"),
            (prop_instance_get_position, pos0, ":var8"),
            (set_spawn_position, pos0),
            (1974, "spr_headquarters_pole_code_only", 0),
            (try_for_range, ":var9", "spr_headquarters_flag_red", ":var4"),
              (set_spawn_position, pos0),
              (try_begin),
                (eq, ":var9", "spr_headquarters_flag_red"),
                (1974, "$team_1_flag_scene_prop"),
              (else_try),
                (eq, ":var9", "spr_headquarters_flag_blue"),
                (1974, "$team_2_flag_scene_prop"),
              (else_try),
                (eq, ":var9", "spr_headquarters_flag_gray"),
                (1974, "spr_headquarters_flag_gray_code_only"),
              (try_end),
            (try_end),
            (store_add, ":var0", 146, "$g_number_of_flags"),
            (try_begin),
              (eq, ":var5", "spr_headquarters_flag_red"),
              (troop_set_slot, "trp_multiplayer_data", ":var0", 1),
            (else_try),
              (eq, ":var5", "spr_headquarters_flag_blue"),
              (troop_set_slot, "trp_multiplayer_data", ":var0", 2),
            (else_try),
              (eq, ":var5", "spr_headquarters_flag_gray"),
              (troop_set_slot, "trp_multiplayer_data", ":var0", 0),
            (try_end),
            (val_add, "$g_number_of_flags", 1),
          (try_end),
        (try_end),
        (assign, "$g_number_of_initial_team_1_flags", 0),
        (assign, "$g_number_of_initial_team_2_flags", 0),
        (try_for_range, ":var10", 0, "$g_number_of_flags"),
          (store_add, ":var0", 146, ":var10"),
          (troop_get_slot, ":var11", "trp_multiplayer_data", ":var0"),
          (try_begin),
            (eq, ":var10", 0),
            (entry_point_get_position, pos0, 64),
            (scene_prop_get_instance, ":var8", "$team_1_flag_scene_prop", ":var10"),
            (assign, "$g_base_flag_team_1", ":var8"),
          (else_try),
            (eq, ":var10", 1),
            (entry_point_get_position, pos0, 65),
            (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var10"),
            (assign, "$g_base_flag_team_2", ":var8"),
          (else_try),
            (assign, ":var12", 2),
            (scene_prop_get_num_instances, ":var13", "spr_headquarters_flag_red"),
            (store_add, ":var14", ":var12", ":var13"),
            (scene_prop_get_num_instances, ":var15", "spr_headquarters_flag_blue"),
            (store_add, ":var16", ":var14", ":var15"),
            (scene_prop_get_num_instances, ":var17", "spr_headquarters_flag_gray"),
            (try_begin),
              (ge, ":var10", ":var12"),
              (gt, ":var13", 0),
              (store_sub, ":var18", ":var10", ":var12"),
              (scene_prop_get_instance, ":var8", "spr_headquarters_flag_red", ":var18"),
            (else_try),
              (ge, ":var10", ":var14"),
              (gt, ":var15", 0),
              (store_sub, ":var18", ":var10", ":var14"),
              (scene_prop_get_instance, ":var8", "spr_headquarters_flag_blue", ":var18"),
            (else_try),
              (ge, ":var10", ":var16"),
              (gt, ":var17", 0),
              (store_sub, ":var18", ":var10", ":var16"),
              (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray", ":var18"),
            (try_end),
            (prop_instance_get_position, pos0, ":var8"),
          (try_end),
          (scene_prop_get_instance, ":var19", "spr_headquarters_pole_code_only", ":var10"),
          (prop_instance_set_position, ":var19", pos0),
          (position_move_z, pos0, 900),
          (try_begin),
            (eq, ":var11", 0),
            (scene_prop_get_instance, ":var8", "$team_1_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (1813, ":var8", 0),
            (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (1813, ":var8", 0),
            (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray_code_only", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (1813, ":var8", 1),
          (else_try),
            (eq, ":var11", 1),
            (scene_prop_get_instance, ":var8", "$team_1_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (1813, ":var8", 1),
            (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (1813, ":var8", 0),
            (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray_code_only", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (1813, ":var8", 0),
            (val_add, "$g_number_of_initial_team_1_flags", 1),
          (else_try),
            (scene_prop_get_instance, ":var8", "$team_1_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (1813, ":var8", 0),
            (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (1813, ":var8", 1),
            (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray_code_only", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (1813, ":var8", 0),
            (val_add, "$g_number_of_initial_team_2_flags", 1),
          (try_end),
        (try_end),
      (else_try),
        (scene_prop_get_num_instances, ":var1", "spr_headquarters_flag_red"),
        (scene_prop_get_num_instances, ":var2", "spr_headquarters_flag_blue"),
        (scene_prop_get_num_instances, ":var3", "spr_headquarters_flag_gray"),
        (assign, "$g_number_of_flags", 2),
        (val_add, "$g_number_of_flags", ":var1"),
        (val_add, "$g_number_of_flags", ":var2"),
        (val_add, "$g_number_of_flags", ":var3"),
      (try_end),
      (try_for_range, ":var18", 0, ":var1"),
        (scene_prop_get_instance, ":var8", "spr_headquarters_flag_red", ":var18"),
        (1813, ":var8", 0),
      (try_end),
      (try_for_range, ":var18", 0, ":var2"),
        (scene_prop_get_instance, ":var8", "spr_headquarters_flag_blue", ":var18"),
        (1813, ":var8", 0),
      (try_end),
      (try_for_range, ":var18", 0, ":var3"),
        (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray", ":var18"),
        (1813, ":var8", 0),
      (try_end),
      (try_for_range, ":var18", 0, "$g_number_of_flags"),
        (store_add, ":var20", 166, ":var18"),
        (troop_set_slot, "trp_multiplayer_data", ":var20", 0),
      (try_end),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (try_begin),
        (415, ":var0"),
        (is_between, ":var0", 0, 1000),
        (402, ":var1", ":var0"),
        (lt, ":var1", 2),
        (call_script, "script_get_headquarters_scores"),
        (assign, ":var2", reg0),
        (assign, ":var3", reg1),
        (assign, ":var4", 0),
        (try_begin),
          (eq, ":var1", 0),
          (gt, ":var2", ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (eq, ":var1", 1),
          (gt, ":var3", ":var2"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (372, 61),
      (try_end),
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (417),
        (ge, ":var1", 0),
        (agent_is_human, ":var0"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (le, ":var2", 1),
        (agent_get_team, ":var3", ":var0"),
        (neq, ":var2", ":var3"),
        (455, ":var4", ":var3"),
        (try_begin),
          (eq, ":var2", 0),
          (val_add, "$g_score_team_2", -10000),
        (else_try),
          (val_add, "$g_score_team_1", -10000),
        (try_end),
        (val_sub, ":var4", 1),
        (400, ":var5"),
        (call_script, "script_team_set_score", ":var3", ":var4"),
        (try_for_range, ":var6", 1, ":var5"),
          (401, ":var6"),
          (396, ":var6", 72, ":var3", ":var4"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (store_add, ":var1", 166, ":var0"),
        (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
        (val_add, ":var2", 1),
        (troop_set_slot, "trp_multiplayer_data", ":var1", ":var2"),
        (store_add, ":var3", 176, ":var0"),
        (troop_get_slot, ":var4", "trp_multiplayer_data", ":var3"),
        (store_mod, ":var5", ":var4", 100),
        (try_begin),
          (ge, ":var4", 100),
          (lt, ":var5", 25),
          (val_add, ":var4", 1),
          (troop_set_slot, "trp_multiplayer_data", ":var3", ":var4"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (417),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (store_add, ":var1", 156, ":var0"),
        (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
        (store_div, ":var3", ":var2", 100),
        (store_mod, ":var4", ":var2", 100),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (scene_prop_get_instance, ":var7", "spr_headquarters_pole_code_only", ":var0"),
        (prop_instance_get_position, pos0, ":var7"),
        (400, ":var8"),
        (try_for_range, ":var9", 0, ":var8"),
          (401, ":var9"),
          (406, ":var10", ":var9"),
          (ge, ":var10", 0),
          (agent_is_alive, ":var10"),
          (agent_get_team, ":var11", ":var10"),
          (agent_get_position, pos1, ":var10"),
          (712, ":var12", 0, 1),
          (position_transform_position_to_parent, ":var13", pos0, pos1),
          (val_add, ":var12", ":var13"),
          (lt, ":var12", 1600),
          (try_begin),
            (eq, ":var11", 0),
            (val_add, ":var5", 1),
          (else_try),
            (eq, ":var11", 1),
            (val_add, ":var6", 1),
          (try_end),
        (try_end),
        (try_begin),
          (this_or_next|neq, ":var3", ":var5"),
          (neq, ":var4", ":var6"),
          (store_add, ":var14", 146, ":var0"),
          (troop_get_slot, ":var15", "trp_multiplayer_data", ":var14"),
          (store_add, ":var16", 176, ":var0"),
          (troop_get_slot, ":var17", "trp_multiplayer_data", ":var16"),
          (store_mod, ":var18", ":var17", 100),
          (store_div, ":var19", ":var17", 100),
          (try_begin),
            (assign, ":var20", 0),
            (try_begin),
              (neq, ":var15", 1),
              (eq, ":var3", 0),
              (gt, ":var5", 0),
              (eq, ":var6", 0),
              (assign, ":var21", 1),
              (assign, ":var20", 1),
            (else_try),
              (neq, ":var15", 2),
              (eq, ":var4", 0),
              (eq, ":var5", 0),
              (gt, ":var6", 0),
              (assign, ":var21", 2),
              (assign, ":var20", 1),
            (try_end),
            (eq, ":var20", 1),
            (store_mul, ":var22", ":var21", 100),
            (troop_set_slot, "trp_multiplayer_data", ":var16", ":var22"),
            (this_or_next|neq, ":var19", ":var21"),
            (ge, ":var18", 25),
            (store_mul, ":var23", ":var21", 100),
            (val_add, ":var23", ":var0"),
            (call_script, "script_show_multiplayer_message", 10, ":var23"),
            (try_for_range, ":var9", 1, ":var8"),
              (401, ":var9"),
              (396, ":var9", 68, 10, ":var23"),
            (try_end),
          (try_end),
          (try_begin),
            (store_mul, ":var2", ":var5", 100),
            (val_add, ":var2", ":var6"),
            (troop_set_slot, "trp_multiplayer_data", ":var1", ":var2"),
            (call_script, "script_set_num_agents_around_flag", ":var0", ":var2"),
            (400, ":var8"),
            (try_for_range, ":var9", 1, ":var8"),
              (401, ":var9"),
              (396, ":var9", 73, ":var0", ":var2"),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (assign, ":var24", -1),
        (scene_prop_get_instance, ":var7", "spr_headquarters_pole_code_only", ":var0"),
        (prop_instance_get_position, pos0, ":var7"),
        (store_add, ":var14", 146, ":var0"),
        (troop_get_slot, ":var15", "trp_multiplayer_data", ":var14"),
        (try_begin),
          (try_begin),
            (scene_prop_get_instance, ":var25", "$team_1_flag_scene_prop", ":var0"),
            (1812, ":var26", ":var25"),
            (assign, ":var27", 1),
            (eq, ":var26", 0),
            (scene_prop_get_instance, ":var25", "$team_2_flag_scene_prop", ":var0"),
            (1812, ":var26", ":var25"),
            (assign, ":var27", 2),
            (eq, ":var26", 0),
            (scene_prop_get_instance, ":var25", "spr_headquarters_flag_gray_code_only", ":var0"),
            (1812, ":var26", ":var25"),
            (assign, ":var27", 0),
          (try_end),
          (prop_instance_get_position, pos1, ":var25"),
          (try_begin),
            (712, ":var12", 0, 1),
            (lt, ":var12", 400),
            (store_add, ":var28", 156, ":var0"),
            (troop_get_slot, ":var29", "trp_multiplayer_data", ":var28"),
            (store_div, ":var5", ":var29", 100),
            (store_mod, ":var6", ":var29", 100),
            (try_begin),
              (gt, ":var5", 0),
              (eq, ":var6", 0),
              (assign, ":var24", 0),
              (assign, ":var30", 1),
            (else_try),
              (eq, ":var5", 0),
              (gt, ":var6", 0),
              (assign, ":var24", 0),
              (assign, ":var30", 2),
            (else_try),
              (eq, ":var5", 0),
              (eq, ":var6", 0),
              (neq, ":var27", 0),
              (assign, ":var24", 0),
              (assign, ":var30", 0),
            (try_end),
          (else_try),
            (neq, ":var15", ":var27"),
            (712, ":var12", 0, 1),
            (ge, ":var12", 8100),
            (store_add, ":var28", 156, ":var0"),
            (troop_get_slot, ":var29", "trp_multiplayer_data", ":var28"),
            (store_div, ":var5", ":var29", 100),
            (store_mod, ":var6", ":var29", 100),
            (try_begin),
              (eq, ":var27", 1),
              (assign, ":var24", 1),
              (assign, ":var30", 1),
            (else_try),
              (eq, ":var27", 2),
              (assign, ":var24", 2),
              (assign, ":var30", 2),
            (try_end),
          (try_end),
        (try_end),
        (try_begin),
          (ge, ":var24", 0),
          (this_or_next|neq, ":var24", ":var15"),
          (neq, ":var27", ":var30"),
          (try_begin),
            (neq, ":var15", 0),
            (eq, ":var24", 0),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var31", 2),
            (else_try),
              (eq, ":var15", 2),
              (assign, ":var31", 1),
            (try_end),
            (store_mul, ":var23", ":var31", 100),
            (val_add, ":var23", ":var0"),
            (call_script, "script_show_multiplayer_message", 8, ":var23"),
            (400, ":var8"),
            (try_for_range, ":var9", 1, ":var8"),
              (401, ":var9"),
              (396, ":var9", 68, 8, ":var23"),
            (try_end),
          (try_end),
          (try_begin),
            (neq, ":var15", ":var24"),
            (neq, ":var24", 0),
            (store_mul, ":var23", ":var24", 100),
            (val_add, ":var23", ":var0"),
            (call_script, "script_show_multiplayer_message", 9, ":var23"),
            (400, ":var8"),
            (try_for_range, ":var9", 1, ":var8"),
              (401, ":var9"),
              (396, ":var9", 68, 9, ":var23"),
            (try_end),
          (try_end),
          (call_script, "script_set_num_agents_around_flag", ":var0", ":var29"),
          (assign, ":var32", 0),
          (400, ":var8"),
          (try_for_range, ":var9", 1, ":var8"),
            (401, ":var9"),
            (396, ":var9", 73, ":var0", ":var29"),
            (val_add, ":var32", 1),
          (try_end),
          (store_mul, ":var33", ":var24", 100),
          (val_add, ":var33", ":var30"),
          (call_script, "script_change_flag_owner", ":var0", ":var33"),
          (try_for_range, ":var9", 1, ":var8"),
            (401, ":var9"),
            (396, ":var9", 75, ":var0", ":var33"),
          (try_end),
          (try_begin),
            (neq, ":var24", 0),
            (try_begin),
              (eq, ":var24", 1),
              (assign, ":var34", ":var5"),
            (else_try),
              (assign, ":var34", ":var6"),
            (try_end),
            (store_add, ":var35", 166, ":var0"),
            (troop_get_slot, ":var36", "trp_multiplayer_data", ":var35"),
            (troop_set_slot, "trp_multiplayer_data", ":var35", 0),
            (val_min, ":var36", 360),
            (scene_prop_get_instance, ":var37", "$team_1_flag_scene_prop", ":var0"),
            (scene_prop_get_instance, ":var38", "$team_2_flag_scene_prop", ":var0"),
            (try_begin),
              (this_or_next|eq, "$g_base_flag_team_1", ":var37"),
              (eq, "$g_base_flag_team_2", ":var38"),
              (assign, ":var39", 2),
            (else_try),
              (assign, ":var39", 1),
            (try_end),
            (try_begin),
              (le, ":var34", 1),
              (assign, ":var40", 3),
            (else_try),
              (eq, ":var34", 2),
              (assign, ":var40", 2),
            (else_try),
              (le, ":var34", 6),
              (assign, ":var40", 1),
            (else_try),
              (assign, ":var40", 0),
            (try_end),
            (store_mul, ":var41", ":var36", ":var32"),
            (val_mul, ":var41", ":var39"),
            (val_div, ":var41", 2),
            (try_begin),
              (gt, ":var34", 0),
              (store_div, ":var42", ":var41", ":var34"),
            (try_end),
            (400, ":var8"),
            (try_for_range, ":var9", 0, ":var8"),
              (401, ":var9"),
              (406, ":var10", ":var9"),
              (ge, ":var10", 0),
              (agent_get_team, ":var11", ":var10"),
              (val_add, ":var11", 1),
              (eq, ":var11", ":var24"),
              (agent_get_position, pos1, ":var10"),
              (prop_instance_get_position, pos0, ":var7"),
              (712, ":var12", 0, 1),
              (position_transform_position_to_parent, ":var13", pos0, pos1),
              (val_add, ":var12", ":var13"),
              (lt, ":var12", 1600),
              (431, ":var43", ":var9"),
              (val_add, ":var43", ":var40"),
              (432, ":var9", ":var43"),
              (407, ":var44", ":var9"),
              (val_add, ":var44", ":var42"),
              (408, ":var9", ":var44", 15000),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (assign, ":var3", 0),
      (try_for_range, ":var4", 0, "$g_number_of_flags"),
        (store_add, ":var5", 146, ":var4"),
        (troop_get_slot, ":var6", "trp_multiplayer_data", ":var5"),
        (scene_prop_get_instance, ":var7", "$team_1_flag_scene_prop", ":var4"),
        (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var4"),
        (try_begin),
          (this_or_next|eq, "$g_base_flag_team_1", ":var7"),
          (eq, "$g_base_flag_team_2", ":var8"),
          (assign, ":var9", 2),
        (else_try),
          (assign, ":var9", 1),
        (try_end),
        (try_begin),
          (eq, ":var6", 1),
          (val_add, ":var0", ":var9"),
          (val_add, ":var2", ":var9"),
        (else_try),
          (eq, ":var6", 2),
          (val_add, ":var1", ":var9"),
          (val_add, ":var2", ":var9"),
        (else_try),
          (val_add, ":var3", ":var9"),
        (try_end),
      (try_end),
      (store_add, ":var10", ":var2", ":var3"),
      (store_sub, ":var11", ":var0", ":var1"),
      (store_mul, ":var12", ":var11", 2),
      (store_sub, ":var13", "$g_number_of_initial_team_1_flags", "$g_number_of_initial_team_2_flags"),
      (assign, ":var14", 0),
      (400, ":var15"),
      (try_for_range, ":var16", 0, ":var15"),
        (401, ":var16"),
        (val_add, ":var14", 1),
        (assign, ":var15", 0),
      (try_end),
      (try_begin),
        (ge, ":var12", ":var13"),
        (store_sub, ":var17", ":var12", ":var13"),
        (store_mul, ":var18", ":var17", 125),
        (val_add, ":var18", 500),
        (store_div, ":var19", 250000, ":var18"),
        (try_begin),
          (lt, ":var2", ":var10"),
          (val_mul, ":var19", ":var2"),
          (val_div, ":var19", ":var10"),
          (val_mul, ":var18", ":var2"),
          (val_div, ":var18", ":var10"),
        (try_end),
        (call_script, "script_find_number_of_agents_constant"),
        (val_mul, ":var18", reg0),
        (val_div, ":var18", 100),
        (val_mul, ":var19", reg0),
        (val_div, ":var19", 100),
        (val_mul, ":var18", "$g_multiplayer_point_gained_from_flags"),
        (val_div, ":var18", 100),
        (val_mul, ":var19", "$g_multiplayer_point_gained_from_flags"),
        (val_div, ":var19", 100),
        (try_begin),
          (ge, ":var14", 1),
          (val_sub, "$g_score_team_2", ":var18"),
          (try_begin),
            (ge, ":var1", 1),
            (val_sub, "$g_score_team_1", ":var19"),
          (else_try),
            (val_sub, "$g_score_team_2", ":var19"),
          (try_end),
        (try_end),
      (else_try),
        (store_sub, ":var17", ":var13", ":var12"),
        (store_mul, ":var18", ":var17", 125),
        (val_add, ":var18", 500),
        (store_div, ":var19", 250000, ":var18"),
        (try_begin),
          (lt, ":var2", ":var10"),
          (val_mul, ":var19", ":var2"),
          (val_div, ":var19", ":var10"),
          (val_mul, ":var18", ":var2"),
          (val_div, ":var18", ":var10"),
        (try_end),
        (call_script, "script_find_number_of_agents_constant"),
        (val_mul, ":var18", reg0),
        (val_div, ":var18", 100),
        (val_mul, ":var19", reg0),
        (val_div, ":var19", 100),
        (val_mul, ":var18", "$g_multiplayer_point_gained_from_flags"),
        (val_div, ":var18", 100),
        (val_mul, ":var19", "$g_multiplayer_point_gained_from_flags"),
        (val_div, ":var19", 100),
        (try_begin),
          (ge, ":var14", 1),
          (try_begin),
            (ge, ":var0", 1),
            (val_sub, "$g_score_team_2", ":var19"),
          (else_try),
            (val_sub, "$g_score_team_1", ":var19"),
          (try_end),
          (val_sub, "$g_score_team_1", ":var18"),
        (try_end),
      (try_end),
      (455, ":var20", 0),
      (try_begin),
        (store_div, ":var21", "$g_score_team_1", 10000),
        (neq, ":var21", ":var20"),
        (400, ":var22"),
        (call_script, "script_team_set_score", 0, ":var21"),
        (try_for_range, ":var16", 1, ":var22"),
          (401, ":var16"),
          (396, ":var16", 72, 0, ":var21"),
        (try_end),
      (try_end),
      (455, ":var23", 1),
      (try_begin),
        (store_div, ":var24", "$g_score_team_2", 10000),
        (neq, ":var24", ":var23"),
        (400, ":var22"),
        (call_script, "script_team_set_score", 1, ":var24"),
        (try_for_range, ":var16", 1, ":var22"),
          (401, ":var16"),
          (396, ":var16", 72, 1, ":var24"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (400, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (401, ":var1"),
        (neg|438, ":var1"),
        (402, ":var2", ":var1"),
        (lt, ":var2", 2),
        (404, ":var3", ":var1"),
        (ge, ":var3", 0),
        (406, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (528, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (508, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (1760, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var9"),
        (409, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (1707, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (1760, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (417),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (455, ":var1", 0),
          (455, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (458, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_sarleon_longbowman_multiplayer_ai", "trp_sarleon_longbowman_multiplayer"),
          (store_troop_faction, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (400, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (401, ":var17"),
          (402, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (568, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (417),
      (try_for_agents, ":var0"),
        (1707, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (1765, ":var1", ":var0"),
        (try_begin),
          (neg|401, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (402, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (20, 0, 0, 
    [],
    [
      (417),
      (call_script, "script_check_team_balance"),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (455, ":var7", 0),
        (455, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (400, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (401, ":var11"),
            (406, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|1707, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_team_score_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|903, "prsnt_multiplayer_escape_menu"),
      (neg|903, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_cf", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (64, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (65, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (417),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (417),
        (store_current_scene, ":var0"),
        (this_or_next|eq, ":var0", "scn_random_multi_plain_medium"),
        (this_or_next|eq, ":var0", "scn_random_multi_plain_large"),
        (this_or_next|eq, ":var0", "scn_random_multi_steppe_medium"),
        (eq, ":var0", "scn_random_multi_steppe_large"),
        (entry_point_get_position, pos0, 0),
        (1781, 64, 0),
        (entry_point_get_position, pos1, 32),
        (1781, 65, 1),
      (try_end),
      (assign, "$g_multiplayer_game_type", 4),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (assign, "$flag_1_at_ground_timer", 0),
      (assign, "$flag_2_at_ground_timer", 0),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (call_script, "script_determine_team_flags", 1),
      (426, 0, -1),
      (426, 1, -1),
      (try_begin),
        (417),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
        (entry_point_get_position, pos0, 64),
        (set_spawn_position, pos0),
        (1974, "$team_1_flag_scene_prop", 0),
        (entry_point_get_position, pos0, 65),
        (set_spawn_position, pos0),
        (1974, "$team_2_flag_scene_prop", 0),
      (try_end),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (agent_is_human, ":var0"),
        (1756, ":var2", ":var0"),
        (try_begin),
          (try_begin),
            (417),
            (ge, ":var2", 0),
            (415, ":var3"),
            (400, ":var4"),
            (call_script, "script_set_attached_scene_prop", ":var0", -1),
            (1734, ":var0", 100),
            (try_for_range, ":var5", 1, ":var4"),
              (401, ":var5"),
              (neq, ":var3", ":var5"),
              (396, ":var5", 70, ":var0", -1),
            (try_end),
            (prop_instance_get_position, pos0, ":var2"),
            (position_set_z_to_ground_level, pos0),
            (prop_instance_set_position, ":var2", pos0),
            (agent_get_team, ":var6", ":var0"),
            (try_begin),
              (eq, ":var6", 0),
              (assign, ":var7", 1),
            (else_try),
              (assign, ":var7", 0),
            (try_end),
            (509, ":var7", 0, 2),
            (415, ":var3"),
            (400, ":var4"),
            (call_script, "script_set_team_flag_situation", ":var7", 2),
            (try_for_range, ":var5", 1, ":var4"),
              (401, ":var5"),
              (neq, ":var3", ":var5"),
              (396, ":var5", 71, ":var7", 2),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (try_for_range, ":var0", 0, 2),
        (try_begin),
          (549, ":var0", 0, 2),
          (assign, ":var1", -1),
          (try_begin),
            (eq, ":var0", 0),
            (val_add, "$flag_1_at_ground_timer", 1),
            (ge, "$flag_1_at_ground_timer", 60),
            (assign, ":var1", 0),
          (else_try),
            (val_add, "$flag_2_at_ground_timer", 1),
            (ge, "$flag_2_at_ground_timer", 60),
            (assign, ":var1", 1),
          (try_end),
          (try_begin),
            (ge, ":var1", 0),
            (try_begin),
              (eq, ":var1", 0),
              (assign, "$flag_1_at_ground_timer", 0),
            (else_try),
              (eq, ":var1", 1),
              (assign, "$flag_2_at_ground_timer", 0),
            (try_end),
            (509, ":var1", 0, 0),
            (call_script, "script_set_team_flag_situation", ":var1", 0),
            (415, ":var2"),
            (400, ":var3"),
            (try_for_range, ":var4", 1, ":var3"),
              (401, ":var4"),
              (neq, ":var2", ":var4"),
              (396, ":var4", 71, ":var1", 0),
            (try_end),
            (scene_prop_get_instance, ":var5", "$team_1_flag_scene_prop", 0),
            (scene_prop_get_instance, ":var6", "$team_2_flag_scene_prop", 0),
            (assign, ":var7", ":var5"),
            (assign, ":var8", 64),
            (assign, ":var9", ":var6"),
            (assign, ":var10", 65),
            (try_begin),
              (eq, ":var1", 0),
              (entry_point_get_position, pos5, ":var8"),
              (prop_instance_set_position, ":var7", pos5),
            (else_try),
              (entry_point_get_position, pos5, ":var10"),
              (prop_instance_set_position, ":var9", pos5),
            (try_end),
            (store_mul, ":var11", ":var1", -1),
            (val_sub, ":var11", 1),
            (call_script, "script_show_multiplayer_message", 5, ":var11"),
            (try_for_range, ":var4", 0, ":var3"),
              (401, ":var4"),
              (neq, ":var2", ":var4"),
              (396, ":var4", 68, 5, ":var11"),
            (try_end),
          (try_end),
        (else_try),
          (try_begin),
            (eq, ":var0", 0),
            (assign, "$flag_1_at_ground_timer", 0),
          (else_try),
            (assign, "$flag_2_at_ground_timer", 0),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (400, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (401, ":var1"),
        (neg|438, ":var1"),
        (402, ":var2", ":var1"),
        (lt, ":var2", 2),
        (404, ":var3", ":var1"),
        (ge, ":var3", 0),
        (406, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (528, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (508, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (1760, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var9"),
        (409, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (1707, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (1760, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (417),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (455, ":var1", 0),
          (455, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (458, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_sarleon_longbowman_multiplayer_ai", "trp_sarleon_longbowman_multiplayer"),
          (store_troop_faction, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (400, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (401, ":var17"),
          (402, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (568, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (417),
      (try_for_agents, ":var0"),
        (1707, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (1765, ":var1", ":var0"),
        (try_begin),
          (neg|401, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (402, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (417),
      (scene_prop_get_instance, ":var0", "$team_1_flag_scene_prop", 0),
      (prop_instance_get_position, pos1, ":var0"),
      (scene_prop_get_instance, ":var1", "$team_2_flag_scene_prop", 0),
      (prop_instance_get_position, pos2, ":var1"),
      (415, ":var2"),
      (400, ":var3"),
      (try_for_agents, ":var4"),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (neg|1707, ":var4"),
        (agent_get_horse, ":var5", ":var4"),
        (eq, ":var5", -1),
        (1756, ":var6", ":var4"),
        (agent_get_team, ":var7", ":var4"),
        (try_begin),
          (eq, ":var7", 0),
          (assign, ":var8", 1),
        (else_try),
          (assign, ":var8", 0),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
          (assign, ":var9", ":var0"),
          (assign, ":var10", 64),
        (else_try),
          (assign, ":var9", ":var1"),
          (assign, ":var10", 65),
        (try_end),
        (agent_get_position, pos3, ":var4"),
        (prop_instance_get_position, pos4, ":var9"),
        (get_distance_between_positions, ":var11", pos3, pos4),
        (529, ":var12", ":var7", 0),
        (try_begin),
          (eq, ":var12", 2),
          (lt, ":var11", 100),
          (509, ":var7", 0, 0),
          (call_script, "script_set_team_flag_situation", ":var7", 0),
          (try_for_range, ":var13", 1, ":var3"),
            (401, ":var13"),
            (neq, ":var2", ":var13"),
            (396, ":var13", 71, ":var7", 0),
          (try_end),
          (entry_point_get_position, pos5, ":var10"),
          (prop_instance_set_position, ":var9", pos5),
          (try_begin),
            (417),
            (neg|1707, ":var4"),
            (1724, ":var14", ":var4"),
            (431, ":var15", ":var14"),
            (val_add, ":var15", 1),
            (432, ":var14", ":var15"),
          (try_end),
          (call_script, "script_show_multiplayer_message", 5, ":var4"),
          (try_for_range, ":var13", 0, ":var3"),
            (401, ":var13"),
            (neq, ":var2", ":var13"),
            (396, ":var13", 68, 5, ":var4"),
          (try_end),
        (try_end),
        (try_begin),
          (neq, ":var6", -1),
          (try_begin),
            (eq, ":var7", 0),
            (assign, ":var16", ":var1"),
            (assign, ":var17", 65),
          (else_try),
            (assign, ":var16", ":var0"),
            (assign, ":var17", 64),
          (try_end),
          (eq, ":var6", ":var16"),
          (eq, ":var12", 0),
          (lt, ":var11", 100),
          (455, ":var18", ":var7"),
          (val_add, ":var18", 1),
          (456, ":var7", ":var18"),
          (try_begin),
            (417),
            (neg|1707, ":var4"),
            (1724, ":var14", ":var4"),
            (431, ":var15", ":var14"),
            (val_add, ":var15", "$g_multiplayer_point_gained_from_capturing_flag"),
            (432, ":var14", ":var15"),
          (try_end),
          (call_script, "script_team_set_score", ":var7", ":var18"),
          (try_for_range, ":var13", 1, ":var3"),
            (401, ":var13"),
            (neq, ":var2", ":var13"),
            (396, ":var13", 72, ":var7", ":var18"),
          (try_end),
          (1757, ":var4", -1),
          (509, ":var8", 0, 0),
          (call_script, "script_set_attached_scene_prop", ":var4", -1),
          (1734, ":var4", 100),
          (try_for_range, ":var13", 1, ":var3"),
            (401, ":var13"),
            (neq, ":var2", ":var13"),
            (396, ":var13", 70, ":var4", -1),
          (try_end),
          (call_script, "script_set_team_flag_situation", ":var8", 0),
          (try_for_range, ":var13", 1, ":var3"),
            (401, ":var13"),
            (neq, ":var2", ":var13"),
            (396, ":var13", 71, ":var8", 0),
          (try_end),
          (entry_point_get_position, pos5, ":var17"),
          (prop_instance_set_position, ":var16", pos5),
          (call_script, "script_show_multiplayer_message", 4, ":var4"),
          (try_for_range, ":var13", 0, ":var3"),
            (401, ":var13"),
            (neq, ":var2", ":var13"),
            (396, ":var13", 68, 4, ":var4"),
          (try_end),
        (try_end),
        (eq, ":var6", -1),
        (agent_get_position, pos3, ":var4"),
        (agent_get_team, ":var7", ":var4"),
        (try_begin),
          (eq, ":var7", 0),
          (get_distance_between_positions, ":var11", pos2, pos3),
          (assign, ":var16", ":var1"),
        (else_try),
          (get_distance_between_positions, ":var11", pos1, pos3),
          (assign, ":var16", ":var0"),
        (try_end),
        (try_begin),
          (le, ":var11", 100),
          (neg|549, ":var8", 0, 1),
          (1757, ":var4", ":var16"),
          (1758, ":var4", 20),
          (1759, ":var4", 50),
          (try_begin),
            (eq, ":var7", 0),
            (assign, "$flag_1_at_ground_timer", 0),
          (else_try),
            (eq, ":var7", 1),
            (assign, "$flag_2_at_ground_timer", 0),
          (try_end),
          (509, ":var8", 0, 1),
          (call_script, "script_set_attached_scene_prop", ":var4", ":var16"),
          (1734, ":var4", 75),
          (try_for_range, ":var13", 1, ":var3"),
            (401, ":var13"),
            (neq, ":var2", ":var13"),
            (396, ":var13", 70, ":var4", ":var16"),
          (try_end),
          (call_script, "script_set_team_flag_situation", ":var8", 1),
          (try_for_range, ":var13", 1, ":var3"),
            (401, ":var13"),
            (neq, ":var2", ":var13"),
            (396, ":var13", 71, ":var8", 1),
          (try_end),
          (call_script, "script_show_multiplayer_message", 6, ":var4"),
          (try_for_range, ":var13", 0, ":var3"),
            (401, ":var13"),
            (neq, ":var2", ":var13"),
            (396, ":var13", 68, 6, ":var4"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (20, 0, 0, 
    [],
    [
      (417),
      (call_script, "script_check_team_balance"),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (455, ":var7", 0),
        (455, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (400, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (401, ":var11"),
            (406, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|1707, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_team_score_display"),
      (start_presentation, "prsnt_multiplayer_flag_projection_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|903, "prsnt_multiplayer_escape_menu"),
      (neg|903, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_sg", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (2, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (34, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (417),
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 2),
        (try_begin),
          (eq, ":var0", 0),
          (assign, ":var1", "spr_belfry_a"),
        (else_try),
          (assign, ":var1", "spr_belfry_b"),
        (try_end),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (prop_instance_get_position, pos1, ":var4"),
          (prop_instance_get_starting_position, pos11, ":var4"),
          (store_add, ":var5", 11, ":var3"),
          (try_begin),
            (eq, ":var0", 1),
            (scene_prop_get_num_instances, ":var6", "spr_belfry_a"),
            (val_add, ":var5", ":var6"),
          (try_end),
          (val_mul, ":var5", 10),
          (store_add, ":var7", ":var5", 10),
          (try_for_range, ":var8", ":var5", ":var7"),
            (1782, ":var8"),
            (assign, ":var7", ":var8"),
          (try_end),
          (assign, ":var9", ":var7"),
          (val_sub, ":var7", 1),
          (assign, reg0, ":var7"),
          (neg|1782, ":var7"),
          (try_begin),
            (712, ":var10", 1, 11),
            (ge, ":var10", 4),
            (assign, ":var11", -1),
            (assign, ":var12", -1),
            (try_for_range, ":var8", ":var5", ":var9"),
              (entry_point_get_position, pos4, ":var8"),
              (712, ":var13", 11, 4),
              (lt, ":var13", ":var10"),
              (gt, ":var13", ":var11"),
              (assign, ":var11", ":var13"),
              (assign, ":var12", ":var8"),
            (try_end),
            (try_begin),
              (ge, ":var12", 0),
              (entry_point_get_position, pos5, ":var12"),
            (else_try),
              (copy_position, pos5, pos11),
            (try_end),
            (get_distance_between_positions, ":var14", pos1, pos5),
            (try_begin),
              (eq, ":var0", 0),
              (scene_prop_get_instance, ":var15", "spr_belfry_platform_a", ":var3"),
              (scene_prop_get_instance, ":var16", "spr_belfry_platform_b", ":var3"),
            (else_try),
              (scene_prop_get_instance, ":var15", "spr_belfry_b_platform_a", ":var3"),
            (try_end),
            (store_mul, ":var17", ":var3", 3),
            (try_begin),
              (eq, ":var1", "spr_belfry_b"),
              (scene_prop_get_num_instances, ":var6", "spr_belfry_a"),
              (store_mul, ":var18", ":var6", 3),
              (val_add, ":var17", ":var18"),
            (try_end),
            (scene_prop_get_instance, ":var19", "spr_belfry_wheel", ":var17"),
            (val_add, ":var17", 1),
            (scene_prop_get_instance, ":var20", "spr_belfry_wheel", ":var17"),
            (val_add, ":var17", 1),
            (scene_prop_get_instance, ":var21", "spr_belfry_wheel", ":var17"),
            (init_position, pos17),
            (position_move_y, pos17, -225),
            (position_transform_position_to_local, pos18, pos1, pos17),
            (position_move_y, pos17, -225),
            (position_transform_position_to_local, pos19, pos1, pos17),
            (assign, ":var22", 0),
            (400, ":var23"),
            (try_for_range, ":var24", 0, ":var23"),
              (401, ":var24"),
              (406, ":var25", ":var24"),
              (ge, ":var25", 0),
              (agent_get_team, ":var26", ":var25"),
              (eq, ":var26", 1),
              (agent_get_horse, ":var27", ":var25"),
              (eq, ":var27", -1),
              (agent_get_position, pos2, ":var25"),
              (position_is_behind_position, ":var28", pos18, 2),
              (lt, ":var28", 36),
              (neg|1801, ":var4", ":var25"),
              (neg|1801, ":var15", ":var25"),
              (this_or_next|eq, ":var0", 1),
              (neg|1801, ":var16", ":var25"),
              (neg|1801, ":var19", ":var25"),
              (neg|1801, ":var20", ":var25"),
              (neg|1801, ":var21", ":var25"),
              (neg|714, 2, 19),
              (714, 2, 1),
              (val_add, ":var22", 1),
            (try_end),
            (val_min, ":var22", 16),
            (try_begin),
              (530, ":var29", ":var4", 3),
              (530, ":var30", ":var4", 4),
              (this_or_next|neq, ":var29", ":var22"),
              (neq, ":var30", ":var12"),
              (try_begin),
                (eq, ":var30", ":var12"),
                (1862, ":var31", ":var4"),
                (eq, ":var31", 1),
                (store_mul, ":var32", "$g_last_number_of_agents_around_belfry", 100),
                (store_sqrt, ":var32", ":var32"),
                (val_min, ":var32", 300),
                (assign, ":var33", ":var14"),
                (val_mul, ":var33", ":var32"),
                (val_div, ":var33", 100),
                (val_mul, ":var33", 4),
              (try_end),
              (try_begin),
                (ge, ":var12", 0),
                (init_position, pos9),
                (position_set_y, pos9, -500),
                (position_set_x, pos9, -300),
                (position_transform_position_to_local, pos10, pos5, pos9),
                (792, ":var34", 10),
                (init_position, pos9),
                (position_set_y, pos9, -500),
                (position_set_x, pos9, 300),
                (position_transform_position_to_local, pos10, pos5, pos9),
                (792, ":var35", 10),
                (store_add, ":var36", ":var34", ":var35"),
                (val_mul, ":var36", 100),
                (store_div, ":var37", ":var36", 24),
                (init_position, pos20),
                (738, 20, ":var37"),
                (position_transform_position_to_local, pos23, pos5, pos20),
                (init_position, pos9),
                (position_set_x, pos9, -300),
                (position_transform_position_to_local, pos10, pos5, pos9),
                (792, ":var38", 10),
                (init_position, pos9),
                (position_set_x, pos9, 300),
                (position_transform_position_to_local, pos10, pos5, pos9),
                (792, ":var39", 10),
                (store_sub, ":var34", ":var38", ":var39"),
                (init_position, pos9),
                (position_set_x, pos9, -300),
                (position_set_y, pos9, -500),
                (position_transform_position_to_local, pos10, pos5, pos9),
                (792, ":var38", 10),
                (init_position, pos9),
                (position_set_x, pos9, 300),
                (position_set_y, pos9, -500),
                (position_transform_position_to_local, pos10, pos5, pos9),
                (792, ":var39", 10),
                (store_sub, ":var35", ":var38", ":var39"),
                (store_add, ":var36", ":var34", ":var35"),
                (val_mul, ":var36", 100),
                (store_div, ":var37", ":var36", 24),
                (val_mul, ":var37", -1),
                (init_position, pos20),
                (739, 20, ":var37"),
                (position_transform_position_to_local, pos22, pos23, pos20),
              (else_try),
                (copy_position, pos22, pos5),
              (try_end),
              (try_begin),
                (ge, ":var22", 1),
                (store_mul, ":var32", ":var22", 100),
                (store_sqrt, ":var32", ":var32"),
                (val_min, ":var32", 300),
                (val_mul, ":var14", 100),
                (val_mul, ":var14", 3),
                (val_div, ":var14", ":var32"),
                (prop_instance_get_position, pos6, ":var15"),
                (717, 7, 1, 6),
                (position_transform_position_to_local, pos8, pos22, pos7),
                (prop_instance_animate_to_position, ":var15", pos8, ":var14"),
                (try_begin),
                  (eq, ":var0", 0),
                  (prop_instance_get_position, pos6, ":var16"),
                  (717, 7, 1, 6),
                  (position_transform_position_to_local, pos8, pos22, pos7),
                  (prop_instance_animate_to_position, ":var16", pos8, ":var14"),
                (try_end),
                (store_mul, ":var40", ":var14", -25),
                (assign, "$g_last_number_of_agents_around_belfry", ":var22"),
                (prop_instance_get_position, pos13, ":var19"),
                (prop_instance_get_position, pos20, ":var4"),
                (717, 7, 20, 13),
                (position_transform_position_to_local, pos21, pos22, pos7),
                (1865, ":var19", 21, ":var14", ":var40"),
                (prop_instance_get_position, pos13, ":var20"),
                (prop_instance_get_position, pos20, ":var4"),
                (717, 7, 20, 13),
                (position_transform_position_to_local, pos21, pos22, pos7),
                (1865, ":var20", 21, ":var14", ":var40"),
                (prop_instance_get_position, pos13, ":var21"),
                (prop_instance_get_position, pos20, ":var4"),
                (717, 7, 20, 13),
                (position_transform_position_to_local, pos21, pos22, pos7),
                (1865, ":var21", 21, ":var14", ":var40"),
                (prop_instance_animate_to_position, ":var4", pos22, ":var14"),
              (else_try),
                (1862, ":var31", ":var4"),
                (eq, ":var31", 1),
                (1861, ":var15"),
                (try_begin),
                  (eq, ":var0", 0),
                  (1861, ":var16"),
                (try_end),
                (1861, ":var19"),
                (1861, ":var20"),
                (1861, ":var21"),
                (1861, ":var4"),
              (try_end),
              (510, ":var4", 3, ":var22"),
              (510, ":var4", 4, ":var12"),
            (try_end),
          (else_try),
            (le, ":var10", 4),
            (550, ":var4", 5, 0),
            (510, ":var4", 5, 1),
            (try_begin),
              (eq, ":var0", 0),
              (scene_prop_get_instance, ":var15", "spr_belfry_platform_a", ":var3"),
            (else_try),
              (scene_prop_get_instance, ":var15", "spr_belfry_b_platform_a", ":var3"),
            (try_end),
            (prop_instance_get_starting_position, pos0, ":var15"),
            (prop_instance_animate_to_position, ":var15", pos0, 400),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (417),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
      (try_begin),
        (417),
        (this_or_next|401, ":var0"),
        (eq, ":var0", 0),
        (store_mission_timer_a, ":var1"),
        (val_sub, ":var1", "$g_round_start_time"),
        (try_begin),
          (lt, ":var1", 25),
          (assign, ":var2", 0),
        (else_try),
          (lt, ":var1", 60),
          (assign, ":var2", 1),
        (else_try),
          (lt, ":var1", 105),
          (assign, ":var2", 2),
        (else_try),
          (lt, ":var1", 160),
          (assign, ":var2", 3),
        (else_try),
          (assign, ":var2", "$g_multiplayer_number_of_respawn_count"),
        (try_end),
        (508, ":var0", 39, ":var2"),
        (395, ":var0", 89, ":var2"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 6),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (try_begin),
        (417),
        (try_for_range, ":var0", 176, 186),
          (troop_set_slot, "trp_multiplayer_data", ":var0", -1),
        (try_end),
        (assign, "$g_my_spawn_count", 0),
      (else_try),
        (assign, "$g_my_spawn_count", 0),
      (try_end),
      (assign, "$g_waiting_for_confirmation_to_terminate", 0),
      (assign, "$g_round_ended", 0),
      (try_begin),
        (417),
        (assign, "$g_round_start_time", 0),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (assign, "$g_flag_is_not_ready", 0),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (426, 0, -1),
      (426, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_number_of_flags", 0),
      (try_begin),
        (417),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
        (entry_point_get_position, pos1, 66),
        (set_spawn_position, pos1),
        (1974, "spr_headquarters_pole_code_only", 0),
        (position_move_z, pos1, 900),
        (set_spawn_position, pos1),
        (1974, "$team_1_flag_scene_prop", 0),
        (store_add, ":var0", 146, "$g_number_of_flags"),
        (troop_set_slot, "trp_multiplayer_data", ":var0", 1),
      (try_end),
      (val_add, "$g_number_of_flags", 1),
      (try_begin),
        (417),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_a"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_a", ":var2"),
          (510, ":var3", 5, 1),
        (try_end),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_b"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_b", ":var2"),
          (510, ":var3", 5, 1),
        (try_end),
        (call_script, "script_move_belfries_to_their_first_entry_point", "spr_belfry_a"),
        (call_script, "script_move_belfries_to_their_first_entry_point", "spr_belfry_b"),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_a"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_a", ":var2"),
          (510, ":var3", 3, 0),
          (510, ":var3", 4, 0),
        (try_end),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_b"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_b", ":var2"),
          (510, ":var3", 3, 0),
          (510, ":var3", 4, 0),
        (try_end),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_a"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_a", ":var2"),
          (510, ":var3", 5, 0),
        (try_end),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_b"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_b", ":var2"),
          (510, ":var3", 5, 0),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (415, ":var1"),
        (ge, ":var1", 0),
        (406, ":var2", ":var1"),
        (eq, ":var2", ":var0"),
        (ge, ":var2", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var2"),
      (try_end),
      (try_begin),
        (neg|417),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (assign, "$g_round_ended", 0),
          (assign, "$g_my_spawn_count", 0),
          (call_script, "script_initialize_all_scene_prop_slots"),
          (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
          (call_script, "script_initialize_objects_clients"),
        (try_end),
      (try_end),
      (try_begin),
        (415, ":var1"),
        (ge, ":var1", 0),
        (406, ":var2", ":var1"),
        (eq, ":var2", ":var0"),
        (val_add, "$g_my_spawn_count", 1),
        (try_begin),
          (ge, "$g_my_spawn_count", "$g_multiplayer_number_of_respawn_count"),
          (gt, "$g_multiplayer_number_of_respawn_count", 0),
          (415, ":var1"),
          (402, ":var3", ":var1"),
          (eq, ":var3", 0),
          (assign, "$g_my_spawn_count", 999),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (415, ":var2"),
        (ge, ":var2", 0),
        (406, ":var3", ":var2"),
        (ge, ":var3", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var3"),
      (try_end),
      (try_begin),
        (417),
        (agent_is_human, ":var0"),
        (neg|1707, ":var0"),
        (1724, ":var4", ":var0"),
        (508, ":var4", 0, 0),
      (try_end),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (0, 0, 0, 
    [],
    [
      (417),
      (eq, "$g_round_ended", 0),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (store_add, ":var1", 156, ":var0"),
        (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
        (store_div, ":var3", ":var2", 100),
        (store_mod, ":var4", ":var2", 100),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (scene_prop_get_instance, ":var7", "spr_headquarters_pole_code_only", ":var0"),
        (prop_instance_get_position, pos0, ":var7"),
        (400, ":var8"),
        (try_for_range, ":var9", 0, ":var8"),
          (401, ":var9"),
          (406, ":var10", ":var9"),
          (ge, ":var10", 0),
          (agent_is_alive, ":var10"),
          (agent_get_team, ":var11", ":var10"),
          (agent_get_position, pos1, ":var10"),
          (712, ":var12", 0, 1),
          (position_transform_position_to_parent, ":var13", pos0, pos1),
          (val_add, ":var12", ":var13"),
          (lt, ":var12", 1600),
          (try_begin),
            (eq, ":var11", 0),
            (val_add, ":var5", 1),
          (else_try),
            (eq, ":var11", 1),
            (val_add, ":var6", 1),
          (try_end),
        (try_end),
        (try_begin),
          (this_or_next|neq, ":var3", ":var5"),
          (neq, ":var4", ":var6"),
          (store_add, ":var14", 176, ":var0"),
          (troop_get_slot, ":var15", "trp_multiplayer_data", ":var14"),
          (store_mod, ":var16", ":var15", 100),
          (store_div, ":var17", ":var15", 100),
          (try_begin),
            (eq, ":var4", 0),
            (gt, ":var6", 0),
            (eq, ":var5", 0),
            (assign, ":var18", 2),
            (store_mul, ":var19", ":var18", 100),
            (troop_set_slot, "trp_multiplayer_data", ":var14", ":var19"),
            (this_or_next|neq, ":var17", ":var18"),
            (ge, ":var16", 25),
            (store_mul, ":var20", ":var18", 100),
            (val_add, ":var20", ":var0"),
          (try_end),
          (try_begin),
            (store_mul, ":var2", ":var5", 100),
            (val_add, ":var2", ":var6"),
            (troop_set_slot, "trp_multiplayer_data", ":var1", ":var2"),
            (400, ":var8"),
            (call_script, "script_set_num_agents_around_flag", ":var0", ":var2"),
            (try_for_range, ":var9", 1, ":var8"),
              (401, ":var9"),
              (396, ":var9", 73, ":var0", ":var2"),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (eq, "$g_round_ended", 0),
        (eq, "$g_flag_is_not_ready", 0),
        (scene_prop_get_instance, ":var7", "spr_headquarters_pole_code_only", ":var0"),
        (prop_instance_get_position, pos0, ":var7"),
        (try_begin),
          (scene_prop_get_instance, ":var21", "$team_1_flag_scene_prop", ":var0"),
          (prop_instance_get_position, pos1, ":var21"),
          (try_begin),
            (712, ":var12", 0, 1),
            (lt, ":var12", 400),
            (1862, ":var22", ":var21"),
            (eq, ":var22", 1),
            (assign, "$g_winner_team", 1),
            (1861, ":var21"),
            (400, ":var8"),
            (call_script, "script_draw_this_round", "$g_winner_team"),
            (try_for_range, ":var9", 1, ":var8"),
              (401, ":var9"),
              (395, ":var9", 69, "$g_winner_team"),
            (try_end),
            (assign, "$g_flag_is_not_ready", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (assign, ":var0", "$g_multiplayer_num_bots_team_1"),
      (assign, ":var1", "$g_multiplayer_num_bots_team_2"),
      (400, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (401, ":var3"),
        (402, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var0", 0),
        (eq, ":var1", 0),
        (store_mission_timer_a, ":var5"),
        (val_sub, ":var5", "$g_round_start_time"),
        (le, ":var5", 2),
        (store_mission_timer_a, "$g_round_start_time"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (417),
      (eq, "$g_round_ended", 0),
      (eq, "$g_flag_is_not_ready", 0),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (ge, ":var1", "$g_multiplayer_round_max_seconds"),
    ],
    [
      (assign, ":var0", 0),
      (store_add, ":var1", 156, ":var0"),
      (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
      (store_mod, ":var3", ":var2", 100),
      (try_begin),
        (eq, ":var3", 0),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
        (assign, "$g_flag_is_not_ready", 1),
        (assign, "$g_winner_team", 0),
        (400, ":var4"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var5", 1, ":var4"),
          (401, ":var5"),
          (395, ":var5", 69, "$g_winner_team"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (store_add, ":var1", 176, ":var0"),
        (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
        (store_mod, ":var3", ":var2", 100),
        (try_begin),
          (ge, ":var2", 100),
          (lt, ":var3", 25),
          (val_add, ":var2", 1),
          (troop_set_slot, "trp_multiplayer_data", ":var1", ":var2"),
        (try_end),
      (try_end),
    ]),

    (10, 0, 0, 
    [
      (417),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (400, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (401, ":var3"),
        (402, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (eq, "$g_team_balance_next_round", 0),
          (assign, "$g_team_balance_next_round", 1),
          (call_script, "script_show_multiplayer_message", 3, 0),
          (400, ":var2"),
          (try_for_range, ":var8", 1, ":var2"),
            (401, ":var8"),
            (395, ":var8", 68, 3),
          (try_end),
          (call_script, "script_warn_player_about_auto_team_balance"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 3, 
    [
      (417),
      (eq, "$g_round_ended", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_round_finish_time"),
      (ge, ":var0", "$g_multiplayer_respawn_period"),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (400, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (401, ":var3"),
        (402, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
          (assign, ":var8", 1),
          (assign, ":var9", 0),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
          (assign, ":var8", 0),
          (assign, ":var9", 1),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (try_for_range, ":var10", 0, ":var6"),
            (assign, ":var11", 0),
            (assign, ":var12", -1),
            (400, ":var2"),
            (try_for_range, ":var13", 0, ":var2"),
              (401, ":var13"),
              (402, ":var4", ":var13"),
              (eq, ":var4", ":var8"),
              (528, ":var14", ":var13", 21),
              (try_begin),
                (gt, ":var14", ":var11"),
                (assign, ":var11", ":var14"),
                (assign, ":var12", ":var13"),
              (try_end),
            (try_end),
            (try_begin),
              (ge, ":var12", 0),
              (try_begin),
                (406, ":var15", ":var12"),
                (ge, ":var15", 0),
                (agent_is_alive, ":var15"),
                (433, ":var16", ":var12"),
                (val_add, ":var16", 1),
                (434, ":var12", ":var16"),
                (435, ":var17", ":var12"),
                (val_sub, ":var17", 1),
                (436, ":var12", ":var17"),
                (431, ":var18", ":var12"),
                (val_add, ":var18", 1),
                (432, ":var12", ":var18"),
                (try_for_range, ":var13", 1, ":var2"),
                  (401, ":var13"),
                  (398, ":var13", 86, ":var12", ":var18", ":var16", ":var17"),
                (try_end),
                (460, ":var19", ":var12"),
                (407, ":var20", ":var12"),
                (val_add, ":var20", ":var19"),
                (408, ":var12", ":var20", 15000),
              (try_end),
              (405, ":var12", -1),
              (403, ":var12", ":var9"),
              (394, ":var12", 79),
            (try_end),
          (try_end),
          (call_script, "script_show_multiplayer_message", 2, 0),
          (415, ":var21"),
          (400, ":var2"),
          (try_for_range, ":var13", 0, ":var2"),
            (401, ":var13"),
            (neq, ":var21", ":var13"),
            (395, ":var13", 68, 2),
          (try_end),
          (assign, "$g_team_balance_next_round", 0),
        (try_end),
      (try_end),
      (assign, "$g_team_balance_next_round", 0),
      (400, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (401, ":var13"),
        (508, ":var13", 0, 0),
        (508, ":var13", 25, 0),
        (406, ":var22", ":var13"),
        (ge, ":var22", 0),
        (agent_is_alive, ":var22"),
        (459, ":var13"),
        (460, ":var19", ":var13"),
        (508, ":var13", 1, ":var19"),
      (try_end),
      (assign, ":var23", 500),
      (val_mul, ":var23", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var23", 100),
      (400, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (401, ":var13"),
        (407, ":var20", ":var13"),
        (402, ":var4", ":var13"),
        (try_begin),
          (this_or_next|eq, ":var4", 0),
          (eq, ":var4", 1),
          (val_add, ":var20", ":var23"),
        (try_end),
        (try_begin),
          (528, ":var19", ":var13", 1),
          (store_add, ":var24", ":var20", ":var19"),
          (store_mul, ":var25", "$g_multiplayer_initial_gold_multiplier", 10),
          (lt, ":var24", ":var25"),
          (store_sub, ":var26", ":var25", ":var24"),
          (val_add, ":var20", ":var26"),
        (try_end),
        (408, ":var13", ":var20", 15000),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (416),
      (assign, "$g_my_spawn_count", 0),
      (400, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (401, ":var13"),
        (508, ":var13", 39, 0),
      (try_end),
      (call_script, "script_initialize_objects"),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_close_gate_if_it_is_open"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (call_script, "script_move_belfries_to_their_first_entry_point", "spr_belfry_a"),
      (call_script, "script_move_belfries_to_their_first_entry_point", "spr_belfry_b"),
      (scene_prop_get_num_instances, ":var27", "spr_belfry_a"),
      (try_for_range, ":var28", 0, ":var27"),
        (scene_prop_get_instance, ":var29", "spr_belfry_a", ":var28"),
        (510, ":var29", 3, 0),
        (510, ":var29", 4, 0),
      (try_end),
      (scene_prop_get_num_instances, ":var27", "spr_belfry_a"),
      (try_for_range, ":var28", 0, ":var27"),
        (scene_prop_get_instance, ":var29", "spr_belfry_a", ":var28"),
        (510, ":var29", 5, 0),
      (try_end),
      (scene_prop_get_num_instances, ":var27", "spr_belfry_b"),
      (try_for_range, ":var28", 0, ":var27"),
        (scene_prop_get_instance, ":var29", "spr_belfry_b", ":var28"),
        (510, ":var29", 3, 0),
        (510, ":var29", 4, 0),
      (try_end),
      (scene_prop_get_num_instances, ":var27", "spr_belfry_b"),
      (try_for_range, ":var28", 0, ":var27"),
        (scene_prop_get_instance, ":var29", "spr_belfry_b", ":var28"),
        (510, ":var29", 5, 0),
      (try_end),
      (try_for_range, ":var30", 0, "$g_number_of_flags"),
        (scene_prop_get_instance, ":var31", "spr_headquarters_pole_code_only", ":var30"),
        (prop_instance_get_position, pos1, ":var31"),
        (position_move_z, pos1, 900),
        (scene_prop_get_instance, ":var32", "$team_1_flag_scene_prop", ":var30"),
        (1861, ":var32"),
        (prop_instance_set_position, ":var32", pos1),
      (try_end),
      (assign, "$g_round_ended", 0),
      (store_mission_timer_a, "$g_round_start_time"),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (400, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (401, ":var13"),
        (395, ":var13", 78, -9999),
      (try_end),
      (assign, "$g_flag_is_not_ready", 0),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (400, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (401, ":var1"),
        (neg|438, ":var1"),
        (548, ":var1", 0, 0),
        (402, ":var2", ":var1"),
        (lt, ":var2", 2),
        (404, ":var3", ":var1"),
        (ge, ":var3", 0),
        (406, ":var4", ":var1"),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (assign, ":var7", 0),
        (try_begin),
          (assign, ":var8", 0),
          (400, ":var0"),
          (try_for_range, ":var9", 0, ":var0"),
            (401, ":var9"),
            (402, ":var10", ":var9"),
            (try_begin),
              (eq, ":var10", 0),
              (val_add, ":var6", 1),
            (else_try),
              (eq, ":var10", 1),
              (val_add, ":var7", 1),
            (try_end),
            (val_add, ":var8", 1),
          (try_end),
          (store_mission_timer_a, ":var11"),
          (val_sub, ":var11", "$g_round_start_time"),
          (eq, "$g_round_ended", 0),
          (try_begin),
            (lt, ":var4", 0),
            (try_begin),
              (eq, ":var2", 0),
              (528, ":var12", ":var1", 28),
              (store_mission_timer_a, ":var13"),
              (store_sub, ":var14", ":var13", ":var12"),
              (assign, ":var15", "$g_multiplayer_respawn_period"),
              (val_add, ":var15", 27),
              (lt, ":var14", ":var15"),
              (store_sub, ":var11", ":var13", "$g_round_start_time"),
              (ge, ":var11", 30),
              (gt, ":var8", 2),
              (store_mul, ":var16", ":var6", ":var7"),
              (neq, ":var16", 0),
              (assign, ":var5", 0),
            (else_try),
              (assign, ":var5", 1),
            (try_end),
          (else_try),
            (1760, ":var14", ":var4"),
            (assign, ":var15", "$g_multiplayer_respawn_period"),
            (try_begin),
              (eq, ":var2", 0),
              (val_add, ":var15", 27),
            (try_end),
            (this_or_next|gt, ":var14", ":var15"),
            (548, ":var1", 25, 0),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (528, ":var17", ":var1", 39),
        (try_begin),
          (gt, "$g_multiplayer_number_of_respawn_count", 0),
          (try_begin),
            (eq, ":var5", 1),
            (eq, ":var2", 0),
            (ge, ":var17", "$g_multiplayer_number_of_respawn_count"),
            (assign, ":var5", 0),
          (else_try),
            (eq, ":var5", 1),
            (eq, ":var2", 1),
            (ge, ":var17", 999),
            (assign, ":var5", 0),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (528, ":var17", ":var1", 39),
        (val_add, ":var17", 1),
        (508, ":var1", 39, ":var17"),
        (try_begin),
          (ge, ":var17", "$g_multiplayer_number_of_respawn_count"),
          (gt, "$g_multiplayer_number_of_respawn_count", 0),
          (eq, ":var2", 0),
          (assign, ":var17", 999),
          (508, ":var1", 39, ":var17"),
        (try_end),
        (assign, ":var18", 0),
        (422, ":var19", ":var1", 8),
        (try_begin),
          (this_or_next|is_between, ":var19", "itm_sumpter_horse", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var19", "itm_warhorse_sarranid"),
          (eq, ":var19", "itm_warhorse_steppe"),
          (assign, ":var18", 1),
        (try_end),
        (try_begin),
          (lt, ":var11", 20),
          (try_begin),
            (eq, ":var2", 0),
            (call_script, "script_multiplayer_find_spawn_point", ":var2", 1, ":var18"),
            (assign, ":var20", reg0),
          (else_try),
            (eq, ":var2", 1),
            (assign, ":var20", 32),
          (try_end),
        (else_try),
          (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var18"),
          (assign, ":var20", reg0),
        (try_end),
        (409, ":var1", ":var20"),
        (508, ":var1", 0, 1),
        (508, ":var1", 25, 1),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (1707, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (1760, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (417),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (455, ":var1", 0),
          (455, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (458, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_sarleon_longbowman_multiplayer_ai", "trp_sarleon_longbowman_multiplayer"),
          (store_troop_faction, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (400, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (401, ":var17"),
          (402, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (568, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (417),
      (try_for_agents, ":var0"),
        (1707, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (1765, ":var1", ":var0"),
        (try_begin),
          (neg|401, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (402, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (455, ":var7", 0),
        (455, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (400, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (401, ":var11"),
            (406, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|1707, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_round_time_counter"),
      (start_presentation, "prsnt_multiplayer_team_score_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|903, "prsnt_multiplayer_escape_menu"),
      (neg|903, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_bt", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (417),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 2),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (assign, "$g_waiting_for_confirmation_to_terminate", 0),
      (assign, "$g_round_ended", 0),
      (assign, "$g_battle_death_mode_started", 0),
      (assign, "$g_reduced_waiting_seconds", 0),
      (try_begin),
        (417),
        (assign, "$server_mission_timer_while_player_joined", 0),
        (assign, "$g_round_start_time", 0),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (call_script, "script_determine_team_flags", 1),
      (426, 0, -1),
      (426, 1, -1),
      (try_begin),
        (417),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
        (entry_point_get_position, pos0, 67),
        (position_set_z_to_ground_level, pos0),
        (position_move_z, pos0, -2000),
        (position_move_x, pos0, 100),
        (set_spawn_position, pos0),
        (1974, "spr_headquarters_pole_code_only", 0),
        (position_move_x, pos0, -200),
        (set_spawn_position, pos0),
        (1974, "spr_headquarters_pole_code_only", 0),
        (scene_prop_get_instance, ":var0", "spr_headquarters_pole_code_only", 0),
        (prop_instance_get_position, pos0, ":var0"),
        (1974, "$team_1_flag_scene_prop", 0),
        (position_move_z, pos0, 100),
        (prop_instance_set_position, reg0, pos0),
        (scene_prop_get_instance, ":var1", "spr_headquarters_pole_code_only", 1),
        (prop_instance_get_position, pos0, ":var1"),
        (1974, "$team_2_flag_scene_prop", 0),
        (position_move_z, pos0, 100),
        (prop_instance_set_position, reg0, pos0),
        (assign, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1"),
        (assign, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2"),
      (try_end),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (415, ":var1"),
        (ge, ":var1", 0),
        (406, ":var2", ":var1"),
        (eq, ":var2", ":var0"),
        (ge, ":var2", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var2"),
      (try_end),
      (call_script, "script_calculate_new_death_waiting_time_at_death_mod"),
      (try_begin),
        (neg|417),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (assign, "$g_round_ended", 0),
          (call_script, "script_initialize_all_scene_prop_slots"),
          (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
          (call_script, "script_initialize_objects_clients"),
          (try_begin),
            (eq, "$g_team_balance_next_round", 1),
            (assign, "$g_team_balance_next_round", 0),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (415, ":var2"),
        (ge, ":var2", 0),
        (406, ":var3", ":var2"),
        (ge, ":var3", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var3"),
      (try_end),
      (try_begin),
        (agent_is_human, ":var0"),
        (assign, ":var4", 0),
        (assign, ":var5", 0),
        (try_for_agents, ":var6"),
          (agent_is_human, ":var6"),
          (try_begin),
            (agent_is_alive, ":var6"),
            (agent_get_team, ":var7", ":var6"),
            (try_begin),
              (eq, ":var7", 0),
              (val_add, ":var4", 1),
            (else_try),
              (eq, ":var7", 1),
              (val_add, ":var5", 1),
            (try_end),
          (try_end),
        (try_end),
        (try_begin),
          (eq, "$g_round_ended", 0),
          (try_begin),
            (this_or_next|eq, ":var4", 0),
            (eq, ":var5", 0),
            (assign, "$g_winner_team", -1),
            (assign, reg0, "$g_multiplayer_respawn_period"),
            (try_begin),
              (eq, ":var4", 0),
              (try_begin),
                (neq, ":var5", 0),
                (455, ":var8", 1),
                (val_add, ":var8", 1),
                (456, 1, ":var8"),
                (assign, "$g_winner_team", 1),
              (try_end),
              (call_script, "script_show_multiplayer_message", 12, "$g_winner_team"),
              (call_script, "script_check_achievement_last_man_standing", "$g_winner_team"),
            (else_try),
              (try_begin),
                (neq, ":var4", 0),
                (455, ":var9", 0),
                (val_add, ":var9", 1),
                (456, 0, ":var9"),
                (assign, "$g_winner_team", 0),
              (try_end),
              (call_script, "script_show_multiplayer_message", 12, "$g_winner_team"),
              (call_script, "script_check_achievement_last_man_standing", "$g_winner_team"),
            (try_end),
            (store_mission_timer_a, "$g_round_finish_time"),
            (assign, "$g_round_ended", 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (417),
        (agent_is_human, ":var0"),
        (neg|1707, ":var0"),
        (ge, ":var0", 0),
        (1724, ":var10", ":var0"),
        (ge, ":var10", 0),
        (set_fixed_point_multiplier, 100),
        (1724, ":var10", ":var0"),
        (agent_get_position, pos0, ":var0"),
        (position_get_x, ":var11", pos0),
        (position_get_y, ":var12", pos0),
        (position_get_z, ":var13", pos0),
        (508, ":var10", 29, ":var11"),
        (508, ":var10", 30, ":var12"),
        (508, ":var10", 31, ":var13"),
      (try_end),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (1, 0, 0, 
    [
      (417),
      (eq, "$g_round_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (ge, ":var1", "$g_multiplayer_round_max_seconds"),
      (assign, ":var2", 0),
      (try_begin),
        (eq, "$g_battle_death_mode_started", 2),
        (scene_prop_get_instance, ":var3", "spr_headquarters_pole_code_only", 0),
        (scene_prop_get_instance, ":var4", "spr_headquarters_pole_code_only", 1),
        (scene_prop_get_instance, ":var5", "$team_1_flag_scene_prop", 0),
        (scene_prop_get_instance, ":var6", "$team_2_flag_scene_prop", 0),
        (prop_instance_get_position, pos1, ":var3"),
        (prop_instance_get_position, pos2, ":var4"),
        (prop_instance_get_position, pos3, ":var5"),
        (prop_instance_get_position, pos4, ":var6"),
        (get_distance_between_positions, ":var7", pos1, pos3),
        (get_distance_between_positions, ":var8", pos2, pos4),
        (store_add, ":var9", ":var7", 50),
        (store_add, ":var10", ":var8", 50),
        (try_begin),
          (le, ":var7", ":var10"),
          (1862, ":var11", ":var5"),
          (eq, ":var11", 1),
          (1863, 5, ":var5"),
          (position_get_z, ":var12", pos5),
          (position_get_z, ":var13", pos3),
          (ge, ":var12", ":var13"),
          (assign, ":var2", 1),
        (try_end),
        (try_begin),
          (le, ":var8", ":var9"),
          (1862, ":var11", ":var6"),
          (eq, ":var11", 1),
          (1863, 5, ":var6"),
          (position_get_z, ":var12", pos5),
          (position_get_z, ":var14", pos4),
          (ge, ":var12", ":var14"),
          (assign, ":var2", 1),
        (try_end),
      (try_end),
      (eq, ":var2", 0),
    ],
    [
      (store_mission_timer_a, "$g_round_finish_time"),
      (assign, "$g_round_ended", 1),
      (assign, "$g_winner_team", -1),
      (try_begin),
        (eq, "$g_battle_death_mode_started", 2),
        (scene_prop_get_instance, ":var0", "spr_headquarters_pole_code_only", 0),
        (scene_prop_get_instance, ":var1", "spr_headquarters_pole_code_only", 1),
        (scene_prop_get_instance, ":var2", "$team_1_flag_scene_prop", 0),
        (scene_prop_get_instance, ":var3", "$team_2_flag_scene_prop", 0),
        (prop_instance_get_position, pos1, ":var0"),
        (prop_instance_get_position, pos2, ":var1"),
        (prop_instance_get_position, pos3, ":var2"),
        (prop_instance_get_position, pos4, ":var3"),
        (get_distance_between_positions, ":var4", pos1, pos3),
        (get_distance_between_positions, ":var5", pos2, pos4),
        (try_begin),
          (ge, ":var4", ":var5"),
          (store_sub, ":var6", ":var4", ":var5"),
          (ge, ":var6", 50),
          (assign, "$g_winner_team", 0),
        (else_try),
          (store_sub, ":var6", ":var5", ":var4"),
          (ge, ":var6", 50),
          (assign, "$g_winner_team", 1),
        (try_end),
      (try_end),
      (415, ":var7"),
      (call_script, "script_draw_this_round", "$g_winner_team"),
      (400, ":var8"),
      (try_for_range, ":var9", 1, ":var8"),
        (401, ":var9"),
        (neq, ":var9", ":var7"),
        (395, ":var9", 69, "$g_winner_team"),
      (try_end),
    ]),

    (10, 0, 0, 
    [
      (417),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (400, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (401, ":var3"),
        (402, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (eq, "$g_team_balance_next_round", 0),
          (assign, "$g_team_balance_next_round", 1),
          (call_script, "script_show_multiplayer_message", 3, 0),
          (400, ":var2"),
          (try_for_range, ":var8", 1, ":var2"),
            (401, ":var8"),
            (395, ":var8", 68, 3),
          (try_end),
          (call_script, "script_warn_player_about_auto_team_balance"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (417),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 0),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_round_start_time"),
      (store_div, "$g_multiplayer_round_max_seconds_div_2", "$g_multiplayer_round_max_seconds", 2),
      (ge, ":var0", "$g_multiplayer_round_max_seconds_div_2"),
    ],
    [
      (call_script, "script_calculate_new_death_waiting_time_at_death_mod"),
      (assign, "$g_battle_death_mode_started", 1),
    ]),

    (1, 0, 0, 
    [
      (417),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_death_mode_part_1_start_time"),
      (store_add, ":var1", "$g_battle_waiting_seconds", "$g_reduced_waiting_seconds"),
      (ge, ":var0", ":var1"),
      (store_mission_timer_a, ":var2"),
      (store_sub, ":var3", ":var2", "$g_round_start_time"),
      (store_sub, ":var4", "$g_multiplayer_round_max_seconds", 15),
      (lt, ":var3", ":var4"),
    ],
    [
      (assign, "$g_battle_death_mode_started", 2),
      (call_script, "script_start_death_mode"),
      (400, ":var0"),
      (try_for_range, ":var1", 1, ":var0"),
        (401, ":var1"),
        (395, ":var1", 80),
      (try_end),
      (scene_prop_get_instance, ":var2", "spr_headquarters_pole_code_only", 0),
      (scene_prop_get_instance, ":var3", "spr_headquarters_pole_code_only", 1),
      (scene_prop_get_instance, ":var4", "$team_1_flag_scene_prop", 0),
      (scene_prop_get_instance, ":var5", "$team_2_flag_scene_prop", 0),
      (store_random_in_range, "$g_random_entry_point", 0, 3),
      (val_add, "$g_random_entry_point", 67),
      (entry_point_get_position, pos0, "$g_random_entry_point"),
      (position_set_z_to_ground_level, pos0),
      (position_move_x, pos0, 100),
      (prop_instance_set_position, ":var2", pos0),
      (position_move_x, pos0, -200),
      (prop_instance_set_position, ":var3", pos0),
      (prop_instance_get_position, pos0, ":var2"),
      (position_move_z, pos0, 100),
      (prop_instance_set_position, ":var4", pos0),
      (prop_instance_get_position, pos0, ":var3"),
      (position_move_z, pos0, 100),
      (prop_instance_set_position, ":var5", pos0),
      (start_presentation, "prsnt_multiplayer_flag_projection_display_bt"),
    ]),

    (3, 0, 0, 
    [
      (417),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_death_mode_part_1_start_time"),
      (store_add, ":var1", "$g_battle_waiting_seconds", "$g_reduced_waiting_seconds"),
      (val_sub, ":var1", 20),
      (ge, ":var0", ":var1"),
    ],
    [
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (eq, ":var0", 0),
        (agent_is_human, ":var1"),
        (try_for_agents, ":var2"),
          (agent_is_human, ":var2"),
          (neq, ":var1", ":var2"),
          (agent_get_team, ":var3", ":var1"),
          (agent_get_team, ":var4", ":var2"),
          (neq, ":var3", ":var4"),
          (agent_get_position, pos1, ":var1"),
          (agent_get_position, pos2, ":var2"),
          (position_is_behind_position, ":var5", pos1, 2),
          (le, ":var5", 49),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (val_add, "$g_reduced_waiting_seconds", 3),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (417),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 1),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (store_sub, ":var2", "$g_multiplayer_round_max_seconds", 66),
      (ge, ":var1", ":var2"),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (store_sub, ":var3", "$g_multiplayer_round_max_seconds", 24),
      (le, ":var1", ":var3"),
    ],
    [
      (val_add, "$g_reduced_waiting_seconds", 1),
    ]),

    (0, 0, 0, 
    [
      (417),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 2),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (scene_prop_get_instance, ":var0", "spr_headquarters_pole_code_only", 0),
      (scene_prop_get_instance, ":var1", "spr_headquarters_pole_code_only", 1),
      (scene_prop_get_instance, ":var2", "$team_1_flag_scene_prop", 0),
      (scene_prop_get_instance, ":var3", "$team_2_flag_scene_prop", 0),
      (prop_instance_get_position, pos1, ":var0"),
      (prop_instance_get_position, pos2, ":var1"),
      (prop_instance_get_position, pos3, ":var2"),
      (prop_instance_get_position, pos4, ":var3"),
      (copy_position, pos7, pos1),
      (position_move_z, pos7, 100),
      (copy_position, pos8, pos2),
      (position_move_z, pos8, 100),
      (get_distance_between_positions, ":var4", pos1, pos3),
      (get_distance_between_positions, ":var5", pos2, pos4),
      (assign, ":var6", 0),
      (assign, ":var7", 0),
      (400, ":var8"),
      (try_for_range, ":var9", 0, ":var8"),
        (401, ":var9"),
        (406, ":var10", ":var9"),
        (ge, ":var10", 0),
        (agent_is_human, ":var10"),
        (agent_is_alive, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos0, ":var10"),
        (agent_get_horse, ":var12", ":var10"),
        (eq, ":var12", -1),
        (try_begin),
          (eq, ":var11", 0),
          (try_begin),
            (712, ":var13", 0, 1),
            (lt, ":var13", 1600),
            (try_begin),
              (this_or_next|eq, ":var6", 0),
              (eq, ":var6", 1),
              (assign, ":var6", 1),
            (else_try),
              (assign, ":var6", -2),
            (try_end),
          (try_end),
          (try_begin),
            (712, ":var13", 0, 2),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var7", 0),
              (assign, ":var7", -1),
            (else_try),
              (eq, ":var7", 1),
              (assign, ":var7", -2),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var11", 1),
          (try_begin),
            (712, ":var13", 0, 2),
            (lt, ":var13", 1600),
            (try_begin),
              (this_or_next|eq, ":var7", 0),
              (eq, ":var7", 1),
              (assign, ":var7", 1),
            (else_try),
              (assign, ":var7", -2),
            (try_end),
          (try_end),
          (try_begin),
            (712, ":var13", 0, 1),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var6", 0),
              (assign, ":var6", -1),
            (else_try),
              (eq, ":var6", 1),
              (assign, ":var6", -2),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var4", 800),
        (assign, "$g_winner_team", 0),
        (400, ":var8"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var9", 1, ":var8"),
          (401, ":var9"),
          (395, ":var9", 69, "$g_winner_team"),
        (try_end),
        (455, ":var14", 0),
        (call_script, "script_team_set_score", 0, ":var14"),
        (try_for_range, ":var9", 1, ":var8"),
          (401, ":var9"),
          (396, ":var9", 72, 0, ":var14"),
        (try_end),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
      (else_try),
        (ge, ":var5", 800),
        (assign, "$g_winner_team", 1),
        (400, ":var8"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var9", 1, ":var8"),
          (401, ":var9"),
          (395, ":var9", 69, "$g_winner_team"),
        (try_end),
        (455, ":var15", 1),
        (call_script, "script_team_set_score", 1, ":var15"),
        (try_for_range, ":var9", 1, ":var8"),
          (401, ":var9"),
          (396, ":var9", 72, 1, ":var15"),
        (try_end),
        (call_script, "script_show_multiplayer_message", 12, 0),
        (call_script, "script_check_achievement_last_man_standing", "$g_winner_team"),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
      (try_end),
      (try_begin),
        (eq, "$g_round_ended", 0),
        (position_get_z, ":var16", pos3),
        (1862, ":var17", ":var2"),
        (try_begin),
          (eq, ":var6", -2),
          (eq, ":var17", 1),
          (1861, ":var2"),
        (else_try),
          (this_or_next|eq, ":var6", 0),
          (eq, ":var6", -1),
          (1863, 9, ":var2"),
          (position_get_z, ":var18", pos9),
          (this_or_next|eq, ":var17", 0),
          (gt, ":var18", ":var16"),
          (get_distance_between_positions, ":var19", pos3, pos7),
          (gt, ":var19", 0),
          (val_mul, ":var19", 16),
          (prop_instance_animate_to_position, ":var2", pos7, ":var19"),
        (else_try),
          (eq, ":var6", 1),
          (1863, 9, ":var2"),
          (position_get_z, ":var18", pos9),
          (this_or_next|eq, ":var17", 0),
          (lt, ":var18", ":var16"),
          (copy_position, pos5, pos1),
          (position_move_z, pos5, 800),
          (get_distance_between_positions, ":var19", pos3, pos5),
          (gt, ":var19", 0),
          (val_mul, ":var19", 8),
          (prop_instance_animate_to_position, ":var2", pos5, ":var19"),
        (try_end),
        (position_get_z, ":var20", pos4),
        (1862, ":var17", ":var3"),
        (try_begin),
          (eq, ":var7", -2),
          (eq, ":var17", 1),
          (1861, ":var3"),
        (else_try),
          (this_or_next|eq, ":var7", 0),
          (eq, ":var7", -1),
          (1863, 9, ":var3"),
          (position_get_z, ":var21", pos9),
          (this_or_next|eq, ":var17", 0),
          (gt, ":var21", ":var20"),
          (get_distance_between_positions, ":var22", pos4, pos8),
          (gt, ":var22", 0),
          (val_mul, ":var22", 16),
          (prop_instance_animate_to_position, ":var3", pos8, ":var22"),
        (else_try),
          (eq, ":var7", 1),
          (1863, 9, ":var3"),
          (position_get_z, ":var21", pos9),
          (this_or_next|eq, ":var17", 0),
          (lt, ":var21", ":var20"),
          (copy_position, pos6, pos2),
          (position_move_z, pos6, 800),
          (get_distance_between_positions, ":var22", pos4, pos6),
          (gt, ":var22", 0),
          (val_mul, ":var22", 8),
          (prop_instance_animate_to_position, ":var3", pos6, ":var22"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 3, 
    [
      (417),
      (eq, "$g_round_ended", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_round_finish_time"),
      (ge, ":var0", "$g_multiplayer_respawn_period"),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (400, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (401, ":var3"),
        (402, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
          (assign, ":var8", 1),
          (assign, ":var9", 0),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
          (assign, ":var8", 0),
          (assign, ":var9", 1),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (try_for_range, ":var10", 0, ":var6"),
            (assign, ":var11", 0),
            (assign, ":var12", -1),
            (400, ":var2"),
            (try_for_range, ":var13", 0, ":var2"),
              (401, ":var13"),
              (402, ":var4", ":var13"),
              (eq, ":var4", ":var8"),
              (528, ":var14", ":var13", 21),
              (try_begin),
                (gt, ":var14", ":var11"),
                (assign, ":var11", ":var14"),
                (assign, ":var12", ":var13"),
              (try_end),
            (try_end),
            (try_begin),
              (ge, ":var12", 0),
              (try_begin),
                (406, ":var15", ":var12"),
                (ge, ":var15", 0),
                (agent_is_alive, ":var15"),
                (433, ":var16", ":var12"),
                (val_add, ":var16", 1),
                (434, ":var12", ":var16"),
                (435, ":var17", ":var12"),
                (val_sub, ":var17", 1),
                (436, ":var12", ":var17"),
                (431, ":var18", ":var12"),
                (val_add, ":var18", 1),
                (432, ":var12", ":var18"),
                (try_for_range, ":var13", 1, ":var2"),
                  (401, ":var13"),
                  (398, ":var13", 86, ":var12", ":var18", ":var16", ":var17"),
                (try_end),
                (460, ":var19", ":var12"),
                (407, ":var20", ":var12"),
                (val_add, ":var20", ":var19"),
                (408, ":var12", ":var20", 15000),
              (try_end),
              (405, ":var12", -1),
              (403, ":var12", ":var9"),
              (394, ":var12", 79),
            (try_end),
          (try_end),
          (call_script, "script_show_multiplayer_message", 2, 0),
          (415, ":var21"),
          (400, ":var2"),
          (try_for_range, ":var13", 0, ":var2"),
            (401, ":var13"),
            (neq, ":var21", ":var13"),
            (395, ":var13", 68, 2),
          (try_end),
          (assign, "$g_team_balance_next_round", 0),
        (try_end),
      (try_end),
      (assign, "$g_team_balance_next_round", 0),
      (400, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (401, ":var13"),
        (508, ":var13", 0, 0),
        (406, ":var22", ":var13"),
        (ge, ":var22", 0),
        (agent_is_alive, ":var22"),
        (459, ":var13"),
        (460, ":var19", ":var13"),
        (508, ":var13", 1, ":var19"),
      (try_end),
      (assign, ":var23", 500),
      (val_mul, ":var23", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var23", 100),
      (400, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (401, ":var13"),
        (407, ":var20", ":var13"),
        (402, ":var4", ":var13"),
        (try_begin),
          (this_or_next|eq, ":var4", 0),
          (eq, ":var4", 1),
          (val_add, ":var20", ":var23"),
        (try_end),
        (try_begin),
          (528, ":var19", ":var13", 1),
          (store_add, ":var24", ":var20", ":var19"),
          (store_mul, ":var25", "$g_multiplayer_initial_gold_multiplier", 10),
          (lt, ":var24", ":var25"),
          (store_sub, ":var26", ":var25", ":var24"),
          (val_add, ":var20", ":var26"),
        (try_end),
        (408, ":var13", ":var20", 15000),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (416),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (try_begin),
        (eq, "$g_battle_death_mode_started", 2),
        (call_script, "script_move_death_mode_flags_down"),
      (try_end),
      (assign, "$g_battle_death_mode_started", 0),
      (assign, "$g_reduced_waiting_seconds", 0),
      (call_script, "script_multiplayer_close_gate_if_it_is_open"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_round_ended", 0),
      (assign, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1"),
      (assign, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2"),
      (store_mission_timer_a, "$g_round_start_time"),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (400, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (401, ":var13"),
        (395, ":var13", 78, -9999),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (assign, ":var0", "$g_multiplayer_num_bots_team_1"),
      (assign, ":var1", "$g_multiplayer_num_bots_team_2"),
      (400, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (401, ":var3"),
        (402, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var0", 0),
        (eq, ":var1", 0),
        (store_mission_timer_a, ":var5"),
        (val_sub, ":var5", "$g_round_start_time"),
        (le, ":var5", 2),
        (store_mission_timer_a, "$g_round_start_time"),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (400, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (401, ":var1"),
        (neg|438, ":var1"),
        (try_begin),
          (548, ":var1", 0, 0),
          (402, ":var2", ":var1"),
          (lt, ":var2", 2),
          (404, ":var3", ":var1"),
          (ge, ":var3", 0),
          (assign, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (try_begin),
            (assign, ":var7", 0),
            (400, ":var0"),
            (try_for_range, ":var8", 0, ":var0"),
              (401, ":var8"),
              (val_add, ":var7", 1),
              (402, ":var9", ":var8"),
              (try_begin),
                (eq, ":var9", 0),
                (val_add, ":var5", 1),
              (else_try),
                (eq, ":var9", 1),
                (val_add, ":var6", 1),
              (try_end),
            (try_end),
            (store_mul, ":var10", ":var5", ":var6"),
            (store_mission_timer_a, ":var11"),
            (val_sub, ":var11", "$g_round_start_time"),
            (this_or_next|lt, ":var11", 30),
            (this_or_next|le, ":var7", 2),
            (eq, ":var10", 0),
            (eq, "$g_round_ended", 0),
            (assign, ":var4", 1),
          (try_end),
          (eq, ":var4", 1),
          (try_begin),
            (eq, ":var2", 0),
            (assign, ":var12", 0),
          (else_try),
            (eq, ":var2", 1),
            (assign, ":var12", 32),
          (try_end),
          (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
          (409, ":var1", ":var12"),
          (508, ":var1", 0, 1),
        (else_try),
          (eq, "$g_multiplayer_player_respawn_as_bot", 1),
          (406, ":var13", ":var1"),
          (ge, ":var13", 0),
          (neg|agent_is_alive, ":var13"),
          (1760, ":var14", ":var13"),
          (gt, ":var14", "$g_multiplayer_respawn_period"),
          (402, ":var2", ":var1"),
          (assign, ":var15", 0),
          (try_for_agents, ":var16"),
            (eq, ":var15", 0),
            (agent_is_alive, ":var16"),
            (agent_is_human, ":var16"),
            (1707, ":var16"),
            (agent_get_team, ":var17", ":var16"),
            (eq, ":var17", ":var2"),
            (assign, ":var15", 1),
          (try_end),
          (try_begin),
            (eq, ":var15", 1),
            (call_script, "script_find_most_suitable_bot_to_control", ":var1"),
            (421, ":var1", reg0),
            (528, ":var18", ":var1", 0),
            (val_add, ":var18", 1),
            (508, ":var1", 0, ":var18"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (417),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (455, ":var1", 0),
          (455, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (458, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_sarleon_longbowman_multiplayer_ai", "trp_sarleon_longbowman_multiplayer"),
          (store_troop_faction, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (400, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (401, ":var17"),
          (402, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (568, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (417),
      (try_for_agents, ":var0"),
        (1707, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (1765, ":var1", ":var0"),
        (try_begin),
          (neg|401, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (402, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (455, ":var7", 0),
        (455, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (400, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (401, ":var11"),
            (406, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|1707, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_round_time_counter"),
      (start_presentation, "prsnt_multiplayer_team_score_display"),
      (try_begin),
        (eq, "$g_battle_death_mode_started", 2),
        (start_presentation, "prsnt_multiplayer_flag_projection_display_bt"),
      (try_end),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|903, "prsnt_multiplayer_escape_menu"),
      (neg|903, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_fd", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (417),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 3),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (assign, "$g_waiting_for_confirmation_to_terminate", 0),
      (assign, "$g_round_ended", 0),
      (assign, "$g_reduced_waiting_seconds", 0),
      (try_begin),
        (417),
        (assign, "$g_round_start_time", 0),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (call_script, "script_determine_team_flags", 1),
      (426, 0, -1),
      (426, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_destructible_target_1", "spr_catapult_destructible"),
      (assign, "$g_destructible_target_2", "spr_trebuchet_destructible"),
      (scene_prop_get_num_instances, ":var0", "$g_destructible_target_1"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "$g_destructible_target_1", ":var1"),
        (ge, ":var2", 0),
        (1818, ":var2", 0),
      (try_end),
      (scene_prop_get_num_instances, ":var3", "$g_destructible_target_2"),
      (try_for_range, ":var4", 0, ":var3"),
        (scene_prop_get_instance, ":var5", "$g_destructible_target_2", ":var4"),
        (ge, ":var5", 0),
        (1818, ":var5", 0),
      (try_end),
      (try_begin),
        (scene_prop_get_num_instances, ":var6", "spr_catapult_destructible"),
        (ge, ":var6", 1),
        (scene_prop_get_instance, ":var7", "spr_catapult_destructible", 0),
        (1817, "$g_defender_team", ":var7"),
      (else_try),
        (scene_prop_get_num_instances, ":var8", "spr_trebuchet_destructible"),
        (ge, ":var8", 1),
        (scene_prop_get_instance, ":var9", "spr_trebuchet_destructible", 0),
        (1817, "$g_defender_team", ":var9"),
      (try_end),
      (assign, "$g_number_of_targets_destroyed", 0),
      (try_begin),
        (assign, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1"),
        (assign, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2"),
      (try_end),
      (start_presentation, "prsnt_multiplayer_destructible_targets_display"),
      (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (415, ":var1"),
        (ge, ":var1", 0),
        (406, ":var2", ":var1"),
        (eq, ":var2", ":var0"),
        (ge, ":var2", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var2"),
      (try_end),
      (try_begin),
        (neg|417),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (assign, "$g_round_ended", 0),
          (call_script, "script_initialize_all_scene_prop_slots"),
          (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
          (call_script, "script_initialize_objects_clients"),
          (start_presentation, "prsnt_multiplayer_destructible_targets_display"),
          (try_begin),
            (eq, "$g_team_balance_next_round", 1),
            (assign, "$g_team_balance_next_round", 0),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (415, ":var2"),
        (ge, ":var2", 0),
        (406, ":var3", ":var2"),
        (ge, ":var3", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var3"),
      (try_end),
      (try_begin),
        (agent_is_human, ":var0"),
        (assign, ":var4", 0),
        (assign, ":var5", 0),
        (try_for_agents, ":var6"),
          (agent_is_human, ":var6"),
          (try_begin),
            (agent_is_alive, ":var6"),
            (agent_get_team, ":var7", ":var6"),
            (try_begin),
              (eq, ":var7", 0),
              (val_add, ":var4", 1),
            (else_try),
              (eq, ":var7", 1),
              (val_add, ":var5", 1),
            (try_end),
          (try_end),
        (try_end),
        (try_begin),
          (eq, "$g_round_ended", 0),
          (try_begin),
            (this_or_next|eq, ":var4", 0),
            (eq, ":var5", 0),
            (assign, "$g_winner_team", -1),
            (assign, reg0, "$g_multiplayer_respawn_period"),
            (try_begin),
              (eq, ":var4", 0),
              (try_begin),
                (neq, ":var5", 0),
                (assign, "$g_winner_team", 1),
              (try_end),
              (try_begin),
                (eq, "$g_winner_team", -1),
              (else_try),
                (eq, "$g_defender_team", 1),
                (try_begin),
                  (neg|417),
                  (call_script, "script_calculate_number_of_targets_destroyed"),
                (try_end),
                (store_sub, ":var8", 2, "$g_number_of_targets_destroyed"),
                (call_script, "script_show_multiplayer_message", 16, ":var8"),
              (else_try),
                (call_script, "script_show_multiplayer_message", 17, 0),
              (try_end),
            (else_try),
              (try_begin),
                (neq, ":var4", 0),
                (assign, "$g_winner_team", 0),
              (try_end),
              (try_begin),
                (eq, "$g_winner_team", -1),
              (else_try),
                (eq, "$g_defender_team", 0),
                (try_begin),
                  (neg|417),
                  (call_script, "script_calculate_number_of_targets_destroyed"),
                (try_end),
                (store_sub, ":var8", 2, "$g_number_of_targets_destroyed"),
                (call_script, "script_show_multiplayer_message", 16, ":var8"),
              (else_try),
                (call_script, "script_show_multiplayer_message", 17, 0),
              (try_end),
            (try_end),
            (store_mission_timer_a, "$g_round_finish_time"),
            (assign, "$g_round_ended", 1),
            (try_begin),
              (417),
              (ge, "$g_winner_team", 0),
              (lt, "$g_winner_team", 2),
              (neq, "$g_winner_team", -1),
              (455, ":var9", "$g_winner_team"),
              (store_sub, ":var10", 2, "$g_number_of_targets_destroyed"),
              (val_add, ":var9", ":var10"),
              (call_script, "script_team_set_score", "$g_winner_team", ":var9"),
              (400, ":var11"),
              (try_for_range, ":var12", 1, ":var11"),
                (401, ":var12"),
                (396, ":var12", 72, "$g_winner_team", ":var9"),
              (try_end),
            (try_end),
            (try_begin),
              (neq, "$g_defender_team", "$g_winner_team"),
              (neq, "$g_winner_team", -1),
              (assign, "$g_number_of_targets_destroyed", 2),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (417),
        (agent_is_human, ":var0"),
        (neg|1707, ":var0"),
        (ge, ":var0", 0),
        (1724, ":var13", ":var0"),
        (ge, ":var13", 0),
        (set_fixed_point_multiplier, 100),
        (1724, ":var13", ":var0"),
        (agent_get_position, pos0, ":var0"),
        (position_get_x, ":var14", pos0),
        (position_get_y, ":var15", pos0),
        (position_get_z, ":var16", pos0),
        (508, ":var13", 29, ":var14"),
        (508, ":var13", 30, ":var15"),
        (508, ":var13", 31, ":var16"),
      (try_end),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (1, 0, 0, 
    [
      (417),
      (eq, "$g_round_ended", 0),
      (eq, "$g_number_of_targets_destroyed", 2),
    ],
    [
      (store_mission_timer_a, "$g_round_finish_time"),
      (assign, "$g_round_ended", 1),
      (415, ":var0"),
      (call_script, "script_draw_this_round", -9),
      (400, ":var1"),
      (try_for_range, ":var2", 1, ":var1"),
        (401, ":var2"),
        (neq, ":var2", ":var0"),
        (395, ":var2", 69, -9),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (417),
      (eq, "$g_round_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (ge, ":var1", "$g_multiplayer_round_max_seconds"),
    ],
    [
      (store_mission_timer_a, "$g_round_finish_time"),
      (assign, "$g_round_ended", 1),
      (assign, "$g_winner_team", -9),
      (415, ":var0"),
      (store_sub, ":var1", 2, "$g_number_of_targets_destroyed"),
      (call_script, "script_show_multiplayer_message", 16, ":var1"),
      (400, ":var2"),
      (try_for_range, ":var3", 1, ":var2"),
        (401, ":var3"),
        (396, ":var3", 68, 16, ":var1"),
      (try_end),
      (call_script, "script_draw_this_round", "$g_winner_team"),
      (400, ":var2"),
      (try_for_range, ":var3", 1, ":var2"),
        (401, ":var3"),
        (neq, ":var3", ":var0"),
        (395, ":var3", 69, "$g_winner_team"),
      (try_end),
      (try_begin),
        (417),
        (assign, "$g_winner_team", "$g_defender_team"),
        (455, ":var4", "$g_winner_team"),
        (store_sub, ":var5", 2, "$g_number_of_targets_destroyed"),
        (val_add, ":var4", ":var5"),
        (call_script, "script_team_set_score", "$g_winner_team", ":var4"),
        (try_for_range, ":var3", 1, ":var2"),
          (401, ":var3"),
          (396, ":var3", 72, "$g_winner_team", ":var4"),
        (try_end),
      (try_end),
    ]),

    (10, 0, 0, 
    [
      (417),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (400, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (401, ":var3"),
        (402, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (eq, "$g_team_balance_next_round", 0),
          (assign, "$g_team_balance_next_round", 1),
          (call_script, "script_show_multiplayer_message", 3, 0),
          (400, ":var2"),
          (try_for_range, ":var8", 1, ":var2"),
            (401, ":var8"),
            (395, ":var8", 68, 3),
          (try_end),
          (call_script, "script_warn_player_about_auto_team_balance"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (417),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 2),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (scene_prop_get_instance, ":var0", "spr_headquarters_pole_code_only", 0),
      (scene_prop_get_instance, ":var1", "spr_headquarters_pole_code_only", 1),
      (scene_prop_get_instance, ":var2", "$team_1_flag_scene_prop", 0),
      (scene_prop_get_instance, ":var3", "$team_2_flag_scene_prop", 0),
      (prop_instance_get_position, pos1, ":var0"),
      (prop_instance_get_position, pos2, ":var1"),
      (prop_instance_get_position, pos3, ":var2"),
      (prop_instance_get_position, pos4, ":var3"),
      (copy_position, pos7, pos1),
      (position_move_z, pos7, 100),
      (copy_position, pos8, pos2),
      (position_move_z, pos8, 100),
      (get_distance_between_positions, ":var4", pos1, pos3),
      (get_distance_between_positions, ":var5", pos2, pos4),
      (assign, ":var6", 0),
      (assign, ":var7", 0),
      (400, ":var8"),
      (try_for_range, ":var9", 0, ":var8"),
        (401, ":var9"),
        (406, ":var10", ":var9"),
        (ge, ":var10", 0),
        (agent_is_human, ":var10"),
        (agent_is_alive, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos0, ":var10"),
        (agent_get_horse, ":var12", ":var10"),
        (eq, ":var12", -1),
        (try_begin),
          (eq, ":var11", 0),
          (try_begin),
            (712, ":var13", 0, 1),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var6", 0),
              (assign, ":var6", 1),
            (else_try),
              (eq, ":var6", -1),
              (assign, ":var6", -2),
            (try_end),
          (try_end),
          (try_begin),
            (712, ":var13", 0, 2),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var7", 0),
              (assign, ":var7", -1),
            (else_try),
              (eq, ":var7", 1),
              (assign, ":var7", -2),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var11", 1),
          (try_begin),
            (712, ":var13", 0, 2),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var7", 0),
              (assign, ":var7", 1),
            (else_try),
              (assign, ":var7", -2),
            (try_end),
          (try_end),
          (try_begin),
            (712, ":var13", 0, 1),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var6", 0),
              (assign, ":var6", -1),
            (else_try),
              (eq, ":var6", 1),
              (assign, ":var6", -2),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var4", 800),
        (assign, "$g_winner_team", 0),
        (400, ":var8"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var9", 1, ":var8"),
          (401, ":var9"),
          (395, ":var9", 69, "$g_winner_team"),
        (try_end),
        (455, ":var14", 0),
        (call_script, "script_team_set_score", 0, ":var14"),
        (try_for_range, ":var9", 1, ":var8"),
          (401, ":var9"),
          (396, ":var9", 72, 0, ":var14"),
        (try_end),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
      (else_try),
        (ge, ":var5", 800),
        (assign, "$g_winner_team", 1),
        (400, ":var8"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var9", 1, ":var8"),
          (401, ":var9"),
          (395, ":var9", 69, "$g_winner_team"),
        (try_end),
        (455, ":var15", 1),
        (call_script, "script_team_set_score", 1, ":var15"),
        (try_for_range, ":var9", 1, ":var8"),
          (401, ":var9"),
          (396, ":var9", 72, 1, ":var15"),
        (try_end),
        (call_script, "script_show_multiplayer_message", 12, 0),
        (call_script, "script_check_achievement_last_man_standing", "$g_winner_team"),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
      (try_end),
      (try_begin),
        (eq, "$g_round_ended", 0),
        (position_get_z, ":var16", pos3),
        (1862, ":var17", ":var2"),
        (try_begin),
          (eq, ":var6", -2),
          (eq, ":var17", 1),
          (1861, ":var2"),
        (else_try),
          (this_or_next|eq, ":var6", 0),
          (eq, ":var6", -1),
          (1863, 9, ":var2"),
          (position_get_z, ":var18", pos9),
          (this_or_next|eq, ":var17", 0),
          (gt, ":var18", ":var16"),
          (get_distance_between_positions, ":var19", pos3, pos7),
          (gt, ":var19", 0),
          (val_mul, ":var19", 16),
          (prop_instance_animate_to_position, ":var2", pos7, ":var19"),
        (else_try),
          (eq, ":var6", 1),
          (1863, 9, ":var2"),
          (position_get_z, ":var18", pos9),
          (this_or_next|eq, ":var17", 0),
          (lt, ":var18", ":var16"),
          (copy_position, pos5, pos1),
          (position_move_z, pos5, 800),
          (get_distance_between_positions, ":var19", pos3, pos5),
          (gt, ":var19", 0),
          (val_mul, ":var19", 8),
          (prop_instance_animate_to_position, ":var2", pos5, ":var19"),
        (try_end),
        (position_get_z, ":var20", pos4),
        (1862, ":var17", ":var3"),
        (try_begin),
          (eq, ":var7", -2),
          (eq, ":var17", 1),
          (1861, ":var3"),
        (else_try),
          (this_or_next|eq, ":var7", 0),
          (eq, ":var7", -1),
          (1863, 9, ":var3"),
          (position_get_z, ":var21", pos9),
          (this_or_next|eq, ":var17", 0),
          (gt, ":var21", ":var20"),
          (get_distance_between_positions, ":var22", pos4, pos8),
          (gt, ":var22", 0),
          (val_mul, ":var22", 16),
          (prop_instance_animate_to_position, ":var3", pos8, ":var22"),
        (else_try),
          (eq, ":var7", 1),
          (1863, 9, ":var3"),
          (position_get_z, ":var21", pos9),
          (this_or_next|eq, ":var17", 0),
          (lt, ":var21", ":var20"),
          (copy_position, pos6, pos2),
          (position_move_z, pos6, 800),
          (get_distance_between_positions, ":var22", pos4, pos6),
          (gt, ":var22", 0),
          (val_mul, ":var22", 8),
          (prop_instance_animate_to_position, ":var3", pos6, ":var22"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 3, 
    [
      (417),
      (eq, "$g_round_ended", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_round_finish_time"),
      (ge, ":var0", "$g_multiplayer_respawn_period"),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (400, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (401, ":var3"),
        (402, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
          (assign, ":var8", 1),
          (assign, ":var9", 0),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
          (assign, ":var8", 0),
          (assign, ":var9", 1),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (try_for_range, ":var10", 0, ":var6"),
            (assign, ":var11", 0),
            (assign, ":var12", -1),
            (400, ":var2"),
            (try_for_range, ":var13", 0, ":var2"),
              (401, ":var13"),
              (402, ":var4", ":var13"),
              (eq, ":var4", ":var8"),
              (528, ":var14", ":var13", 21),
              (try_begin),
                (gt, ":var14", ":var11"),
                (assign, ":var11", ":var14"),
                (assign, ":var12", ":var13"),
              (try_end),
            (try_end),
            (try_begin),
              (ge, ":var12", 0),
              (try_begin),
                (406, ":var15", ":var12"),
                (ge, ":var15", 0),
                (agent_is_alive, ":var15"),
                (433, ":var16", ":var12"),
                (val_add, ":var16", 1),
                (434, ":var12", ":var16"),
                (435, ":var17", ":var12"),
                (val_sub, ":var17", 1),
                (436, ":var12", ":var17"),
                (431, ":var18", ":var12"),
                (val_add, ":var18", 1),
                (432, ":var12", ":var18"),
                (try_for_range, ":var13", 1, ":var2"),
                  (401, ":var13"),
                  (398, ":var13", 86, ":var12", ":var18", ":var16", ":var17"),
                (try_end),
                (460, ":var19", ":var12"),
                (407, ":var20", ":var12"),
                (val_add, ":var20", ":var19"),
                (408, ":var12", ":var20", 15000),
              (try_end),
              (405, ":var12", -1),
              (403, ":var12", ":var9"),
              (394, ":var12", 79),
            (try_end),
          (try_end),
          (call_script, "script_show_multiplayer_message", 2, 0),
          (415, ":var21"),
          (400, ":var2"),
          (try_for_range, ":var13", 0, ":var2"),
            (401, ":var13"),
            (neq, ":var21", ":var13"),
            (395, ":var13", 68, 2),
          (try_end),
          (assign, "$g_team_balance_next_round", 0),
        (try_end),
      (try_end),
      (assign, "$g_team_balance_next_round", 0),
      (400, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (401, ":var13"),
        (508, ":var13", 0, 0),
        (406, ":var22", ":var13"),
        (ge, ":var22", 0),
        (agent_is_alive, ":var22"),
        (459, ":var13"),
        (460, ":var19", ":var13"),
        (508, ":var13", 1, ":var19"),
      (try_end),
      (assign, ":var23", 500),
      (val_mul, ":var23", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var23", 100),
      (store_sub, ":var24", 2, "$g_number_of_targets_destroyed"),
      (store_mul, ":var25", ":var24", 100),
      (store_mul, ":var26", "$g_number_of_targets_destroyed", 100),
      (val_add, ":var25", 100),
      (val_sub, ":var26", 100),
      (400, ":var2"),
      (val_mul, ":var25", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var25", 100),
      (val_mul, ":var26", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var26", 100),
      (try_for_range, ":var13", 0, ":var2"),
        (401, ":var13"),
        (407, ":var20", ":var13"),
        (402, ":var4", ":var13"),
        (val_add, ":var20", ":var23"),
        (try_begin),
          (eq, ":var4", "$g_defender_team"),
          (val_add, ":var20", ":var25"),
        (else_try),
          (val_add, ":var20", ":var26"),
        (try_end),
        (try_begin),
          (528, ":var19", ":var13", 1),
          (store_add, ":var27", ":var20", ":var19"),
          (store_mul, ":var28", "$g_multiplayer_initial_gold_multiplier", 10),
          (lt, ":var27", ":var28"),
          (store_sub, ":var29", ":var28", ":var27"),
          (val_add, ":var20", ":var29"),
        (try_end),
        (408, ":var13", ":var20", 15000),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (416),
      (400, ":var2"),
      (try_for_range, ":var13", 1, ":var2"),
        (401, ":var13"),
        (508, ":var13", 32, 0),
        (508, ":var13", 33, 0),
      (try_end),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_close_gate_if_it_is_open"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_round_ended", 0),
      (assign, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1"),
      (assign, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2"),
      (start_presentation, "prsnt_multiplayer_destructible_targets_display"),
      (call_script, "script_initialize_objects"),
      (store_mission_timer_a, "$g_round_start_time"),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (400, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (401, ":var13"),
        (395, ":var13", 78, -9999),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (assign, ":var0", "$g_multiplayer_num_bots_team_1"),
      (assign, ":var1", "$g_multiplayer_num_bots_team_2"),
      (400, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (401, ":var3"),
        (402, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var0", 0),
        (eq, ":var1", 0),
        (store_mission_timer_a, ":var5"),
        (val_sub, ":var5", "$g_round_start_time"),
        (le, ":var5", 2),
        (store_mission_timer_a, "$g_round_start_time"),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (400, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (401, ":var1"),
        (neg|438, ":var1"),
        (try_begin),
          (548, ":var1", 0, 0),
          (402, ":var2", ":var1"),
          (lt, ":var2", 2),
          (404, ":var3", ":var1"),
          (ge, ":var3", 0),
          (assign, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (try_begin),
            (assign, ":var7", 0),
            (400, ":var0"),
            (try_for_range, ":var8", 0, ":var0"),
              (401, ":var8"),
              (val_add, ":var7", 1),
              (402, ":var9", ":var8"),
              (try_begin),
                (eq, ":var9", 0),
                (val_add, ":var5", 1),
              (else_try),
                (eq, ":var9", 1),
                (val_add, ":var6", 1),
              (try_end),
            (try_end),
            (store_mul, ":var10", ":var5", ":var6"),
            (store_mission_timer_a, ":var11"),
            (val_sub, ":var11", "$g_round_start_time"),
            (this_or_next|lt, ":var11", 30),
            (this_or_next|le, ":var7", 2),
            (eq, ":var10", 0),
            (eq, "$g_round_ended", 0),
            (assign, ":var4", 1),
          (try_end),
          (eq, ":var4", 1),
          (try_begin),
            (eq, ":var2", 0),
            (assign, ":var12", 0),
          (else_try),
            (eq, ":var2", 1),
            (assign, ":var12", 32),
          (try_end),
          (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
          (409, ":var1", ":var12"),
          (508, ":var1", 0, 1),
        (else_try),
          (eq, "$g_multiplayer_player_respawn_as_bot", 1),
          (406, ":var13", ":var1"),
          (ge, ":var13", 0),
          (neg|agent_is_alive, ":var13"),
          (1760, ":var14", ":var13"),
          (gt, ":var14", "$g_multiplayer_respawn_period"),
          (402, ":var2", ":var1"),
          (assign, ":var15", 0),
          (try_for_agents, ":var16"),
            (eq, ":var15", 0),
            (agent_is_alive, ":var16"),
            (agent_is_human, ":var16"),
            (1707, ":var16"),
            (agent_get_team, ":var17", ":var16"),
            (eq, ":var17", ":var2"),
            (assign, ":var15", 1),
          (try_end),
          (try_begin),
            (eq, ":var15", 1),
            (call_script, "script_find_most_suitable_bot_to_control", ":var1"),
            (421, ":var1", reg0),
            (528, ":var18", ":var1", 0),
            (val_add, ":var18", 1),
            (508, ":var1", 0, ":var18"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (417),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (455, ":var1", 0),
          (455, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (458, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_sarleon_longbowman_multiplayer_ai", "trp_sarleon_longbowman_multiplayer"),
          (store_troop_faction, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (400, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (401, ":var17"),
          (402, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (568, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (417),
      (try_for_agents, ":var0"),
        (1707, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (1765, ":var1", ":var0"),
        (try_begin),
          (neg|401, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (402, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (455, ":var7", 0),
        (455, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (400, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (401, ":var11"),
            (406, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|1707, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_round_time_counter"),
      (start_presentation, "prsnt_multiplayer_team_score_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|903, "prsnt_multiplayer_escape_menu"),
      (neg|903, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("bandit_lair", mtf_battle_mode, charge,
  "Ambushing a bandit lair",
  [
    (0, mtef_team_0|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 7, []),
    (1, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (2, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (4, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (5, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (6, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (7, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (8, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (9, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (10, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (assign, "$relative_of_merchant_is_found", 0),
      (try_begin),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (eq, ":var1", 1),
        (agent_get_position, pos4, ":var0"),
        (agent_set_scripted_destination, ":var0", pos4, 1),
      (try_end),
      (try_begin),
        (agent_get_troop_id, ":var2", ":var0"),
        (is_between, ":var2", "trp_relative_of_merchant_sarleon", "trp_relative_of_merchants_end"),
        (agent_set_team, ":var0", 7),
        (team_set_relation, 0, 7, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (party_get_template_id, ":var0", "$g_encountered_party"),
      (eq, ":var0", "pt_looter_lair"),
      (check_quest_active, "qst_save_relative_of_merchant"),
      (eq, "$relative_of_merchant_is_found", 0),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (is_between, ":var2", "trp_relative_of_merchant_sarleon", "trp_relative_of_merchants_end"),
        (agent_set_scripted_destination, ":var1", pos0),
        (agent_get_position, pos1, ":var1"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (le, ":var3", 200),
        (start_mission_conversation, ":var2"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (neg|main_hero_fallen),
      (num_active_teams_le, 1),
      (party_get_template_id, ":var0", "$g_encountered_party"),
      (eq, ":var0", "pt_treasure_lair"),
      (party_set_slot, "$g_encountered_party", 8, 2),
      (finish_mission),
    ],
    []),

    (1, 0, ti_once, 
    [],
    [
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$bandits_spawned_extra", 0),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (eq, ":var1", 1),
        (1693, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_position, pos0, ":var0"),
        (try_for_agents, ":var2"),
          (agent_is_alive, ":var2"),
          (agent_get_team, ":var3", ":var2"),
          (eq, ":var3", 0),
          (agent_is_human, ":var2"),
          (store_agent_hit_points, ":var4", ":var0"),
          (assign, ":var5", 0),
          (try_begin),
            (lt, ":var4", 100),
            (try_for_agents, ":var6"),
              (agent_is_alive, ":var6"),
              (agent_get_team, ":var7", ":var6"),
              (eq, ":var7", 1),
              (neq, ":var0", ":var6"),
              (1693, ":var6"),
              (agent_is_human, ":var6"),
              (agent_get_position, pos1, ":var0"),
              (agent_get_position, pos2, ":var6"),
              (get_distance_between_positions, ":var8", pos1, pos2),
              (le, ":var8", 1000),
              (agent_clear_scripted_mode, ":var6"),
            (try_end),
            (assign, ":var5", 1),
          (else_try),
            (agent_get_position, pos1, ":var0"),
            (agent_get_position, pos2, ":var2"),
            (get_distance_between_positions, ":var8", pos1, pos2),
            (le, ":var8", 4000),
            (try_for_agents, ":var6"),
              (agent_is_alive, ":var6"),
              (agent_get_team, ":var7", ":var6"),
              (eq, ":var7", 1),
              (neq, ":var0", ":var6"),
              (1693, ":var6"),
              (agent_is_human, ":var6"),
              (agent_get_position, pos1, ":var0"),
              (agent_get_position, pos2, ":var6"),
              (get_distance_between_positions, ":var8", pos1, pos2),
              (le, ":var8", 1000),
              (agent_clear_scripted_mode, ":var6"),
            (try_end),
            (assign, ":var5", 1),
          (try_end),
          (eq, ":var5", 1),
          (agent_clear_scripted_mode, ":var0"),
        (try_end),
      (try_end),
    ]),

    (20, 0, 0, 
    [
      (le, "$defender_reinforcement_stage", 1),
    ],
    [
      (store_character_level, ":var0", "trp_player"),
      (store_add, ":var1", 7, ":var0"),
      (val_div, ":var1", 3),
      (lt, "$bandits_spawned_extra", ":var1"),
      (val_add, "$bandits_spawned_extra", 1),
      (party_get_template_id, ":var2", "$g_encountered_party"),
      (store_random_in_range, ":var3", 0, 2),
      (try_begin),
        (eq, ":var2", "pt_sea_raider_lair"),
        (assign, ":var4", "trp_vanskerry_lair_leader"),
      (else_try),
        (eq, ":var2", "pt_forest_bandit_lair"),
        (assign, ":var4", "trp_heretic_lair_leader"),
      (else_try),
        (eq, ":var2", "pt_mountain_bandit_lair"),
        (assign, ":var4", "trp_myst_lair_leader"),
      (else_try),
        (eq, ":var2", "pt_snake_bandit_lair"),
        (assign, ":var4", "trp_snake_lair_leader"),
      (else_try),
        (eq, ":var2", "pt_steppe_bandit_lair"),
        (assign, ":var4", "trp_singal_lair_leader"),
      (else_try),
        (eq, ":var2", "pt_treasure_lair"),
        (assign, ":var4", "trp_singal_lair_leader"),
      (try_end),
      (store_current_scene, ":var5"),
      (modify_visitors_at_site, ":var5"),
      (try_begin),
        (eq, ":var2", "pt_looter_lair"),
        (neq, ":var3", 0),
        (check_quest_active, "qst_save_relative_of_merchant"),
        (store_faction_of_party, ":var6", "$g_starting_town"),
        (store_sub, ":var7", ":var6", "fac_kingdom_1"),
        (store_add, ":var4", "trp_heretic_lair_leader", ":var7"),
        (add_visitors_to_current_scene, 2, ":var4", 1),
      (else_try),
        (neq, ":var3", 0),
        (add_visitors_to_current_scene, 2, ":var4", 1),
      (try_end),
      (store_random_in_range, ":var8", 3, 11),
      (call_script, "script_select_lair_warrior", ":var2"),
      (add_visitors_to_current_scene, ":var8", reg33, 1),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (2073, ":var1"),
      (try_begin),
        (ge, ":var0", 0),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var2", ":var0"),
        (str_store_troop_name, s6, ":var2"),
        (try_begin),
          (neg|agent_is_ally, ":var0"),
          (party_add_members, "p_total_enemy_casualties", ":var2", 1),
          (try_begin),
            (eq, ":var1", 1),
            (party_wound_members, "p_total_enemy_casualties", ":var2", 1),
          (try_end),
        (try_end),
        (party_add_members, "p_temp_casualties", ":var2", 1),
        (eq, ":var1", 1),
        (party_wound_members, "p_temp_casualties", ":var2", 1),
      (try_end),
      (assign, ":var3", 0),
      (try_for_agents, ":var4"),
        (1707, ":var4"),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (neg|agent_is_ally, ":var4"),
        (val_add, ":var3", 1),
      (try_end),
      (try_begin),
        (le, ":var3", 2),
        (le, "$defender_reinforcement_stage", 1),
        (val_add, "$defender_reinforcement_stage", 1),
        (store_character_level, ":var5", "trp_player"),
        (store_add, ":var6", 10, ":var5"),
        (val_div, ":var6", 3),
        (try_begin),
          (ge, "$defender_reinforcement_stage", 2),
          (val_sub, ":var6", "$bandits_spawned_extra"),
        (try_end),
        (party_get_template_id, ":var7", "$g_encountered_party"),
        (store_random_in_range, ":var8", 0, 2),
        (try_begin),
          (eq, ":var7", "pt_sea_raider_lair"),
          (assign, ":var9", "trp_vanskerry_lair_leader"),
        (else_try),
          (eq, ":var7", "pt_forest_bandit_lair"),
          (assign, ":var9", "trp_heretic_lair_leader"),
        (else_try),
          (eq, ":var7", "pt_mountain_bandit_lair"),
          (assign, ":var9", "trp_myst_lair_leader"),
        (else_try),
          (eq, ":var7", "pt_snake_bandit_lair"),
          (assign, ":var9", "trp_snake_lair_leader"),
        (else_try),
          (eq, ":var7", "pt_steppe_bandit_lair"),
          (assign, ":var9", "trp_singal_lair_leader"),
        (else_try),
          (eq, ":var7", "pt_treasure_lair"),
          (assign, ":var9", "trp_singal_lair_leader"),
        (try_end),
        (store_current_scene, ":var10"),
        (modify_visitors_at_site, ":var10"),
        (try_for_range, ":var11", 0, ":var6"),
          (store_random_in_range, ":var12", 2, 11),
          (call_script, "script_select_lair_warrior", ":var7"),
          (add_visitors_to_current_scene, ":var12", reg33, 1),
          (neq, ":var7", "pt_looter_lair"),
          (neq, ":var8", 0),
          (eq, ":var11", 0),
          (val_add, ":var12", 1),
          (try_begin),
            (eq, ":var12", 11),
            (assign, ":var12", 2),
          (try_end),
          (add_visitors_to_current_scene, ":var12", ":var9", 1),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 4096),
      (set_party_battle_mode),
    ]),

    (2, 0, ti_once, 
    [
      (neg|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (party_get_template_id, ":var0", "$g_encountered_party"),
      (try_begin),
        (eq, ":var0", "pt_looter_lair"),
        (check_quest_active, "qst_save_relative_of_merchant"),
        (store_faction_of_party, ":var1", "$g_starting_town"),
        (try_begin),
          (eq, ":var1", "fac_kingdom_1"),
          (assign, ":var2", "trp_relative_of_merchant_sarleon"),
        (else_try),
          (eq, ":var1", "fac_kingdom_2"),
          (assign, ":var2", "trp_relative_of_merchant_ravenstern"),
        (else_try),
          (eq, ":var1", "fac_kingdom_3"),
          (assign, ":var2", "trp_relative_of_merchant_dshar"),
        (else_try),
          (eq, ":var1", "fac_kingdom_4"),
          (assign, ":var2", "trp_relative_of_merchant_fierdsvain"),
        (else_try),
          (eq, ":var1", "fac_kingdom_5"),
          (assign, ":var2", "trp_relative_of_merchant_empire"),
        (try_end),
        (get_player_agent_no, ":var3"),
        (agent_get_position, pos0, ":var3"),
        (assign, ":var4", 100000),
        (try_for_range, ":var5", 1, 10),
          (entry_point_get_position, pos1, ":var5"),
          (get_distance_between_positions, ":var6", pos0, pos1),
          (le, ":var6", ":var4"),
          (ge, ":var6", 1000),
          (assign, ":var7", ":var5"),
          (assign, ":var4", ":var6"),
        (try_end),
        (add_visitors_to_current_scene, ":var7", ":var2", 1, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (try_begin),
        (this_or_next|key_is_down, key_left_control),
        (key_is_down, key_right_control),
        (try_begin),
          (key_clicked, key_h),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (else_try),
          (this_or_next|key_is_down, key_left_alt),
          (key_is_down, key_right_alt),
          (key_clicked, key_f4),
          (val_or, "$g_achieve_bits_delay_popup", 16777216),
        (try_end),
      (try_end),
      (game_key_clicked, 22),
      (neg|903, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (903, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (1, 0, ti_once, 
    [
      (neg|903, "prsnt_killcount"),
      (neg|903, "prsnt_troop_ratio_bar"),
      (neg|903, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 0),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_option_show_killcount", 0),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_option_show_killcount", 1),
        (eq, "$g_option_show_ratio_bar", 1),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$g_option_ratio_bar_is_global", 1),
      (this_or_next|eq, "$g_option_message_on_player_kill", 1),
      (eq, "$g_option_message_on_soldier_death", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (2073, ":var2"),
      (agent_is_human, ":var0"),
      (try_begin),
        (ge, ":var0", 0),
        (try_begin),
          (neg|agent_is_ally, ":var0"),
          (val_sub, "$enemy_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (agent_get_party_id, ":var3", ":var0"),
          (eq, ":var3", "p_main_party"),
          (val_sub, "$player_count_alive", 1),
        (else_try),
          (agent_is_ally, ":var0"),
          (neq, ":var3", "p_main_party"),
          (val_sub, "$ally_count_alive", 1),
        (try_end),
        (assign, reg1, "$enemy_count_alive"),
        (assign, reg2, "$player_count_alive"),
        (assign, reg3, "$ally_count_alive"),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_soldier_death", 1),
        (agent_is_ally, ":var0"),
        (agent_get_party_id, ":var3", ":var0"),
        (eq, ":var3", "p_main_party"),
        (neq, ":var2", 1),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (display_message, "@{s13} has died", 0xEC251A),
      (try_end),
      (try_begin),
        (eq, "$g_option_message_on_player_kill", 1),
        (agent_get_troop_id, ":var5", ":var1"),
        (eq, ":var5", "trp_player"),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s13, ":var4"),
        (try_begin),
          (neq, ":var2", 1),
          (display_message, "@You have killed {s13}", 0x33D0BC),
        (else_try),
          (display_message, "@You have knocked out {s13}", 0x33D0BC),
        (try_end),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (assign, ":var0", 0),
      (party_get_template_id, ":var1", "$g_encountered_party"),
      (try_begin),
        (eq, ":var1", "pt_looter_lair"),
        (check_quest_active, "qst_save_relative_of_merchant"),
        (this_or_next|main_hero_fallen),
        (eq, "$relative_of_merchant_is_found", 1),
        (assign, ":var0", 1),
      (else_try),
        (this_or_next|neq, ":var1", "pt_looter_lair"),
        (neg|check_quest_active, "qst_save_relative_of_merchant"),
        (store_mission_timer_a, ":var2"),
        (ge, ":var2", 5),
        (this_or_next|main_hero_fallen),
        (num_active_teams_le, 1),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
      (else_try),
        (party_set_slot, "$g_encountered_party", 8, 2),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (party_get_template_id, ":var0", "$g_encountered_party"),
        (eq, ":var0", "pt_treasure_lair"),
        (display_message, "@The thieves guarding the treasure were beaten - find the treasure chest"),
      (else_try),
        (finish_mission),
      (try_end),
    ]),

  ]),

  ("alley_fight", mtf_battle_mode, charge,
  "Alley fight",
  [
    (0, mtef_team_0|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 7, []),
    (1, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (2, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (get_player_agent_no, ":var1"),
      (neq, ":var0", ":var1"),
      (assign, "$g_main_attacker_agent", ":var0"),
      (1753, ":var0", 199),
      (try_begin),
        (agent_get_troop_id, ":var2", ":var0"),
        (is_between, ":var2", "trp_sarleon_merchant", "trp_startup_merchants_end"),
        (agent_set_team, ":var0", 7),
        (team_set_relation, 0, 7, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$talked_with_merchant", 0),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (is_between, ":var2", "trp_sarleon_merchant", "trp_startup_merchants_end"),
        (agent_set_scripted_destination, ":var1", pos0),
        (agent_get_position, pos1, ":var1"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (le, ":var3", 200),
        (assign, "$talk_context", 11),
        (start_mission_conversation, ":var2"),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (ge, "$g_main_attacker_agent", 0),
      (ge, ":var0", 0),
      (1712, "$g_main_attacker_agent"),
      (1712, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (agent_get_position, pos1, "$g_main_attacker_agent"),
      (get_distance_between_positions, ":var1", pos0, pos1),
      (ge, ":var1", 5),
      (agent_set_scripted_destination, "$g_main_attacker_agent", pos0),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (display_message, "str_cannot_leave_now"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 4096),
      (set_party_battle_mode),
    ]),

    (0, 0, ti_once, 
    [
      (neg|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (store_faction_of_party, ":var0", "$g_starting_town"),
      (try_begin),
        (eq, ":var0", "fac_kingdom_1"),
        (assign, ":var1", "trp_sarleon_merchant"),
      (else_try),
        (eq, ":var0", "fac_kingdom_2"),
        (assign, ":var1", "trp_ravenstern_merchant"),
      (else_try),
        (eq, ":var0", "fac_kingdom_3"),
        (assign, ":var1", "trp_dshar_merchant"),
      (else_try),
        (eq, ":var0", "fac_kingdom_4"),
        (assign, ":var1", "trp_fierdsvain_merchant"),
      (else_try),
        (eq, ":var0", "fac_kingdom_5"),
        (assign, ":var1", "trp_empire_merchant"),
      (try_end),
      (add_visitors_to_current_scene, 3, ":var1", 1, 0),
    ]),

    (1, 0, ti_once, 
    [
      (eq, "$talked_with_merchant", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (assign, "$g_killed_first_bandit", 0),
      (else_try),
        (assign, "$g_killed_first_bandit", 1),
      (try_end),
      (finish_mission),
      (assign, "$g_main_attacker_agent", 0),
      (assign, "$talked_with_merchant", 1),
      (assign, "$current_startup_quest_phase", 1),
      (change_screen_return),
      (set_trigger_result, 1),
      (get_player_agent_no, ":var0"),
      (store_agent_hit_points, ":var1", ":var0"),
      (try_begin),
        (lt, ":var1", 90),
        (agent_set_hit_points, ":var0", 90),
      (try_end),
    ]),

    (1, 3, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (assign, "$g_killed_first_bandit", 0),
      (else_try),
        (assign, "$g_killed_first_bandit", 1),
      (try_end),
      (finish_mission),
      (assign, "$g_main_attacker_agent", 0),
      (assign, "$talked_with_merchant", 1),
      (assign, "$current_startup_quest_phase", 1),
      (change_screen_return),
      (set_trigger_result, 1),
      (get_player_agent_no, ":var0"),
      (store_agent_hit_points, ":var1", ":var0"),
      (try_begin),
        (lt, ":var1", 90),
        (agent_set_hit_points, ":var0", 90),
      (try_end),
    ]),

  ]),

  ("meeting_merchant", 0, -1,
  "Meeting with the merchant",
  [
    (0, mtef_team_0, af_override_horse, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (ti_before_mission_start, 0, 0, 
    [
      (eq, "$fadefromblack", 1),
    ],
    [
      (start_presentation, "prsnt_fade_from_black", 0),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (agent_get_troop_id, ":var1", ":var0"),
        (is_between, ":var1", "trp_sarleon_merchant", "trp_startup_merchants_end"),
        (agent_set_team, ":var0", 7),
        (team_set_relation, 0, 7, 0),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (assign, "$dialog_with_merchant_ended", 0),
      (store_current_scene, ":var0"),
      (scene_set_slot, ":var0", 0, 1),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", 16384),
      (else_try),
        (eq, "$talk_context", 14),
        (call_script, "script_music_set_situation_with_culture", 512),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 8192),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (assign, ":var0", 0),
      (try_begin),
        (ge, "$dialog_with_merchant_ended", 6),
        (assign, ":var0", 1),
      (else_try),
        (ge, "$dialog_with_merchant_ended", 1),
        (neg|conversation_screen_is_active),
        (try_begin),
          (eq, "$dialog_with_merchant_ended", 1),
          (check_quest_active, "qst_collect_men"),
          (dialog_box, "str_start_up_first_quest", "@Tutorial"),
        (try_end),
        (val_add, "$dialog_with_merchant_ended", 1),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (conversation_screen_is_active),
        (tutorial_message, -1),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
    ],
    [
      (1124, 17, 17),
      (1123, 500, 650),
      (1125, 0),
      (1126, 1),
      (tutorial_message, "str_press_tab_to_exit_from_town"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    []),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (gt, "$dialog_with_merchant_ended", 0),
        (assign, ":var0", 0),
        (party_get_position, pos1, "$current_town"),
        (try_for_range, ":var1", 0, 10),
          (map_get_random_position_around_position, pos0, pos1, 2),
          (get_distance_between_positions, ":var2", pos0, pos1),
          (ge, ":var2", ":var0"),
          (assign, ":var0", ":var2"),
          (copy_position, pos2, pos0),
        (try_end),
        (party_set_position, "p_main_party", pos2),
        (finish_mission),
        (assign, "$current_startup_quest_phase", 2),
        (tutorial_message, -1),
        (1126, 0),
        (change_screen_map),
        (try_begin),
          (check_quest_finished, "qst_save_town_from_bandits"),
          (assign, "$g_do_one_more_meeting_with_merchant", 1),
        (else_try),
          (set_spawn_radius, 30),
          (try_for_range, ":var1", 0, 20),
            (spawn_around_party, "p_main_party", "pt_looters"),
          (try_end),
        (try_end),
        (set_trigger_result, 1),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ],
    []),

  ]),

  ("town_fight", 0, -1,
  "Town Fight",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (14, mtef_visitor_source, af_override_horse, 0, 1, []),
    (15, mtef_visitor_source, af_override_horse, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_team, ":var0", 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (mission_disable_talk),
      (assign, "$g_main_attacker_agent", 0),
      (set_party_battle_mode),
      (assign, "$number_of_bandits_killed_by_player", 0),
      (assign, "$number_of_civilian_loses", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (1, 0, ti_once, 
    [
      (call_script, "script_init_town_walker_agents"),
    ],
    []),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (try_begin),
        (agent_get_team, ":var2", ":var0"),
        (eq, ":var2", 1),
        (get_player_agent_no, ":var3"),
        (eq, ":var3", ":var1"),
        (val_add, "$number_of_bandits_killed_by_player", 1),
      (else_try),
        (eq, ":var2", 0),
        (val_add, "$number_of_civilian_loses", 1),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (lt, "$merchant_sign_count", 8),
      (val_add, "$merchant_sign_count", 1),
      (try_begin),
        (eq, "$merchant_sign_count", 2),
        (get_player_agent_no, ":var0"),
        (try_for_agents, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (ge, ":var2", "trp_sarleon_merchant"),
          (lt, ":var2", "trp_startup_merchants_end"),
          (assign, "$g_city_merchant_troop_id", ":var2"),
          (assign, "$g_city_merchant_agent_id", ":var1"),
          (agent_get_position, pos0, ":var0"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var3", -1000),
          (try_for_range, ":var4", 0, 64),
            (entry_point_get_position, pos6, ":var4"),
            (get_distance_between_positions, ":var5", pos0, pos6),
            (get_distance_between_positions, ":var6", pos1, pos6),
            (store_sub, ":var7", ":var6", ":var5"),
            (ge, ":var6", 15),
            (ge, ":var7", ":var3"),
            (copy_position, pos2, pos6),
            (assign, ":var3", ":var7"),
          (try_end),
          (agent_set_scripted_destination, ":var1", pos2, 0),
          (agent_set_speed_limit, ":var1", 10),
        (try_end),
      (else_try),
        (eq, "$merchant_sign_count", 5),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos0, ":var0"),
        (agent_set_scripted_destination, "$g_city_merchant_agent_id", pos0, 0),
        (agent_set_speed_limit, "$g_city_merchant_agent_id", 10),
      (else_try),
        (eq, "$merchant_sign_count", 7),
        (agent_clear_scripted_mode, "$g_city_merchant_agent_id"),
        (assign, "$talk_context", 0),
        (start_mission_conversation, "$g_city_merchant_troop_id"),
      (try_end),
    ],
    []),

    (1, 0, 0, 
    [],
    [
      (ge, "$merchant_sign_count", 8),
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (eq, ":var2", 0),
        (agent_get_position, pos0, ":var1"),
        (assign, ":var3", 10000),
        (try_for_agents, ":var4"),
          (agent_is_alive, ":var4"),
          (agent_get_team, ":var5", ":var4"),
          (eq, ":var5", 1),
          (agent_get_position, pos1, ":var4"),
          (get_distance_between_positions, ":var6", pos0, pos1),
          (le, ":var6", ":var3"),
          (assign, ":var3", ":var6"),
          (copy_position, pos2, pos1),
        (try_end),
        (assign, reg1, ":var6"),
        (try_begin),
          (le, ":var3", 500),
          (agent_clear_scripted_mode, ":var1"),
        (else_try),
          (lt, ":var3", 10000),
          (agent_set_scripted_destination, ":var1", pos2, 0),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (lt, "$merchant_sign_count", 8),
      (call_script, "script_tick_town_walkers"),
    ],
    []),

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
      (ge, "$merchant_sign_count", 8),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (assign, "$g_killed_first_bandit", 0),
      (else_try),
        (assign, "$g_killed_first_bandit", 1),
      (try_end),
      (assign, "$current_startup_quest_phase", 4),
      (mission_enable_talk),
      (finish_mission),
      (372, 6),
      (change_screen_return),
      (set_trigger_result, 1),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (try_begin),
        (eq, "$g_mt_mode", 0),
        (set_trigger_result, 1),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (display_message, "str_cant_use_inventory_disguised"),
      (else_try),
        (display_message, "str_cant_use_inventory_now"),
      (try_end),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

  ]),

  ("multiplayer_duel", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    []),

    (2, 0, 2, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (neg|agent_slot_eq, ":var0", 15, 1),
        (agent_get_team, ":var1", ":var0"),
        (gt, ":var1", -1),
        (1773, ":var2", ":var0"),
        (gt, ":var2", -1),
        (team_get_weapon_usage_order, ":var3", ":var1", ":var2"),
        (neq, ":var3", 1),
        (agent_get_horse, ":var4", ":var0"),
        (try_begin),
          (ge, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (assign, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 4),
              (assign, ":var5", 1),
              (assign, ":var7", ":var12"),
            (else_try),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var5", 1),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (agent_get_team, ":var1", ":var0"),
          (agent_get_position, pos10, ":var0"),
          (assign, ":var18", 3000),
          (try_for_agents, ":var19"),
            (agent_is_alive, ":var19"),
            (agent_is_human, ":var19"),
            (agent_get_team, ":var20", ":var19"),
            (teams_are_enemies, ":var20", ":var1"),
            (agent_get_position, pos15, ":var19"),
            (get_distance_between_positions, ":var21", pos15, pos10),
            (lt, ":var21", ":var18"),
            (assign, ":var18", ":var21"),
          (try_end),
          (set_fixed_point_multiplier, 100),
          (1689, 11, ":var0"),
          (position_get_y, ":var22", pos11),
          (convert_from_fixed_point, ":var22"),
          (agent_get_wielded_item, ":var23", ":var0"),
          (gt, ":var23", 0),
          (item_get_type, ":var24", ":var23"),
          (try_begin),
            (lt, ":var18", 400),
            (le, ":var22", 4),
            (eq, ":var24", 4),
            (1747, ":var0", ":var10"),
          (else_try),
            (this_or_next|gt, ":var22", 6),
            (gt, ":var18", 600),
            (this_or_next|eq, ":var24", 2),
            (eq, ":var24", 3),
            (1747, ":var0", ":var7"),
          (try_end),
        (else_try),
          (agent_get_wielded_item, ":var23", ":var0", 0),
          (gt, ":var23", 0),
          (this_or_next|is_between, ":var23", "itm_practice_lance_red", "itm_sumpter_horse"),
          (this_or_next|is_between, ":var23", "itm_jousting_lance", "itm_long_bardiche"),
          (eq, ":var23", "itm_black_iron_spear"),
          (assign, ":var6", 0),
          (assign, ":var8", 0),
          (assign, ":var9", 0),
          (assign, ":var10", 0),
          (try_for_range, ":var11", 0, 4),
            (1804, ":var12", ":var0", ":var11"),
            (gt, ":var12", 0),
            (neq, ":var12", ":var23"),
            (item_get_type, ":var13", ":var12"),
            (try_begin),
              (eq, ":var13", 2),
              (assign, ":var6", 1),
              (assign, ":var8", ":var12"),
            (else_try),
              (eq, ":var13", 3),
              (assign, ":var6", 1),
              (assign, ":var9", ":var12"),
            (try_end),
          (try_end),
          (eq, ":var6", 1),
          (try_begin),
            (gt, ":var8", 0),
            (eq, ":var9", 0),
            (assign, ":var10", ":var8"),
          (else_try),
            (eq, ":var8", 0),
            (gt, ":var9", 0),
            (assign, ":var10", ":var9"),
          (else_try),
            (gt, ":var8", 0),
            (gt, ":var9", 0),
            (agent_get_troop_id, ":var14", ":var0"),
            (store_proficiency_level, ":var15", ":var14", wpt_one_handed_weapon),
            (store_proficiency_level, ":var16", ":var14", wpt_two_handed_weapon),
            (store_sub, ":var17", ":var16", ":var15"),
            (try_begin),
              (gt, ":var17", 30),
              (assign, ":var10", ":var9"),
            (else_try),
              (assign, ":var10", ":var8"),
            (try_end),
          (try_end),
          (1747, ":var0", ":var10"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (1, 5, 0, 
    [
      (417),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 7),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (team_set_relation, 0, 0, 1),
      (team_set_relation, 0, 1, 1),
      (team_set_relation, 1, 1, 1),
      (2006, 1),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (426, 0, -1),
      (426, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart_deathmatch"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (get_player_agent_no, ":var2"),
        (1712, ":var2"),
        (agent_slot_ge, ":var2", 21, 0),
        (try_begin),
          (eq, ":var0", ":var2"),
          (display_message, "str_you_have_lost_a_duel"),
        (else_try),
          (agent_slot_eq, ":var2", 21, ":var0"),
          (display_message, "str_you_have_won_a_duel"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_ge, ":var0", 21, 0),
        (agent_get_slot, ":var3", ":var0", 21),
        (agent_set_slot, ":var0", 21, -1),
        (try_begin),
          (1712, ":var3"),
          (agent_set_slot, ":var3", 21, -1),
          (1802, ":var3"),
          (try_begin),
            (1724, ":var4", ":var3"),
            (neg|401, ":var4"),
            (1732, ":var3"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (400, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (401, ":var1"),
        (neg|438, ":var1"),
        (402, ":var2", ":var1"),
        (lt, ":var2", 2),
        (404, ":var3", ":var1"),
        (ge, ":var3", 0),
        (406, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (528, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (508, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (1760, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var9"),
        (409, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (1707, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (1760, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (417),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (store_random_in_range, ":var1", 0, ":var0"),
        (val_sub, ":var1", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var2", 0),
          (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
        (else_try),
          (assign, ":var2", 1),
          (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
        (try_end),
        (458, ":var3", ":var2"),
        (assign, ":var4", 0),
        (try_for_range, ":var5", "trp_sarleon_longbowman_multiplayer_ai", "trp_sarleon_longbowman_multiplayer"),
          (store_troop_faction, ":var6", ":var5"),
          (eq, ":var6", ":var3"),
          (val_add, ":var4", 1),
        (try_end),
        (store_random_in_range, ":var7", 0, ":var4"),
        (assign, ":var8", "trp_sarleon_longbowman_multiplayer"),
        (try_for_range, ":var5", "trp_sarleon_longbowman_multiplayer_ai", ":var8"),
          (store_troop_faction, ":var6", ":var5"),
          (eq, ":var6", ":var3"),
          (val_sub, ":var7", 1),
          (lt, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", ":var5"),
        (try_end),
        (troop_get_inventory_slot, ":var10", ":var9", ek_horse),
        (try_begin),
          (ge, ":var10", 0),
          (assign, ":var11", 1),
        (else_try),
          (assign, ":var11", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var11"),
        (store_current_scene, ":var12"),
        (modify_visitors_at_site, ":var12"),
        (add_visitors_to_current_scene, reg0, ":var9", 1, ":var2", -1),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (417),
      (assign, ":var0", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (store_mul, ":var2", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var1", ":var2"),
        (assign, ":var0", 1),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (470, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart_deathmatch"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|903, "prsnt_multiplayer_escape_menu"),
      (neg|903, "prsnt_multiplayer_stats_chart_deathmatch"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

    (1, 0, 0, 
    [],
    [
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", 3),
      (try_for_agents, ":var2"),
        (agent_slot_ge, ":var2", 21, 0),
        (agent_get_slot, ":var3", ":var2", 22),
        (ge, ":var3", 0),
        (le, ":var3", ":var1"),
        (agent_set_slot, ":var2", 22, -1),
        (agent_get_slot, ":var4", ":var2", 21),
        (1712, ":var4"),
        (1803, ":var2", ":var4", -1),
        (1732, ":var2"),
      (try_end),
    ]),

  ]),

  ("visit_old_ruins_1", 0, -1,
  "Walk around camp.",
  [
    (0, mtef_scene_source, 0, 0, 1, []),
    (1, mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (12, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (13, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (14, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (15, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (16, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (17, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$temp", 4),
      (call_script, "script_change_banners_and_chest"),
      (mission_enable_talk),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (this_or_next|is_between, ":var1", "trp_fierd_recruit", "trp_fierd_warrior"),
      (this_or_next|is_between, ":var1", "trp_fierd_noblewoman", "trp_fierd_deserter"),
      (eq, ":var1", "trp_falcon_knight"),
      (troop_slot_eq, ":var1", 404, 0),
      (store_random_in_range, ":var2", 0, 100),
      (try_begin),
        (le, ":var2", 64),
        (troop_set_type, ":var1", 0),
      (else_try),
        (troop_set_type, ":var1", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (try_begin),
        (eq, ":var1", "trp_player_knight"),
        (troop_get_inventory_capacity, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (troop_get_inventory_slot, ":var4", "trp_player_knight", ":var3"),
          (gt, ":var4", 0),
          (item_get_type, ":var5", ":var4"),
          (try_begin),
            (this_or_next|is_between, ":var5", 2, 11),
            (is_between, ":var5", 16, 19),
            (agent_has_item_equipped, ":var0", ":var4"),
            (1774, ":var0", ":var4"),
          (try_end),
        (try_end),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var7", "trp_player_knight_save", ":var6"),
          (try_begin),
            (gt, ":var7", 0),
            (store_add, ":var8", ":var6", 1),
            (1779, ":var0", ":var7", ":var8"),
          (try_end),
        (try_end),
      (else_try),
        (eq, ":var1", "trp_player_sergeant"),
        (troop_get_inventory_capacity, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (troop_get_inventory_slot, ":var4", "trp_player_sergeant", ":var3"),
          (gt, ":var4", 0),
          (item_get_type, ":var5", ":var4"),
          (try_begin),
            (this_or_next|is_between, ":var5", 2, 11),
            (is_between, ":var5", 16, 19),
            (agent_has_item_equipped, ":var0", ":var4"),
            (1774, ":var0", ":var4"),
          (try_end),
        (try_end),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var7", "trp_player_sergeant_save", ":var6"),
          (try_begin),
            (gt, ":var7", 0),
            (store_add, ":var8", ":var6", 1),
            (1779, ":var0", ":var7", ":var8"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (try_begin),
        (this_or_next|quest_slot_eq, "qst_horse_armor", 11, 1),
        (this_or_next|quest_slot_eq, "qst_horse_armor", 11, 2),
        (this_or_next|quest_slot_eq, "qst_horse_armor", 11, 3),
        (troop_slot_eq, "trp_old_ruin_camp_blacksmith", 80, 2),
        (entry_point_get_position, pos1, 23),
        (copy_position, pos2, pos1),
        (set_spawn_position, pos2),
        (spawn_item, "itm_horse_armor", imod_plain, 0),
      (try_end),
      (try_begin),
        (party_slot_eq, "p_old_ruins", 10, "scn_abhuva_pendor_castle_2_base"),
        (party_get_num_companions, ":var0", "p_old_ruins"),
        (try_begin),
          (gt, ":var0", 10),
          (store_div, ":var1", ":var0", 3),
          (val_min, ":var1", 33),
          (try_begin),
            (store_time_of_day, ":var2"),
            (neg|is_between, ":var2", 6, 21),
            (val_div, ":var1", 5),
            (val_max, ":var1", 1),
          (try_end),
        (else_try),
          (assign, ":var1", 2),
        (try_end),
        (assign, ":var3", 2),
        (assign, ":var4", 0),
      (else_try),
        (this_or_next|quest_slot_eq, "qst_old_tale_part_2", 11, 4),
        (quest_slot_eq, "qst_old_tale_part_2", 11, 5),
        (assign, ":var1", 3),
        (assign, ":var3", 1),
        (assign, ":var4", 3),
      (else_try),
        (assign, ":var3", 0),
      (try_end),
      (gt, ":var3", 0),
      (entry_point_get_position, pos1, 20),
      (entry_point_get_position, pos2, 21),
      (init_position, pos3),
      (position_copy_rotation, pos3, pos1),
      (position_get_x, ":var5", pos1),
      (position_get_x, ":var6", pos2),
      (position_get_y, ":var7", pos1),
      (position_get_y, ":var8", pos2),
      (store_sub, ":var9", ":var6", ":var5"),
      (store_div, ":var10", ":var9", ":var1"),
      (store_sub, ":var11", ":var8", ":var7"),
      (store_div, ":var12", ":var11", ":var1"),
      (assign, ":var13", ":var5"),
      (assign, ":var14", ":var7"),
      (try_for_range, ":var15", 0, ":var1"),
        (val_add, ":var13", ":var10"),
        (val_add, ":var14", ":var12"),
        (position_set_x, pos3, ":var13"),
        (position_set_y, pos3, ":var14"),
        (position_set_z_to_ground_level, pos3),
        (set_spawn_position, pos3),
        (store_random_in_range, ":var16", 0, 300),
        (try_begin),
          (eq, ":var3", 2),
          (try_begin),
            (lt, ":var16", 50),
            (assign, ":var17", "itm_sumpter_horse"),
          (else_try),
            (lt, ":var16", 100),
            (assign, ":var17", "itm_saddle_horse"),
          (else_try),
            (lt, ":var16", 150),
            (assign, ":var17", "itm_courser"),
          (else_try),
            (lt, ":var16", 200),
            (assign, ":var17", "itm_grey_steppe"),
          (else_try),
            (lt, ":var16", 250),
            (assign, ":var17", "itm_hunter"),
          (else_try),
            (assign, ":var17", "itm_sarleon_hunter"),
          (try_end),
        (else_try),
          (assign, ":var17", "itm_sumpter_horse"),
        (try_end),
        (spawn_horse, ":var17"),
      (try_end),
      (entry_point_get_position, pos1, 8),
      (init_position, pos2),
      (position_copy_rotation, pos2, pos1),
      (position_get_x, ":var5", pos1),
      (val_sub, ":var5", 150),
      (position_get_y, ":var7", pos1),
      (val_sub, ":var7", 200),
      (try_for_range, ":var15", 0, ":var4"),
        (position_set_x, pos2, ":var5"),
        (position_set_y, pos2, ":var7"),
        (position_set_z_to_ground_level, pos2),
        (set_spawn_position, pos2),
        (1974, "spr_box_a"),
        (store_random_in_range, ":var18", 0, 50),
        (val_add, ":var18", 100),
        (val_add, ":var5", ":var18"),
        (store_random_in_range, ":var19", -100, 100),
        (val_add, ":var7", ":var19"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (set_fixed_point_multiplier, 100),
      (try_begin),
        (is_between, ":var1", "trp_old_ruin_camp_master", "trp_order_constable"),
        (agent_set_stand_animation, ":var0", "anim_stand_townguard"),
        (agent_set_animation, ":var0", "anim_stand_townguard"),
        (store_random_in_range, ":var2", 0, 100),
        (agent_set_animation_progress, ":var0", ":var2"),
      (else_try),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (agent_get_position, pos1, ":var0"),
        (assign, ":var3", 0),
        (try_for_range, ":var4", 18, 20),
          (entry_point_get_position, pos2, ":var4"),
          (get_distance_between_positions, ":var5", pos1, pos2),
          (lt, ":var5", 200),
          (assign, ":var3", 1),
        (try_end),
        (eq, ":var3", 1),
        (agent_clear_scripted_mode, ":var0"),
        (2077, ":var0", 0),
        (agent_set_stand_animation, ":var0", "anim_stand_townguard"),
        (agent_set_animation, ":var0", "anim_stand_townguard"),
        (store_random_in_range, ":var2", 0, 100),
        (agent_set_animation_progress, ":var0", ":var2"),
        (assign, "$temp", 4),
      (else_try),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (agent_get_position, pos1, ":var0"),
        (try_for_range, ":var4", 8, 18),
          (entry_point_get_position, pos2, ":var4"),
          (get_distance_between_positions, ":var5", pos1, pos2),
          (lt, ":var5", 200),
          (agent_set_slot, ":var0", 0, ":var4"),
        (try_end),
        (call_script, "script_set_old_ruins_walker_destination", ":var0"),
      (else_try),
        (neg|agent_is_human, ":var0"),
        (agent_get_position, pos1, ":var0"),
        (try_for_range, ":var4", 20, 23),
          (entry_point_get_position, pos2, ":var4"),
          (get_distance_between_positions, ":var5", pos1, pos2),
          (lt, ":var5", 200),
          (agent_set_slot, ":var0", 0, ":var4"),
        (try_end),
        (call_script, "script_set_old_ruins_walker_destination", ":var0"),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (store_current_scene, ":var0"),
      (scene_set_slot, ":var0", 0, 1),
      (call_script, "script_music_set_situation_with_culture", 65536),
    ]),

    (3, 0, 0, 
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (agent_get_slot, ":var1", ":var0", 0),
        (neg|is_between, ":var1", 18, 20),
        (agent_get_troop_id, ":var2", ":var0"),
        (this_or_next|is_between, ":var2", "trp_npc_adonja", "trp_kingdom_1_lord"),
        (is_between, ":var2", "trp_novice_fighter", "trp_ramun_the_slave_trader"),
        (entry_point_get_position, pos1, ":var1"),
        (try_begin),
          (is_between, ":var1", 8, 18),
          (init_position, pos2),
          (store_random_in_range, ":var3", -250, 250),
          (position_set_x, pos2, ":var3"),
          (store_random_in_range, ":var4", -250, 250),
          (position_set_y, pos2, ":var4"),
          (position_transform_position_to_local, pos1, pos1, pos2),
        (try_end),
        (agent_get_position, pos2, ":var0"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", 400),
        (assign, ":var6", 0),
        (try_begin),
          (is_between, ":var1", 8, 18),
          (store_random_in_range, ":var6", 0, 100),
        (try_end),
        (lt, ":var6", 20),
        (call_script, "script_set_old_ruins_walker_destination", ":var0"),
      (try_end),
    ],
    []),

    (10, 0, 0, 
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (neg|agent_is_human, ":var0"),
        (agent_get_slot, ":var1", ":var0", 0),
        (entry_point_get_position, pos1, ":var1"),
        (try_begin),
          (is_between, ":var1", 20, 23),
          (init_position, pos2),
          (store_random_in_range, ":var2", -400, 400),
          (position_set_x, pos2, ":var2"),
          (store_random_in_range, ":var3", -400, 400),
          (position_set_y, pos2, ":var3"),
          (position_transform_position_to_local, pos1, pos1, pos2),
        (try_end),
        (agent_get_position, pos2, ":var0"),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (lt, ":var4", 600),
        (assign, ":var5", 0),
        (try_begin),
          (is_between, ":var1", 20, 23),
          (store_random_in_range, ":var5", 0, 100),
        (try_end),
        (lt, ":var5", 80),
        (call_script, "script_set_old_ruins_walker_destination", ":var0"),
      (try_end),
    ],
    []),

    (30, 0, 0, 
    [
      (eq, "$temp", 4),
    ],
    [
      (assign, ":var0", -1),
      (assign, ":var1", -1),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_is_human, ":var2"),
        (1707, ":var2"),
        (agent_get_entry_no, ":var3", ":var2"),
        (this_or_next|eq, ":var3", 18),
        (eq, ":var3", 19),
        (try_begin),
          (eq, ":var3", 18),
          (assign, ":var0", ":var2"),
        (else_try),
          (assign, ":var1", ":var2"),
        (try_end),
      (try_end),
      (gt, ":var0", -1),
      (gt, ":var1", -1),
      (agent_clear_scripted_mode, ":var0"),
      (agent_clear_scripted_mode, ":var1"),
      (party_get_slot, ":var4", "p_old_ruins", 267),
      (val_min, ":var4", 1000),
      (2090, ":var0", ":var4", 0),
      (2090, ":var1", ":var4", 0),
      (1733, ":var0", 1),
      (1733, ":var1", 1),
      (1807, ":var0", 1),
      (1807, ":var1", 1),
      (1803, ":var0", ":var1", -1),
      (1803, ":var1", ":var0", -1),
      (1753, ":var0", 199),
      (1753, ":var1", 199),
      (assign, "$temp", 3),
    ]),

    (ti_on_agent_knocked_down, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_agent_hit_points, ":var2", ":var0", 1),
      (store_agent_hit_points, ":var3", ":var1", 1),
      (try_begin),
        (gt, ":var2", ":var3"),
        (agent_get_troop_id, ":var4", ":var0"),
        (str_store_troop_name, s1, ":var4"),
        (display_log_message, "@{s1} won sparring session"),
      (else_try),
        (agent_get_troop_id, ":var4", ":var1"),
        (str_store_troop_name, s1, ":var4"),
        (display_log_message, "@{s1} won sparring session"),
      (try_end),
      (1802, ":var0"),
      (1802, ":var1"),
      (1807, ":var0", 0),
      (1807, ":var1", 0),
      (agent_set_hit_points, ":var0", 100, 0),
      (agent_set_hit_points, ":var1", 100, 0),
      (agent_clear_scripted_mode, ":var0"),
      (agent_clear_scripted_mode, ":var1"),
      (entry_point_get_position, pos1, 18),
      (agent_set_scripted_destination, ":var0", pos1, 0, 1),
      (agent_set_scripted_destination, ":var1", pos1, 0, 1),
      (1732, ":var0"),
      (1732, ":var1"),
      (assign, "$temp", 2),
    ]),

    (5, 0, 0, 
    [
      (is_between, "$temp", 1, 3),
    ],
    [
      (entry_point_get_position, pos1, 18),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (1707, ":var0"),
        (agent_get_position, pos2, ":var0"),
        (get_distance_between_positions, ":var1", pos1, pos2),
        (le, ":var1", 150),
        (1749, ":var0"),
        (val_sub, "$temp", 1),
      (try_end),
      (try_begin),
        (lt, "$temp", 0),
        (assign, "$temp", 0),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (finish_mission, 0),
    ]),

  ]),
#done COOP BEGIN ##########################
] + coop_mission_templates 
#COOP END############################
