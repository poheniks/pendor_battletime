# -*- coding: UTF-8 -*-
####################################################################################################################
# Generated by Warband Module Decompiler
# All rights of the module belong to their respective owners
####################################################################################################################

from header_common import *
from header_operations import *
from header_parties import *
from header_items import *
from header_skills import *
from header_triggers import *
from header_troops import *

from module_constants import *

####################################################################################################################
#  Each trigger contains the following fields:
# 1) Check interval: How frequently this trigger will be checked
# 2) Delay interval: Time to wait before applying the consequences of the trigger
#    After its conditions have been evaluated as true.
# 3) Re-arm interval. How much time must pass after applying the consequences of the trigger for the trigger to become active again.
#    You can put the constant ti_once here to make sure that the trigger never becomes active again after it fires once.
# 4) Conditions block (list). This must be a valid operation block. See header_operations.py for reference.
#    Every time the trigger is checked, the conditions block will be executed.
#    If the conditions block returns true, the consequences block will be executed.
#    If the conditions block is empty, it is assumed that it always evaluates to true.
# 5) Consequences block (list). This must be a valid operation block. See header_operations.py for reference. 
####################################################################################################################

triggers = [
  (0.1, 0, ti_once,[
    (map_free, 0),
  ],
  [
    (dialog_box, "str_tutorial_map1"),
  ]),

  (0, 0, 0,[
    (map_free),
    (neq, "$g_player_troop", "trp_player"),
  ],
  [
    (assign, "$g_player_troop", "trp_player"),
    (set_player_troop, "$g_player_troop"),
  ]),

  (0, 0, 24,[],
  [
    (reset_item_probabilities, 100),
    (set_merchandise_modifier_quality, 100),
    (reset_item_probabilities, 100),
    (set_item_probability_in_merchandise, "itm_salt", 700),
    (troop_add_merchandise, "trp_salt_mine_merchant", itp_type_goods, 36),
    (try_begin),
      (try_for_range, ":var0", 0, 3),
        (store_random_in_range, ":var1", "itm_smoked_fish", "itm_baggage_train"),
        (troop_add_item, "trp_order_quartermaster", ":var1", imod_plain),
      (try_end),
      (troop_ensure_inventory_space, "trp_order_quartermaster", 12),
      (troop_sort_inventory, "trp_order_quartermaster"),
      (assign, ":var2", 0),
      (assign, ":var3", 0),
      (store_item_kind_count, ":var2", "itm_arquebus_1", "trp_order_quartermaster"),
      (store_item_kind_count, ":var3", "itm_bullets_1", "trp_order_quartermaster"),
      (try_begin),
        (gt, ":var2", 2),
        (val_sub, ":var2", 2),
        (troop_remove_items, "trp_order_quartermaster", "itm_arquebus_1", ":var2"),
      (try_end),
      (try_begin),
        (gt, ":var3", 2),
        (val_sub, ":var3", 2),
        (troop_remove_items, "trp_order_quartermaster", "itm_bullets_1", ":var3"),
      (try_end),
      (store_random_in_range, ":var4", 0, 100),
      (try_begin),
        (item_slot_eq, "itm_arquebus_1", 65, 1),
        (try_begin),
          (lt, ":var4", 50),
          (troop_add_item, "trp_order_quartermaster", "itm_bullets_1", imod_plain),
          (lt, ":var4", 20),
          (troop_add_item, "trp_order_quartermaster", "itm_arquebus_1", imod_plain),
        (try_end),
      (else_try),
        (lt, ":var4", 2),
        (troop_add_item, "trp_order_quartermaster", "itm_bullets_1", imod_plain),
      (try_end),
      (troop_sort_inventory, "trp_order_quartermaster"),
    (try_end),
    (store_sub, ":var5", 301, "itm_spice"),
    (try_for_range, ":var6", "p_town_1", "p_castle_1"),
      (party_get_slot, ":var7", ":var6", 23),
      (reset_item_probabilities, 100),
      (try_for_range, ":var8", "itm_spice", "itm_baggage_train"),
        (store_add, ":var9", ":var8", ":var5"),
        (party_get_slot, ":var10", ":var6", ":var9"),
        (call_script, "script_center_get_production", ":var6", ":var8"),
        (assign, ":var11", reg0),
        (call_script, "script_center_get_consumption", ":var6", ":var8"),
        (val_sub, ":var11", reg0),
        (val_abs, ":var11"),
        (val_min, ":var11", 50),
        (val_mul, ":var11", 6),
        (val_mul, ":var11", 1000),
        (val_div, ":var11", ":var10"),
        (val_mul, ":var11", 1000),
        (val_div, ":var11", ":var10"),
        (val_mul, ":var11", 1000),
        (val_div, ":var11", ":var10"),
        (set_item_probability_in_merchandise, ":var8", ":var11"),
      (try_end),
      (troop_add_merchandise, ":var7", itp_type_goods, 36),
      (troop_ensure_inventory_space, ":var7", 55),
      (troop_sort_inventory, ":var7"),
      (store_troop_gold, ":var12", ":var7"),
      (lt, ":var12", 3500),
      (store_random_in_range, ":var13", 2000, 3000),
      (call_script, "script_troop_add_gold", ":var7", ":var13"),
    (try_end),
  ]),

  (0, 0, 168,[],
  [
    (call_script, "script_restock_special_merchant", "trp_noldor_merchant", 200, 4, 300, 30),
    (call_script, "script_restock_special_merchant", "trp_quigfen", 200, 2, 200, 15),
    (reset_item_probabilities, 100),
    (set_merchandise_modifier_quality, 135),
    (try_for_range, ":var0", "trp_town_1_armorer", "trp_town_1_weaponsmith"),
      (store_sub, ":var1", ":var0", "trp_town_1_armorer"),
      (val_add, ":var1", "p_town_1"),
      (troop_clear_inventory, ":var0"),
      (party_get_slot, ":var2", ":var1", 61),
      (1513, ":var0", ":var2", 13, 16),
      (1513, ":var0", ":var2", 12, 16),
      (1513, ":var0", ":var2", 14, 8),
      (1513, ":var0", ":var2", 15, 4),
      (troop_ensure_inventory_space, ":var0", 40),
      (troop_sort_inventory, ":var0"),
    (try_end),
  ]),

  (0, 0, 168,[],
  [
    (reset_item_probabilities, 100),
    (set_merchandise_modifier_quality, 120),
    (try_for_range, ":var0", "trp_town_1_weaponsmith", "trp_town_1_tavernkeeper"),
      (store_sub, ":var1", ":var0", "trp_town_1_weaponsmith"),
      (val_add, ":var1", "p_town_1"),
      (troop_clear_inventory, ":var0"),
      (party_get_slot, ":var2", ":var1", 61),
      (1513, ":var0", ":var2", 2, 9),
      (1513, ":var0", ":var2", 3, 4),
      (1513, ":var0", ":var2", 4, 4),
      (1513, ":var0", ":var2", 7, 8),
      (1513, ":var0", ":var2", 8, 5),
      (1513, ":var0", ":var2", 9, 3),
      (1513, ":var0", ":var2", 10, 2),
      (1513, ":var0", ":var2", 5, 3),
      (1513, ":var0", ":var2", 6, 2),
      (troop_ensure_inventory_space, ":var0", 40),
      (troop_sort_inventory, ":var0"),
    (try_end),
  ]),

  (0, 0, 168,[],
  [
    (reset_item_probabilities, 100),
    (set_merchandise_modifier_quality, 120),
    (try_for_range, ":var0", "trp_town_1_horse_merchant", "trp_town_1_mayor"),
      (troop_clear_inventory, ":var0"),
      (store_sub, ":var1", ":var0", "trp_town_1_horse_merchant"),
      (val_add, ":var1", "p_town_1"),
      (party_get_slot, ":var2", ":var1", 61),
      (store_random_in_range, ":var3", 5, 16),
      (1513, ":var0", ":var2", 1, ":var3"),
      (troop_ensure_inventory_space, ":var0", 65),
      (troop_sort_inventory, ":var0"),
    (try_end),
  ]),

  (0, 0, 24,[],
  [
    (try_for_range, ":var0", "trp_town_1_armorer", "trp_town_1_weaponsmith"),
      (store_sub, ":var1", ":var0", "trp_town_1_armorer"),
      (val_add, ":var1", "p_town_1"),
      (troop_sort_inventory, ":var0"),
      (troop_ensure_inventory_space, ":var0", 40),
      (troop_sort_inventory, ":var0"),
      (store_troop_gold, ":var2", ":var0"),
      (try_begin),
        (lt, ":var2", 4500),
        (store_random_in_range, ":var3", 400, 800),
        (call_script, "script_troop_add_gold", ":var0", ":var3"),
      (else_try),
        (gt, ":var2", 15000),
        (store_random_in_range, ":var4", 50, 150),
        (troop_remove_gold, ":var0", ":var4"),
      (try_end),
    (try_end),
    (try_for_range, ":var0", "trp_town_1_weaponsmith", "trp_town_1_tavernkeeper"),
      (store_sub, ":var1", ":var0", "trp_town_1_weaponsmith"),
      (val_add, ":var1", "p_town_1"),
      (troop_sort_inventory, ":var0"),
      (troop_ensure_inventory_space, ":var0", 30),
      (troop_sort_inventory, ":var0"),
      (store_troop_gold, ":var2", ":var0"),
      (try_begin),
        (lt, ":var2", 4500),
        (store_random_in_range, ":var3", 400, 800),
        (call_script, "script_troop_add_gold", ":var0", ":var3"),
      (else_try),
        (gt, ":var2", 15000),
        (store_random_in_range, ":var4", 50, 150),
        (troop_remove_gold, ":var0", ":var4"),
      (try_end),
    (try_end),
    (try_for_range, ":var0", "trp_town_1_horse_merchant", "trp_town_1_mayor"),
      (store_sub, ":var1", ":var0", "trp_town_1_horse_merchant"),
      (val_add, ":var1", "p_town_1"),
      (troop_sort_inventory, ":var0"),
      (troop_ensure_inventory_space, ":var0", 40),
      (troop_sort_inventory, ":var0"),
      (store_troop_gold, ":var2", ":var0"),
      (try_begin),
        (lt, ":var2", 4500),
        (store_random_in_range, ":var3", 400, 800),
        (call_script, "script_troop_add_gold", ":var0", ":var3"),
      (else_try),
        (gt, ":var2", 15000),
        (store_random_in_range, ":var4", 50, 150),
        (troop_remove_gold, ":var0", ":var4"),
      (try_end),
    (try_end),
    (troop_sort_inventory, "trp_noldor_merchant"),
    (troop_get_inventory_capacity, ":var5", "trp_noldor_merchant"),
    (store_sub, ":var6", ":var5", 30),
    (try_for_range_backwards, ":var7", ":var6", ":var5"),
      (troop_get_inventory_slot, ":var8", "trp_noldor_merchant", ":var7"),
      (troop_set_inventory_slot, "trp_noldor_merchant", ":var7", -1),
    (try_end),
    (troop_sort_inventory, "trp_noldor_merchant"),
    (store_troop_gold, ":var2", "trp_noldor_merchant"),
    (try_begin),
      (lt, ":var2", 6000),
      (store_random_in_range, ":var3", 500, 900),
      (call_script, "script_troop_add_gold", "trp_noldor_merchant", ":var3"),
    (else_try),
      (gt, ":var2", 40000),
      (store_random_in_range, ":var4", 100, 200),
      (troop_remove_gold, "trp_noldor_merchant", ":var4"),
    (try_end),
    (troop_sort_inventory, "trp_quigfen"),
    (troop_get_inventory_capacity, ":var5", "trp_quigfen"),
    (store_sub, ":var6", ":var5", 15),
    (try_for_range_backwards, ":var7", ":var6", ":var5"),
      (troop_get_inventory_slot, ":var8", "trp_quigfen", ":var7"),
      (neq, ":var8", "itm_book_noldor_1"),
      (troop_set_inventory_slot, "trp_quigfen", ":var7", -1),
    (try_end),
    (troop_sort_inventory, "trp_quigfen"),
    (store_troop_gold, ":var2", "trp_quigfen"),
    (try_begin),
      (lt, ":var2", 8000),
      (store_random_in_range, ":var3", 600, 1000),
      (call_script, "script_troop_add_gold", "trp_quigfen", ":var3"),
    (else_try),
      (gt, ":var2", 40000),
      (store_random_in_range, ":var4", 100, 200),
      (troop_remove_gold, "trp_quigfen", ":var4"),
    (try_end),
  ]),

  (1, 0, 0,[
    (check_quest_active, "qst_track_down_bandits"),
    (neg|check_quest_failed, "qst_track_down_bandits"),
    (neg|check_quest_succeeded, "qst_track_down_bandits"),
  ],
  [
    (quest_get_slot, ":var0", "qst_track_down_bandits", 8),
    (try_begin),
      (party_is_active, ":var0"),
      (store_faction_of_party, ":var1", ":var0"),
      (neg|is_between, ":var1", "fac_player_supporters_faction", "fac_kingdoms_end"),
      (assign, ":var2", 8),
      (try_begin),
        (is_currently_night),
        (assign, ":var2", 5),
      (try_end),
      (try_for_parties, ":var3"),
        (gt, ":var3", "p_spawn_points_end"),
        (store_faction_of_party, ":var4", ":var3"),
        (is_between, ":var4", "fac_player_supporters_faction", "fac_kingdoms_end"),
        (store_distance_to_party_from_party, ":var5", ":var3", ":var0"),
        (lt, ":var5", ":var2"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (str_store_party_name, s4, ":var3"),
          (display_message, "@{!}DEBUG -- Wanted bandits spotted by {s4}"),
        (try_end),
        (call_script, "script_get_closest_center", ":var0"),
        (assign, ":var6", reg0),
        (call_script, "script_add_log_entry", 70, ":var3", ":var6", ":var0", -1),
      (try_end),
    (else_try),
      (display_message, "str_bandits_eliminated_by_another", 0x66CCFF),
      (call_script, "script_abort_quest", "qst_track_down_bandits", 0),
    (try_end),
  ]),

  (2, 0, 0,[
    (store_random_party_of_template, reg2, "pt_prisoner_train_party"),
    (party_is_in_any_town, reg2),
  ],
  [
    (store_faction_of_party, ":var0", reg2),
    (call_script, "script_cf_select_random_walled_center_with_faction", ":var0", -1),
    (party_set_ai_behavior, reg2, ai_bhvr_travel_to_party),
    (party_set_ai_object, reg2, reg0),
    (party_set_flags, reg2, 65536, 0),
  ]),

  (4, 0, 0,[
    (eq, "$caravan_escort_state", 1),
    (assign, ":var0", 0),
    (try_begin),
      (neg|party_is_active, "$caravan_escort_party_id"),
      (assign, ":var0", 1),
    (else_try),
      (get_party_ai_object, ":var1", "$caravan_escort_party_id"),
      (neq, ":var1", "$caravan_escort_destination_town"),
      (assign, ":var0", 1),
    (try_end),
    (eq, ":var0", 1),
  ],
  [
    (assign, "$caravan_escort_state", 0),
  ]),

  (1.5, 0, 0,[
    (store_random_party_of_template, reg2, "pt_messenger_party"),
    (party_is_in_any_town, reg2),
  ],
  [
    (store_faction_of_party, ":var0", reg2),
    (call_script, "script_cf_select_random_walled_center_with_faction", ":var0", -1),
    (party_set_ai_behavior, reg2, ai_bhvr_travel_to_party),
    (party_set_ai_object, reg2, reg0),
    (party_set_flags, reg2, 65536, 0),
  ]),

  (1, 0, 0,[],
  [
    (try_for_range, ":var0", "fac_player_supporters_faction", "fac_kingdoms_end"),
      (faction_slot_eq, ":var0", 21, 0),
      (try_begin),
        (store_random_in_range, ":var1", 0, 100),
        (lt, ":var1", 10),
        (call_script, "script_create_kingdom_party_if_below_limit", ":var0", 11),
      (try_end),
    (try_end),
  ]),

  (0.2, 0, 0,[
    (check_quest_active, "qst_incriminate_loyal_commander"),
    (neg|check_quest_concluded, "qst_incriminate_loyal_commander"),
    (quest_slot_eq, "qst_incriminate_loyal_commander", 11, 2),
    (quest_get_slot, ":var0", "qst_incriminate_loyal_commander", 1),
    (quest_get_slot, ":var1", "qst_incriminate_loyal_commander", 8),
    (try_begin),
      (neg|party_is_active, ":var1"),
      (quest_set_slot, "qst_incriminate_loyal_commander", 11, 3),
      (call_script, "script_fail_quest", "qst_incriminate_loyal_commander"),
    (else_try),
      (party_is_in_town, ":var1", ":var0"),
      (remove_party, ":var1"),
      (quest_set_slot, "qst_incriminate_loyal_commander", 11, 3),
      (quest_get_slot, ":var2", "qst_incriminate_loyal_commander", 4),
      (assign, ":var3", 0),
      (try_for_range, ":var4", "fac_player_supporters_faction", "fac_kingdoms_end"),
        (faction_slot_eq, ":var4", 21, 0),
        (neq, ":var4", "fac_player_supporters_faction"),
        (neg|quest_slot_eq, "qst_incriminate_loyal_commander", 3, ":var4"),
        (val_add, ":var3", 1),
      (try_end),
      (try_begin),
        (gt, ":var3", 0),
        (store_random_in_range, ":var5", 0, ":var3"),
        (assign, ":var6", -1),
        (try_for_range, ":var4", "fac_player_supporters_faction", "fac_kingdoms_end"),
          (eq, ":var6", -1),
          (faction_slot_eq, ":var4", 21, 0),
          (neq, ":var4", "fac_player_supporters_faction"),
          (neg|quest_slot_eq, "qst_incriminate_loyal_commander", 3, ":var4"),
          (val_sub, ":var5", 1),
          (lt, ":var5", 0),
          (assign, ":var6", ":var4"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (call_script, "script_change_troop_faction", ":var2", ":var6"),
      (else_try),
        (call_script, "script_change_troop_faction", ":var2", "fac_robber_knights"),
      (try_end),
      (call_script, "script_succeed_quest", "qst_incriminate_loyal_commander"),
    (try_end),
  ],
  []),

  (0.2, 0, 0,[
    (check_quest_active, "qst_bring_back_runaway_serfs"),
    (neg|check_quest_concluded, "qst_bring_back_runaway_serfs"),
    (quest_get_slot, ":var0", "qst_bring_back_runaway_serfs", 7),
    (quest_get_slot, ":var1", "qst_bring_back_runaway_serfs", 1),
    (try_begin),
      (party_is_active, "$qst_bring_back_runaway_serfs_party_1"),
      (try_begin),
        (party_is_in_town, "$qst_bring_back_runaway_serfs_party_1", ":var1"),
        (remove_party, "$qst_bring_back_runaway_serfs_party_1"),
        (val_add, "$qst_bring_back_runaway_serfs_num_parties_fleed", 1),
      (else_try),
        (party_is_in_town, "$qst_bring_back_runaway_serfs_party_1", ":var0"),
        (remove_party, "$qst_bring_back_runaway_serfs_party_1"),
        (val_add, "$qst_bring_back_runaway_serfs_num_parties_returned", 1),
      (else_try),
        (store_distance_to_party_from_party, ":var2", "p_main_party", "$qst_bring_back_runaway_serfs_party_1"),
        (gt, ":var2", 3),
        (party_set_ai_object, "$qst_bring_back_runaway_serfs_party_1", ":var1"),
      (try_end),
    (try_end),
    (try_begin),
      (party_is_active, "$qst_bring_back_runaway_serfs_party_2"),
      (try_begin),
        (party_is_in_town, "$qst_bring_back_runaway_serfs_party_2", ":var1"),
        (remove_party, "$qst_bring_back_runaway_serfs_party_2"),
        (val_add, "$qst_bring_back_runaway_serfs_num_parties_fleed", 1),
      (else_try),
        (party_is_in_town, "$qst_bring_back_runaway_serfs_party_2", ":var0"),
        (remove_party, "$qst_bring_back_runaway_serfs_party_2"),
        (val_add, "$qst_bring_back_runaway_serfs_num_parties_returned", 1),
      (else_try),
        (store_distance_to_party_from_party, ":var2", "p_main_party", "$qst_bring_back_runaway_serfs_party_2"),
        (gt, ":var2", 3),
        (party_set_ai_object, "$qst_bring_back_runaway_serfs_party_2", ":var1"),
      (try_end),
    (try_end),
    (try_begin),
      (party_is_active, "$qst_bring_back_runaway_serfs_party_3"),
      (try_begin),
        (party_is_in_town, "$qst_bring_back_runaway_serfs_party_3", ":var1"),
        (remove_party, "$qst_bring_back_runaway_serfs_party_3"),
        (val_add, "$qst_bring_back_runaway_serfs_num_parties_fleed", 1),
      (else_try),
        (party_is_in_town, "$qst_bring_back_runaway_serfs_party_3", ":var0"),
        (remove_party, "$qst_bring_back_runaway_serfs_party_3"),
        (val_add, "$qst_bring_back_runaway_serfs_num_parties_returned", 1),
      (else_try),
        (store_distance_to_party_from_party, ":var2", "p_main_party", "$qst_bring_back_runaway_serfs_party_3"),
        (gt, ":var2", 3),
        (party_set_ai_object, "$qst_bring_back_runaway_serfs_party_3", ":var1"),
      (try_end),
    (try_end),
    (assign, ":var3", "$qst_bring_back_runaway_serfs_num_parties_returned"),
    (val_add, ":var3", "$qst_bring_back_runaway_serfs_num_parties_fleed"),
    (ge, ":var3", 3),
    (try_begin),
      (ge, "$qst_bring_back_runaway_serfs_num_parties_returned", 3),
      (call_script, "script_succeed_quest", "qst_bring_back_runaway_serfs"),
    (else_try),
      (eq, "$qst_bring_back_runaway_serfs_num_parties_returned", 0),
      (call_script, "script_fail_quest", "qst_bring_back_runaway_serfs"),
    (else_try),
      (call_script, "script_conclude_quest", "qst_bring_back_runaway_serfs"),
    (try_end),
  ],
  []),

  (0.5, 0, 0,[
    (check_quest_active, "qst_follow_spy"),
    (eq, "$qst_follow_spy_no_active_parties", 0),
    (quest_get_slot, ":var0", "qst_follow_spy", 12),
    (quest_get_slot, ":var1", "qst_follow_spy", 7),
    (assign, ":var2", 0),
    (try_begin),
      (this_or_next|ge, "$qst_follow_spy_run_away", 2),
      (neg|this_or_next|party_is_active, "$qst_follow_spy_spy_party"),
      (neg|party_is_active, "$qst_follow_spy_spy_partners_party"),
    (else_try),
      (eq, "$qst_follow_spy_meeting_state", 0),
      (store_distance_to_party_from_party, ":var3", "p_main_party", "$qst_follow_spy_spy_party"),
      (try_begin),
        (assign, ":var4", 3),
        (try_begin),
          (is_currently_night),
          (assign, ":var4", 1),
        (try_end),
        (le, ":var3", ":var4"),
        (store_distance_to_party_from_party, ":var5", "p_main_party", ":var0"),
        (gt, ":var5", 1),
        (val_add, "$qst_follow_spy_run_away", 1),
        (try_begin),
          (eq, "$qst_follow_spy_run_away", 2),
          (assign, ":var2", 1),
          (display_message, "str_qst_follow_spy_noticed_you"),
        (try_end),
      (else_try),
        (store_distance_to_party_from_party, ":var3", "$qst_follow_spy_spy_partners_party", "$qst_follow_spy_spy_party"),
        (le, ":var3", 1),
        (party_attach_to_party, "$qst_follow_spy_spy_party", "$qst_follow_spy_spy_partners_party"),
        (assign, "$qst_follow_spy_meeting_state", 1),
        (assign, "$qst_follow_spy_meeting_counter", 0),
      (try_end),
    (else_try),
      (eq, "$qst_follow_spy_meeting_state", 1),
      (store_distance_to_party_from_party, ":var3", "p_main_party", "$qst_follow_spy_spy_partners_party"),
      (try_begin),
        (le, ":var3", 1),
        (party_detach, "$qst_follow_spy_spy_party"),
        (val_add, "$qst_follow_spy_run_away", 1),
        (try_begin),
          (eq, "$qst_follow_spy_run_away", 2),
          (assign, ":var2", 1),
          (display_message, "str_qst_follow_spy_noticed_you"),
        (try_end),
      (else_try),
        (val_add, "$qst_follow_spy_meeting_counter", 1),
        (gt, "$qst_follow_spy_meeting_counter", 4),
        (party_detach, "$qst_follow_spy_spy_party"),
        (assign, ":var2", 1),
        (assign, "$qst_follow_spy_meeting_state", 2),
      (try_end),
    (try_end),
    (try_begin),
      (eq, ":var2", 1),
      (party_set_ai_object, "$qst_follow_spy_spy_party", ":var0"),
      (party_set_ai_object, "$qst_follow_spy_spy_partners_party", ":var1"),
      (party_set_ai_behavior, "$qst_follow_spy_spy_party", ai_bhvr_travel_to_party),
      (party_set_ai_behavior, "$qst_follow_spy_spy_partners_party", ai_bhvr_travel_to_party),
      (party_set_flags, "$qst_follow_spy_spy_party", 65536, 0),
      (party_set_flags, "$qst_follow_spy_spy_partners_party", 65536, 0),
    (try_end),
    (assign, ":var6", 0),
    (try_begin),
      (party_is_active, "$qst_follow_spy_spy_party"),
      (val_add, ":var6", 1),
      (party_is_in_town, "$qst_follow_spy_spy_party", ":var0"),
      (remove_party, "$qst_follow_spy_spy_party"),
      (assign, "$qst_follow_spy_spy_back_in_town", 1),
      (val_sub, ":var6", 1),
    (try_end),
    (try_begin),
      (party_is_active, "$qst_follow_spy_spy_partners_party"),
      (val_add, ":var6", 1),
      (party_is_in_town, "$qst_follow_spy_spy_partners_party", ":var1"),
      (remove_party, "$qst_follow_spy_spy_partners_party"),
      (assign, "$qst_follow_spy_partner_back_in_town", 1),
      (val_sub, ":var6", 1),
    (try_end),
    (try_begin),
      (eq, "$qst_follow_spy_partner_back_in_town", 1),
      (eq, "$qst_follow_spy_spy_back_in_town", 1),
      (call_script, "script_fail_quest", "qst_follow_spy"),
    (try_end),
    (try_begin),
      (eq, ":var6", 0),
      (assign, "$qst_follow_spy_no_active_parties", 1),
      (party_count_prisoners_of_type, ":var7", "p_main_party", "trp_spy"),
      (party_count_prisoners_of_type, ":var8", "p_main_party", "trp_spy_partner"),
      (gt, ":var7", 0),
      (gt, ":var8", 0),
      (call_script, "script_succeed_quest", "qst_follow_spy"),
    (try_end),
  ],
  []),

  (168, 0, 0,[],
  [
    (val_mul, "$debt_to_merchants_guild", 101),
    (val_div, "$debt_to_merchants_guild", 100),
  ]),

  (0.1, 0, 0.1,[
    (check_quest_active, "qst_escort_merchant_caravan"),
    (eq, "$escort_merchant_caravan_mode", 1),
  ],
  [
    (quest_get_slot, ":var0", "qst_escort_merchant_caravan", 8),
    (try_begin),
      (party_is_active, ":var0"),
      (party_set_ai_behavior, ":var0", ai_bhvr_hold),
      (party_set_flags, ":var0", 65536, 0),
    (try_end),
  ]),

  (0.1, 0, 0.1,[
    (check_quest_active, "qst_escort_merchant_caravan"),
    (eq, "$escort_merchant_caravan_mode", 0),
  ],
  [
    (quest_get_slot, ":var0", "qst_escort_merchant_caravan", 8),
    (try_begin),
      (party_is_active, ":var0"),
      (party_set_ai_behavior, ":var0", ai_bhvr_escort_party),
      (party_set_flags, ":var0", 65536, 0),
      (party_set_ai_object, ":var0", "p_main_party"),
    (try_end),
  ]),

  (0.1, 0, 0,[
    (check_quest_active, "qst_escort_merchant_caravan"),
    (quest_get_slot, ":var0", "qst_escort_merchant_caravan", 8),
    (neg|party_is_active, ":var0"),
  ],
  [
    (call_script, "script_abort_quest", "qst_escort_merchant_caravan", 2),
  ]),

  (0.1, 0, 0,[
    (check_quest_active, "qst_escort_peasants"),
    (neg|check_quest_succeeded, "qst_escort_peasants"),
    (quest_get_slot, ":var0", "qst_escort_peasants", 8),
    (neg|party_is_active, ":var0"),
  ],
  [
    (call_script, "script_abort_quest", "qst_escort_peasants", 2),
  ]),

  (0.1, 0, 0,[
    (check_quest_active, "qst_escort_peasants"),
    (neg|check_quest_succeeded, "qst_escort_peasants"),
    (quest_get_slot, ":var0", "qst_escort_peasants", 8),
    (party_is_active, ":var0"),
    (party_is_in_any_town, ":var0"),
    (party_get_cur_town, ":var1", ":var0"),
    (quest_slot_eq, "qst_escort_peasants", 1, ":var1"),
    (remove_party, ":var0"),
  ],
  [
    (call_script, "script_succeed_quest", "qst_escort_peasants"),
  ]),

  (0.3, 0, 1.1,[
    (check_quest_active, "qst_troublesome_bandits"),
    (neg|check_quest_failed, "qst_troublesome_bandits"),
    (store_num_parties_destroyed, ":var0", "pt_troublesome_bandits"),
    (lt, "$qst_troublesome_bandits_eliminated", ":var0"),
    (store_num_parties_destroyed_by_player, ":var1", "pt_troublesome_bandits"),
    (eq, ":var1", "$qst_troublesome_bandits_eliminated_by_player"),
  ],
  [
    (display_message, "str_bandits_eliminated_by_another", 0x66CCFF),
    (call_script, "script_abort_quest", "qst_troublesome_bandits", 0),
  ]),

  (0.3, 0, 1.1,[
    (check_quest_active, "qst_troublesome_bandits"),
    (neg|check_quest_succeeded, "qst_troublesome_bandits"),
    (store_num_parties_destroyed, ":var0", "pt_troublesome_bandits"),
    (lt, "$qst_troublesome_bandits_eliminated", ":var0"),
    (store_num_parties_destroyed_by_player, ":var1", "pt_troublesome_bandits"),
    (neq, ":var1", "$qst_troublesome_bandits_eliminated_by_player"),
  ],
  [
    (call_script, "script_succeed_quest", "qst_troublesome_bandits"),
  ]),

  (0.3, 0, 1.1,[
    (check_quest_active, "qst_marauding_jatu"),
    (neg|check_quest_succeeded, "qst_marauding_jatu"),
    (store_num_parties_destroyed, ":var0", "pt_jatu_quest_army"),
    (gt, ":var0", 0),
  ],
  [
    (call_script, "script_succeed_quest", "qst_marauding_jatu"),
  ]),

  (0.3, 0, 1.1,[
    (check_quest_active, "qst_order_rivalry"),
    (neg|check_quest_succeeded, "qst_order_rivalry"),
    (neg|check_quest_failed, "qst_order_rivalry"),
    (quest_get_slot, ":var0", "qst_order_rivalry", 8),
    (neg|party_is_active, ":var0"),
  ],
  [
    (call_script, "script_succeed_quest", "qst_order_rivalry"),
  ]),

  (1, 0, 0,[
    (check_quest_active, "qst_kidnapped_girl"),
    (quest_get_slot, ":var0", "qst_kidnapped_girl", 8),
    (party_is_active, ":var0"),
    (party_is_in_any_town, ":var0"),
    (remove_party, ":var0"),
  ],
  []),

  (0, 0, 336,[
    (try_for_range, ":var0", "trp_kingdom_1_pretender", "trp_knight_1_1_wife"),
      (troop_set_slot, ":var0", 12, 0),
      (neq, ":var0", "$supported_pretender"),
      (troop_get_slot, ":var1", ":var0", 14),
      (faction_slot_eq, ":var1", 21, 0),
      (faction_slot_eq, ":var1", 60, 1),
      (neg|troop_slot_eq, ":var0", 2, 2),
      (try_for_range, ":var2", 0, 30),
        (troop_slot_eq, ":var0", 12, 0),
        (store_random_in_range, ":var3", "p_town_1", "p_castle_1"),
        (store_faction_of_party, ":var4", ":var3"),
        (store_relation, ":var5", ":var4", ":var1"),
        (le, ":var5", 0),
        (troop_set_slot, ":var0", 12, ":var3"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (str_store_troop_name, s4, ":var0"),
          (str_store_party_name, s5, ":var3"),
          (display_message, "@{!}{s4} is in {s5}"),
        (try_end),
      (try_end),
    (try_end),
  ],
  []),

  (360, 0, 0,[
    (call_script, "script_update_companion_candidates_in_taverns"),
  ],
  []),

  (0, 0, 24,[],
  [
    (assign, ":var0", 0),
    (assign, ":var1", 100),
    (try_for_range, ":var2", "trp_npc_adonja", "trp_kingdom_1_lord"),
      (main_party_has_troop, ":var2"),
      (val_add, ":var0", 1),
    (try_end),
    (val_sub, ":var1", ":var0"),
    (store_skill_level, ":var3", "skl_persuasion", "trp_player"),
    (val_add, ":var1", ":var3"),
    (assign, reg7, ":var1"),
    (try_begin),
      (gt, "$personality_clash_after_24_hrs", 0),
      (try_begin),
        (troop_get_slot, ":var4", "$personality_clash_after_24_hrs", 71),
        (main_party_has_troop, "$personality_clash_after_24_hrs"),
        (main_party_has_troop, ":var4"),
        (try_begin),
          (neq, "$g_option_companion_dialogs", 0),
          (assign, "$npc_with_personality_clash", "$personality_clash_after_24_hrs"),
        (else_try),
          (troop_get_slot, ":var5", "$personality_clash_after_24_hrs", 77),
          (val_add, ":var5", 5),
          (troop_set_slot, "$personality_clash_after_24_hrs", 77, ":var5"),
          (troop_set_slot, "$personality_clash_after_24_hrs", 72, 3),
          (troop_get_slot, ":var4", "$personality_clash_after_24_hrs", 71),
          (str_store_troop_name, s11, "$personality_clash_after_24_hrs"),
          (str_store_troop_name, s12, ":var4"),
          (display_message, "@{s11} and {s12} are upset at each other.", 0xFFFF00),
          (assign, "$npc_with_personality_clash", 0),
        (try_end),
      (try_end),
      (assign, "$personality_clash_after_24_hrs", 0),
    (try_end),
    (try_for_range, ":var6", "trp_npc_adonja", "trp_kingdom_1_lord"),
      (troop_set_slot, ":var6", 81, 0),
      (try_begin),
        (troop_slot_eq, ":var6", 5, 1),
        (troop_set_slot, ":var6", 80, 1),
      (try_end),
      (troop_get_slot, ":var7", ":var6", 2),
      (try_begin),
        (eq, ":var7", 11),
        (troop_get_slot, ":var8", ":var6", 84),
        (str_store_troop_name, s31, ":var6"),
        (troop_get_slot, ":var9", "trp_player", 7),
        (assign, reg4, ":var9"),
        (assign, reg5, ":var8"),
        (gt, ":var9", ":var8"),
        (troop_set_slot, ":var6", 77, 0),
        (troop_set_slot, ":var6", 69, 0),
        (troop_set_slot, ":var6", 2, 0),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var6", 151, 5),
        (troop_slot_eq, ":var6", 152, 1),
        (troop_get_slot, ":var4", ":var6", 144),
        (main_party_has_troop, ":var4"),
        (troop_slot_eq, ":var4", 145, 0),
        (troop_set_slot, ":var4", 145, 1),
        (str_store_troop_name, s3, ":var6"),
        (str_store_troop_name, s4, ":var4"),
        (try_begin),
          (eq, "$cheat_mode", 1),
          (display_message, "str_s4_ready_to_voice_objection_to_s3s_mission_if_in_party"),
        (try_end),
      (try_end),
      (try_begin),
        (main_party_has_troop, ":var6"),
        (call_script, "script_npc_morale", ":var6"),
        (assign, ":var10", reg0),
        (try_begin),
          (lt, ":var10", 20),
          (store_random_in_range, ":var11", 0, 100),
          (val_add, ":var10", ":var11"),
          (lt, ":var10", 20),
          (assign, "$npc_is_quitting", ":var6"),
        (try_end),
        (troop_get_slot, ":var5", ":var6", 77),
        (val_mul, ":var5", 90),
        (val_div, ":var5", ":var1"),
        (troop_set_slot, ":var6", 77, ":var5"),
        (troop_get_slot, ":var5", ":var6", 69),
        (val_mul, ":var5", 90),
        (val_div, ":var5", ":var1"),
        (troop_set_slot, ":var6", 69, ":var5"),
        (try_begin),
          (this_or_next|troop_slot_ge, ":var6", 72, 1),
          (eq, "$disable_npc_complaints", 1),
          (troop_get_slot, ":var12", ":var6", 71),
          (main_party_has_troop, ":var12"),
          (call_script, "script_reduce_companion_morale_for_clash", ":var6", ":var12", 72),
        (try_end),
        (try_begin),
          (this_or_next|troop_slot_ge, ":var6", 74, 1),
          (eq, "$disable_npc_complaints", 1),
          (troop_get_slot, ":var12", ":var6", 73),
          (main_party_has_troop, ":var12"),
          (call_script, "script_reduce_companion_morale_for_clash", ":var6", ":var12", 74),
        (try_end),
        (try_begin),
          (this_or_next|troop_slot_ge, ":var6", 76, 1),
          (eq, "$disable_npc_complaints", 1),
          (troop_get_slot, ":var12", ":var6", 75),
          (main_party_has_troop, ":var12"),
          (troop_get_slot, ":var5", ":var6", 77),
          (val_mul, ":var5", 9),
          (val_div, ":var5", 10),
          (troop_set_slot, ":var6", 77, ":var5"),
        (try_end),
        (try_begin),
          (eq, "$npc_with_personality_clash", 0),
          (eq, "$npc_with_personality_clash_2", 0),
          (eq, "$personality_clash_after_24_hrs", 0),
          (troop_slot_eq, ":var6", 72, 0),
          (troop_get_slot, ":var4", ":var6", 71),
          (main_party_has_troop, ":var4"),
          (assign, "$personality_clash_after_24_hrs", ":var6"),
        (try_end),
        (try_begin),
          (eq, "$npc_with_political_grievance", 0),
          (troop_slot_eq, ":var6", 145, 1),
          (assign, "$npc_with_political_grievance", ":var6"),
        (try_end),
      (else_try),
        (neg|main_party_has_troop, ":var6"),
        (eq, ":var7", 5),
        (troop_get_slot, ":var13", ":var6", 151),
        (try_begin),
          (gt, ":var13", 0),
          (val_sub, ":var13", 1),
          (troop_set_slot, ":var6", 151, ":var13"),
        (else_try),
          (troop_slot_ge, ":var6", 152, 1),
          (neg|this_or_next|troop_slot_eq, ":var6", 152, 8),
          (hero_can_join, "p_main_party"),
          (assign, "$npc_to_rejoin_party", ":var6"),
        (try_end),
      (try_end),
    (try_end),
  ]),

  (1, 0, 0,[
    (troop_get_type, ":var0", "trp_player"),
    (ge, ":var0", 1),
    (try_for_range, ":var1", "trp_npc_adonja", "trp_kingdom_1_lord"),
      (troop_slot_eq, ":var1", 2, 5),
      (troop_get_inventory_capacity, ":var2", ":var1"),
      (try_for_range, ":var3", 0, ":var2"),
        (troop_get_inventory_slot, ":var4", ":var1", ":var3"),
        (ge, ":var4", 0),
        (this_or_next|eq, ":var4", "itm_ebony_great_sword"),
        (this_or_next|eq, ":var4", "itm_havathang"),
        (eq, ":var4", "itm_strange_great_sword"),
        (372, 80),
        (assign, ":var2", 0),
      (try_end),
    (try_end),
  ],
  []),

  (1, 0, 1,[
    (neq, "$snouz_test_war", 0),
  ],
  [
    (try_begin),
      (eq, "$snouz_test_war", 1),
      (set_relation, "fac_kingdom_1", "fac_kingdom_2", 100),
      (set_relation, "fac_kingdom_1", "fac_kingdom_3", 100),
      (set_relation, "fac_kingdom_1", "fac_kingdom_4", -100),
      (set_relation, "fac_kingdom_1", "fac_kingdom_5", 100),
      (set_relation, "fac_kingdom_2", "fac_kingdom_3", 100),
      (set_relation, "fac_kingdom_2", "fac_kingdom_4", 100),
      (set_relation, "fac_kingdom_2", "fac_kingdom_5", 100),
      (set_relation, "fac_kingdom_3", "fac_kingdom_4", 100),
      (set_relation, "fac_kingdom_3", "fac_kingdom_5", -100),
      (set_relation, "fac_kingdom_4", "fac_kingdom_5", 100),
    (else_try),
      (eq, "$snouz_test_war", 2),
      (set_relation, "fac_kingdom_1", "fac_kingdom_2", 100),
      (set_relation, "fac_kingdom_1", "fac_kingdom_3", 100),
      (set_relation, "fac_kingdom_1", "fac_kingdom_4", 100),
      (set_relation, "fac_kingdom_1", "fac_kingdom_5", -100),
      (set_relation, "fac_kingdom_2", "fac_kingdom_3", 100),
      (set_relation, "fac_kingdom_2", "fac_kingdom_4", 100),
      (set_relation, "fac_kingdom_2", "fac_kingdom_5", 100),
      (set_relation, "fac_kingdom_3", "fac_kingdom_4", -100),
      (set_relation, "fac_kingdom_3", "fac_kingdom_5", 100),
      (set_relation, "fac_kingdom_4", "fac_kingdom_5", 100),
    (else_try),
      (eq, "$snouz_test_war", 3),
      (set_relation, "fac_kingdom_1", "fac_kingdom_2", -100),
      (set_relation, "fac_kingdom_1", "fac_kingdom_3", 100),
      (set_relation, "fac_kingdom_1", "fac_kingdom_4", 100),
      (set_relation, "fac_kingdom_1", "fac_kingdom_5", 100),
      (set_relation, "fac_kingdom_2", "fac_kingdom_3", 100),
      (set_relation, "fac_kingdom_2", "fac_kingdom_4", 100),
      (set_relation, "fac_kingdom_2", "fac_kingdom_5", 100),
      (set_relation, "fac_kingdom_3", "fac_kingdom_4", 100),
      (set_relation, "fac_kingdom_3", "fac_kingdom_5", 100),
      (set_relation, "fac_kingdom_4", "fac_kingdom_5", -100),
    (else_try),
      (eq, "$snouz_test_war", 4),
      (set_relation, "fac_kingdom_1", "fac_kingdom_2", 100),
      (set_relation, "fac_kingdom_1", "fac_kingdom_3", -100),
      (set_relation, "fac_kingdom_1", "fac_kingdom_4", 100),
      (set_relation, "fac_kingdom_1", "fac_kingdom_5", 100),
      (set_relation, "fac_kingdom_2", "fac_kingdom_3", 100),
      (set_relation, "fac_kingdom_2", "fac_kingdom_4", -100),
      (set_relation, "fac_kingdom_2", "fac_kingdom_5", 100),
      (set_relation, "fac_kingdom_3", "fac_kingdom_4", 100),
      (set_relation, "fac_kingdom_3", "fac_kingdom_5", 100),
      (set_relation, "fac_kingdom_4", "fac_kingdom_5", 100),
    (try_end),
  ]),

  (0, 0, ti_on_switch_to_map,[],
  [
    (troop_set_slot, "trp_quick_battle_6_player", 406, 0),
  ]),

]